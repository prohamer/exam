<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第2章 生物體的組成 - 互動式闖關系統</title>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor: default;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overscroll-behavior: none;
            -webkit-user-select: none;
            user-select: none;
            overflow-x: hidden;
        }

        button, a, .clickable {
            cursor: pointer !important;
        }

        .drag-item {
            transition: all 0.2s ease;
            cursor: grab !important;
            touch-action: none;
            -webkit-touch-callout: none;
        }

        .drag-item:active {
            cursor: grabbing !important;
        }

        .drop-zone {
            transition: all 0.2s ease;
            min-height: 80px;
        }

        .drop-zone.drag-over {
            background: rgba(59, 130, 246, 0.2);
            border: 3px dashed #3b82f6 !important;
            transform: scale(1.02);
        }

        .correct-answer {
            animation: correctPulse 0.6s ease-out;
            border: 3px solid #10b981 !important;
            background: rgba(16, 185, 129, 0.1);
        }

        .wrong-answer {
            animation: shake 0.5s ease-out;
            border: 3px solid #ef4444 !important;
            background: rgba(239, 68, 68, 0.1);
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const CHAPTER_DATA = {
            "2-1": [
                {
                    id: "2-1-1",
                    section: "2-1",
                    type: "classification",
                    title: "第一關:細胞的發現與學說",
                    description: "請將科學家與其貢獻,或是細胞學說的內容進行正確分類",
                    zones: [
                        { id: 'zone1', title: '虎克 (Hooke)', icon: 'fa-microscope' },
                        { id: 'zone2', title: '細胞學說', icon: 'fa-book-open' }
                    ],
                    items: [
                        { id: 'item1', text: '發現並命名細胞 (Cell)', val: 'hooke' },
                        { id: 'item2', text: '觀察軟木栓薄片', val: 'hooke' },
                        { id: 'item3', text: '生物體皆由細胞組成', val: 'theory' },
                        { id: 'item4', text: '細胞是生物體構造與功能的基本單位', val: 'theory' },
                        { id: 'item5', text: '看到的其實是細胞壁', val: 'hooke' }
                    ],
                    solution: {
                        zone1: ['hooke'],
                        zone2: ['theory']
                    }
                },
                {
                    id: "2-1-2",
                    section: "2-1",
                    type: "classification",
                    title: "第二關:顯微鏡下的細胞形態",
                    description: "根據課本內容,判斷下列細胞形態對應的功能或位置",
                    zones: [
                        { id: 'zone1', title: '保護功能', icon: 'fa-shield-halved' },
                        { id: 'zone2', title: '輸送功能', icon: 'fa-truck-fast' },
                        { id: 'zone3', title: '控制收縮', icon: 'fa-dumbbell' }
                    ],
                    items: [
                        { id: 'item1', text: '扁平排列緊密', val: 'protect' },
                        { id: 'item2', text: '口腔皮膜細胞', val: 'protect' },
                        { id: 'item3', text: '圓球狀', val: 'transport' },
                        { id: 'item4', text: '紅血球', val: 'transport' },
                        { id: 'item5', text: '細長形狀', val: 'control' },
                        { id: 'item6', text: '肌肉細胞', val: 'control' }
                    ],
                    solution: {
                        zone1: ['protect'],
                        zone2: ['transport'],
                        zone3: ['control']
                    }
                }
            ],
            "2-2": [
                {
                    id: "2-2-1",
                    section: "2-2",
                    type: "classification",
                    title: "第一關:動植物細胞比較",
                    description: "將構造拖曳至正確的分類中(植物特有或兩者共有)",
                    zones: [
                        { id: 'zone1', title: '植物特有', icon: 'fa-leaf' },
                        { id: 'zone2', title: '兩者共有', icon: 'fa-circle-check' }
                    ],
                    items: [
                        { id: 'item1', text: '細胞壁', val: 'plant' },
                        { id: 'item2', text: '葉綠體', val: 'plant' },
                        { id: 'item3', text: '細胞膜', val: 'both' },
                        { id: 'item4', text: '細胞核', val: 'both' },
                        { id: 'item5', text: '粒線體', val: 'both' },
                        { id: 'item6', text: '液泡', val: 'both' }
                    ],
                    solution: {
                        zone1: ['plant'],
                        zone2: ['both']
                    }
                },
                {
                    id: "2-2-2",
                    section: "2-2",
                    type: "classification",
                    title: "第二關:胞器的功能",
                    description: "請將下列功能描述配對至正確的胞器",
                    zones: [
                        { id: 'zone1', title: '細胞核', icon: 'fa-dna' },
                        { id: 'zone2', title: '粒線體', icon: 'fa-bolt' },
                        { id: 'zone3', title: '葉綠體', icon: 'fa-sun' },
                        { id: 'zone4', title: '液泡', icon: 'fa-droplet' }
                    ],
                    items: [
                        { id: 'item1', text: '含遺傳物質 DNA', val: 'nucleus' },
                        { id: 'item2', text: '細胞的生命中樞', val: 'nucleus' },
                        { id: 'item3', text: '行呼吸作用', val: 'mitochondria' },
                        { id: 'item4', text: '產生能量 (能量工廠)', val: 'mitochondria' },
                        { id: 'item5', text: '行光合作用', val: 'chloroplast' },
                        { id: 'item6', text: '製造養分', val: 'chloroplast' },
                        { id: 'item7', text: '儲存水分與廢物', val: 'vacuole' },
                        { id: 'item8', text: '植物細胞中較大', val: 'vacuole' }
                    ],
                    solution: {
                        zone1: ['nucleus'],
                        zone2: ['mitochondria'],
                        zone3: ['chloroplast'],
                        zone4: ['vacuole']
                    }
                }
            ],
            "2-3": [
                {
                    id: "2-3-1",
                    section: "2-3",
                    type: "classification",
                    title: "第一關:擴散與滲透",
                    description: "判斷物質進出細胞的方式或現象",
                    zones: [
                        { id: 'zone1', title: '擴散作用', icon: 'fa-wind' },
                        { id: 'zone2', title: '滲透作用', icon: 'fa-droplet' }
                    ],
                    items: [
                        { id: 'item1', text: '氣體分子(氧氣/二氧化碳)進出', val: 'diffusion' },
                        { id: 'item2', text: '聞到花香', val: 'diffusion' },
                        { id: 'item3', text: '水分子通過細胞膜', val: 'osmosis' },
                        { id: 'item4', text: '濃食鹽水中紅血球萎縮', val: 'osmosis' },
                        { id: 'item5', text: '清水中紅血球脹破', val: 'osmosis' }
                    ],
                    solution: {
                        zone1: ['diffusion'],
                        zone2: ['osmosis']
                    }
                }
            ],
            "2-4": [
                {
                    id: "2-4-1",
                    section: "2-4",
                    type: "classification",
                    title: "第一關:生物體的組成層次",
                    description: "請依序排列動物體的組成層次(由簡到繁)",
                    zones: [
                        { id: 'zone1', title: '第1層', icon: 'fa-1' },
                        { id: 'zone2', title: '第2層', icon: 'fa-2' },
                        { id: 'zone3', title: '第3層', icon: 'fa-3' },
                        { id: 'zone4', title: '第4層', icon: 'fa-4' },
                        { id: 'zone5', title: '第5層', icon: 'fa-5' }
                    ],
                    items: [
                        { id: 'item1', text: '細胞', val: '1' },
                        { id: 'item2', text: '組織', val: '2' },
                        { id: 'item3', text: '器官', val: '3' },
                        { id: 'item4', text: '系統', val: '4' },
                        { id: 'item5', text: '個體', val: '5' }
                    ],
                    solution: {
                        zone1: ['1'],
                        zone2: ['2'],
                        zone3: ['3'],
                        zone4: ['4'],
                        zone5: ['5']
                    }
                },
                {
                    id: "2-4-2",
                    section: "2-4",
                    type: "classification",
                    title: "第二關:組織與器官分辨",
                    description: "區分下列例子屬於組織還是器官",
                    zones: [
                        { id: 'zone1', title: '組織 (Tissue)', icon: 'fa-shapes' },
                        { id: 'zone2', title: '器官 (Organ)', icon: 'fa-heart' }
                    ],
                    items: [
                        { id: 'item1', text: '葉肉組織', val: 'tissue' },
                        { id: 'item2', text: '輸導組織(維管束)', val: 'tissue' },
                        { id: 'item3', text: '血液', val: 'tissue' },
                        { id: 'item4', text: '葉子', val: 'organ' },
                        { id: 'item5', text: '根/莖/花/果實', val: 'organ' },
                        { id: 'item6', text: '心臟', val: 'organ' },
                        { id: 'item7', text: '胃', val: 'organ' }
                    ],
                    solution: {
                        zone1: ['tissue'],
                        zone2: ['organ']
                    }
                }
            ]
        };

        const themeColors = {
            '2-1': { primary: 'from-blue-500 to-cyan-600', header: 'from-blue-600 to-cyan-700', badge: 'bg-blue-500' },
            '2-2': { primary: 'from-green-500 to-emerald-600', header: 'from-green-600 to-emerald-700', badge: 'bg-green-500' },
            '2-3': { primary: 'from-amber-500 to-orange-600', header: 'from-amber-600 to-orange-700', badge: 'bg-amber-500' },
            '2-4': { primary: 'from-purple-500 to-pink-600', header: 'from-purple-600 to-pink-700', badge: 'bg-purple-500' }
        };

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        let touchDragData = null;
        let touchDragElement = null;
        let touchClone = null;
        let touchRemoveCallback = null;
        let touchSourceZoneId = null;
        let isDragging = false;

        function handleTouchStart(e, item, removeCallback) {
            e.preventDefault();
            e.stopPropagation();
            isDragging = true;
            touchDragData = item;
            touchDragElement = e.currentTarget;
            touchRemoveCallback = removeCallback;
            document.body.style.overflow = 'hidden';
            document.body.style.touchAction = 'none';
            const sourceZone = touchDragElement.closest('.drop-zone');
            touchSourceZoneId = sourceZone ? sourceZone.getAttribute('data-zone-id') : null;
            const touch = e.touches[0];
            touchClone = touchDragElement.cloneNode(true);
            touchClone.style.position = 'fixed';
            touchClone.style.zIndex = '10000';
            touchClone.style.opacity = '0.8';
            touchClone.style.pointerEvents = 'none';
            touchClone.style.width = touchDragElement.offsetWidth + 'px';
            touchClone.style.left = (touch.clientX - touchDragElement.offsetWidth / 2) + 'px';
            touchClone.style.top = (touch.clientY - touchDragElement.offsetHeight / 2) + 'px';
            document.body.appendChild(touchClone);
            touchDragElement.style.opacity = '0.2';
        }

        function handleTouchMove(e) {
            if (!touchClone || !isDragging) return;
            e.preventDefault();
            const touch = e.touches[0];
            touchClone.style.left = (touch.clientX - touchClone.offsetWidth / 2) + 'px';
            touchClone.style.top = (touch.clientY - touchClone.offsetHeight / 2) + 'px';
            const dropZones = document.querySelectorAll('.drop-zone');
            dropZones.forEach(zone => zone.classList.remove('drag-over'));
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            if (elementBelow) {
                const dropZone = elementBelow.closest('.drop-zone');
                if (dropZone) {
                    const targetZoneId = dropZone.getAttribute('data-zone-id');
                    if (targetZoneId !== touchSourceZoneId) {
                        dropZone.classList.add('drag-over');
                    }
                }
            }
        }

        function handleTouchEnd(e, dropCallback) {
            if (!touchClone) return;
            isDragging = false;
            const touch = e.changedTouches[0];
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            let targetZone = null;
            let targetZoneId = null;
            if (elementBelow) {
                targetZone = elementBelow.closest('.drop-zone');
                if (targetZone) {
                    targetZoneId = targetZone.getAttribute('data-zone-id');
                }
            }
            if (touchClone && touchClone.parentNode) {
                touchClone.parentNode.removeChild(touchClone);
            }
            document.body.style.overflow = '';
            document.body.style.touchAction = '';
            const dropZones = document.querySelectorAll('.drop-zone');
            dropZones.forEach(zone => zone.classList.remove('drag-over'));
            const isValidDrop = targetZone && targetZoneId && touchDragData && targetZoneId !== touchSourceZoneId;
            if (isValidDrop && dropCallback) {
                if (touchRemoveCallback) {
                    touchRemoveCallback();
                }
                dropCallback(touchDragData, targetZoneId);
            } else {
                if (touchDragElement) {
                    touchDragElement.style.opacity = '1';
                }
            }
            touchDragData = null;
            touchDragElement = null;
            touchClone = null;
            touchRemoveCallback = null;
            touchSourceZoneId = null;
        }

        if (typeof window !== 'undefined') {
            document.addEventListener('touchcancel', function(e) {
                if (isDragging) {
                    isDragging = false;
                    if (touchClone && touchClone.parentNode) {
                        touchClone.parentNode.removeChild(touchClone);
                    }
                    if (touchDragElement) {
                        touchDragElement.style.opacity = '1';
                    }
                    document.body.style.overflow = '';
                    document.body.style.touchAction = '';
                    touchClone = null;
                    touchDragData = null;
                    touchDragElement = null;
                    touchRemoveCallback = null;
                    touchSourceZoneId = null;
                }
            }, { passive: false });
        }

        function App() {
            const [screen, setScreen] = useState('section_select');
            const [currentSection, setCurrentSection] = useState(null);
            const [currentLevelIndex, setCurrentLevelIndex] = useState(0);
            const [gameState, setGameState] = useState('playing');
            const [droppedItems, setDroppedItems] = useState({});
            const [feedback, setFeedback] = useState({});
            const [startTime, setStartTime] = useState(null);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [score, setScore] = useState({ correct: 0, total: 0 });
            const [shuffledItems, setShuffledItems] = useState([]);
            const [shuffledZones, setShuffledZones] = useState([]);
            const [errorLog, setErrorLog] = useState([]);
            const [sectionCompletionStatus, setSectionCompletionStatus] = useState(() => {
                try {
                    const saved = localStorage.getItem('chapter2_completion_status');
                    return saved ? JSON.parse(saved) : {};
                } catch {
                    return {};
                }
            });
            const [fontScale, setFontScale] = useState(() => {
                try {
                    const saved = localStorage.getItem('chapter2_font_scale');
                    return saved ? parseFloat(saved) : 100;
                } catch {
                    return 100;
                }
            });

            useEffect(() => {
                document.documentElement.style.fontSize = `${fontScale}%`;
            }, [fontScale]);

            const increaseFontSize = () => {
                const newScale = Math.min(fontScale + 10, 150);
                setFontScale(newScale);
                localStorage.setItem('chapter2_font_scale', newScale.toString());
            };

            const decreaseFontSize = () => {
                const newScale = Math.max(fontScale - 10, 70);
                setFontScale(newScale);
                localStorage.setItem('chapter2_font_scale', newScale.toString());
            };

            useEffect(() => {
                let timer;
                if (gameState === 'playing' && startTime) {
                    timer = setInterval(() => {
                        setElapsedTime(Math.floor((new Date() - startTime) / 1000));
                    }, 1000);
                }
                return () => {
                    if (timer) clearInterval(timer);
                };
            }, [gameState, startTime]);

            const initializeLevel = (sectionId, levelIndex) => {
                const level = CHAPTER_DATA[sectionId][levelIndex];
                if (level.items) {
                    setShuffledItems(shuffleArray(level.items));
                }
                if (level.zones) {
                    setShuffledZones(shuffleArray(level.zones));
                }
            };

            const selectSection = (sectionId) => {
                setCurrentSection(sectionId);
                setCurrentLevelIndex(0);
                setScreen('playing');
                setGameState('playing');
                setStartTime(new Date());
                setElapsedTime(0);
                setDroppedItems({});
                setFeedback({});
                setScore({ correct: 0, total: 0 });
                setErrorLog([]);
                initializeLevel(sectionId, 0);
            };

            const handleDragStart = (e, item) => {
                e.dataTransfer.setData('item', JSON.stringify(item));
            };

            const handleDragOver = (e) => {
                e.preventDefault();
            };

            const handleDrop = (e, zoneId) => {
                e.preventDefault();
                const item = JSON.parse(e.dataTransfer.getData('item'));
                setDroppedItems(prev => ({
                    ...prev,
                    [zoneId]: [...(prev[zoneId] || []), item]
                }));
            };

            const handleTouchDrop = (item, zoneId) => {
                setDroppedItems(prev => ({
                    ...prev,
                    [zoneId]: [...(prev[zoneId] || []), item]
                }));
            };

            const removeItem = (zoneId, itemId) => {
                setDroppedItems(prev => ({
                    ...prev,
                    [zoneId]: prev[zoneId].filter(item => item.id !== itemId)
                }));
            };

            const checkAnswers = () => {
                const currentLevel = CHAPTER_DATA[currentSection][currentLevelIndex];
                const newFeedback = {};
                let correctCount = 0;
                let totalZones = Object.keys(currentLevel.solution).length;
                const wrongAnswers = [];

                Object.keys(currentLevel.solution).forEach(zoneId => {
                    const correctVals = currentLevel.solution[zoneId];
                    const droppedVals = (droppedItems[zoneId] || []).map(item => item.val);
                    const isCorrect = droppedVals.length > 0 && droppedVals.every(val => correctVals.includes(val));
                    newFeedback[zoneId] = isCorrect;
                    if (isCorrect) {
                        correctCount++;
                    } else {
                        const zone = currentLevel.zones.find(z => z.id === zoneId);
                        wrongAnswers.push({
                            zone: zone.title,
                            userAnswer: (droppedItems[zoneId] || []).map(item => item.text),
                            correctAnswer: currentLevel.items.filter(item => correctVals.includes(item.val)).map(item => item.text)
                        });
                    }
                });

                const allItemsPlaced = Object.values(droppedItems).flat().length === currentLevel.items.length;
                setFeedback(newFeedback);

                if (correctCount === totalZones && allItemsPlaced) {
                    setGameState('completed');
                    setScore(prev => ({ correct: prev.correct + 1, total: prev.total + 1 }));
                } else {
                    if (wrongAnswers.length > 0) {
                        setErrorLog(prev => [...prev, {
                            levelId: currentLevel.id,
                            levelTitle: currentLevel.title,
                            timestamp: new Date(),
                            errors: wrongAnswers
                        }]);
                    }
                    setScore(prev => ({ ...prev, total: prev.total + 1 }));
                }
            };

            const nextLevel = () => {
                if (currentLevelIndex < CHAPTER_DATA[currentSection].length - 1) {
                    const newIndex = currentLevelIndex + 1;
                    setCurrentLevelIndex(newIndex);
                    setGameState('playing');
                    setStartTime(new Date());
                    setElapsedTime(0);
                    setDroppedItems({});
                    setFeedback({});
                    initializeLevel(currentSection, newIndex);
                } else {
                    const newStatus = {
                        ...sectionCompletionStatus,
                        [currentSection]: {
                            completed: true,
                            completedAt: new Date().toISOString(),
                            attempts: score.total,
                            errors: score.total - score.correct,
                            errorLog: errorLog
                        }
                    };
                    setSectionCompletionStatus(newStatus);
                    localStorage.setItem('chapter2_completion_status', JSON.stringify(newStatus));
                    alert(`恭喜完成 ${currentSection}!`);
                    setScreen('section_select');
                }
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            const currentLevel = currentSection ? CHAPTER_DATA[currentSection][currentLevelIndex] : null;
            const colors = currentSection ? themeColors[currentSection] : themeColors['2-1'];

            if (screen === 'section_select') {
                const sections = [
                    { id: '2-1', title: '2-1 細胞的發現', icon: 'fa-microscope', levels: 2, color: 'from-blue-400 to-cyan-600' },
                    { id: '2-2', title: '2-2 細胞的構造', icon: 'fa-dna', levels: 2, color: 'from-green-400 to-emerald-600' },
                    { id: '2-3', title: '2-3 物質進出細胞', icon: 'fa-right-left', levels: 1, color: 'from-amber-400 to-orange-600' },
                    { id: '2-4', title: '2-4 組成層次', icon: 'fa-layer-group', levels: 2, color: 'from-purple-400 to-pink-600' }
                ];

                return (
                    <div className="min-h-screen flex items-center justify-center p-6">
                        <div className="fixed top-4 right-4 z-50 flex items-center gap-2 glass-effect rounded-xl p-2 shadow-xl">
                            <button onClick={decreaseFontSize} disabled={fontScale <= 70} className={`px-3 py-2 rounded-lg font-bold transition-all ${fontScale <= 70 ? 'bg-white/10 text-white/30 cursor-not-allowed' : 'bg-white/20 text-white hover:bg-white/30 hover:scale-110'}`}>
                                <span className="text-sm">A<sup className="text-xs">-</sup></span>
                            </button>
                            <button onClick={increaseFontSize} disabled={fontScale >= 150} className={`px-3 py-2 rounded-lg font-bold transition-all ${fontScale >= 150 ? 'bg-white/10 text-white/30 cursor-not-allowed' : 'bg-white/20 text-white hover:bg-white/30 hover:scale-110'}`}>
                                <span className="text-sm">A<sup className="text-xs">+</sup></span>
                            </button>
                        </div>
                        
                        <div className="max-w-6xl w-full">
                            <div className="text-center mb-12 fade-in">
                                <h1 className="text-5xl font-black text-white mb-4">
                                    <i className="fas fa-dna mr-4"></i>
                                    第2章 生物體的組成
                                </h1>
                                <p className="text-xl text-white/90 mb-4">選擇一個小節開始學習</p>
                                
                                {Object.keys(sectionCompletionStatus).length > 0 && (
                                    <button onClick={() => { if (confirm('確定要清除所有完成記錄嗎?')) { setSectionCompletionStatus({}); localStorage.removeItem('chapter2_completion_status'); alert('已清除!'); }}} className="bg-red-500/80 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all shadow-lg hover:scale-105">
                                        <i className="fas fa-trash-alt mr-2"></i>
                                        清除所有完成記錄
                                    </button>
                                )}
                            </div>

                            <div className="grid md:grid-cols-2 gap-6">
                                {sections.map((section, index) => {
                                    const isCompleted = sectionCompletionStatus[section.id]?.completed;
                                    return (
                                        <div key={section.id} className="glass-effect rounded-2xl p-8 hover:scale-105 transition-all duration-300 cursor-pointer fade-in relative" style={{ animationDelay: `${index * 0.1}s` }} onClick={() => selectSection(section.id)}>
                                            {isCompleted && (
                                                <div className="absolute top-4 right-4 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center gap-1 shadow-lg">
                                                    <i className="fas fa-check-circle"></i>
                                                    已完成
                                                </div>
                                            )}
                                            <div className={`w-20 h-20 bg-gradient-to-br ${section.color} rounded-2xl flex items-center justify-center mb-6 mx-auto`}>
                                                <i className={`${section.icon} text-4xl text-white`}></i>
                                            </div>
                                            <h2 className="text-2xl font-bold text-white text-center mb-3">{section.title}</h2>
                                            <p className="text-white/80 text-center mb-2">共 {section.levels} 個關卡</p>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            }

            if (screen === 'playing' && currentLevel) {
                const placedItemIds = Object.values(droppedItems).flat().map(item => item.id);
                const availableItems = shuffledItems.filter(item => !placedItemIds.includes(item.id));
                const totalItems = currentLevel.items.length;
                const placedItems = Object.values(droppedItems).flat().length;
                const allPlaced = placedItems === totalItems;

                return (
                    <div className="h-screen flex flex-col overflow-hidden">
                        <div className={`flex-shrink-0 bg-gradient-to-r ${colors.header} p-3 text-white shadow-xl`}>
                            <div className="flex items-center justify-between mb-2">
                                <div className="flex items-center gap-2">
                                    <div className="flex items-center gap-1 bg-black/20 rounded-lg p-1">
                                        <button onClick={decreaseFontSize} disabled={fontScale <= 70} className={`px-2 py-1 rounded text-xs font-bold ${fontScale <= 70 ? 'text-white/30' : 'text-white hover:bg-white/20'}`}>A<sup>-</sup></button>
                                        <button onClick={increaseFontSize} disabled={fontScale >= 150} className={`px-2 py-1 rounded text-xs font-bold ${fontScale >= 150 ? 'text-white/30' : 'text-white hover:bg-white/20'}`}>A<sup>+</sup></button>
                                    </div>
                                    <h2 className="text-base font-bold">{currentLevel.title}</h2>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className="text-xs">⏱️ {formatTime(elapsedTime)}</span>
                                    <button onClick={() => setScreen('section_select')} className="bg-white/20 hover:bg-white/30 px-2 py-1 rounded text-xs">
                                        <i className="fas fa-home"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4">
                            <div className="grid lg:grid-cols-3 gap-3 max-w-6xl mx-auto">
                                <div className="lg:col-span-1">
                                    <div className="glass-effect rounded-lg p-3">
                                        <h3 className="text-sm font-bold text-white mb-2">待分類項目</h3>
                                        <div className="flex flex-wrap gap-2 justify-center">
                                            {availableItems.map(item => (
                                                <div key={item.id} draggable onDragStart={(e) => handleDragStart(e, item)} onTouchStart={(e) => handleTouchStart(e, item, null)} onTouchMove={handleTouchMove} onTouchEnd={(e) => handleTouchEnd(e, handleTouchDrop)} className="drag-item bg-white rounded-lg p-2 shadow-lg w-[calc(50%-0.25rem)] sm:w-[calc(33.333%-0.375rem)]">
                                                    <p className="text-gray-800 font-medium text-center text-sm leading-tight">{item.text}</p>
                                                </div>
                                            ))}
                                            {availableItems.length === 0 && <div className="text-center text-white/70 py-3 text-xs w-full">所有項目都已分類</div>}
                                        </div>
                                    </div>
                                </div>

                                <div className="lg:col-span-2">
                                    <div className="grid gap-2 mb-3">
                                        {shuffledZones.map(zone => (
                                            <div key={zone.id} data-zone-id={zone.id} onDragOver={handleDragOver} onDrop={(e) => handleDrop(e, zone.id)} className={`drop-zone glass-effect rounded-lg p-3 ${feedback[zone.id] === true ? 'correct-answer' : ''} ${feedback[zone.id] === false ? 'wrong-answer' : ''} ${!feedback[zone.id] ? 'border-2 border-white/30' : ''}`}>
                                                <h4 className="text-sm font-bold text-white mb-2 flex items-center">
                                                    <i className={`${zone.icon} mr-1`}></i>
                                                    <span className="flex-1">{zone.title}</span>
                                                    {feedback[zone.id] === true && <i className="fas fa-check-circle text-green-400"></i>}
                                                    {feedback[zone.id] === false && <i className="fas fa-times-circle text-red-400"></i>}
                                                </h4>
                                                <div className="grid grid-cols-2 gap-2">
                                                    {(droppedItems[zone.id] || []).map(item => (
                                                        <div key={item.id} draggable onDragStart={(e) => { handleDragStart(e, item); setTimeout(() => removeItem(zone.id, item.id), 0); }} onTouchStart={(e) => handleTouchStart(e, item, () => removeItem(zone.id, item.id))} onTouchMove={handleTouchMove} onTouchEnd={(e) => handleTouchEnd(e, handleTouchDrop)} className="bg-white rounded-lg p-2 shadow group relative cursor-move">
                                                            <p className="text-gray-800 font-medium text-xs text-center pr-5">{item.text}</p>
                                                            <button onClick={() => removeItem(zone.id, item.id)} className="absolute top-1 right-1 w-4 h-4 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 text-xs flex items-center justify-center">×</button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>

                                    <div className="flex gap-2">
                                        {gameState === 'playing' && (
                                            <button onClick={checkAnswers} className={`flex-1 py-3 rounded-lg font-bold text-sm transition-all shadow-xl ${allPlaced ? 'bg-gradient-to-r from-green-500 to-emerald-600 text-white hover:scale-105' : 'bg-gray-400 text-gray-200 cursor-not-allowed'}`} disabled={!allPlaced}>
                                                <i className="fas fa-check mr-1"></i>
                                                {allPlaced ? '檢查答案' : `尚未完成 (${placedItems}/${totalItems})`}
                                            </button>
                                        )}
                                        {gameState === 'completed' && (
                                            <button onClick={nextLevel} className="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-bold text-sm hover:scale-105 transition-all shadow-xl">
                                                <i className="fas fa-arrow-right mr-1"></i>
                                                {currentLevelIndex < CHAPTER_DATA[currentSection].length - 1 ? '下一關' : '完成本節'}
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
