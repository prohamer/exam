<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>È°èËâ≤Â≠óÂà§Êñ∑ - ‰∫íÂãïÂºèÂ≠∏ÁøíÈÅäÊà≤</title>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor: default;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overscroll-behavior: none;
            overflow-x: hidden;
        }

        button, a, .clickable {
            cursor: pointer !important;
        }

        .drag-item {
            transition: all 0.2s ease;
            cursor: grab !important;
            touch-action: none;
            -webkit-touch-callout: none;
        }

        .drag-item:active {
            cursor: grabbing !important;
        }

        @media (hover: hover) {
            .drag-item:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            }
        }

        .dragging {
            opacity: 0.5;
            transform: scale(1.05);
            z-index: 1000;
            position: fixed;
            pointer-events: none;
        }

        .cursor-move {
            cursor: move !important;
            touch-action: none;
            -webkit-touch-callout: none;
        }

        .cursor-move:active {
            cursor: grabbing !important;
        }

        .drop-zone {
            transition: all 0.2s ease;
            min-height: 80px;
        }

        .drop-zone.drag-over {
            background: rgba(59, 130, 246, 0.2);
            border: 3px dashed #3b82f6 !important;
            transform: scale(1.02);
        }

        .correct-answer {
            animation: correctPulse 0.6s ease-out;
            border: 3px solid #10b981 !important;
            background: rgba(16, 185, 129, 0.1);
        }

        .wrong-answer {
            animation: shake 0.5s ease-out;
            border: 3px solid #ef4444 !important;
            background: rgba(239, 68, 68, 0.1);
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* È°èËâ≤Ê°ÜÂ∫ïËâ≤ */
        .color-red { background: rgba(248, 113, 113, 0.2); }
        .color-yellow { background: rgba(250, 204, 21, 0.2); }
        .color-black { background: rgba(107, 114, 128, 0.2); }
        .color-white { background: rgba(243, 244, 246, 0.3); }
        .color-green { background: rgba(134, 239, 172, 0.2); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ===========================================
        // Ë©ûË™ûË©ûÂ∫´ÔºàÂÖ±31ÂÄãË©ûÔºâ
        // ===========================================
        const ALL_WORDS = [
            // Á¨¨1ÈóúÂéüÂßãË©ûË™ûÔºà15ÂÄãÔºâ- ÊãøÊéâ„ÄåÁ∂†Ëëâ„Äç
            { id: 'r1', text: '„ÄåÁ∑ã„ÄçÈõ≤', val: 'red' },
            { id: 'r2', text: '„Äå‰∏π„ÄçÊ•ì', val: 'red' },
            { id: 'r3', text: '„ÄåÊú±„ÄçÁ†Ç', val: 'red' },
            { id: 'r4', text: '„ÄåËµ§„ÄçË™†', val: 'red' },
            { id: 'y1', text: '„ÄåÈªÉ„ÄçÂúü', val: 'yellow' },
            { id: 'b1', text: '„ÄåÁéÑ„ÄçÈêµ', val: 'black' },
            { id: 'b2', text: '„ÄåÁÉè„ÄçÈõ≤', val: 'black' },
            { id: 'b3', text: '„ÄåÂ¢®„ÄçÊ±Å', val: 'black' },
            { id: 'w1', text: '„ÄåÁ¥†„ÄçÂ∏≥', val: 'white' },
            { id: 'w2', text: '„ÄåÁöé„ÄçÊúà', val: 'white' },
            { id: 'w3', text: '„ÄåÈ∂¥„ÄçÈ´Æ', val: 'white' },
            { id: 'w4', text: '„ÄåÈäÄ„ÄçÊ≤≥', val: 'white' },
            { id: 'g1', text: '„ÄåÁ¢ß„ÄçÁéâ', val: 'green' },
            { id: 'g2', text: '„ÄåÁø†„ÄçÁ´π', val: 'green' },
            { id: 'g3', text: '„ÄåËíº„ÄçÊùæ', val: 'green' },
            // Á¨¨2ÈóúÂéüÂßãË©ûË™ûÔºà16ÂÄãÔºâ
            { id: 'r5', text: '„ÄåÂΩ§„ÄçÈõ≤', val: 'red' },
            { id: 'r6', text: '„ÄåÁµ≥„ÄçËÑ£', val: 'red' },
            { id: 'r7', text: '„ÄåËµ≠„ÄçÂúü', val: 'red' },
            { id: 'r8', text: '„ÄåÊÆ∑„ÄçË°Ä', val: 'red' },
            { id: 'r9', text: '„ÄåÁø°„ÄçÁø†', val: 'red' },
            { id: 'y2', text: '„ÄåÈáë„ÄçÊ¶ú', val: 'yellow' },
            { id: 'b4', text: '„ÄåÈªù„ÄçÊöóËôï', val: 'black' },
            { id: 'b5', text: '„ÄåÈªØ„ÄçÊ∑°ÂÖâ', val: 'black' },
            { id: 'b6', text: '„ÄåÁöÇ„ÄçË°£', val: 'black' },
            { id: 'w5', text: '„ÄåÁöö„ÄçÈõ™', val: 'white' },
            { id: 'w6', text: '„ÄåÁ∏û„ÄçË°£', val: 'white' },
            { id: 'w7', text: '„ÄåÈúú„ÄçÈ¨¢', val: 'white' },
            { id: 'g4', text: '„ÄåËíº„ÄçÁø†', val: 'green' },
            { id: 'g5', text: '„ÄåÁ¢ß„ÄçËçâ', val: 'green' },
            { id: 'g6', text: '„ÄåÊªÑ„ÄçÊµ∑', val: 'green' }
        ];

        // Fisher-Yates Èö®Ê©üÊâì‰∫ÇÊºîÁÆóÊ≥ï
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // È†ÅÈù¢ËºâÂÖ•ÊôÇÈö®Ê©üÂàÜÈÖçË©ûË™ûÂà∞ÂÖ©Èóú
        const shuffledWords = shuffleArray(ALL_WORDS);
        const level1Words = shuffledWords.slice(0, 16);  // Ââç16ÂÄãÁµ¶Á¨¨1Èóú
        const level2Words = shuffledWords.slice(16, 31); // Âæå15ÂÄãÁµ¶Á¨¨2Èóú

        // ===========================================
        // ÈÅäÊà≤Ë≥áÊñô
        // ===========================================
        const GAME_DATA = {
            "theme1-level1": {
                id: "theme1-level1",
                theme: 1,
                title: "È°èËâ≤Âà•Á®±ÂàÜÈ°û - Á¨¨1Èóú",
                description: "Ë´ãÂ∞á‰ª•‰∏ãÈ°èËâ≤Ë©ûË™ûÊãñÊõ≥Âà∞Ê≠£Á¢∫ÁöÑÈ°èËâ≤ÂàÜÈ°ûÊ°ÜÔºàÊú¨Ê¨°Èö®Ê©üÂàÜÈÖçÔºö16ÂÄãË©ûÔºâ",
                zones: [
                    { id: 'red', title: 'üî¥ Á¥ÖËâ≤', color: 'color-red' },
                    { id: 'yellow', title: 'üü° ÈªÉËâ≤', color: 'color-yellow' },
                    { id: 'black', title: '‚ö´ ÈªëËâ≤', color: 'color-black' },
                    { id: 'white', title: '‚ö™ ÁôΩËâ≤', color: 'color-white' },
                    { id: 'green', title: 'üü¢ Á∂†Ëâ≤', color: 'color-green' }
                ],
                items: level1Words,
                solution: {
                    red: ['red'],
                    yellow: ['yellow'],
                    black: ['black'],
                    white: ['white'],
                    green: ['green']
                }
            },
            "theme1-level2": {
                id: "theme1-level2",
                theme: 1,
                title: "È°èËâ≤Âà•Á®±ÂàÜÈ°û - Á¨¨2Èóú",
                description: "Ë´ãÂ∞á‰ª•‰∏ãÈ°èËâ≤Ë©ûË™ûÊãñÊõ≥Âà∞Ê≠£Á¢∫ÁöÑÈ°èËâ≤ÂàÜÈ°ûÊ°ÜÔºàÊú¨Ê¨°Èö®Ê©üÂàÜÈÖçÔºö15ÂÄãË©ûÔºâ",
                zones: [
                    { id: 'red', title: 'üî¥ Á¥ÖËâ≤', color: 'color-red' },
                    { id: 'yellow', title: 'üü° ÈªÉËâ≤', color: 'color-yellow' },
                    { id: 'black', title: '‚ö´ ÈªëËâ≤', color: 'color-black' },
                    { id: 'white', title: '‚ö™ ÁôΩËâ≤', color: 'color-white' },
                    { id: 'green', title: 'üü¢ Á∂†Ëâ≤', color: 'color-green' }
                ],
                items: level2Words,
                solution: {
                    red: ['red'],
                    yellow: ['yellow'],
                    black: ['black'],
                    white: ['white'],
                    green: ['green']
                }
            },
            "theme2-level1": {
                id: "theme2-level1",
                theme: 2,
                title: "Ë©ûË™ûÊÑèÁæ©ÈÖçÂ∞ç - Á¨¨1ÈóúÔºàÂü∫Á§éÔºâ",
                description: "Ë´ãÂ∞áÂê´È°èËâ≤Â≠óÁöÑË©ûË™ûÊãñÊõ≥Âà∞Ê≠£Á¢∫ÁöÑÊÑèÁæ©Ëß£ÈáãÊ°Ü",
                isMatching: true,
                zones: [
                    { id: 'profit', title: 'Âà©ÊΩ§', category: 'red' },
                    { id: 'embarrass', title: 'Â∞∑Â∞¨', category: 'red' },
                    { id: 'malnutrition', title: 'ÁáüÈ§ä‰∏çËâØ', category: 'yellow' },
                    { id: 'golden', title: 'ÁæéÂ•ΩÊôÇÊúü', category: 'yellow' },
                    { id: 'clear', title: 'Ê∏ÖÊ•ö', category: 'black' },
                    { id: 'evil', title: 'Â•∏Ë©ê', category: 'black' },
                    { id: 'fromscratch', title: 'ÂæûÈõ∂ÈñãÂßã', category: 'white' },
                    { id: 'evidence', title: 'Ë≠âÊìö', category: 'white' },
                    { id: 'surpass', title: 'Ë∂ÖË∂ä', category: 'green' },
                    { id: 'childhood', title: 'Áé©‰º¥', category: 'green' },
                    { id: 'shortage', title: 'Áü≠Áº∫', category: 'green' },
                    { id: 'pale', title: 'ÁÑ°Ë°ÄËâ≤', category: 'green' }
                ],
                items: [
                    { id: 'item1', text: 'Âπ¥ÁµÇÂàÜ„ÄåÁ¥Ö„Äç', val: 'profit' },
                    { id: 'item2', text: 'Èù¢„ÄåÁ¥Ö„ÄçËÄ≥Ëµ§', val: 'embarrass' },
                    { id: 'item3', text: 'Èù¢„ÄåÈªÉ„ÄçËÇåÁò¶', val: 'malnutrition' },
                    { id: 'item4', text: '„ÄåÈªÉ„ÄçÈáëÊôÇ‰ª£', val: 'golden' },
                    { id: 'item5', text: '„ÄåÈªë„ÄçÁôΩÂàÜÊòé', val: 'clear' },
                    { id: 'item6', text: '„ÄåÈªë„ÄçÂøÉÂïÜ‰∫∫', val: 'evil' },
                    { id: 'item7', text: '„ÄåÁôΩ„ÄçÊâãËµ∑ÂÆ∂', val: 'fromscratch' },
                    { id: 'item8', text: '„ÄåÁôΩ„ÄçÁ¥ôÈªëÂ≠ó', val: 'evidence' },
                    { id: 'item9', text: '„ÄåÈùí„ÄçÂá∫ÊñºËóç', val: 'surpass' },
                    { id: 'item10', text: '„ÄåÈùí„ÄçÊ¢ÖÁ´πÈ¶¨', val: 'childhood' },
                    { id: 'item11', text: '„ÄåÈùí„ÄçÈªÉ‰∏çÊé•', val: 'shortage' },
                    { id: 'item12', text: '„ÄåËíº„ÄçÁôΩ', val: 'pale' }
                ],
                solution: {}
            },
            "theme2-level2": {
                id: "theme2-level2",
                theme: 2,
                title: "Ë©ûË™ûÊÑèÁæ©ÈÖçÂ∞ç - Á¨¨2ÈóúÔºàÈÄ≤ÈöéÔºâ",
                description: "Ë´ãÂ∞áÂê´È°èËâ≤Â≠óÁöÑË©ûË™ûÊãñÊõ≥Âà∞Ê≠£Á¢∫ÁöÑÊÑèÁæ©Ëß£ÈáãÊ°Ü",
                isMatching: true,
                zones: [
                    { id: 'beauty', title: 'ÁæéÂ•≥', category: 'red' },
                    { id: 'celebrate', title: 'ÂñúÊÖ∂', category: 'red' },
                    { id: 'erotic', title: 'ÊÉÖËâ≤', category: 'yellow' },
                    { id: 'goodday', title: 'ËâØËæ∞', category: 'yellow' },
                    { id: 'confuse', title: 'Ê∑∑Ê∑Ü', category: 'black' },
                    { id: 'ban', title: 'Á¶ÅÊ≠¢', category: 'black' },
                    { id: 'daydream', title: 'ÂπªÊÉ≥', category: 'white' },
                    { id: 'futile', title: 'ÂæíÂãû', category: 'white' },
                    { id: 'unfaithful', title: '‰∏çÂø†', category: 'green' },
                    { id: 'loyal', title: 'Âø†Ë™†', category: 'green' },
                    { id: 'blueprint', title: 'Ë¶èÂäÉ', category: 'green' },
                    { id: 'favor', title: 'ÁúãÈáç', category: 'green' }
                ],
                items: [
                    { id: 'item1', text: '„ÄåÁ¥Ö„ÄçÈ°èËñÑÂëΩ', val: 'beauty' },
                    { id: 'item2', text: 'Êä´„ÄåÁ¥Ö„ÄçÊéõÂΩ©', val: 'celebrate' },
                    { id: 'item3', text: '„ÄåÈªÉ„ÄçËâ≤Á¨ëË©±', val: 'erotic' },
                    { id: 'item4', text: '„ÄåÈªÉ„ÄçÈÅìÂêâÊó•', val: 'goodday' },
                    { id: 'item5', text: '„ÄåÈªë„ÄçÁôΩÈ°õÂÄí', val: 'confuse' },
                    { id: 'item6', text: '„ÄåÈªë„ÄçÂêçÂñÆ', val: 'ban' },
                    { id: 'item7', text: '„ÄåÁôΩ„ÄçÊó•Â§¢', val: 'daydream' },
                    { id: 'item8', text: '„ÄåÁôΩ„ÄçË≤ªÂøÉÊ©ü', val: 'futile' },
                    { id: 'item9', text: '„ÄåÁ∂†„ÄçÂ∏ΩÂ≠ê', val: 'unfaithful' },
                    { id: 'item10', text: '„ÄåÁ¢ß„ÄçË°Ä‰∏πÂøÉ', val: 'loyal' },
                    { id: 'item11', text: '„ÄåËóç„ÄçÂúñ', val: 'blueprint' },
                    { id: 'item12', text: '„ÄåÈùí„ÄçÁùû', val: 'favor' }
                ],
                solution: {}
            },
            "theme2-level3": {
                id: "theme2-level3",
                theme: 2,
                title: "Ë©ûË™ûÊÑèÁæ©ÈÖçÂ∞ç - Á¨¨3ÈóúÔºàÊåëÊà∞Ôºâ",
                description: "Ë´ãÂ∞áÂê´È°èËâ≤Â≠óÁöÑË©ûË™ûÊãñÊõ≥Âà∞Ê≠£Á¢∫ÁöÑÊÑèÁæ©Ëß£ÈáãÊ°Ü",
                isMatching: true,
                zones: [
                    { id: 'redlight', title: 'Ëâ≤ÊÉÖÂ†¥ÊâÄ', category: 'red' },
                    { id: 'lucky', title: 'ÂêâÂà©', category: 'red' },
                    { id: 'dream', title: 'ËôõÂπª', category: 'yellow' },
                    { id: 'emperor', title: 'Á®±Â∏ù', category: 'yellow' },
                    { id: 'threat', title: 'Â®ÅËÑÖ‰ø°', category: 'black' },
                    { id: 'darkhorse', title: 'Âá∫‰∫∫ÊÑèÊñô', category: 'black' },
                    { id: 'despise', title: 'ËºïË¶ñ', category: 'white' },
                    { id: 'funeral', title: 'Âñ™‰∫ã', category: 'white' },
                    { id: 'history', title: 'ÊµÅËä≥', category: 'green' },
                    { id: 'despair', title: 'Â§±Êúõ', category: 'gray' },
                    { id: 'mob', title: 'Ê∑∑‰∫Ç', category: 'gray' },
                    { id: 'grayarea', title: 'Ê®°Á≥ä', category: 'gray' }
                ],
                items: [
                    { id: 'item1', text: '„ÄåÁ¥Ö„ÄçÁáàÂçÄ', val: 'redlight' },
                    { id: 'item2', text: 'ÈñãÈñÄ„ÄåÁ¥Ö„Äç', val: 'lucky' },
                    { id: 'item3', text: '„ÄåÈªÉ„ÄçÁ≤±‰∏ÄÂ§¢', val: 'dream' },
                    { id: 'item4', text: '„ÄåÈªÉ„ÄçË¢çÂä†Ë∫´', val: 'emperor' },
                    { id: 'item5', text: '„ÄåÈªë„ÄçÂáΩ', val: 'threat' },
                    { id: 'item6', text: '„ÄåÈªë„ÄçÈ¶¨', val: 'darkhorse' },
                    { id: 'item7', text: '„ÄåÁôΩ„ÄçÁúº', val: 'despise' },
                    { id: 'item8', text: '„ÄåÁôΩ„Äç‰∫ã', val: 'funeral' },
                    { id: 'item9', text: '„ÄåÈùí„ÄçÂè≤ÁïôÂêç', val: 'history' },
                    { id: 'item10', text: '„ÄåÁÅ∞„ÄçÂøÉÂñ™Âøó', val: 'despair' },
                    { id: 'item11', text: '„ÄåÁÉè„ÄçÂêà‰πãÁúæ', val: 'mob' },
                    { id: 'item12', text: '„ÄåÁÅ∞„ÄçËâ≤Âú∞Â∏∂', val: 'grayarea' }
                ],
                solution: {}
            }
        };

        // ÁÇ∫ÊâÄÊúâ theme2 ÈóúÂç°ÂãïÊÖãÁîüÊàê solution
        ['theme2-level1', 'theme2-level2', 'theme2-level3'].forEach(levelId => {
            GAME_DATA[levelId].zones.forEach(zone => {
                GAME_DATA[levelId].solution[zone.id] = [zone.id];
            });
        });

        // Ëß∏ÊéßÊãñÊõ≥ÊîØÊè¥
        let touchDragData = null;
        let touchDragElement = null;
        let touchClone = null;
        let touchRemoveCallback = null;
        let touchSourceZoneId = null;
        let isDragging = false;

        function handleTouchStart(e, item, removeCallback) {
            e.preventDefault();
            e.stopPropagation();
            
            isDragging = true;
            touchDragData = item;
            touchDragElement = e.currentTarget;
            touchRemoveCallback = removeCallback;
            
            document.body.style.overflow = 'hidden';
            document.body.style.touchAction = 'none';
            document.body.style.userSelect = 'none';
            document.body.style.webkitUserSelect = 'none';
            
            const sourceZone = touchDragElement.closest('.drop-zone');
            touchSourceZoneId = sourceZone ? sourceZone.getAttribute('data-zone-id') : null;
            
            const touch = e.touches[0];
            
            touchClone = touchDragElement.cloneNode(true);
            touchClone.style.position = 'fixed';
            touchClone.style.zIndex = '10000';
            touchClone.style.opacity = '0.8';
            touchClone.style.pointerEvents = 'none';
            touchClone.style.width = touchDragElement.offsetWidth + 'px';
            touchClone.style.left = (touch.clientX - touchDragElement.offsetWidth / 2) + 'px';
            touchClone.style.top = (touch.clientY - touchDragElement.offsetHeight / 2) + 'px';
            touchClone.style.transition = 'none';
            touchClone.style.touchAction = 'none';
            document.body.appendChild(touchClone);
            
            touchDragElement.style.opacity = '0.2';
            touchDragElement.style.transform = 'scale(0.95)';
            touchDragElement.style.transition = 'opacity 0.2s, transform 0.2s';
        }

        function handleTouchMove(e) {
            if (!touchClone || !isDragging) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const touch = e.touches[0];
            
            touchClone.style.left = (touch.clientX - touchClone.offsetWidth / 2) + 'px';
            touchClone.style.top = (touch.clientY - touchClone.offsetHeight / 2) + 'px';
            
            const dropZones = document.querySelectorAll('.drop-zone');
            dropZones.forEach(zone => zone.classList.remove('drag-over'));
            
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            if (elementBelow) {
                const dropZone = elementBelow.closest('.drop-zone');
                if (dropZone) {
                    const targetZoneId = dropZone.getAttribute('data-zone-id');
                    if (targetZoneId !== touchSourceZoneId) {
                        dropZone.classList.add('drag-over');
                    }
                }
            }
        }

        function handleTouchEnd(e, dropCallback) {
            if (!touchClone) return;
            
            isDragging = false;
            
            const touch = e.changedTouches[0];
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            
            let targetZone = null;
            let targetZoneId = null;
            if (elementBelow) {
                targetZone = elementBelow.closest('.drop-zone');
                if (targetZone) {
                    targetZoneId = targetZone.getAttribute('data-zone-id');
                }
            }
            
            if (touchClone && touchClone.parentNode) {
                touchClone.parentNode.removeChild(touchClone);
            }
            
            document.body.style.overflow = '';
            document.body.style.touchAction = '';
            document.body.style.userSelect = '';
            document.body.style.webkitUserSelect = '';
            
            const dropZones = document.querySelectorAll('.drop-zone');
            dropZones.forEach(zone => zone.classList.remove('drag-over'));
            
            const isValidDrop = targetZone && targetZoneId && touchDragData && 
                              targetZoneId !== touchSourceZoneId;
            
            if (isValidDrop && dropCallback) {
                if (touchRemoveCallback) {
                    touchRemoveCallback();
                }
                dropCallback(touchDragData, targetZoneId);
            } else {
                if (touchDragElement) {
                    touchDragElement.style.opacity = '1';
                    touchDragElement.style.transform = 'scale(1)';
                }
            }
            
            touchDragData = null;
            touchDragElement = null;
            touchClone = null;
            touchRemoveCallback = null;
            touchSourceZoneId = null;
        }

        if (typeof window !== 'undefined') {
            document.addEventListener('touchcancel', function(e) {
                if (isDragging) {
                    isDragging = false;
                    if (touchClone && touchClone.parentNode) {
                        touchClone.parentNode.removeChild(touchClone);
                    }
                    if (touchDragElement) {
                        touchDragElement.style.opacity = '1';
                        touchDragElement.style.transform = 'scale(1)';
                    }
                    document.body.style.overflow = '';
                    document.body.style.touchAction = '';
                    document.body.style.userSelect = '';
                    document.body.style.webkitUserSelect = '';
                    touchClone = null;
                    touchDragData = null;
                    touchDragElement = null;
                    touchRemoveCallback = null;
                    touchSourceZoneId = null;
                }
            }, { passive: false });
        }

        // ===========================================
        // ‰∏ªÊáâÁî®Á®ãÂºè
        // ===========================================
        function App() {
            const [screen, setScreen] = useState('level_select');
            const [currentLevelId, setCurrentLevelId] = useState(null);
            const [gameState, setGameState] = useState('playing');
            const [droppedItems, setDroppedItems] = useState({});
            const [feedback, setFeedback] = useState({});
            const [startTime, setStartTime] = useState(null);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [score, setScore] = useState({ correct: 0, total: 0 });
            const [shuffledItems, setShuffledItems] = useState([]);
            const [completionStatus, setCompletionStatus] = useState(() => {
                try {
                    const saved = localStorage.getItem('color_words_completion');
                    return saved ? JSON.parse(saved) : {};
                } catch {
                    return {};
                }
            });
            const [fontScale, setFontScale] = useState(() => {
                try {
                    const saved = localStorage.getItem('color_words_font_scale');
                    return saved ? parseFloat(saved) : 100;
                } catch {
                    return 100;
                }
            });

            useEffect(() => {
                document.documentElement.style.fontSize = `${fontScale}%`;
            }, [fontScale]);

            const increaseFontSize = () => {
                const newScale = Math.min(fontScale + 10, 150);
                setFontScale(newScale);
                localStorage.setItem('color_words_font_scale', newScale.toString());
            };

            const decreaseFontSize = () => {
                const newScale = Math.max(fontScale - 10, 70);
                setFontScale(newScale);
                localStorage.setItem('color_words_font_scale', newScale.toString());
            };

            useEffect(() => {
                let timer;
                if (gameState === 'playing' && startTime) {
                    timer = setInterval(() => {
                        setElapsedTime(Math.floor((new Date() - startTime) / 1000));
                    }, 1000);
                }
                return () => {
                    if (timer) clearInterval(timer);
                };
            }, [gameState, startTime]);

            const initializeLevel = (levelId) => {
                const level = GAME_DATA[levelId];
                setShuffledItems(shuffleArray(level.items));
            };

            const selectLevel = (levelId) => {
                setCurrentLevelId(levelId);
                setScreen('playing');
                setGameState('playing');
                setStartTime(new Date());
                setElapsedTime(0);
                setDroppedItems({});
                setFeedback({});
                setScore({ correct: 0, total: 0 });
                initializeLevel(levelId);
            };

            const handleDragStart = (e, item) => {
                e.dataTransfer.setData('item', JSON.stringify(item));
            };

            const handleDragOver = (e) => {
                e.preventDefault();
            };

            const handleDrop = (e, zoneId) => {
                e.preventDefault();
                const item = JSON.parse(e.dataTransfer.getData('item'));
                
                setDroppedItems(prev => ({
                    ...prev,
                    [zoneId]: [...(prev[zoneId] || []), item]
                }));
            };

            const handleTouchDrop = (item, zoneId) => {
                setDroppedItems(prev => ({
                    ...prev,
                    [zoneId]: [...(prev[zoneId] || []), item]
                }));
            };

            const removeItem = (zoneId, itemId) => {
                setDroppedItems(prev => ({
                    ...prev,
                    [zoneId]: prev[zoneId].filter(item => item.id !== itemId)
                }));
            };

            const checkAnswers = () => {
                const currentLevel = GAME_DATA[currentLevelId];
                const newFeedback = {};
                let correctCount = 0;
                let totalZones = Object.keys(currentLevel.solution).length;

                Object.keys(currentLevel.solution).forEach(zoneId => {
                    const correctVals = currentLevel.solution[zoneId];
                    const droppedVals = (droppedItems[zoneId] || []).map(item => item.val);
                    
                    const isCorrect = droppedVals.length > 0 &&
                                    droppedVals.every(val => correctVals.includes(val));
                    
                    newFeedback[zoneId] = isCorrect;
                    if (isCorrect) {
                        correctCount++;
                    }
                });

                const allItemsPlaced = Object.values(droppedItems).flat().length === currentLevel.items.length;

                setFeedback(newFeedback);

                if (correctCount === totalZones && allItemsPlaced) {
                    setGameState('completed');
                    setScore(prev => ({ 
                        correct: prev.correct + 1, 
                        total: prev.total + 1 
                    }));
                    
                    const newStatus = {
                        ...completionStatus,
                        [currentLevelId]: {
                            completed: true,
                            completedAt: new Date().toISOString(),
                            time: elapsedTime,
                            attempts: score.total + 1
                        }
                    };
                    setCompletionStatus(newStatus);
                    localStorage.setItem('color_words_completion', JSON.stringify(newStatus));
                } else {
                    setScore(prev => ({ 
                        ...prev, 
                        total: prev.total + 1 
                    }));
                }
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            const currentLevel = currentLevelId ? GAME_DATA[currentLevelId] : null;
            const availableItems = currentLevel ? 
                shuffledItems.filter(item => {
                    const placedItemIds = Object.values(droppedItems).flat().map(i => i.id);
                    return !placedItemIds.includes(item.id);
                }) : [];

            // ===========================================
            // ÈóúÂç°ÈÅ∏ÊìáÁï´Èù¢
            // ===========================================
            if (screen === 'level_select') {
                const levels = [
                    { 
                        id: 'theme1-level1', 
                        title: '‰∏ªÈ°å1-Á¨¨1Èóú', 
                        subtitle: 'È°èËâ≤Âà•Á®±ÂàÜÈ°û',
                        icon: 'fa-palette',
                        color: 'from-pink-400 to-rose-600' 
                    },
                    { 
                        id: 'theme1-level2', 
                        title: '‰∏ªÈ°å1-Á¨¨2Èóú', 
                        subtitle: 'È°èËâ≤Âà•Á®±ÂàÜÈ°û',
                        icon: 'fa-palette',
                        color: 'from-purple-400 to-indigo-600' 
                    },
                    { 
                        id: 'theme2-level1', 
                        title: '‰∏ªÈ°å2-Á¨¨1Èóú', 
                        subtitle: 'Ë©ûË™ûÊÑèÁæ©ÈÖçÂ∞çÔºàÂü∫Á§éÔºâ',
                        icon: 'fa-link',
                        color: 'from-blue-400 to-cyan-600' 
                    },
                    { 
                        id: 'theme2-level2', 
                        title: '‰∏ªÈ°å2-Á¨¨2Èóú', 
                        subtitle: 'Ë©ûË™ûÊÑèÁæ©ÈÖçÂ∞çÔºàÈÄ≤ÈöéÔºâ',
                        icon: 'fa-link',
                        color: 'from-teal-400 to-green-600' 
                    },
                    { 
                        id: 'theme2-level3', 
                        title: '‰∏ªÈ°å2-Á¨¨3Èóú', 
                        subtitle: 'Ë©ûË™ûÊÑèÁæ©ÈÖçÂ∞çÔºàÊåëÊà∞Ôºâ',
                        icon: 'fa-link',
                        color: 'from-orange-400 to-red-600' 
                    }
                ];

                return (
                    <div className="min-h-screen flex items-center justify-center p-6">
                        <div className="fixed top-4 right-4 z-50 flex items-center gap-2 glass-effect rounded-xl p-2 shadow-xl">
                            <button
                                onClick={decreaseFontSize}
                                disabled={fontScale <= 70}
                                className={`px-3 py-2 rounded-lg font-bold transition-all ${
                                    fontScale <= 70
                                        ? 'bg-white/10 text-white/30 cursor-not-allowed'
                                        : 'bg-white/20 text-white hover:bg-white/30 hover:scale-110'
                                }`}
                            >
                                <span className="text-sm">A<sup className="text-xs">-</sup></span>
                            </button>
                            
                            <button
                                onClick={increaseFontSize}
                                disabled={fontScale >= 150}
                                className={`px-3 py-2 rounded-lg font-bold transition-all ${
                                    fontScale >= 150
                                        ? 'bg-white/10 text-white/30 cursor-not-allowed'
                                        : 'bg-white/20 text-white hover:bg-white/30 hover:scale-110'
                                }`}
                            >
                                <span className="text-sm">A<sup className="text-xs">+</sup></span>
                            </button>
                        </div>
                        
                        <div className="max-w-4xl w-full">
                            <div className="text-center mb-12 fade-in">
                                <h1 className="text-5xl font-black text-white mb-4">
                                    <i className="fas fa-palette mr-4"></i>
                                    È°èËâ≤Â≠óÂà§Êñ∑
                                </h1>
                                <p className="text-xl text-white/90">ÈÅ∏Êìá‰∏ÄÂÄãÈóúÂç°ÈñãÂßãÂ≠∏Áøí</p>
                            </div>

                            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {levels.map((level, index) => {
                                    const isCompleted = completionStatus[level.id]?.completed;
                                    
                                    return (
                                        <div
                                            key={level.id}
                                            className="glass-effect rounded-2xl p-8 hover:scale-105 transition-all duration-300 cursor-pointer fade-in relative"
                                            style={{ animationDelay: `${index * 0.1}s` }}
                                            onClick={() => selectLevel(level.id)}
                                        >
                                            {isCompleted && (
                                                <div className="absolute top-4 right-4 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center gap-1 shadow-lg">
                                                    <i className="fas fa-check-circle"></i>
                                                    Â∑≤ÂÆåÊàê
                                                </div>
                                            )}
                                            
                                            <div className={`w-20 h-20 bg-gradient-to-br ${level.color} rounded-2xl flex items-center justify-center mb-6 mx-auto`}>
                                                <i className={`${level.icon} text-4xl text-white`}></i>
                                            </div>
                                            
                                            <h2 className="text-2xl font-bold text-white text-center mb-2">
                                                {level.title}
                                            </h2>
                                            
                                            <p className="text-white/80 text-center mb-2">
                                                {level.subtitle}
                                            </p>
                                            
                                            {isCompleted && completionStatus[level.id] && (
                                                <div className="text-center text-white/70 text-xs mt-3">
                                                    <div>‚è±Ô∏è {formatTime(completionStatus[level.id].time)}</div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            }

            // ===========================================
            // ÈÅäÊà≤ÈÄ≤Ë°åÁï´Èù¢
            // ===========================================
            if (screen === 'playing' && currentLevel) {
                const totalItems = currentLevel.items.length;
                const placedItems = Object.values(droppedItems).flat().length;
                const allPlaced = placedItems === totalItems;

                return (
                    <div className="h-screen flex flex-col overflow-hidden">
                        {/* È†ÇÈÉ®Ê®ôÈ°åÂàó */}
                        <div className="flex-shrink-0 bg-gradient-to-r from-purple-600 to-indigo-700 p-3 text-white shadow-xl">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <div className="flex items-center gap-1 bg-black/20 rounded-lg p-1">
                                        <button
                                            onClick={decreaseFontSize}
                                            disabled={fontScale <= 70}
                                            className={`px-1.5 py-0.5 rounded text-xs font-bold transition-all ${
                                                fontScale <= 70 ? 'text-white/30' : 'text-white hover:bg-white/20'
                                            }`}
                                        >
                                            A<sup style={{ fontSize: '8px' }}>-</sup>
                                        </button>
                                        <button
                                            onClick={increaseFontSize}
                                            disabled={fontScale >= 150}
                                            className={`px-1.5 py-0.5 rounded text-xs font-bold transition-all ${
                                                fontScale >= 150 ? 'text-white/30' : 'text-white hover:bg-white/20'
                                            }`}
                                        >
                                            A<sup style={{ fontSize: '8px' }}>+</sup>
                                        </button>
                                    </div>
                                    <h2 className="text-base md:text-lg font-bold">{currentLevel.title}</h2>
                                </div>
                                
                                <div className="flex items-center gap-2">
                                    <span className="text-sm">‚è±Ô∏è {formatTime(elapsedTime)}</span>
                                    <span className="text-sm bg-black/20 px-2 py-1 rounded">üéØ {score.total}</span>
                                    <button
                                        onClick={() => setScreen('level_select')}
                                        className="bg-white/20 hover:bg-white/30 px-2 py-1 rounded transition-all text-sm"
                                    >
                                        <i className="fas fa-home"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* ÈÅäÊà≤ÂÖßÂÆπ */}
                        <div className="flex-1 overflow-y-auto p-4">
                            <div className="max-w-7xl mx-auto">
                                <p className="text-white text-center mb-4">{currentLevel.description}</p>
                                
                                <div className={`grid gap-4 ${currentLevel.isMatching ? 'lg:grid-cols-5' : 'lg:grid-cols-4'}`}>
                                    {/* ÂæÖÂàÜÈ°ûÂçÄ */}
                                    <div className="lg:col-span-1">
                                        <div className="glass-effect rounded-lg p-3 sticky top-2">
                                            <h3 className="text-base font-bold text-white mb-3 flex items-center">
                                                <i className="fas fa-cube mr-2"></i>
                                                ÂæÖÂàÜÈ°ûÈ†ÖÁõÆ
                                            </h3>
                                            <div 
                                                data-zone-id="items"
                                                onDrop={(e) => handleDrop(e, 'items')}
                                                onDragOver={handleDragOver}
                                                className="drop-zone grid grid-cols-2 md:grid-cols-3 lg:grid-cols-2 gap-2 min-h-[100px]"
                                            >
                                                {availableItems.map(item => (
                                                    <div
                                                        key={item.id}
                                                        draggable
                                                        onDragStart={(e) => handleDragStart(e, item)}
                                                        onTouchStart={(e) => handleTouchStart(e, item, null)}
                                                        onTouchMove={handleTouchMove}
                                                        onTouchEnd={(e) => handleTouchEnd(e, handleTouchDrop)}
                                                        className="drag-item bg-white rounded-lg p-2 shadow-lg"
                                                    >
                                                        <p className="text-gray-800 font-medium text-center text-xs md:text-sm">
                                                            {item.text}
                                                        </p>
                                                    </div>
                                                ))}
                                                {availableItems.length === 0 && (
                                                    <div className="text-center text-white/70 py-3 text-xs">
                                                        ÊâÄÊúâÈ†ÖÁõÆÈÉΩÂ∑≤ÂàÜÈ°û
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>

                                    {/* ÂàÜÈ°ûÊ°ÜÂçÄ */}
                                    <div className={currentLevel.isMatching ? 'lg:col-span-4' : 'lg:col-span-3'}>
                                        <div className={`grid ${currentLevel.isMatching ? 'md:grid-cols-2 lg:grid-cols-3' : 'gap-3'}`}>
                                            {currentLevel.zones.map(zone => (
                                                <div
                                                    key={zone.id}
                                                    data-zone-id={zone.id}
                                                    onDragOver={handleDragOver}
                                                    onDrop={(e) => handleDrop(e, zone.id)}
                                                    className={`
                                                        drop-zone rounded-lg p-3 mb-3
                                                        ${zone.color || 'glass-effect'}
                                                        ${feedback[zone.id] === true ? 'correct-answer' : ''}
                                                        ${feedback[zone.id] === false ? 'wrong-answer' : ''}
                                                        ${!feedback[zone.id] ? 'border-2 border-white/30' : ''}
                                                    `}
                                                >
                                                    <h4 className="text-base font-bold text-white mb-2 flex items-center justify-between">
                                                        <span>{zone.title}</span>
                                                        {feedback[zone.id] === true && (
                                                            <i className="fas fa-check-circle text-green-400"></i>
                                                        )}
                                                        {feedback[zone.id] === false && (
                                                            <i className="fas fa-times-circle text-red-400"></i>
                                                        )}
                                                    </h4>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        {(droppedItems[zone.id] || []).map(item => (
                                                            <div
                                                                key={item.id}
                                                                draggable
                                                                onDragStart={(e) => {
                                                                    handleDragStart(e, item);
                                                                    setTimeout(() => removeItem(zone.id, item.id), 0);
                                                                }}
                                                                onTouchStart={(e) => handleTouchStart(e, item, () => removeItem(zone.id, item.id))}
                                                                onTouchMove={handleTouchMove}
                                                                onTouchEnd={(e) => handleTouchEnd(e, handleTouchDrop)}
                                                                className="bg-white rounded-lg p-2 shadow-lg group relative cursor-move"
                                                            >
                                                                <p className="text-gray-800 font-medium text-center text-xs pr-5">
                                                                    {item.text}
                                                                </p>
                                                                <button
                                                                    onClick={() => removeItem(zone.id, item.id)}
                                                                    className="absolute top-1 right-1 w-4 h-4 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-xs"
                                                                >
                                                                    √ó
                                                                </button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>

                                        {/* Ê™¢Êü•ÊåâÈàï */}
                                        <div className="mt-4 flex gap-2">
                                            {gameState === 'playing' && (
                                                <button
                                                    onClick={checkAnswers}
                                                    className={`flex-1 py-3 rounded-lg font-bold text-base transition-all shadow-xl ${
                                                        allPlaced 
                                                            ? 'bg-gradient-to-r from-green-500 to-emerald-600 text-white hover:scale-105 cursor-pointer'
                                                            : 'bg-gray-400 text-gray-200 cursor-not-allowed'
                                                    }`}
                                                    disabled={!allPlaced}
                                                >
                                                    <i className="fas fa-check mr-2"></i>
                                                    {allPlaced ? 'Ê™¢Êü•Á≠îÊ°à' : `Â∞öÊú™ÂÆåÊàê (${placedItems}/${totalItems})`}
                                                </button>
                                            )}
                                            {gameState === 'completed' && (
                                                <button
                                                    onClick={() => setScreen('level_select')}
                                                    className="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-bold text-base hover:scale-105 transition-all shadow-xl"
                                                >
                                                    <i className="fas fa-home mr-2"></i>
                                                    ËøîÂõûÈÅ∏ÂñÆ
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
