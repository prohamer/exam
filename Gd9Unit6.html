<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Sentence Scramble - Lesson 6</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');

        body {
            font-family: 'Nunito', 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff;
            /* Prevent pull-to-refresh and elastic scrolling on mobile */
            overscroll-behavior: none;
            touch-action: pan-y;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Game Elements */
        .slot {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
            height: 42px;
            background-color: #e2e8f0;
            border-bottom: 3px solid #94a3b8;
            border-radius: 8px;
            margin: 0 4px;
            padding: 0 8px;
            vertical-align: middle;
            transition: all 0.2s ease;
            cursor: pointer;
            color: #334155;
            font-weight: 600;
        }

        .slot.filled {
            background-color: #ffffff;
            border-bottom: 3px solid #3b82f6;
            color: #1e40af;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .slot.correct-lock {
            background-color: #dcfce7;
            border-bottom-color: #22c55e;
            color: #15803d;
        }

        .slot.wrong-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            border-bottom-color: #ef4444;
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .word-card {
            display: inline-block;
            padding: 8px 16px;
            background-color: white;
            border: 2px solid #e2e8f0;
            border-radius: 9999px;
            font-weight: 600;
            color: #475569;
            cursor: grab;
            touch-action: none; /* Critical for custom drag */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .word-card:active {
            cursor: grabbing;
            transform: scale(0.95);
        }

        .word-card.used {
            opacity: 0.3;
            pointer-events: none;
            background-color: #f1f5f9;
            border-color: #cbd5e1;
        }

        /* Dragging Ghost */
        .dragging-ghost {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.9;
            transform: scale(1.1);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            background: white;
            padding: 8px 16px;
            border-radius: 9999px;
            border: 2px solid #3b82f6;
            color: #1e40af;
            font-weight: bold;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6;
        }
        
        #end-screen, #game-screen {
            display: none;
        }
        
        .active-screen {
            display: flex !important;
        }

        /* Custom scrollbar for word bank to ensure it scrolls horizontally easily */
        #word-bank-container {
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden text-slate-700 flex flex-col">

    <!-- HOME SCREEN -->
    <div id="home-screen" class="active-screen flex-1 flex flex-col items-center justify-start p-6 overflow-y-auto bg-white">
        <header class="w-full max-w-2xl mb-8 text-center">
            <h1 class="text-3xl font-extrabold text-blue-600 mb-2">Sentence Scramble</h1>
            <p class="text-slate-500">Lesson 6: Are You One of the Customers Who Businesses Trick?</p>
        </header>

        <!-- Difficulty Selector -->
        <div class="w-full max-w-md bg-blue-50 p-4 rounded-xl mb-8 border border-blue-100">
            <label class="block text-sm font-bold text-blue-800 mb-2 flex items-center gap-2">
                <i data-lucide="bar-chart-2" class="w-4 h-4"></i> Difficulty (Blank Ratio)
            </label>
            <div class="flex items-center gap-4">
                <input type="range" id="diff-slider" min="40" max="100" step="10" value="70" 
                       class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                <span id="diff-display" class="font-bold text-blue-700 w-12 text-right">70%</span>
            </div>
            <p class="text-xs text-blue-400 mt-2 text-center">Higher percentage = More blanks to fill</p>
        </div>

        <!-- Levels List -->
        <div id="level-list" class="w-full max-w-md space-y-6 pb-12">
            <!-- Group 1 -->
            <div>
                <h3 class="text-lg font-bold text-slate-800 mb-3 flex items-center">
                    <span class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mr-2 text-sm">R</span>
                    Reading: BOGO Deals
                </h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="startGame('r1')" class="level-btn group relative p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-indigo-400 hover:shadow-md transition text-left" data-id="r1">
                        <div class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Task 1</div>
                        <div class="font-bold text-slate-700">Introduction</div>
                        <div class="status-icon absolute top-3 right-3 opacity-0 text-green-500"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div>
                    </button>
                    <button onclick="startGame('r2')" class="level-btn group relative p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-indigo-400 hover:shadow-md transition text-left" data-id="r2">
                        <div class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Task 2</div>
                        <div class="font-bold text-slate-700">The Trick</div>
                        <div class="status-icon absolute top-3 right-3 opacity-0 text-green-500"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div>
                    </button>
                    <button onclick="startGame('r3')" class="level-btn group relative p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-indigo-400 hover:shadow-md transition text-left" data-id="r3">
                        <div class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Task 3</div>
                        <div class="font-bold text-slate-700">Profit Secret</div>
                        <div class="status-icon absolute top-3 right-3 opacity-0 text-green-500"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div>
                    </button>
                    <button onclick="startGame('r4')" class="level-btn group relative p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-indigo-400 hover:shadow-md transition text-left" data-id="r4">
                        <div class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Task 4</div>
                        <div class="font-bold text-slate-700">Conclusion</div>
                        <div class="status-icon absolute top-3 right-3 opacity-0 text-green-500"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div>
                    </button>
                </div>
            </div>

            <!-- Group 2 -->
            <div>
                <h3 class="text-lg font-bold text-slate-800 mb-3 flex items-center">
                    <span class="w-8 h-8 bg-pink-100 text-pink-600 rounded-full flex items-center justify-center mr-2 text-sm">D</span>
                    Dialogue: Shopping
                </h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="startGame('d1')" class="level-btn group relative p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-pink-400 hover:shadow-md transition text-left" data-id="d1">
                        <div class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Task 1</div>
                        <div class="font-bold text-slate-700">The Cost</div>
                        <div class="status-icon absolute top-3 right-3 opacity-0 text-green-500"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div>
                    </button>
                    <button onclick="startGame('d2')" class="level-btn group relative p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-pink-400 hover:shadow-md transition text-left" data-id="d2">
                        <div class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Task 2</div>
                        <div class="font-bold text-slate-700">Temptation</div>
                        <div class="status-icon absolute top-3 right-3 opacity-0 text-green-500"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div>
                    </button>
                    <button onclick="startGame('d3')" class="level-btn group relative p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-pink-400 hover:shadow-md transition text-left" data-id="d3">
                        <div class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Task 3</div>
                        <div class="font-bold text-slate-700">Where's Rice?</div>
                        <div class="status-icon absolute top-3 right-3 opacity-0 text-green-500"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div>
                    </button>
                    <button onclick="startGame('d4')" class="level-btn group relative p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-pink-400 hover:shadow-md transition text-left" data-id="d4">
                        <div class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Task 4</div>
                        <div class="font-bold text-slate-700">Eye Level Rule</div>
                        <div class="status-icon absolute top-3 right-3 opacity-0 text-green-500"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div>
                    </button>
                </div>
            </div>

            <!-- Group 3 -->
            <div>
                <h3 class="text-lg font-bold text-slate-800 mb-3 flex items-center">
                    <span class="w-8 h-8 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mr-2 text-sm">F</span>
                    Adv: Fair Trade
                </h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="startGame('f1')" class="level-btn group relative p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-amber-400 hover:shadow-md transition text-left" data-id="f1">
                        <div class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Task 1</div>
                        <div class="font-bold text-slate-700">Tom's Story</div>
                        <div class="status-icon absolute top-3 right-3 opacity-0 text-green-500"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div>
                    </button>
                    <button onclick="startGame('f2')" class="level-btn group relative p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-amber-400 hover:shadow-md transition text-left" data-id="f2">
                        <div class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Task 2</div>
                        <div class="font-bold text-slate-700">Lucy's Success</div>
                        <div class="status-icon absolute top-3 right-3 opacity-0 text-green-500"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div>
                    </button>
                </div>
            </div>
            
            <div class="mt-8 text-center">
                <button onclick="resetProgress()" class="text-sm text-red-400 underline hover:text-red-600">Reset Progress</button>
            </div>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="flex-col h-full bg-slate-50 relative">
        <!-- Header -->
        <div class="bg-white px-4 py-3 shadow-sm border-b border-slate-200 flex items-center justify-between shrink-0 z-20">
            <button onclick="goHome()" class="p-2 -ml-2 text-slate-500 hover:bg-slate-100 rounded-full">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <div class="text-center">
                <div class="text-xs text-slate-400 uppercase font-bold tracking-widest" id="game-level-id">TASK R1</div>
                <div class="font-bold text-slate-800" id="game-timer">00:00</div>
            </div>
            <div class="w-8"></div> <!-- Spacer for centering -->
        </div>

        <!-- Scrollable Game Area -->
        <div id="game-container" class="flex-1 overflow-y-auto p-4 pb-40 space-y-6">
            <!-- Sentences will be injected here -->
        </div>

        <!-- Controls & Word Bank (Fixed Bottom) -->
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-30 flex flex-col transition-transform duration-300" style="max-height: 40vh;">
            
            <!-- Toolbar -->
            <div class="flex items-center justify-between px-4 py-2 border-b border-slate-100 bg-slate-50">
                <div class="flex items-center gap-2">
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="quick-fill-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 border-gray-300 appearance-none cursor-pointer transition-all duration-300 left-0"/>
                        <label for="quick-fill-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                    <span class="text-xs font-bold text-slate-500">Quick Fill</span>
                </div>
                <button onclick="checkAnswers()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-1.5 rounded-full font-bold shadow-sm active:transform active:scale-95 transition flex items-center gap-2">
                    <i data-lucide="check" class="w-4 h-4"></i> Check
                </button>
            </div>

            <!-- Word Bank -->
            <div id="word-bank-container" class="p-4 overflow-y-auto bg-slate-100" style="height: 180px;">
                <div id="word-bank" class="flex flex-wrap gap-2 justify-center pb-8">
                    <!-- Words injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- END SCREEN -->
    <div id="end-screen" class="flex-col items-center justify-center p-6 bg-white z-50 overflow-y-auto">
        <div class="w-full max-w-lg bg-white p-6 text-center space-y-6">
            <div class="w-20 h-20 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
                <i data-lucide="trophy" class="w-10 h-10"></i>
            </div>
            
            <h2 class="text-3xl font-extrabold text-slate-800">Excellent!</h2>
            <p class="text-slate-500">You completed the task.</p>

            <div class="grid grid-cols-2 gap-4 my-6">
                <div class="bg-slate-50 p-4 rounded-xl">
                    <div class="text-xs text-slate-400 uppercase font-bold">Time</div>
                    <div class="text-xl font-bold text-slate-700" id="result-time">00:45</div>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl">
                    <div class="text-xs text-slate-400 uppercase font-bold">Difficulty</div>
                    <div class="text-xl font-bold text-blue-600" id="result-diff">70%</div>
                </div>
            </div>

            <div id="result-review" class="text-left bg-yellow-50 p-5 rounded-xl border border-yellow-100 text-sm text-slate-700 leading-relaxed max-h-48 overflow-y-auto mb-4 font-serif">
                <!-- Full text review -->
            </div>

            <div class="flex gap-3">
                <button onclick="goHome()" class="flex-1 py-3 rounded-xl border-2 border-slate-200 font-bold text-slate-500 hover:bg-slate-50">Back</button>
                <button onclick="downloadReport()" class="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold shadow-lg hover:bg-indigo-700 flex items-center justify-center gap-2">
                    <i data-lucide="camera" class="w-4 h-4"></i> Save
                </button>
            </div>
        </div>
        <!-- Hidden capture area -->
        <div id="capture-area" class="fixed top-0 left-0 -z-50 bg-white p-8 w-[600px] pointer-events-none opacity-0">
            <h1 class="text-2xl font-bold mb-4 text-center text-blue-800">Learning Report</h1>
            <div class="border-t-2 border-b-2 border-blue-100 py-4 my-4">
                <p class="mb-2"><strong>Level:</strong> <span id="cap-level"></span></p>
                <p class="mb-2"><strong>Date:</strong> <span id="cap-date"></span></p>
                <p><strong>Time:</strong> <span id="cap-time"></span></p>
            </div>
            <div id="cap-content" class="text-lg leading-relaxed font-serif text-slate-700 bg-slate-50 p-4 rounded"></div>
            <div class="mt-6 text-center text-sm text-slate-400">Generated by English Scramble Game</div>
        </div>
    </div>

    <script>
        // --- 1. DATA ---
        const levelsDB = {
            'r1': {
                title: 'Introduction to BOGO',
                sentences: [
                    { en: "Buy one, get one free sounds like a good deal for anyone who wants to spend money wisely.", ch: "買一送一對任何想要明智消費的人來說，聽起來都是個划算的交易。" },
                    { en: "However, is it really as good as it appears to be?", ch: "然而，它真的像看起來那麼好嗎？" },
                    { en: "BOGO is the kind of sales promotion which businesses love to use.", ch: "BOGO 是商家喜歡使用的促銷手法。" },
                    { en: "It's very common, and it fools many people into spending more money than they first planned to.", ch: "它非常普遍，並且愚弄了許多人，讓他們花了比原先計畫更多的錢。" }
                ]
            },
            'r2': {
                title: 'The Trick',
                sentences: [
                    { en: "Here's how it works.", ch: "它的運作方式是這樣的。" },
                    { en: "Customers who fall for the trick buy one item at the full price and get a second one for free.", ch: "上當的顧客以原價購買一件商品，並免費獲得第二件。" },
                    { en: "At this point, some of you might ask why businesses don't just sell each item at half price.", ch: "這時，有些人可能會問為什麼商家不直接以半價出售每件商品。" },
                    { en: "But for those who understand the game, the answer is quite clear.", ch: "但對於那些了解這場遊戲的人來說，答案相當清楚。" }
                ]
            },
            'r3': {
                title: 'Profit Secret',
                sentences: [
                    { en: "The secret lies in the profits that these stores expect to make.", ch: "秘密在於這些商店預期獲得的利潤。" },
                    { en: "Besides enjoying larger profits, businesses also often cheat customers out of their money with BOGO deals.", ch: "除了享有更大的利潤外，商家還經常利用 BOGO 優惠騙取顧客的錢。" },
                    { en: "They simply sell the first item at a price that is higher than the full price.", ch: "他們只是以高於原價的價格出售第一件商品。" },
                    { en: "That covers the cost of the free one.", ch: "這涵蓋了免費那件商品的成本。" }
                ]
            },
            'r4': {
                title: 'Conclusion',
                sentences: [
                    { en: "As you can see, free is not always a good deal for the people who are pulling out their wallets.", ch: "如你所見，「免費」對掏錢包的人來說並不總是划算的交易。" },
                    { en: "Most of the time, you just end up spending more on something you don't need.", ch: "大多數時候，你只是花更多的錢買了你不需要的東西。" },
                    { en: "So, next time you're out shopping, be sure to watch out for these sales tricks.", ch: "所以，下次你去購物時，務必小心這些銷售陷阱。" },
                    { en: "Then, you'll be a smart shopper whose money is never wasted.", ch: "這樣，你就會成為一個錢從不白花的聰明購物者。" }
                ]
            },
            'd1': {
                title: 'Shopping Cost',
                sentences: [
                    { en: "Hey, Dad. We're back from the supermarket.", ch: "嘿，爸。我們從超市回來了。" },
                    { en: "Wow! How much did all that cost?", ch: "哇！那些總共花了多少錢？" },
                    { en: "It cost three thousand dollars in total.", ch: "總共花了三千元。" },
                    { en: "I thought you were just going there to get some rice for the week.", ch: "我以為你們只是要去那裡買這個禮拜要吃的米。" }
                ]
            },
            'd2': {
                title: 'The Temptation',
                sentences: [
                    { en: "We were, but then we saw many products that were on sale.", ch: "我們是啊，但後來我們看到很多特價商品。" },
                    { en: "We just couldn't pass them up.", ch: "我們就是無法錯過它們。" },
                    { en: "All the clerks there were very helpful.", ch: "那裡的店員都很熱心。" },
                    { en: "She gave us some free samples to try.", ch: "她給了我們一些免費樣品試吃。" }
                ]
            },
            'd3': {
                title: "Where's Rice?",
                sentences: [
                    { en: "Some of them were good. That's why we also bought some cheese.", ch: "有些很好吃。這就是為什麼我們也買了一些起司。" },
                    { en: "Hey! I'm looking through all the things you bought, and I don't see any rice.", ch: "嘿！我翻遍了你們買的所有東西，卻沒看到米。" },
                    { en: "You're right. Come to think of it, I didn't see any on the shelves.", ch: "你說得對。這樣一想，我在架上也沒看到任何米。" }
                ]
            },
            'd4': {
                title: "Eye Level Rule",
                sentences: [
                    { en: "My guess is that you probably weren't looking at the bottom ones.", ch: "我猜你們可能沒有看底層的貨架。" },
                    { en: "Oh, no. Are you saying I followed the eye level rule?", ch: "喔不。你是說我遵循了視線高度規則嗎？" },
                    { en: "Yes, next time you go to a store, don't just let your eyes decide what to get.", ch: "是的，下次你去商店，別只讓你的眼睛決定要買什麼。" },
                    { en: "Make sure every cent is spent wisely.", ch: "確保每一分錢都花得明智。" }
                ]
            },
            'f1': {
                title: "Tom's Story",
                sentences: [
                    { en: "We work hard to grow our coffee beans, but then we get almost nothing when we sell them.", ch: "我們辛勤種植咖啡豆，但賣出時幾乎一無所獲。" },
                    { en: "The price of coffee beans is just too low for us.", ch: "咖啡豆的價格對我們來說太低了。" },
                    { en: "So we can't keep our children in school, buy food, or pay for health care.", ch: "所以我們無法讓孩子上學、買食物或支付醫療費用。" }
                ]
            },
            'f2': {
                title: "Lucy's Success",
                sentences: [
                    { en: "We use the money we get from selling the beans to pay for food, clothes, medicine, and school.", ch: "我們用賣豆子的錢來支付食物、衣服、藥品和學費。" },
                    { en: "Before the fair trade deal, we seldom got paid and had to borrow money.", ch: "在公平貿易協議之前，我們很少拿到錢，而且必須借錢。" },
                    { en: "Now, we are paid a fair price for our coffee beans in cash and on time.", ch: "現在，我們的咖啡豆能以合理的價格、現金且準時地獲得報酬。" }
                ]
            }
        };

        // --- 2. STATE ---
        let currentLevelId = null;
        let timerInterval = null;
        let startTime = 0;
        let activeWords = []; // { id, word, originalIndex }
        let quickFillMode = false;
        let selectedWordId = null; // For Quick Fill OFF mode

        // --- 3. DOM HELPERS ---
        const $ = id => document.getElementById(id);
        const screens = ['home-screen', 'game-screen', 'end-screen'];

        function showScreen(id) {
            screens.forEach(s => $(s).classList.remove('active-screen'));
            $(id).classList.add('active-screen');
        }

        // --- 4. INIT ---
        window.onload = () => {
            lucide.createIcons();
            loadProgress();
            
            $('diff-slider').addEventListener('input', (e) => {
                $('diff-display').textContent = e.target.value + '%';
            });

            $('quick-fill-toggle').addEventListener('change', (e) => {
                quickFillMode = e.target.checked;
                // Clear selection if switching modes
                if (selectedWordId) {
                    const el = document.querySelector(`.word-card[data-id="${selectedWordId}"]`);
                    if(el) el.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
                    selectedWordId = null;
                }
            });
        };

        function loadProgress() {
            const progress = JSON.parse(localStorage.getItem('eng_game_progress') || '{}');
            document.querySelectorAll('.level-btn').forEach(btn => {
                const id = btn.getAttribute('data-id');
                if (progress[id]) {
                    btn.querySelector('.status-icon').classList.remove('opacity-0');
                    btn.classList.add('border-green-200', 'bg-green-50');
                }
            });
        }

        function resetProgress() {
            if(confirm('Reset all progress?')) {
                localStorage.removeItem('eng_game_progress');
                location.reload();
            }
        }

        // --- 5. GAME LOGIC ---
        function startGame(levelId) {
            currentLevelId = levelId;
            const diff = parseInt($('diff-slider').value) / 100;
            const levelData = levelsDB[levelId];
            
            // Build UI
            const container = $('game-container');
            container.innerHTML = '';
            $('word-bank').innerHTML = '';
            $('game-level-id').textContent = `${levelId.toUpperCase()}: ${levelData.title}`;
            
            let wordBankList = [];
            let globalWordIdCounter = 0;

            levelData.sentences.forEach((sent, sIdx) => {
                // Pre-process sentence: split by spaces but keep punctuation attached
                // Simple regex split: whitespace
                const words = sent.en.split(/\s+/);
                
                const wrapper = document.createElement('div');
                wrapper.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-100";
                
                // Chinese Translation
                const chDiv = document.createElement('div');
                chDiv.className = "text-sm text-slate-400 mb-3 font-medium";
                chDiv.innerHTML = `<span class="bg-slate-100 px-2 py-0.5 rounded text-xs mr-2 text-slate-500">#${sIdx+1}</span>${sent.ch}`;
                wrapper.appendChild(chDiv);

                // English Area
                const enDiv = document.createElement('div');
                enDiv.className = "leading-loose text-lg flex flex-wrap items-center";
                
                // Determine blanks based on difficulty
                // We want to keep at least 1 word if possible, unless 100%
                words.forEach((w, wIdx) => {
                    // Randomly decide if this word is a blank
                    // Always make long words more likely to be blanks? No, simple random.
                    const isBlank = Math.random() < diff;

                    if (isBlank) {
                        const wordId = `w_${levelId}_${sIdx}_${wIdx}_${globalWordIdCounter++}`;
                        
                        // Create Slot
                        const slot = document.createElement('span');
                        slot.className = "slot empty";
                        slot.dataset.answer = w.replace(/[^\w']/g, ''); // strip punctuation for flexible check if needed, but here we require exact match visually
                        slot.dataset.fullWord = w; // The actual text to display
                        slot.dataset.slotId = wordId;
                        
                        // Touch/Click handler for slot (Placement)
                        slot.addEventListener('click', (e) => handleSlotClick(e, slot));

                        enDiv.appendChild(slot);

                        // Add to Word Bank List
                        wordBankList.push({
                            id: wordId,
                            text: w
                        });
                    } else {
                        // Fixed Word
                        const fixed = document.createElement('span');
                        fixed.className = "mx-1 font-medium text-slate-800";
                        fixed.textContent = w;
                        enDiv.appendChild(fixed);
                    }
                });

                wrapper.appendChild(enDiv);
                container.appendChild(wrapper);
            });

            // Populate Word Bank (Shuffle)
            wordBankList.sort((a, b) => a.text.localeCompare(b.text)); // Alphabetical sort helps finding words
            // Or Random sort? Usually random in games. Let's do Random.
            wordBankList.sort(() => Math.random() - 0.5);

            const bankContainer = $('word-bank');
            wordBankList.forEach(item => {
                const btn = document.createElement('div');
                btn.className = "word-card";
                btn.textContent = item.text;
                btn.dataset.id = item.id;
                btn.dataset.text = item.text;
                
                // Event Listeners for Drag/Click
                initDraggable(btn);
                
                bankContainer.appendChild(btn);
            });

            // Start Timer
            startTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const delta = Math.floor((Date.now() - startTime) / 1000);
                const m = Math.floor(delta / 60).toString().padStart(2, '0');
                const s = (delta % 60).toString().padStart(2, '0');
                $('game-timer').textContent = `${m}:${s}`;
            }, 1000);

            showScreen('game-screen');
        }

        // --- 6. INTERACTION LOGIC (Touch/Mouse/Click) ---

        // A. WORD CARD CLICK (Selection for Quick Fill / Manual Place)
        function handleWordClick(e) {
            if(e.defaultPrevented) return; // handled by drag

            const card = e.currentTarget;
            if(card.classList.contains('used')) return;

            if (quickFillMode) {
                // Auto fill first empty
                const firstEmpty = document.querySelector('.slot:not(.filled)');
                if (firstEmpty) {
                    fillSlot(firstEmpty, card);
                } else {
                    // Shake to indicate full
                    card.animate([
                        { transform: 'translateX(0)' },
                        { transform: 'translateX(-5px)' },
                        { transform: 'translateX(5px)' },
                        { transform: 'translateX(0)' }
                    ], { duration: 200 });
                }
            } else {
                // Select Mode
                if (selectedWordId === card.dataset.id) {
                    // Deselect
                    selectedWordId = null;
                    card.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
                } else {
                    // Remove prev selection
                    if (selectedWordId) {
                        const prev = document.querySelector(`.word-card[data-id="${selectedWordId}"]`);
                        if(prev) prev.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
                    }
                    // Select new
                    selectedWordId = card.dataset.id;
                    card.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
                }
            }
        }

        // B. SLOT CLICK (Recieve Word or Return Word)
        function handleSlotClick(e, slot) {
            // If slot is filled, return word to bank
            if (slot.classList.contains('filled')) {
                returnWordFromSlot(slot);
                return;
            }

            // If empty and we have a selected word
            if (!slot.classList.contains('filled') && selectedWordId && !quickFillMode) {
                const card = document.querySelector(`.word-card[data-id="${selectedWordId}"]`);
                if (card && !card.classList.contains('used')) {
                    fillSlot(slot, card);
                    // Clear selection
                    selectedWordId = null;
                    card.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
                }
            }
        }

        // C. CORE ACTION: Fill Slot
        function fillSlot(slot, cardElement) {
            // Mark card as used
            cardElement.classList.add('used');

            // Update Slot
            slot.textContent = cardElement.dataset.text;
            slot.classList.add('filled', 'bg-white');
            slot.classList.remove('empty');
            slot.dataset.filledId = cardElement.dataset.id;

            // Optional: Animation
            slot.animate([
                { transform: 'scale(0.8)', opacity: 0.5 },
                { transform: 'scale(1.05)', opacity: 1 },
                { transform: 'scale(1)', opacity: 1 }
            ], { duration: 200 });
        }

        // D. CORE ACTION: Return Word
        function returnWordFromSlot(slot) {
            const wordId = slot.dataset.filledId;
            if (!wordId) return;

            // Reset Slot
            slot.textContent = '';
            slot.classList.remove('filled', 'bg-white', 'correct-lock', 'wrong-shake');
            slot.classList.add('empty');
            delete slot.dataset.filledId;

            // Reset Card in Bank
            const card = document.querySelector(`.word-card[data-id="${wordId}"]`);
            if (card) {
                card.classList.remove('used');
            }
        }

        // E. DRAG & DROP IMPLEMENTATION (Ghost Element)
        let dragSrcEl = null;
        let ghostEl = null;
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        function initDraggable(el) {
            // Touch
            el.addEventListener('touchstart', handleDragStart, { passive: false });
            el.addEventListener('touchmove', handleDragMove, { passive: false });
            el.addEventListener('touchend', handleDragEnd);
            
            // Mouse
            el.addEventListener('mousedown', handleDragStart);
            
            // Click fallback logic inside DragEnd/MouseUp check
        }

        function handleDragStart(e) {
            if (e.target.classList.contains('used')) return;
            
            const isTouch = e.type === 'touchstart';
            const pageX = isTouch ? e.touches[0].pageX : e.pageX;
            const pageY = isTouch ? e.touches[0].pageY : e.pageY;
            
            // Wait a tiny bit to distinguish tap from drag? 
            // Better: Create ghost immediately but only move it on move.
            
            dragSrcEl = e.currentTarget;
            const rect = dragSrcEl.getBoundingClientRect();
            dragOffsetX = pageX - rect.left;
            dragOffsetY = pageY - rect.top;

            // Create Ghost
            ghostEl = dragSrcEl.cloneNode(true);
            ghostEl.classList.add('dragging-ghost');
            ghostEl.style.width = rect.width + 'px';
            ghostEl.style.left = (pageX - dragOffsetX) + 'px';
            ghostEl.style.top = (pageY - dragOffsetY) + 'px';
            document.body.appendChild(ghostEl);

            if (!isTouch) {
                document.addEventListener('mousemove', handleDragMove);
                document.addEventListener('mouseup', handleDragEnd);
            }
        }

        function handleDragMove(e) {
            if (!ghostEl) return;
            e.preventDefault(); // Stop scrolling

            const isTouch = e.type === 'touchmove';
            const pageX = isTouch ? e.touches[0].pageX : e.pageX;
            const pageY = isTouch ? e.touches[0].pageY : e.pageY;

            ghostEl.style.left = (pageX - dragOffsetX) + 'px';
            ghostEl.style.top = (pageY - dragOffsetY) + 'px';
            ghostEl.style.display = 'none'; // Hide momentarily to find element below
            
            // Highlight drop zone
            const elemBelow = document.elementFromPoint(
                isTouch ? e.touches[0].clientX : e.clientX,
                isTouch ? e.touches[0].clientY : e.clientY
            );
            ghostEl.style.display = 'block';

            document.querySelectorAll('.slot').forEach(s => s.style.transform = 'scale(1)');
            if (elemBelow && elemBelow.classList.contains('slot')) {
                elemBelow.style.transform = 'scale(1.1)';
            }
        }

        function handleDragEnd(e) {
            // Cleanup listeners
            document.removeEventListener('mousemove', handleDragMove);
            document.removeEventListener('mouseup', handleDragEnd);

            if (!ghostEl) return;

            // Determine if it was a Click (Drag distance very small)
            // Implementation: Simple check - if ghost didn't move much? 
            // Actually, let's just use the Drop logic. If no drop target, trigger click logic.
            
            const isTouch = e.type === 'touchend';
            const clientX = isTouch ? e.changedTouches[0].clientX : e.clientX;
            const clientY = isTouch ? e.changedTouches[0].clientY : e.clientY;

            ghostEl.style.display = 'none';
            const elemBelow = document.elementFromPoint(clientX, clientY);
            
            let dropped = false;
            if (elemBelow && elemBelow.classList.contains('slot')) {
                // If slot filled, clear it first (Overwrite)
                if (elemBelow.classList.contains('filled')) {
                    returnWordFromSlot(elemBelow);
                }
                fillSlot(elemBelow, dragSrcEl);
                dropped = true;
            }

            ghostEl.remove();
            ghostEl = null;
            document.querySelectorAll('.slot').forEach(s => s.style.transform = 'scale(1)');

            // If not dropped and didn't move far, treat as Click
            if (!dropped) {
                // Approximate click detection
                // Ideally we track start vs end coordinates. 
                // For simplicity here, we just call the click handler if not dropped.
                 handleWordClick({ currentTarget: dragSrcEl, defaultPrevented: false });
            }
            
            dragSrcEl = null;
        }


        // --- 7. CHECK & END GAME ---
        function checkAnswers() {
            const slots = document.querySelectorAll('.slot');
            let allCorrect = true;
            let filledCount = 0;

            slots.forEach(slot => {
                if (!slot.classList.contains('filled')) {
                    allCorrect = false;
                    return;
                }
                filledCount++;

                const currentText = slot.textContent;
                const correctText = slot.dataset.fullWord;

                if (currentText === correctText) {
                    slot.classList.add('correct-lock');
                    slot.classList.remove('wrong-shake');
                } else {
                    allCorrect = false;
                    slot.classList.add('wrong-shake');
                    setTimeout(() => slot.classList.remove('wrong-shake'), 500);
                    // Record mistake? (Optional)
                }
            });

            if (allCorrect && filledCount === slots.length) {
                endGame();
            }
        }

        function endGame() {
            clearInterval(timerInterval);
            const timeStr = $('game-timer').textContent;
            const diffStr = $('diff-display').textContent;
            
            // Save Progress
            const progress = JSON.parse(localStorage.getItem('eng_game_progress') || '{}');
            progress[currentLevelId] = { time: timeStr, date: new Date().toLocaleDateString(), diff: diffStr };
            localStorage.setItem('eng_game_progress', JSON.stringify(progress));

            // Setup End Screen
            $('result-time').textContent = timeStr;
            $('result-diff').textContent = diffStr;
            
            // Build Review Text
            const levelData = levelsDB[currentLevelId];
            let reviewHtml = '';
            levelData.sentences.forEach(s => {
                reviewHtml += `<p class="mb-2"><span class="font-bold text-blue-600">${s.en}</span> <br><span class="text-xs text-gray-500">${s.ch}</span></p>`;
            });
            $('result-review').innerHTML = reviewHtml;

            // Prepare Capture Data
            $('cap-level').textContent = levelData.title;
            $('cap-date').textContent = new Date().toLocaleDateString();
            $('cap-time').textContent = timeStr;
            $('cap-content').innerHTML = reviewHtml;

            showScreen('end-screen');
            lucide.createIcons(); // Re-init icons on new screen
        }

        function goHome() {
            clearInterval(timerInterval);
            loadProgress(); // Refresh checks
            showScreen('home-screen');
        }

        // --- 8. REPORT GENERATION ---
        function downloadReport() {
            const captureArea = $('capture-area');
            captureArea.style.opacity = '1';
            captureArea.style.zIndex = '100'; // Bring to front briefly

            html2canvas(captureArea, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Lesson6_${currentLevelId}_Report.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
                
                captureArea.style.opacity = '0';
                captureArea.style.zIndex = '-50';
            });
        }

    </script>
</body>
</html>