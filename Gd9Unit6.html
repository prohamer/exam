<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Sentence Scramble - Lesson 6</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+TC:wght@400;500;700&display=swap');

        :root {
            --game-font-size: 18px; /* Default Font Size */
        }

        body {
            font-family: 'Nunito', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            overscroll-behavior: none;
            touch-action: pan-y;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px; /* Thinner scrollbar */
            height: 4px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 99px;
        }

        /* --- Dynamic Font Size Wrapper --- */
        .dynamic-text-area {
            font-size: var(--game-font-size);
            line-height: 1.6; /* Tighter line height */
        }

        /* --- Game Elements --- */
        .slot {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 2.5em; /* Tighter width */
            min-height: 1.8em; /* Tighter height */
            background-color: #f1f5f9;
            border: 2px dashed #cbd5e1;
            border-radius: 0.4em;
            margin: 0 0.15em; /* Tighter margin */
            padding: 0 0.3em;
            vertical-align: middle;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            color: #334155;
            font-weight: 700;
            touch-action: pan-y; /* Allow scroll by default */
        }

        .slot.filled {
            background-color: #ffffff;
            border: 2px solid #6366f1;
            border-bottom-width: 3px; /* Slightly less 3D height */
            color: #4338ca;
            box-shadow: 0 2px 4px -1px rgba(99, 102, 241, 0.1);
            cursor: grab; /* Show grab cursor */
            touch-action: none; /* Prevent scroll when dragging filled slot */
        }

        .slot.filled:active {
            cursor: grabbing;
        }

        .slot.correct-lock {
            background-color: #ecfdf5;
            border-color: #10b981;
            color: #047857;
            border-style: solid;
        }

        .slot.wrong-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            border-color: #ef4444;
            background-color: #fef2f2;
            color: #b91c1c;
            border-style: solid;
        }

        .word-card {
            display: inline-block;
            padding: 0.35rem 0.75rem; /* Tighter padding */
            background-color: white;
            border: 1px solid #e2e8f0;
            border-bottom: 3px solid #cbd5e1;
            border-radius: 0.6rem;
            font-weight: 700;
            color: #475569;
            cursor: grab;
            touch-action: none;
            transition: transform 0.1s, border-color 0.1s;
            font-size: 0.95rem; 
        }

        .word-card:active {
            cursor: grabbing;
            transform: translateY(2px);
            border-bottom-width: 1px;
            margin-bottom: 2px;
        }

        .word-card.used {
            opacity: 0.4;
            pointer-events: none;
            background-color: #f1f5f9;
            border-color: #e2e8f0;
            transform: scale(0.95);
            border-bottom-width: 1px;
        }

        .dragging-ghost {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.95;
            transform: scale(1.1) rotate(-2deg);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.2);
            background: white;
            padding: 0.4rem 0.8rem;
            border-radius: 0.6rem;
            border: 2px solid #6366f1;
            color: #4338ca;
            font-weight: bold;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .toggle-checkbox:checked {
            right: 0;
            border-color: #6366f1;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #6366f1;
        }
        
        #end-screen, #game-screen {
            display: none;
        }
        
        .active-screen {
            display: flex !important;
        }

        #word-bank-container {
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden text-slate-700 flex flex-col bg-slate-50">

    <!-- HOME SCREEN -->
    <div id="home-screen" class="active-screen flex-1 flex flex-col items-center justify-start p-4 overflow-y-auto">
        <!-- Compact Header -->
        <header class="w-full max-w-2xl mb-4 text-center mt-2">
            <h1 class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-sky-500 mb-1 drop-shadow-sm">Sentence Scramble</h1>
            <p class="text-slate-500 font-medium text-sm">Lesson 6: Business Tricks</p>
        </header>

        <!-- Compact Difficulty Selector -->
        <div class="w-full max-w-md bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-6">
            <label class="block text-xs font-bold text-slate-700 mb-2 flex items-center gap-2">
                <div class="p-1 bg-indigo-100 text-indigo-600 rounded-md"><i data-lucide="bar-chart-2" class="w-3 h-3"></i></div>
                DIFFICULTY
            </label>
            <div class="flex items-center gap-3">
                <span class="text-[10px] text-slate-400 font-bold">EASY</span>
                <input type="range" id="diff-slider" min="40" max="100" step="10" value="70" 
                       class="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                <span class="text-[10px] text-slate-400 font-bold">HARD</span>
            </div>
            <div class="mt-1 text-center">
                <span id="diff-display" class="inline-block px-2 py-0.5 bg-indigo-50 text-indigo-700 text-xs font-bold rounded-full">70% Blanks</span>
            </div>
        </div>

        <!-- Compact Levels List -->
        <div id="level-list" class="w-full max-w-md space-y-5 pb-10">
            <!-- Group 1 -->
            <div>
                <h3 class="text-base font-bold text-slate-700 mb-2 flex items-center">
                    <span class="w-6 h-6 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mr-2 text-xs font-bold shadow-sm">R</span>
                    Reading: BOGO Deals
                </h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="startGame('r1')" class="level-btn group relative p-3 bg-white border border-slate-200 rounded-xl hover:border-indigo-400 hover:shadow-md transition-all text-left" data-id="r1">
                        <div class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">Task 1</div>
                        <div class="font-bold text-slate-700 text-sm group-hover:text-indigo-600">Introduction</div>
                        <div class="status-icon absolute top-2 right-2 opacity-0 text-emerald-500"><i data-lucide="check-circle-2" class="w-4 h-4 fill-emerald-50"></i></div>
                    </button>
                    <button onclick="startGame('r2')" class="level-btn group relative p-3 bg-white border border-slate-200 rounded-xl hover:border-indigo-400 hover:shadow-md transition-all text-left" data-id="r2">
                        <div class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">Task 2</div>
                        <div class="font-bold text-slate-700 text-sm group-hover:text-indigo-600">The Trick</div>
                        <div class="status-icon absolute top-2 right-2 opacity-0 text-emerald-500"><i data-lucide="check-circle-2" class="w-4 h-4 fill-emerald-50"></i></div>
                    </button>
                    <button onclick="startGame('r3')" class="level-btn group relative p-3 bg-white border border-slate-200 rounded-xl hover:border-indigo-400 hover:shadow-md transition-all text-left" data-id="r3">
                        <div class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">Task 3</div>
                        <div class="font-bold text-slate-700 text-sm group-hover:text-indigo-600">Profit Secret</div>
                        <div class="status-icon absolute top-2 right-2 opacity-0 text-emerald-500"><i data-lucide="check-circle-2" class="w-4 h-4 fill-emerald-50"></i></div>
                    </button>
                    <button onclick="startGame('r4')" class="level-btn group relative p-3 bg-white border border-slate-200 rounded-xl hover:border-indigo-400 hover:shadow-md transition-all text-left" data-id="r4">
                        <div class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">Task 4</div>
                        <div class="font-bold text-slate-700 text-sm group-hover:text-indigo-600">Conclusion</div>
                        <div class="status-icon absolute top-2 right-2 opacity-0 text-emerald-500"><i data-lucide="check-circle-2" class="w-4 h-4 fill-emerald-50"></i></div>
                    </button>
                </div>
            </div>

            <!-- Group 2 -->
            <div>
                <h3 class="text-base font-bold text-slate-700 mb-2 flex items-center">
                    <span class="w-6 h-6 bg-pink-100 text-pink-600 rounded-full flex items-center justify-center mr-2 text-xs font-bold shadow-sm">D</span>
                    Dialogue: Shopping
                </h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="startGame('d1')" class="level-btn group relative p-3 bg-white border border-slate-200 rounded-xl hover:border-pink-400 hover:shadow-md transition-all text-left" data-id="d1">
                        <div class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">Task 1</div>
                        <div class="font-bold text-slate-700 text-sm group-hover:text-pink-600">The Cost</div>
                        <div class="status-icon absolute top-2 right-2 opacity-0 text-emerald-500"><i data-lucide="check-circle-2" class="w-4 h-4 fill-emerald-50"></i></div>
                    </button>
                    <button onclick="startGame('d2')" class="level-btn group relative p-3 bg-white border border-slate-200 rounded-xl hover:border-pink-400 hover:shadow-md transition-all text-left" data-id="d2">
                        <div class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">Task 2</div>
                        <div class="font-bold text-slate-700 text-sm group-hover:text-pink-600">Temptation</div>
                        <div class="status-icon absolute top-2 right-2 opacity-0 text-emerald-500"><i data-lucide="check-circle-2" class="w-4 h-4 fill-emerald-50"></i></div>
                    </button>
                    <button onclick="startGame('d3')" class="level-btn group relative p-3 bg-white border border-slate-200 rounded-xl hover:border-pink-400 hover:shadow-md transition-all text-left" data-id="d3">
                        <div class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">Task 3</div>
                        <div class="font-bold text-slate-700 text-sm group-hover:text-pink-600">Where's Rice?</div>
                        <div class="status-icon absolute top-2 right-2 opacity-0 text-emerald-500"><i data-lucide="check-circle-2" class="w-4 h-4 fill-emerald-50"></i></div>
                    </button>
                    <button onclick="startGame('d4')" class="level-btn group relative p-3 bg-white border border-slate-200 rounded-xl hover:border-pink-400 hover:shadow-md transition-all text-left" data-id="d4">
                        <div class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">Task 4</div>
                        <div class="font-bold text-slate-700 text-sm group-hover:text-pink-600">Eye Level Rule</div>
                        <div class="status-icon absolute top-2 right-2 opacity-0 text-emerald-500"><i data-lucide="check-circle-2" class="w-4 h-4 fill-emerald-50"></i></div>
                    </button>
                </div>
            </div>

            <!-- Group 3 -->
            <div>
                <h3 class="text-base font-bold text-slate-700 mb-2 flex items-center">
                    <span class="w-6 h-6 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mr-2 text-xs font-bold shadow-sm">F</span>
                    Adv: Fair Trade
                </h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="startGame('f1')" class="level-btn group relative p-3 bg-white border border-slate-200 rounded-xl hover:border-amber-400 hover:shadow-md transition-all text-left" data-id="f1">
                        <div class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">Task 1</div>
                        <div class="font-bold text-slate-700 text-sm group-hover:text-amber-600">Tom's Story</div>
                        <div class="status-icon absolute top-2 right-2 opacity-0 text-emerald-500"><i data-lucide="check-circle-2" class="w-4 h-4 fill-emerald-50"></i></div>
                    </button>
                    <button onclick="startGame('f2')" class="level-btn group relative p-3 bg-white border border-slate-200 rounded-xl hover:border-amber-400 hover:shadow-md transition-all text-left" data-id="f2">
                        <div class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">Task 2</div>
                        <div class="font-bold text-slate-700 text-sm group-hover:text-amber-600">Lucy's Success</div>
                        <div class="status-icon absolute top-2 right-2 opacity-0 text-emerald-500"><i data-lucide="check-circle-2" class="w-4 h-4 fill-emerald-50"></i></div>
                    </button>
                </div>
            </div>
            
            <div class="mt-6 text-center">
                <button onclick="resetProgress()" class="text-xs text-rose-400 underline hover:text-rose-600 transition">Reset Progress</button>
            </div>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="flex-col h-full bg-slate-50 relative">
        <!-- Ultra Compact Header -->
        <div class="bg-white px-3 py-2 shadow-sm border-b border-slate-200 flex items-center justify-between shrink-0 z-20">
            <button onclick="goHome()" class="p-1.5 -ml-1 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </button>
            
            <!-- Title & Timer -->
            <div class="text-center flex flex-col items-center">
                <div class="text-[9px] text-indigo-400 uppercase font-bold tracking-widest leading-none" id="game-level-id">TASK R1</div>
                <div class="font-mono font-bold text-slate-700 text-base tabular-nums tracking-tight leading-none mt-0.5" id="game-timer">00:00</div>
            </div>

            <!-- Compact Font Control -->
            <div class="flex items-center gap-0.5 bg-slate-100 rounded p-0.5">
                <button onclick="adjustFontSize(-2)" class="w-7 h-7 flex items-center justify-center rounded bg-white text-slate-500 shadow-sm border border-slate-200 active:scale-95 hover:text-indigo-600 font-serif font-bold text-xs">A-</button>
                <button onclick="adjustFontSize(2)" class="w-7 h-7 flex items-center justify-center rounded bg-white text-slate-500 shadow-sm border border-slate-200 active:scale-95 hover:text-indigo-600 font-serif font-bold text-base">A+</button>
            </div>
        </div>

        <!-- Scrollable Game Area -->
        <!-- Added dynamic-text-area class to wrapper -->
        <!-- pb-[50vh] ensures last item can be scrolled to view -->
        <div id="game-container" class="dynamic-text-area flex-1 overflow-y-auto p-2 pb-[50vh] space-y-2">
            <!-- Sentences will be injected here -->
        </div>

        <!-- Controls & Word Bank (Fixed Bottom, Compact) -->
        <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur shadow-[0_-4px_20px_-5px_rgba(0,0,0,0.1)] z-30 flex flex-col border-t border-indigo-100">
            
            <!-- Toolbar -->
            <div class="flex items-center justify-between px-3 py-2 border-b border-slate-100">
                <div class="flex items-center gap-2">
                    <div class="relative inline-block w-9 h-5 align-middle select-none">
                        <input type="checkbox" name="toggle" id="quick-fill-toggle" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-[3px] border-slate-300 appearance-none cursor-pointer transition-all duration-300 top-0.5 left-0.5"/>
                        <label for="quick-fill-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer transition-colors duration-300"></label>
                    </div>
                    <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Quick Fill</span>
                </div>
                <button onclick="checkAnswers()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-1.5 rounded-full font-bold shadow-md shadow-indigo-200 active:transform active:scale-95 transition flex items-center gap-1.5 text-sm">
                    <i data-lucide="check" class="w-3.5 h-3.5"></i> Check
                </button>
            </div>

            <!-- Word Bank (Reduced Height) -->
            <!-- Modified: Changed class from "p-2" to "pl-3 py-2 pr-14" to create a safe scroll zone on the right side -->
            <div id="word-bank-container" class="pl-3 py-2 pr-14 overflow-y-auto bg-slate-50/80" style="height: 150px;">
                <div id="word-bank" class="flex flex-wrap gap-1.5 justify-center pb-6 pt-1">
                    <!-- Words injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- END SCREEN -->
    <div id="end-screen" class="flex-col items-center justify-center p-6 bg-white z-50 overflow-y-auto">
        <div class="w-full max-w-lg bg-white p-6 rounded-2xl shadow-xl border border-slate-100 text-center space-y-4">
            <div class="w-20 h-20 bg-emerald-100 text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-2 animate-bounce ring-4 ring-emerald-50">
                <i data-lucide="trophy" class="w-10 h-10 stroke-[1.5]"></i>
            </div>
            
            <div>
                <h2 class="text-2xl font-extrabold text-slate-800 mb-1">Excellent!</h2>
                <p class="text-slate-500 text-sm">You completed the task successfully.</p>
            </div>

            <div class="grid grid-cols-2 gap-3 my-4">
                <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <div class="text-[9px] text-slate-400 uppercase font-bold tracking-wider mb-0.5">Time</div>
                    <div class="text-xl font-bold text-slate-700 font-mono" id="result-time">00:45</div>
                </div>
                <div class="bg-indigo-50 p-3 rounded-xl border border-indigo-100">
                    <div class="text-[9px] text-indigo-400 uppercase font-bold tracking-wider mb-0.5">Difficulty</div>
                    <div class="text-xl font-bold text-indigo-600" id="result-diff">70%</div>
                </div>
            </div>

            <div id="result-review" class="text-left bg-yellow-50 p-4 rounded-xl border border-yellow-100 text-sm text-slate-700 leading-relaxed max-h-48 overflow-y-auto mb-4 font-serif shadow-inner">
                <!-- Full text review -->
            </div>

            <div class="flex gap-2">
                <button onclick="goHome()" class="flex-1 py-3 rounded-lg border-2 border-slate-200 font-bold text-slate-500 hover:bg-slate-50 hover:text-slate-700 transition text-sm">Back</button>
                <button onclick="downloadReport()" class="flex-1 py-3 rounded-lg bg-indigo-600 text-white font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:-translate-y-0.5 transition flex items-center justify-center gap-1.5 text-sm">
                    <i data-lucide="download" class="w-4 h-4"></i> Save
                </button>
            </div>
        </div>
        <!-- Hidden capture area -->
        <div id="capture-area" class="fixed top-0 left-0 -z-50 bg-white p-12 w-[600px] pointer-events-none opacity-0 font-serif">
            <div class="text-center border-b-2 border-indigo-100 pb-6 mb-6">
                <h1 class="text-3xl font-extrabold text-indigo-800 mb-2">Learning Report</h1>
                <p class="text-slate-400">English Sentence Scramble</p>
            </div>
            <div class="flex justify-between text-sm text-slate-500 mb-8 font-sans">
                <p><strong>Level:</strong> <span id="cap-level"></span></p>
                <p><strong>Date:</strong> <span id="cap-date"></span></p>
                <p><strong>Time:</strong> <span id="cap-time"></span></p>
            </div>
            <div id="cap-content" class="text-lg leading-relaxed text-slate-800 bg-slate-50 p-8 rounded-xl border border-slate-100"></div>
            <div class="mt-8 text-center text-xs text-slate-300 uppercase tracking-widest">Keep Learning</div>
        </div>
    </div>

    <script>
        // --- 1. DATA ---
        const levelsDB = {
            'r1': {
                title: 'Introduction to BOGO',
                sentences: [
                    { en: "Buy one, get one free sounds like a good deal for anyone who wants to spend money wisely.", ch: "買一送一對任何想要明智消費的人來說，聽起來都是個划算的交易。" },
                    { en: "However, is it really as good as it appears to be?", ch: "然而，它真的像看起來那麼好嗎？" },
                    { en: "BOGO is the kind of sales promotion which businesses love to use.", ch: "BOGO 是商家喜歡使用的促銷手法。" },
                    { en: "It's very common, and it fools many people into spending more money than they first planned to.", ch: "它非常普遍，並且愚弄了許多人，讓他們花了比原先計畫更多的錢。" }
                ]
            },
            'r2': {
                title: 'The Trick',
                sentences: [
                    { en: "Here's how it works.", ch: "它的運作方式是這樣的。" },
                    { en: "Customers who fall for the trick buy one item at the full price and get a second one for free.", ch: "上當的顧客以原價購買一件商品，並免費獲得第二件。" },
                    { en: "At this point, some of you might ask why businesses don't just sell each item at half price.", ch: "這時，有些人可能會問為什麼商家不直接以半價出售每件商品。" },
                    { en: "But for those who understand the game, the answer is quite clear.", ch: "但對於那些了解這場遊戲的人來說，答案相當清楚。" }
                ]
            },
            'r3': {
                title: 'Profit Secret',
                sentences: [
                    { en: "The secret lies in the profits that these stores expect to make.", ch: "秘密在於這些商店預期獲得的利潤。" },
                    { en: "Besides enjoying larger profits, businesses also often cheat customers out of their money with BOGO deals.", ch: "除了享有更大的利潤外，商家還經常利用 BOGO 優惠騙取顧客的錢。" },
                    { en: "They simply sell the first item at a price that is higher than the full price.", ch: "他們只是以高於原價的價格出售第一件商品。" },
                    { en: "That covers the cost of the free one.", ch: "這涵蓋了免費那件商品的成本。" }
                ]
            },
            'r4': {
                title: 'Conclusion',
                sentences: [
                    { en: "As you can see, free is not always a good deal for the people who are pulling out their wallets.", ch: "如你所見，「免費」對掏錢包的人來說並不總是划算的交易。" },
                    { en: "Most of the time, you just end up spending more on something you don't need.", ch: "大多數時候，你只是花更多的錢買了你不需要的東西。" },
                    { en: "So, next time you're out shopping, be sure to watch out for these sales tricks.", ch: "所以，下次你去購物時，務必小心這些銷售陷阱。" },
                    { en: "Then, you'll be a smart shopper whose money is never wasted.", ch: "這樣，你就會成為一個錢從不白花的聰明購物者。" }
                ]
            },
            'd1': {
                title: 'Shopping Cost',
                sentences: [
                    { en: "Hey, Dad. We're back from the supermarket.", ch: "嘿，爸。我們從超市回來了。" },
                    { en: "Wow! How much did all that cost?", ch: "哇！那些總共花了多少錢？" },
                    { en: "It cost three thousand dollars in total.", ch: "總共花了三千元。" },
                    { en: "I thought you were just going there to get some rice for the week.", ch: "我以為你們只是要去那裡買這個禮拜要吃的米。" }
                ]
            },
            'd2': {
                title: 'The Temptation',
                sentences: [
                    { en: "We were, but then we saw many products that were on sale.", ch: "我們是啊，但後來我們看到很多特價商品。" },
                    { en: "We just couldn't pass them up.", ch: "我們就是無法錯過它們。" },
                    { en: "All the clerks there were very helpful.", ch: "那裡的店員都很熱心。" },
                    { en: "She gave us some free samples to try.", ch: "她給了我們一些免費樣品試吃。" }
                ]
            },
            'd3': {
                title: "Where's Rice?",
                sentences: [
                    { en: "Some of them were good. That's why we also bought some cheese.", ch: "有些很好吃。這就是為什麼我們也買了一些起司。" },
                    { en: "Hey! I'm looking through all the things you bought, and I don't see any rice.", ch: "嘿！我翻遍了你們買的所有東西，卻沒看到米。" },
                    { en: "You're right. Come to think of it, I didn't see any on the shelves.", ch: "你說得對。這樣一想，我在架上也沒看到任何米。" }
                ]
            },
            'd4': {
                title: "Eye Level Rule",
                sentences: [
                    { en: "My guess is that you probably weren't looking at the bottom ones.", ch: "我猜你們可能沒有看底層的貨架。" },
                    { en: "Oh, no. Are you saying I followed the eye level rule?", ch: "喔不。你是說我遵循了視線高度規則嗎？" },
                    { en: "Yes, next time you go to a store, don't just let your eyes decide what to get.", ch: "是的，下次你去商店，別只讓你的眼睛決定要買什麼。" },
                    { en: "Make sure every cent is spent wisely.", ch: "確保每一分錢都花得明智。" }
                ]
            },
            'f1': {
                title: "Tom's Story",
                sentences: [
                    { en: "We work hard to grow our coffee beans, but then we get almost nothing when we sell them.", ch: "我們辛勤種植咖啡豆，但賣出時幾乎一無所獲。" },
                    { en: "The price of coffee beans is just too low for us.", ch: "咖啡豆的價格對我們來說太低了。" },
                    { en: "So we can't keep our children in school, buy food, or pay for health care.", ch: "所以我們無法讓孩子上學、買食物或支付醫療費用。" }
                ]
            },
            'f2': {
                title: "Lucy's Success",
                sentences: [
                    { en: "We use the money we get from selling the beans to pay for food, clothes, medicine, and school.", ch: "我們用賣豆子的錢來支付食物、衣服、藥品和學費。" },
                    { en: "Before the fair trade deal, we seldom got paid and had to borrow money.", ch: "在公平貿易協議之前，我們很少拿到錢，而且必須借錢。" },
                    { en: "Now, we are paid a fair price for our coffee beans in cash and on time.", ch: "現在，我們的咖啡豆能以合理的價格、現金且準時地獲得報酬。" }
                ]
            }
        };

        // --- 2. STATE ---
        let currentLevelId = null;
        let timerInterval = null;
        let startTime = 0;
        let activeWords = []; 
        let quickFillMode = false;
        let selectedWordId = null; 
        
        // Font Size State
        let currentFontSize = 18; // px

        // --- 3. DOM HELPERS ---
        const $ = id => document.getElementById(id);
        const screens = ['home-screen', 'game-screen', 'end-screen'];

        function showScreen(id) {
            screens.forEach(s => $(s).classList.remove('active-screen'));
            $(id).classList.add('active-screen');
        }

        // --- 4. INIT ---
        window.onload = () => {
            lucide.createIcons();
            loadProgress();
            
            $('diff-slider').addEventListener('input', (e) => {
                $('diff-display').textContent = e.target.value + '% Blanks';
            });

            $('quick-fill-toggle').addEventListener('change', (e) => {
                quickFillMode = e.target.checked;
                // Clear selection if switching modes
                if (selectedWordId) {
                    const el = document.querySelector(`.word-card[data-id="${selectedWordId}"]`);
                    if(el) el.classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-50');
                    selectedWordId = null;
                }
            });
        };

        function loadProgress() {
            const progress = JSON.parse(localStorage.getItem('eng_game_progress') || '{}');
            document.querySelectorAll('.level-btn').forEach(btn => {
                const id = btn.getAttribute('data-id');
                if (progress[id]) {
                    btn.querySelector('.status-icon').classList.remove('opacity-0');
                    btn.classList.add('border-emerald-200', 'bg-emerald-50');
                }
            });
        }

        function resetProgress() {
            if(confirm('Reset all progress?')) {
                localStorage.removeItem('eng_game_progress');
                location.reload();
            }
        }

        // --- 5. FONT SIZE LOGIC ---
        function adjustFontSize(change) {
            currentFontSize += change;
            // Limit range: 14px to 32px
            if (currentFontSize < 14) currentFontSize = 14;
            if (currentFontSize > 32) currentFontSize = 32;
            
            // Apply to CSS Variable
            document.documentElement.style.setProperty('--game-font-size', currentFontSize + 'px');
        }

        // --- 6. GAME LOGIC ---
        function startGame(levelId) {
            currentLevelId = levelId;
            const diff = parseInt($('diff-slider').value) / 100;
            const levelData = levelsDB[levelId];
            
            // Build UI
            const container = $('game-container');
            container.innerHTML = '';
            $('word-bank').innerHTML = '';
            $('game-level-id').textContent = `${levelId.toUpperCase()}: ${levelData.title}`;
            
            let wordBankList = [];
            let globalWordIdCounter = 0;

            levelData.sentences.forEach((sent, sIdx) => {
                // Pre-process sentence
                const words = sent.en.split(/\s+/);
                
                // Tightened wrapper padding and margin
                const wrapper = document.createElement('div');
                wrapper.className = "bg-white p-3 rounded-xl shadow-sm border border-slate-100 mb-1 transition-all hover:shadow-md";
                
                // Chinese Translation - Reduced margin
                const chDiv = document.createElement('div');
                chDiv.className = "text-sm text-slate-400 mb-2 font-medium flex items-center";
                chDiv.innerHTML = `<span class="bg-indigo-50 text-indigo-500 px-1.5 py-0.5 rounded text-[10px] font-bold mr-2">#${sIdx+1}</span> ${sent.ch}`;
                wrapper.appendChild(chDiv);

                // English Area - Tighter gap
                const enDiv = document.createElement('div');
                enDiv.className = "flex flex-wrap items-center gap-y-2 leading-relaxed text-slate-700";
                
                // Determine blanks based on difficulty
                words.forEach((w, wIdx) => {
                    const isBlank = Math.random() < diff;

                    if (isBlank) {
                        const wordId = `w_${levelId}_${sIdx}_${wIdx}_${globalWordIdCounter++}`;
                        
                        // Create Slot
                        const slot = document.createElement('span');
                        slot.className = "slot empty";
                        slot.dataset.answer = w.replace(/[^\w']/g, ''); 
                        slot.dataset.fullWord = w; 
                        slot.dataset.slotId = wordId;
                        
                        // Touch/Click handler
                        slot.addEventListener('click', (e) => handleSlotClick(e, slot));

                        // **NEW: Allow slot to be dragged when filled**
                        initDraggable(slot);

                        enDiv.appendChild(slot);

                        // Add to Word Bank List
                        wordBankList.push({
                            id: wordId,
                            text: w
                        });
                    } else {
                        // Fixed Word
                        const fixed = document.createElement('span');
                        fixed.className = "mx-1 font-semibold";
                        fixed.textContent = w;
                        enDiv.appendChild(fixed);
                    }
                });

                wrapper.appendChild(enDiv);
                container.appendChild(wrapper);
            });

            // Populate Word Bank (Sort Alphabetically A-Z)
            // Modified: Removed random sort, enforced case-insensitive alphabetical sort
            wordBankList.sort((a, b) => a.text.toLowerCase().localeCompare(b.text.toLowerCase()));

            const bankContainer = $('word-bank');
            wordBankList.forEach(item => {
                const btn = document.createElement('div');
                btn.className = "word-card shadow-sm";
                btn.textContent = item.text;
                btn.dataset.id = item.id;
                btn.dataset.text = item.text;
                
                initDraggable(btn);
                
                bankContainer.appendChild(btn);
            });

            // Start Timer
            startTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const delta = Math.floor((Date.now() - startTime) / 1000);
                const m = Math.floor(delta / 60).toString().padStart(2, '0');
                const s = (delta % 60).toString().padStart(2, '0');
                $('game-timer').textContent = `${m}:${s}`;
            }, 1000);

            showScreen('game-screen');
        }

        // --- 7. INTERACTION LOGIC ---

        function handleWordClick(e) {
            if(e.defaultPrevented) return;

            const card = e.currentTarget;
            if(card.classList.contains('used')) return;

            if (quickFillMode) {
                const firstEmpty = document.querySelector('.slot:not(.filled)');
                if (firstEmpty) {
                    fillSlot(firstEmpty, card);
                } else {
                    // Shake effect
                    card.animate([
                        { transform: 'translateX(0)' },
                        { transform: 'translateX(-4px)' },
                        { transform: 'translateX(4px)' },
                        { transform: 'translateX(0)' }
                    ], { duration: 300 });
                }
            } else {
                // Select Mode
                if (selectedWordId === card.dataset.id) {
                    selectedWordId = null;
                    card.classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-50');
                } else {
                    if (selectedWordId) {
                        const prev = document.querySelector(`.word-card[data-id="${selectedWordId}"]`);
                        if(prev) prev.classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-50');
                    }
                    selectedWordId = card.dataset.id;
                    card.classList.add('ring-2', 'ring-indigo-500', 'bg-indigo-50');
                }
            }
        }

        function handleSlotClick(e, slot) {
            if (slot.classList.contains('filled')) {
                returnWordFromSlot(slot);
                return;
            }

            if (!slot.classList.contains('filled') && selectedWordId && !quickFillMode) {
                const card = document.querySelector(`.word-card[data-id="${selectedWordId}"]`);
                if (card && !card.classList.contains('used')) {
                    fillSlot(slot, card);
                    selectedWordId = null;
                    card.classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-50');
                }
            }
        }

        function fillSlot(slot, cardElement) {
            cardElement.classList.add('used');

            slot.textContent = cardElement.dataset.text;
            slot.classList.add('filled');
            slot.classList.remove('empty');
            slot.dataset.filledId = cardElement.dataset.id;

            slot.animate([
                { transform: 'scale(0.9)', opacity: 0.8 },
                { transform: 'scale(1.05)', opacity: 1 },
                { transform: 'scale(1)', opacity: 1 }
            ], { duration: 250, easing: 'cubic-bezier(0.175, 0.885, 0.32, 1.275)' });
        }

        function returnWordFromSlot(slot) {
            const wordId = slot.dataset.filledId;
            if (!wordId) return;

            slot.textContent = '';
            slot.classList.remove('filled', 'correct-lock', 'wrong-shake');
            slot.classList.add('empty');
            delete slot.dataset.filledId;

            const card = document.querySelector(`.word-card[data-id="${wordId}"]`);
            if (card) {
                card.classList.remove('used');
            }
        }

        // --- DRAG & DROP ---
        let dragSrcEl = null;
        let ghostEl = null;
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        function initDraggable(el) {
            el.addEventListener('touchstart', handleDragStart, { passive: false });
            el.addEventListener('touchmove', handleDragMove, { passive: false });
            el.addEventListener('touchend', handleDragEnd);
            el.addEventListener('mousedown', handleDragStart);
        }

        function handleDragStart(e) {
            // **UPDATED: Allow drag if it's a card OR a filled slot**
            if (e.currentTarget.classList.contains('used')) return;
            if (e.currentTarget.classList.contains('slot') && !e.currentTarget.classList.contains('filled')) return;
            
            const isTouch = e.type === 'touchstart';
            const pageX = isTouch ? e.touches[0].pageX : e.pageX;
            const pageY = isTouch ? e.touches[0].pageY : e.pageY;
            
            dragSrcEl = e.currentTarget;
            const rect = dragSrcEl.getBoundingClientRect();
            dragOffsetX = pageX - rect.left;
            dragOffsetY = pageY - rect.top;

            ghostEl = dragSrcEl.cloneNode(true);
            ghostEl.classList.add('dragging-ghost');
            // If dragging a slot, maybe fix style to look like a card? 
            // For now cloning the element is fine, it looks like moving the block.
            
            ghostEl.style.width = rect.width + 'px';
            ghostEl.style.left = (pageX - dragOffsetX) + 'px';
            ghostEl.style.top = (pageY - dragOffsetY) + 'px';
            document.body.appendChild(ghostEl);

            if (!isTouch) {
                document.addEventListener('mousemove', handleDragMove);
                document.addEventListener('mouseup', handleDragEnd);
            }
        }

        function handleDragMove(e) {
            if (!ghostEl) return;
            e.preventDefault(); 

            const isTouch = e.type === 'touchmove';
            const pageX = isTouch ? e.touches[0].pageX : e.pageX;
            const pageY = isTouch ? e.touches[0].pageY : e.pageY;

            ghostEl.style.left = (pageX - dragOffsetX) + 'px';
            ghostEl.style.top = (pageY - dragOffsetY) + 'px';
            ghostEl.style.display = 'none'; 
            
            const elemBelow = document.elementFromPoint(
                isTouch ? e.touches[0].clientX : e.clientX,
                isTouch ? e.touches[0].clientY : e.clientY
            );
            ghostEl.style.display = 'block';

            document.querySelectorAll('.slot').forEach(s => s.style.transform = 'scale(1)');
            if (elemBelow && elemBelow.classList.contains('slot')) {
                elemBelow.style.transform = 'scale(1.1)';
            }
        }

        function handleDragEnd(e) {
            document.removeEventListener('mousemove', handleDragMove);
            document.removeEventListener('mouseup', handleDragEnd);

            if (!ghostEl) return;

            const isTouch = e.type === 'touchend';
            const clientX = isTouch ? e.changedTouches[0].clientX : e.clientX;
            const clientY = isTouch ? e.changedTouches[0].clientY : e.clientY;

            // **UPDATED: Identify Source Card**
            let sourceCard = dragSrcEl;
            if (dragSrcEl.classList.contains('slot')) {
                const wordId = dragSrcEl.dataset.filledId;
                if (wordId) {
                    sourceCard = document.querySelector(`.word-card[data-id="${wordId}"]`);
                } else {
                    // Safety: if something went wrong, just cleanup
                    ghostEl.remove(); ghostEl = null; dragSrcEl = null; return;
                }
            }

            ghostEl.style.display = 'none';
            const elemBelow = document.elementFromPoint(clientX, clientY);
            
            let dropped = false;

            if (elemBelow && elemBelow.classList.contains('slot')) {
                // If dropped on the same slot, treat as no-op or let click logic handle it (if barely moved)
                if (elemBelow !== dragSrcEl) {
                    // 1. If target is filled, empty it (Overwrite/Swap)
                    if (elemBelow.classList.contains('filled')) {
                        returnWordFromSlot(elemBelow);
                    }
                    
                    // 2. If source was a slot, empty it (Move)
                    if (dragSrcEl.classList.contains('slot')) {
                        returnWordFromSlot(dragSrcEl);
                    }
                    
                    // 3. Fill target
                    fillSlot(elemBelow, sourceCard);
                    dropped = true;
                } else {
                     // Dropped on self. 
                     dropped = true; // Mark as dropped to prevent standard fallback
                }
            } else if (dragSrcEl.classList.contains('slot')) {
                // **UPDATED: Dragged out of slot -> Return to bank**
                returnWordFromSlot(dragSrcEl);
                dropped = true;
            }

            ghostEl.remove();
            ghostEl = null;
            document.querySelectorAll('.slot').forEach(s => s.style.transform = 'scale(1)');

            // Handle "Click" fallback only if NOT dragging a filled slot
            // (If dragging a filled slot, clicking handles "Return" via handleSlotClick logic natively, 
            // or we successfully dropped/moved it above)
            if (!dropped && !dragSrcEl.classList.contains('slot')) {
                 handleWordClick({ currentTarget: dragSrcEl, defaultPrevented: false });
            }
            
            dragSrcEl = null;
        }


        // --- 8. CHECK & END ---
        function checkAnswers() {
            const slots = document.querySelectorAll('.slot');
            let allCorrect = true;
            let filledCount = 0;

            slots.forEach(slot => {
                if (!slot.classList.contains('filled')) {
                    allCorrect = false;
                    return;
                }
                filledCount++;

                const currentText = slot.textContent;
                const correctText = slot.dataset.fullWord;

                if (currentText === correctText) {
                    slot.classList.add('correct-lock');
                    slot.classList.remove('wrong-shake');
                } else {
                    allCorrect = false;
                    slot.classList.add('wrong-shake');
                    setTimeout(() => slot.classList.remove('wrong-shake'), 500);
                }
            });

            if (allCorrect && filledCount === slots.length) {
                endGame();
            }
        }

        function endGame() {
            clearInterval(timerInterval);
            const timeStr = $('game-timer').textContent;
            const diffStr = $('diff-display').textContent;
            
            const progress = JSON.parse(localStorage.getItem('eng_game_progress') || '{}');
            progress[currentLevelId] = { time: timeStr, date: new Date().toLocaleDateString(), diff: diffStr };
            localStorage.setItem('eng_game_progress', JSON.stringify(progress));

            $('result-time').textContent = timeStr;
            $('result-diff').textContent = diffStr;
            
            const levelData = levelsDB[currentLevelId];
            let reviewHtml = '';
            levelData.sentences.forEach(s => {
                reviewHtml += `<p class="mb-3"><span class="font-bold text-indigo-700">${s.en}</span> <br><span class="text-xs text-slate-500">${s.ch}</span></p>`;
            });
            $('result-review').innerHTML = reviewHtml;

            $('cap-level').textContent = levelData.title;
            $('cap-date').textContent = new Date().toLocaleDateString();
            $('cap-time').textContent = timeStr;
            $('cap-content').innerHTML = reviewHtml;

            showScreen('end-screen');
            lucide.createIcons();
        }

        function goHome() {
            clearInterval(timerInterval);
            loadProgress(); 
            showScreen('home-screen');
        }

        function downloadReport() {
            const captureArea = $('capture-area');
            captureArea.style.opacity = '1';
            captureArea.style.zIndex = '100'; 

            html2canvas(captureArea, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Lesson6_${currentLevelId}_Report.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
                
                captureArea.style.opacity = '0';
                captureArea.style.zIndex = '-50';
            });
        }
    </script>
</body>
</html>
