<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8上第6章 探索物質組成 - 互動式闖關系統</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor: default;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overscroll-behavior: none;
            -webkit-user-select: none;
            user-select: none;
            overflow-x: hidden;
        }

        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            cursor: text;
        }

        button, a, .clickable {
            cursor: pointer !important;
        }

        .drag-item {
            transition: all 0.2s ease;
            cursor: grab !important;
            touch-action: none;
            -webkit-touch-callout: none;
        }

        .drag-item:active {
            cursor: grabbing !important;
        }

        @media (hover: hover) {
            .drag-item:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            }
        }

        .dragging {
            opacity: 0.5;
            transform: scale(1.05);
            z-index: 1000;
            position: fixed;
            pointer-events: none;
        }

        .cursor-move {
            cursor: move !important;
            touch-action: none;
            -webkit-touch-callout: none;
        }

        .cursor-move:active {
            cursor: grabbing !important;
        }

        .drop-zone {
            transition: all 0.2s ease;
            min-height: 80px;
        }

        .drop-zone.drag-over {
            background: rgba(59, 130, 246, 0.2);
            border: 3px dashed #3b82f6 !important;
            transform: scale(1.02);
        }

        .formula-slot {
            transition: all 0.2s ease;
            min-height: 70px;
            min-width: 100px;
        }

        .formula-slot.drag-over {
            background: rgba(59, 130, 246, 0.3);
            border: 3px dashed #3b82f6 !important;
            transform: scale(1.05);
        }

        .correct-answer {
            animation: correctPulse 0.6s ease-out;
            border: 3px solid #10b981 !important;
            background: rgba(16, 185, 129, 0.1);
        }

        .wrong-answer {
            animation: shake 0.5s ease-out;
            border: 3px solid #ef4444 !important;
            background: rgba(239, 68, 68, 0.1);
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .animate-bounce-slow {
            animation: bounce-slow 2s ease-in-out infinite;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .formula-display {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .progress-bar {
            max-width: 50%;
        }

        @media (max-width: 768px) {
            .progress-bar {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        let touchDragData = null;
        let touchDragElement = null;
        let touchClone = null;
        let touchRemoveCallback = null;
        let touchSourceZoneId = null;

        function handleTouchStartGlobal(e, item, removeCallback) {
            e.preventDefault();
            
            touchDragData = item;
            touchDragElement = e.currentTarget;
            touchRemoveCallback = removeCallback;
            
            const scrollContainer = document.querySelector('.overflow-y-auto');
            if (scrollContainer) {
                scrollContainer.style.overflowY = 'hidden';
                scrollContainer.style.touchAction = 'none';
            }
            
            const sourceZone = touchDragElement.closest('.drop-zone, .formula-slot');
            touchSourceZoneId = sourceZone ? sourceZone.getAttribute('data-zone-id') : null;
            
            const touch = e.touches[0];
            
            touchClone = touchDragElement.cloneNode(true);
            touchClone.style.position = 'fixed';
            touchClone.style.zIndex = '10000';
            touchClone.style.opacity = '0.8';
            touchClone.style.pointerEvents = 'none';
            touchClone.style.width = touchDragElement.offsetWidth + 'px';
            touchClone.style.left = (touch.clientX - touchDragElement.offsetWidth / 2) + 'px';
            touchClone.style.top = (touch.clientY - touchDragElement.offsetHeight / 2) + 'px';
            touchClone.style.transition = 'none';
            document.body.appendChild(touchClone);
            
            touchDragElement.style.opacity = '0.2';
            touchDragElement.style.transform = 'scale(0.95)';
            touchDragElement.style.transition = 'opacity 0.2s, transform 0.2s';
        }

        function handleTouchMoveGlobal(e) {
            if (!touchClone) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const touch = e.touches[0];
            
            touchClone.style.left = (touch.clientX - touchClone.offsetWidth / 2) + 'px';
            touchClone.style.top = (touch.clientY - touchClone.offsetHeight / 2) + 'px';
            
            const dropZones = document.querySelectorAll('.drop-zone, .formula-slot');
            dropZones.forEach(zone => zone.classList.remove('drag-over'));
            
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            if (elementBelow) {
                const dropZone = elementBelow.closest('.drop-zone, .formula-slot');
                if (dropZone) {
                    const targetZoneId = dropZone.getAttribute('data-zone-id');
                    if (targetZoneId !== touchSourceZoneId) {
                        dropZone.classList.add('drag-over');
                    }
                }
            }
        }

        function handleTouchEndGlobal(e, dropCallback) {
            if (!touchClone) return;
            
            const touch = e.changedTouches[0];
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            
            let targetZone = null;
            let targetZoneId = null;
            if (elementBelow) {
                targetZone = elementBelow.closest('.drop-zone, .formula-slot');
                if (targetZone) {
                    targetZoneId = targetZone.getAttribute('data-zone-id');
                }
            }
            
            if (touchClone && touchClone.parentNode) {
                touchClone.parentNode.removeChild(touchClone);
            }
            
            const scrollContainer = document.querySelector('.overflow-y-auto');
            if (scrollContainer) {
                scrollContainer.style.overflowY = 'auto';
                scrollContainer.style.touchAction = '';
            }
            
            const dropZones = document.querySelectorAll('.drop-zone, .formula-slot');
            dropZones.forEach(zone => zone.classList.remove('drag-over'));
            
            const isValidDrop = targetZone && targetZoneId && touchDragData && 
                              targetZoneId !== touchSourceZoneId;
            
            if (isValidDrop && dropCallback) {
                if (touchRemoveCallback) {
                    touchRemoveCallback();
                }
                dropCallback(touchDragData, targetZoneId);
            } else {
                if (touchDragElement) {
                    touchDragElement.style.opacity = '1';
                    touchDragElement.style.transform = 'scale(1)';
                }
            }
            
            touchDragData = null;
            touchDragElement = null;
            touchClone = null;
            touchRemoveCallback = null;
            touchSourceZoneId = null;
        }

        const CHAPTER_DATA = {
            "6-1": [
                {
                    id: "6-1-1",
                    section: "6-1",
                    title: "第一關：金屬與非金屬元素分類",
                    description: "請將以下元素依其性質分類到金屬或非金屬",
                    type: "classification",
                    zones: [
                        { id: 'metal', title: '金屬元素', icon: 'fa-layer-group' },
                        { id: 'nonmetal', title: '非金屬元素', icon: 'fa-cube' }
                    ],
                    items: [
                        { id: 'item1', text: '鐵 (Fe)', val: 'Fe' },
                        { id: 'item2', text: '銅 (Cu)', val: 'Cu' },
                        { id: 'item3', text: '硫 (S)', val: 'S' },
                        { id: 'item4', text: '碳 (C)', val: 'C' },
                        { id: 'item5', text: '鋁 (Al)', val: 'Al' },
                        { id: 'item6', text: '氯 (Cl)', val: 'Cl' },
                        { id: 'item7', text: '金 (Au)', val: 'Au' },
                        { id: 'item8', text: '氧 (O)', val: 'O' },
                        { id: 'item9', text: '銀 (Ag)', val: 'Ag' },
                        { id: 'item10', text: '氮 (N)', val: 'N' }
                    ],
                    solution: {
                        metal: ['Fe', 'Cu', 'Al', 'Au', 'Ag'],
                        nonmetal: ['S', 'C', 'Cl', 'O', 'N']
                    }
                },
                {
                    id: "6-1-2",
                    section: "6-1",
                    title: "第二關：金屬與非金屬性質配對",
                    description: "請將以下性質分類到金屬或非金屬元素",
                    type: "classification",
                    zones: [
                        { id: 'metal_properties', title: '金屬元素的特性', icon: 'fa-gem' },
                        { id: 'nonmetal_properties', title: '非金屬元素的特性', icon: 'fa-cube' }
                    ],
                    items: [
                        { id: 'item1', text: '具有金屬光澤', val: 'metal_luster' },
                        { id: 'item2', text: '大部分為電熱不良導體', val: 'poor_conductor' },
                        { id: 'item3', text: '具有延性與展性', val: 'ductile' },
                        { id: 'item4', text: '容易被敲碎', val: 'brittle' },
                        { id: 'item5', text: '導電性與導熱性佳', val: 'good_conductor' },
                        { id: 'item6', text: '顏色差異大', val: 'various_color' }
                    ],
                    solution: {
                        metal_properties: ['metal_luster', 'good_conductor', 'ductile'],
                        nonmetal_properties: ['various_color', 'brittle', 'poor_conductor']
                    }
                },
                {
                    id: "6-1-3",
                    section: "6-1",
                    title: "第三關：特殊性質配對",
                    description: "請將特性拖拉到對應的物質",
                    type: "classification",
                    zones: [
                        { id: 'graphite', title: '石墨', icon: 'fa-atom' },
                        { id: 'diamond', title: '鑽石', icon: 'fa-gem' },
                        { id: 'mercury', title: '汞（水銀）', icon: 'fa-droplet' },
                        { id: 'gold', title: '金', icon: 'fa-coins' },
                        { id: 'copper', title: '銅', icon: 'fa-circle' },
                        { id: 'activated_carbon', title: '活性碳', icon: 'fa-filter' }
                    ],
                    items: [
                        { id: 'item1', text: '碳的同素異形體，可導電', val: 'graphite_prop' },
                        { id: 'item2', text: '自然界最硬的物質', val: 'diamond_prop' },
                        { id: 'item3', text: '常溫下唯一液態金屬', val: 'mercury_prop' },
                        { id: 'item4', text: '延展性最好的金屬，呈金黃色', val: 'gold_prop' },
                        { id: 'item5', text: '導電性僅次於銀的金屬', val: 'copper_prop' },
                        { id: 'item6', text: '多孔隙，吸附性高，可用於過濾', val: 'activated_carbon_prop' }
                    ],
                    solution: {
                        graphite: ['graphite_prop'],
                        diamond: ['diamond_prop'],
                        mercury: ['mercury_prop'],
                        gold: ['gold_prop'],
                        copper: ['copper_prop'],
                        activated_carbon: ['activated_carbon_prop']
                    }
                }
            ],
            "6-2": [
                {
                    id: "6-2-1",
                    section: "6-2",
                    title: "第一關：元素週期表的族與週期",
                    description: "請將元素分類到其對應的族群",
                    type: "classification",
                    zones: [
                        { id: 'group1', title: '第1族（鹼金屬）', icon: 'fa-fire' },
                        { id: 'group2', title: '第2族（鹼土金屬）', icon: 'fa-mountain' },
                        { id: 'group17', title: '第17族（鹵素）', icon: 'fa-flask-vial' },
                        { id: 'group18', title: '第18族（鈍氣）', icon: 'fa-shield-halved' }
                    ],
                    items: [
                        { id: 'item1', text: '鈉 (Na)', val: 'Na' },
                        { id: 'item2', text: '鎂 (Mg)', val: 'Mg' },
                        { id: 'item3', text: '氦 (He)', val: 'He' },
                        { id: 'item4', text: '氯 (Cl)', val: 'Cl' },
                        { id: 'item5', text: '鉀 (K)', val: 'K' },
                        { id: 'item6', text: '鈣 (Ca)', val: 'Ca' },
                        { id: 'item7', text: '氖 (Ne)', val: 'Ne' },
                        { id: 'item8', text: '氬 (Ar)', val: 'Ar' },
                        { id: 'item9', text: '鋰 (Li)', val: 'Li' },
                        { id: 'item10', text: '鍶 (Sr)', val: 'Sr' },
                        { id: 'item11', text: '氟 (F)', val: 'F' },
                        { id: 'item12', text: '溴 (Br)', val: 'Br' }
                    ],
                    solution: {
                        group1: ['Na', 'K', 'Li'],
                        group2: ['Mg', 'Ca', 'Sr'],
                        group18: ['He', 'Ne', 'Ar'],
                        group17: ['Cl', 'F', 'Br']
                    }
                },
                {
                    id: "6-2-2",
                    section: "6-2",
                    title: "第二關：同族元素的性質",
                    description: "請將以下元素依其化學性質歸類",
                    type: "classification",
                    zones: [
                        { id: 'alkali', title: '鹼金屬（易與水反應）', icon: 'fa-flask' },
                        { id: 'noble', title: '鈍氣（化學性質安定）', icon: 'fa-shield-alt' }
                    ],
                    items: [
                        { id: 'item1', text: '鈉 (Na)', val: 'Na' },
                        { id: 'item2', text: '鉀 (K)', val: 'K' },
                        { id: 'item3', text: '氦 (He)', val: 'He' },
                        { id: 'item4', text: '氖 (Ne)', val: 'Ne' },
                        { id: 'item5', text: '鋰 (Li)', val: 'Li' },
                        { id: 'item6', text: '氬 (Ar)', val: 'Ar' }
                    ],
                    solution: {
                        alkali: ['Na', 'K', 'Li'],
                        noble: ['He', 'Ne', 'Ar']
                    }
                }
            ],
            "6-3": [
                {
                    id: "6-3-1",
                    section: "6-3",
                    title: "第一關：道耳頓的原子說配對",
                    description: "請將原子說的要點與實例配對",
                    type: "classification",
                    zones: [
                        { id: 'concept1', title: '物質由原子組成', icon: 'fa-atom' },
                        { id: 'concept2', title: '相同元素的原子性質相同', icon: 'fa-equals' },
                        { id: 'concept3', title: '化合物由不同原子以固定比例組成', icon: 'fa-layer-group' },
                        { id: 'concept4', title: '化學反應是原子重新組合', icon: 'fa-arrows-rotate' }
                    ],
                    items: [
                        { id: 'item1', text: '金是由金原子組成', val: 'example1' },
                        { id: 'item2', text: '所有氧原子的質量相同', val: 'example2' },
                        { id: 'item3', text: '水分子由2個氫原子和1個氧原子組成', val: 'example3' },
                        { id: 'item4', text: '氫氣與氧氣反應生成水', val: 'example4' }
                    ],
                    solution: {
                        concept1: ['example1'],
                        concept2: ['example2'],
                        concept3: ['example3'],
                        concept4: ['example4']
                    }
                },
                {
                    id: "6-3-2",
                    section: "6-3",
                    title: "第二關：原子結構組成",
                    description: "請將原子的組成粒子分類",
                    type: "classification",
                    zones: [
                        { id: 'nucleus', title: '原子核內', icon: 'fa-circle-dot' },
                        { id: 'electron', title: '原子核外', icon: 'fa-circle' }
                    ],
                    items: [
                        { id: 'item1', text: '質子', val: 'proton' },
                        { id: 'item2', text: '中子', val: 'neutron' },
                        { id: 'item3', text: '電子', val: 'electron' }
                    ],
                    solution: {
                        nucleus: ['proton', 'neutron'],
                        electron: ['electron']
                    }
                },
                {
                    id: "6-3-3",
                    section: "6-3",
                    title: "第三關：原子計算",
                    description: "鈹原子（⁹₄Be）中，請分類以下數值",
                    type: "classification",
                    zones: [
                        { id: 'four', title: '數值為 4', icon: 'fa-4' },
                        { id: 'five', title: '數值為 5', icon: 'fa-5' },
                        { id: 'nine', title: '數值為 9', icon: 'fa-9' }
                    ],
                    items: [
                        { id: 'item1', text: '質子數', val: 'proton_num' },
                        { id: 'item2', text: '中子數', val: 'neutron_num' },
                        { id: 'item3', text: '電子數', val: 'electron_num' },
                        { id: 'item4', text: '質量數', val: 'mass_num' }
                    ],
                    solution: {
                        four: ['proton_num', 'electron_num'],
                        five: ['neutron_num'],
                        nine: ['mass_num']
                    }
                }
            ],
            "6-4": [
                {
                    id: "6-4-1",
                    section: "6-4",
                    title: "第一關：分子的原子數",
                    description: "請將分子依其原子數分類",
                    type: "classification",
                    zones: [
                        { id: 'one', title: '1個原子', icon: 'fa-circle' },
                        { id: 'two', title: '2個原子', icon: 'fa-grip-lines' },
                        { id: 'three', title: '3個原子', icon: 'fa-ellipsis' }
                    ],
                    items: [
                        { id: 'item1', text: '氫氣 (H₂)', val: 'h2' },
                        { id: 'item2', text: '水 (H₂O)', val: 'h2o' },
                        { id: 'item3', text: '臭氧 (O₃)', val: 'o3' },
                        { id: 'item4', text: '氦氣 (He)', val: 'he' }
                    ],
                    solution: {
                        one: ['he'],
                        two: ['h2'],
                        three: ['h2o', 'o3']
                    }
                },
                {
                    id: "6-4-2",
                    section: "6-4",
                    title: "第二關：常見化學式",
                    description: "請將物質名稱與化學式配對（拖到對應位置）",
                    type: "classification",
                    zones: [
                        { id: 'h2o', title: 'H₂O', icon: 'fa-droplet' },
                        { id: 'o2', title: 'O₂', icon: 'fa-wind' },
                        { id: 'nacl', title: 'NaCl', icon: 'fa-cube' },
                        { id: 'co2', title: 'CO₂', icon: 'fa-cloud' }
                    ],
                    items: [
                        { id: 'item1', text: '水', val: 'water' },
                        { id: 'item2', text: '氧氣', val: 'oxygen' },
                        { id: 'item3', text: '氯化鈉（食鹽）', val: 'salt' },
                        { id: 'item4', text: '二氧化碳', val: 'carbon_dioxide' }
                    ],
                    solution: {
                        h2o: ['water'],
                        o2: ['oxygen'],
                        nacl: ['salt'],
                        co2: ['carbon_dioxide']
                    }
                },
                {
                    id: "6-4-3",
                    section: "6-4",
                    title: "第三關：物質分類",
                    description: "請將以下物質依其分類歸類",
                    type: "classification",
                    zones: [
                        { id: 'element', title: '元素', icon: 'fa-atom' },
                        { id: 'compound', title: '化合物', icon: 'fa-flask' },
                        { id: 'mixture', title: '混合物', icon: 'fa-blender' }
                    ],
                    items: [
                        { id: 'item1', text: '氧氣 (O₂)', val: 'oxygen_o2' },
                        { id: 'item2', text: '水 (H₂O)', val: 'water_h2o' },
                        { id: 'item3', text: '空氣', val: 'air' },
                        { id: 'item4', text: '鐵 (Fe)', val: 'iron_fe' },
                        { id: 'item5', text: '食鹽水', val: 'saltwater' },
                        { id: 'item6', text: '二氧化碳 (CO₂)', val: 'co2' }
                    ],
                    solution: {
                        element: ['oxygen_o2', 'iron_fe'],
                        compound: ['water_h2o', 'co2'],
                        mixture: ['air', 'saltwater']
                    }
                }
            ]
        };

        const themeColors = {
            '6-1': { 
                primary: 'from-green-400 to-emerald-600',
                header: 'from-green-500 to-emerald-700', 
                badge: 'bg-green-500' 
            },
            '6-2': { 
                primary: 'from-blue-400 to-blue-600',
                header: 'from-blue-500 to-blue-700', 
                badge: 'bg-blue-500' 
            },
            '6-3': { 
                primary: 'from-purple-400 to-pink-600',
                header: 'from-purple-500 to-pink-700', 
                badge: 'bg-purple-500' 
            },
            '6-4': { 
                primary: 'from-orange-400 to-red-600',
                header: 'from-orange-500 to-red-700', 
                badge: 'bg-orange-500' 
            }
        };

        function App() {
            const [screen, setScreen] = useState('section_select');
            const [currentSection, setCurrentSection] = useState(null);
            const [currentLevelIndex, setCurrentLevelIndex] = useState(0);
            const [gameState, setGameState] = useState('playing');
            const [droppedItems, setDroppedItems] = useState({});
            const [draggedItem, setDraggedItem] = useState(null);
            const [startTime, setStartTime] = useState(null);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [attempts, setAttempts] = useState(0);
            const [showFeedback, setShowFeedback] = useState(false);
            const [feedbackType, setFeedbackType] = useState('');
            const [sectionCompletionStatus, setSectionCompletionStatus] = useState({});
            const [fontScale, setFontScale] = useState(100);
            const [errorLog, setErrorLog] = useState([]);

            useEffect(() => {
                const saved = localStorage.getItem('chapter6_completion_status');
                if (saved) {
                    setSectionCompletionStatus(JSON.parse(saved));
                }
                const savedFont = localStorage.getItem('chapter6_font_scale');
                if (savedFont) {
                    setFontScale(parseInt(savedFont));
                }
            }, []);

            useEffect(() => {
                document.documentElement.style.fontSize = `${fontScale}%`;
            }, [fontScale]);

            useEffect(() => {
                let timer;
                if (gameState === 'playing' && startTime) {
                    timer = setInterval(() => {
                        setElapsedTime(Math.floor((new Date() - startTime) / 1000));
                    }, 1000);
                }
                return () => {
                    if (timer) clearInterval(timer);
                };
            }, [gameState, startTime]);

            const increaseFontSize = () => {
                setFontScale(prev => {
                    const newScale = Math.min(prev + 10, 150);
                    localStorage.setItem('chapter6_font_scale', newScale);
                    return newScale;
                });
            };

            const decreaseFontSize = () => {
                setFontScale(prev => {
                    const newScale = Math.max(prev - 10, 70);
                    localStorage.setItem('chapter6_font_scale', newScale);
                    return newScale;
                });
            };

            const clearAllProgress = () => {
                if (confirm('確定要清除所有完成記錄嗎？此操作無法復原。')) {
                    localStorage.removeItem('chapter6_completion_status');
                    localStorage.removeItem('chapter6_font_scale');
                    setSectionCompletionStatus({});
                    setFontScale(100);
                    alert('已清除所有記錄！');
                }
            };

            const startSection = (sectionId) => {
                setCurrentSection(sectionId);
                setCurrentLevelIndex(0);
                setDroppedItems({});
                setStartTime(new Date());
                setElapsedTime(0);
                setAttempts(0);
                setErrorLog([]);
                setScreen('game');
                setGameState('playing');
            };

            const handleDragStart = (e, item) => {
                setDraggedItem(item);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragEnd = () => {
                setDraggedItem(null);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDrop = (e, targetZoneId) => {
                if (e) {
                    e.preventDefault();
                }
                
                const item = draggedItem || touchDragData;
                if (!item) return;

                const currentLevel = CHAPTER_DATA[currentSection][currentLevelIndex];
                
                if (currentLevel.type === 'classification') {
                    const newDroppedItems = { ...droppedItems };
                    
                    Object.keys(newDroppedItems).forEach(zoneId => {
                        newDroppedItems[zoneId] = newDroppedItems[zoneId].filter(val => val !== item.val);
                    });
                    
                    if (targetZoneId !== 'items') {
                        if (!newDroppedItems[targetZoneId]) {
                            newDroppedItems[targetZoneId] = [];
                        }
                        newDroppedItems[targetZoneId].push(item.val);
                    }
                    
                    setDroppedItems(newDroppedItems);
                }
                
                setDraggedItem(null);
            };

            const checkAnswer = () => {
                const currentLevel = CHAPTER_DATA[currentSection][currentLevelIndex];
                setAttempts(prev => prev + 1);
                
                let allCorrect = true;
                const newErrorLog = [...errorLog];
                const zoneResults = {};

                if (currentLevel.type === 'classification') {
                    // 檢查每個分類框
                    Object.keys(currentLevel.solution).forEach(zoneId => {
                        const correctVals = currentLevel.solution[zoneId];
                        const userVals = droppedItems[zoneId] || [];
                        
                        // 檢查：該區域的所有項目的val都必須在正確答案中
                        // 且該區域必須有項目（不能為空）
                        const isCorrect = userVals.length > 0 &&
                                        userVals.every(val => correctVals.includes(val));
                        
                        zoneResults[zoneId] = isCorrect;
                        
                        if (!isCorrect) {
                            allCorrect = false;
                            
                            // 記錄錯誤：找出不該在這個框的項目
                            if (userVals.length > 0) {
                                for (const val of userVals) {
                                    if (!correctVals.includes(val)) {
                                        const itemText = currentLevel.items.find(i => i.val === val)?.text;
                                        const correctZone = Object.keys(currentLevel.solution).find(zId =>
                                            currentLevel.solution[zId].includes(val)
                                        );
                                        const correctZoneTitle = correctZone ? 
                                            currentLevel.zones.find(z => z.id === correctZone)?.title : '未知';
                                        const wrongZoneTitle = currentLevel.zones.find(z => z.id === zoneId)?.title;
                                        
                                        newErrorLog.push({
                                            levelTitle: currentLevel.title,
                                            wrongAnswer: `${itemText} → ${wrongZoneTitle}`,
                                            correctAnswer: `${itemText} → ${correctZoneTitle}`
                                        });
                                    }
                                }
                            }
                        }
                    });
                    
                    // 額外檢查：確保所有項目都已分類
                    const allItemsPlaced = Object.values(droppedItems).flat().length === currentLevel.items.length;
                    if (!allItemsPlaced) {
                        allCorrect = false;
                    }
                    
                    // 顯示各分類框的狀態
                    currentLevel.zones.forEach(zone => {
                        const zoneElement = document.querySelector(`[data-zone-id="${zone.id}"]`);
                        if (zoneElement) {
                            zoneElement.classList.remove('correct-answer', 'wrong-answer');
                            if (zoneResults[zone.id]) {
                                zoneElement.classList.add('correct-answer');
                            } else if ((droppedItems[zone.id] || []).length > 0) {
                                // 只有在有項目但不正確時才顯示錯誤
                                zoneElement.classList.add('wrong-answer');
                            }
                            
                            // 移除動畫類別
                            setTimeout(() => {
                                zoneElement.classList.remove('correct-answer', 'wrong-answer');
                            }, 1500);
                        }
                    });
                }

                setErrorLog(newErrorLog);
                
                if (allCorrect) {
                    setFeedbackType('correct');
                    setShowFeedback(true);
                    setTimeout(() => {
                        setShowFeedback(false);
                        if (currentLevelIndex < CHAPTER_DATA[currentSection].length - 1) {
                            setCurrentLevelIndex(prev => prev + 1);
                            setDroppedItems({});
                        } else {
                            const totalTime = Math.floor((new Date() - startTime) / 1000);
                            const newStatus = {
                                ...sectionCompletionStatus,
                                [currentSection]: {
                                    completed: true,
                                    completedAt: new Date().toISOString(),
                                    totalTime: totalTime,
                                    attempts: attempts + 1,
                                    errors: newErrorLog.length,
                                    errorLog: newErrorLog
                                }
                            };
                            setSectionCompletionStatus(newStatus);
                            localStorage.setItem('chapter6_completion_status', JSON.stringify(newStatus));
                            setScreen('section_complete');
                            
                            const allComplete = Object.keys(CHAPTER_DATA).every(
                                sectionId => newStatus[sectionId]?.completed
                            );
                            if (allComplete) {
                                setTimeout(() => setScreen('all_complete'), 2000);
                            }
                        }
                    }, 1500);
                }
            };

            const downloadCertificate = async (elementId, filename) => {
                try {
                    const element = document.getElementById(elementId);
                    if (!element) return;
                    
                    const canvas = await html2canvas(element, {
                        scale: 2,
                        backgroundColor: '#ffffff'
                    });
                    
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = canvas.toDataURL();
                    link.click();
                } catch (error) {
                    console.error('下載證書失敗:', error);
                    alert('下載證書時發生錯誤，請稍後再試');
                }
            };

            if (screen === 'section_select') {
                const sections = [
                    { id: '6-1', title: '6-1 元素', icon: 'fa-flask', levels: 3, color: 'from-green-400 to-emerald-600' },
                    { id: '6-2', title: '6-2 元素週期表', icon: 'fa-table', levels: 2, color: 'from-blue-400 to-blue-600' },
                    { id: '6-3', title: '6-3 原子的結構', icon: 'fa-atom', levels: 3, color: 'from-purple-400 to-pink-600' },
                    { id: '6-4', title: '6-4 分子與化學式', icon: 'fa-flask-vial', levels: 3, color: 'from-orange-400 to-red-600' }
                ];

                const allComplete = sections.every(s => sectionCompletionStatus[s.id]?.completed);

                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-600 via-blue-600 to-cyan-500 p-4">
                        <div className="max-w-6xl mx-auto">
                            <div className="text-center mb-8 fade-in">
                                <div className="flex justify-between items-center mb-4">
                                    <div className="flex gap-2">
                                        <button
                                            onClick={decreaseFontSize}
                                            className="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg font-bold transition-all backdrop-blur-sm"
                                            title="縮小字體"
                                        >
                                            A⁻
                                        </button>
                                        <button
                                            onClick={increaseFontSize}
                                            className="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg font-bold transition-all backdrop-blur-sm"
                                            title="放大字體"
                                        >
                                            A⁺
                                        </button>
                                    </div>
                                    <div className="flex gap-2">
                                        {allComplete && (
                                            <button
                                                onClick={() => setScreen('all_complete')}
                                                className="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg font-bold transition-all"
                                            >
                                                <i className="fas fa-certificate mr-2"></i>
                                                查看完成證書
                                            </button>
                                        )}
                                        <button
                                            onClick={clearAllProgress}
                                            className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold transition-all"
                                        >
                                            <i className="fas fa-trash mr-2"></i>
                                            清除記錄
                                        </button>
                                    </div>
                                </div>
                                <h1 className="text-6xl font-black text-white mb-4 drop-shadow-lg">
                                    <i className="fas fa-atom mr-4"></i>
                                    第6章 探索物質組成
                                </h1>
                                <p className="text-2xl text-white/90 font-bold">
                                    選擇一個小節開始學習
                                </p>
                            </div>

                            <div className="grid md:grid-cols-2 gap-6">
                                {sections.map(section => {
                                    const status = sectionCompletionStatus[section.id];
                                    const isCompleted = status?.completed;
                                    
                                    return (
                                        <div
                                            key={section.id}
                                            className={`bg-gradient-to-br ${section.color} rounded-3xl p-8 shadow-2xl transform hover:scale-105 transition-all cursor-pointer fade-in`}
                                            onClick={() => startSection(section.id)}
                                        >
                                            <div className="flex items-center justify-between mb-6">
                                                <div className="flex items-center gap-4">
                                                    <div className="bg-white/20 backdrop-blur-sm rounded-2xl p-4">
                                                        <i className={`fas ${section.icon} text-5xl text-white`}></i>
                                                    </div>
                                                    <div className="text-white">
                                                        <h2 className="text-3xl font-black mb-1">{section.title}</h2>
                                                        <p className="text-lg opacity-90">{section.levels} 個關卡</p>
                                                    </div>
                                                </div>
                                                {isCompleted && (
                                                    <div className="bg-yellow-400 rounded-full p-3 animate-bounce-slow">
                                                        <i className="fas fa-check text-2xl text-white"></i>
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {isCompleted && (
                                                <div className="bg-white/20 backdrop-blur-sm rounded-xl p-4 text-white">
                                                    <div className="grid grid-cols-3 gap-4 text-center">
                                                        <div>
                                                            <div className="text-2xl font-bold">{status.totalTime}秒</div>
                                                            <div className="text-sm opacity-90">完成時間</div>
                                                        </div>
                                                        <div>
                                                            <div className="text-2xl font-bold">{status.attempts}次</div>
                                                            <div className="text-sm opacity-90">嘗試次數</div>
                                                        </div>
                                                        <div>
                                                            <div className="text-2xl font-bold">{status.errors}</div>
                                                            <div className="text-sm opacity-90">錯誤次數</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                            
                                            <div className="mt-4 text-center">
                                                <button className="bg-white text-gray-800 px-8 py-3 rounded-xl font-bold hover:bg-gray-100 transition-all">
                                                    {isCompleted ? '再次挑戰' : '開始遊戲'}
                                                    <i className="fas fa-arrow-right ml-2"></i>
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            }

            if (screen === 'game') {
                const currentLevel = CHAPTER_DATA[currentSection][currentLevelIndex];
                const totalLevels = CHAPTER_DATA[currentSection].length;
                const theme = themeColors[currentSection];

                const totalItems = currentLevel.items.length;
                const placedItems = Object.values(droppedItems).flat().length;
                const allPlaced = placedItems === totalItems;

                return (
                    <div className={`min-h-screen bg-gradient-to-br ${theme.primary} p-4`}>
                        <div className="max-w-7xl mx-auto">
                            <div className={`bg-gradient-to-r ${theme.header} rounded-2xl p-4 mb-6 shadow-lg`}>
                                <div className="flex flex-wrap items-center justify-between gap-4">
                                    <div className="flex items-center gap-4">
                                        <button
                                            onClick={decreaseFontSize}
                                            className="bg-white/20 hover:bg-white/30 text-white px-3 py-2 rounded-lg font-bold transition-all"
                                        >
                                            A⁻
                                        </button>
                                        <button
                                            onClick={increaseFontSize}
                                            className="bg-white/20 hover:bg-white/30 text-white px-3 py-2 rounded-lg font-bold transition-all"
                                        >
                                            A⁺
                                        </button>
                                        <div>
                                            <h2 className="text-2xl font-black text-white">{currentLevel.title}</h2>
                                            <p className="text-white/90">{currentLevel.description}</p>
                                        </div>
                                    </div>
                                    
                                    <div className="flex items-center gap-6">
                                        <div className="progress-bar bg-white/20 rounded-full px-6 py-2 backdrop-blur-sm">
                                            <span className="text-white font-bold">
                                                關卡 {currentLevelIndex + 1}/{totalLevels}
                                            </span>
                                        </div>
                                        <div className="bg-white/20 rounded-full px-6 py-2 backdrop-blur-sm">
                                            <i className="fas fa-clock text-white mr-2"></i>
                                            <span className="text-white font-bold">{elapsedTime}秒</span>
                                        </div>
                                        <button
                                            onClick={() => setScreen('section_select')}
                                            className="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-xl font-bold transition-all"
                                        >
                                            <i className="fas fa-home mr-2"></i>
                                            返回
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {currentLevel.type === 'classification' && (
                                <>
                                    {currentLevel.zones.length <= 3 ? (
                                        <div className="grid md:grid-cols-2 gap-6">
                                            <div className="space-y-4">
                                                <div className="bg-white/20 backdrop-blur-sm rounded-xl p-4">
                                                    <h3 className="text-xl font-bold text-white mb-4">
                                                        <i className="fas fa-boxes mr-2"></i>
                                                        待分類項目
                                                    </h3>
                                                    <div
                                                        data-zone-id="items"
                                                        onDrop={(e) => handleDrop(e, 'items')}
                                                        onDragOver={handleDragOver}
                                                        className="drop-zone bg-white/10 rounded-xl p-4 min-h-[120px] border-2 border-dashed border-white/30"
                                                    >
                                                        <div className="flex flex-wrap gap-3">
                                                            {currentLevel.items.filter(item => {
                                                                const isPlaced = Object.values(droppedItems).flat().includes(item.val);
                                                                return !isPlaced;
                                                            }).map(item => (
                                                                <div
                                                                    key={item.id}
                                                                    draggable
                                                                    onDragStart={(e) => handleDragStart(e, item)}
                                                                    onDragEnd={handleDragEnd}
                                                                    onTouchStart={(e) => handleTouchStartGlobal(e, item, null)}
                                                                    onTouchMove={handleTouchMoveGlobal}
                                                                    onTouchEnd={(e) => handleTouchEndGlobal(e, (data, targetZoneId) => {
                                                                        handleDrop(null, targetZoneId);
                                                                    })}
                                                                    className="drag-item bg-blue-500 text-white px-6 py-3 rounded-lg cursor-move hover:bg-blue-600 transition-colors shadow-lg"
                                                                >
                                                                    {item.text}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="space-y-4">
                                                {currentLevel.zones.map(zone => (
                                                    <div
                                                        key={zone.id}
                                                        data-zone-id={zone.id}
                                                        onDrop={(e) => handleDrop(e, zone.id)}
                                                        onDragOver={handleDragOver}
                                                        className="drop-zone bg-white rounded-xl p-6 border-4 border-dashed border-gray-300 hover:border-blue-400 transition-all min-h-[120px]"
                                                    >
                                                        <h3 className="text-xl font-bold text-gray-800 mb-4">
                                                            <i className={`fas ${zone.icon} mr-2`}></i>
                                                            {zone.title}
                                                        </h3>
                                                        <div className="flex flex-wrap gap-2">
                                                            {(droppedItems[zone.id] || []).map(val => {
                                                                const item = currentLevel.items.find(i => i.val === val);
                                                                return item ? (
                                                                    <div
                                                                        key={item.id}
                                                                        draggable
                                                                        onDragStart={(e) => handleDragStart(e, item)}
                                                                        onDragEnd={handleDragEnd}
                                                                        onTouchStart={(e) => handleTouchStartGlobal(e, item, () => {
                                                                            const newItems = {...droppedItems};
                                                                            newItems[zone.id] = newItems[zone.id].filter(v => v !== item.val);
                                                                            setDroppedItems(newItems);
                                                                        })}
                                                                        onTouchMove={handleTouchMoveGlobal}
                                                                        onTouchEnd={(e) => handleTouchEndGlobal(e, (data, targetZoneId) => {
                                                                            handleDrop(null, targetZoneId);
                                                                        })}
                                                                        className="drag-item bg-green-500 text-white px-4 py-2 rounded-lg cursor-move hover:bg-green-600 transition-colors shadow-md"
                                                                    >
                                                                        {item.text}
                                                                    </div>
                                                                ) : null;
                                                            })}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ) : (
                                        <>
                                            <div className={`grid gap-6 mb-6 ${
                                                currentLevel.zones.length === 4 ? 'md:grid-cols-2' : 'md:grid-cols-3'
                                            }`}>
                                                {currentLevel.zones.map(zone => (
                                                    <div
                                                        key={zone.id}
                                                        data-zone-id={zone.id}
                                                        onDrop={(e) => handleDrop(e, zone.id)}
                                                        onDragOver={handleDragOver}
                                                        className="drop-zone bg-white rounded-xl p-6 border-4 border-dashed border-gray-300 hover:border-blue-400 transition-all min-h-[120px]"
                                                    >
                                                        <h3 className="text-lg font-bold text-gray-800 mb-3">
                                                            <i className={`fas ${zone.icon} mr-2`}></i>
                                                            {zone.title}
                                                        </h3>
                                                        <div className="flex flex-wrap gap-2">
                                                            {(droppedItems[zone.id] || []).map(val => {
                                                                const item = currentLevel.items.find(i => i.val === val);
                                                                return item ? (
                                                                    <div
                                                                        key={item.id}
                                                                        draggable
                                                                        onDragStart={(e) => handleDragStart(e, item)}
                                                                        onDragEnd={handleDragEnd}
                                                                        onTouchStart={(e) => handleTouchStartGlobal(e, item, () => {
                                                                            const newItems = {...droppedItems};
                                                                            newItems[zone.id] = newItems[zone.id].filter(v => v !== item.val);
                                                                            setDroppedItems(newItems);
                                                                        })}
                                                                        onTouchMove={handleTouchMoveGlobal}
                                                                        onTouchEnd={(e) => handleTouchEndGlobal(e, (data, targetZoneId) => {
                                                                            handleDrop(null, targetZoneId);
                                                                        })}
                                                                        className="drag-item bg-green-500 text-white px-4 py-2 rounded-lg cursor-move hover:bg-green-600 transition-colors shadow-md text-sm"
                                                                    >
                                                                        {item.text}
                                                                    </div>
                                                                ) : null;
                                                            })}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>

                                            <div className="bg-white/20 backdrop-blur-sm rounded-xl p-6">
                                                <h3 className="text-xl font-bold text-white mb-4">
                                                    <i className="fas fa-boxes mr-2"></i>
                                                    待分類項目
                                                </h3>
                                                <div
                                                    data-zone-id="items"
                                                    onDrop={(e) => handleDrop(e, 'items')}
                                                    onDragOver={handleDragOver}
                                                    className="drop-zone bg-white/10 rounded-xl p-4 min-h-[120px] border-2 border-dashed border-white/30"
                                                >
                                                    <div className="flex flex-wrap gap-3">
                                                        {currentLevel.items.filter(item => {
                                                            const isPlaced = Object.values(droppedItems).flat().includes(item.val);
                                                            return !isPlaced;
                                                        }).map(item => (
                                                            <div
                                                                key={item.id}
                                                                draggable
                                                                onDragStart={(e) => handleDragStart(e, item)}
                                                                onDragEnd={handleDragEnd}
                                                                onTouchStart={(e) => handleTouchStartGlobal(e, item, null)}
                                                                onTouchMove={handleTouchMoveGlobal}
                                                                onTouchEnd={(e) => handleTouchEndGlobal(e, (data, targetZoneId) => {
                                                                    handleDrop(null, targetZoneId);
                                                                })}
                                                                className="drag-item bg-blue-500 text-white px-6 py-3 rounded-lg cursor-move hover:bg-blue-600 transition-colors shadow-lg"
                                                            >
                                                                {item.text}
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        </>
                                    )}
                                </>
                            )}

                            <div className="text-center mt-8">
                                <button
                                    onClick={checkAnswer}
                                    disabled={!allPlaced}
                                    className={`px-12 py-4 rounded-2xl text-xl font-black transition-all transform hover:scale-105 shadow-2xl ${
                                        allPlaced
                                            ? 'bg-green-500 hover:bg-green-600 text-white cursor-pointer'
                                            : 'bg-gray-400 text-gray-200 cursor-not-allowed'
                                    }`}
                                >
                                    {allPlaced ? (
                                        <>
                                            <i className="fas fa-check-circle mr-2"></i>
                                            檢查答案
                                        </>
                                    ) : (
                                        <>
                                            <i className="fas fa-exclamation-circle mr-2"></i>
                                            尚未完成 ({placedItems}/{totalItems})
                                        </>
                                    )}
                                </button>
                            </div>

                            {showFeedback && (
                                <div className={`fixed inset-0 flex items-center justify-center z-50 ${feedbackType === 'correct' ? 'bg-green-500/50' : 'bg-red-500/50'} backdrop-blur-sm`}>
                                    <div className={`${feedbackType === 'correct' ? 'bg-green-500' : 'bg-red-500'} text-white px-16 py-12 rounded-3xl shadow-2xl text-center ${feedbackType === 'wrong' ? 'shake' : ''}`}>
                                        <i className={`fas ${feedbackType === 'correct' ? 'fa-check-circle' : 'fa-times-circle'} text-8xl mb-4`}></i>
                                        <p className="text-4xl font-black">
                                            {feedbackType === 'correct' ? '答對了！' : '再試一次！'}
                                        </p>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            if (screen === 'section_complete') {
                const status = sectionCompletionStatus[currentSection];
                
                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-400 via-blue-500 to-purple-600 p-4 flex items-center justify-center">
                        <div className="max-w-2xl w-full">
                            <div id="section-certificate" className="bg-white rounded-3xl p-8 shadow-2xl fade-in">
                                <div className="text-center mb-6">
                                    <i className="fas fa-trophy text-8xl text-yellow-500 mb-4 animate-bounce-slow"></i>
                                    <h1 className="text-5xl font-black text-gray-800 mb-2">
                                        完成 {currentSection}！
                                    </h1>
                                    <p className="text-2xl text-gray-600">
                                        恭喜你完成本小節所有關卡
                                    </p>
                                </div>

                                <div className="bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl p-6 mb-6">
                                    <div className="grid grid-cols-3 gap-4 text-center">
                                        <div>
                                            <div className="text-3xl font-bold text-blue-600">{status.totalTime}</div>
                                            <div className="text-gray-600">秒</div>
                                        </div>
                                        <div>
                                            <div className="text-3xl font-bold text-purple-600">{status.attempts}</div>
                                            <div className="text-gray-600">嘗試次數</div>
                                        </div>
                                        <div>
                                            <div className="text-3xl font-bold text-red-600">{status.errors}</div>
                                            <div className="text-gray-600">錯誤次數</div>
                                        </div>
                                    </div>
                                </div>

                                {status.errorLog && status.errorLog.length > 0 && (
                                    <div className="bg-red-50 rounded-2xl p-6 mb-6">
                                        <h3 className="text-lg font-bold text-red-800 mb-3">
                                            <i className="fas fa-exclamation-triangle mr-2"></i>
                                            錯誤記錄（供複習）
                                        </h3>
                                        <div className="space-y-2 max-h-60 overflow-y-auto">
                                            {status.errorLog.map((error, index) => (
                                                <div key={index} className="bg-white p-3 rounded-lg text-sm">
                                                    <div className="font-bold text-gray-700">{error.levelTitle}</div>
                                                    <div className="text-red-600">✗ 你的答案：{error.wrongAnswer}</div>
                                                    <div className="text-green-600">✓ 正確答案：{error.correctAnswer}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                <div className="text-center text-sm text-gray-500">
                                    完成時間：{new Date(status.completedAt).toLocaleString('zh-TW')}
                                </div>
                            </div>
                            
                            <div className="flex justify-center gap-4 mt-6">
                                <button
                                    onClick={() => downloadCertificate('section-certificate', `第6章_${currentSection}_完成證書.png`)}
                                    className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-bold transition-all"
                                >
                                    <i className="fas fa-download mr-2"></i>
                                    下載證書
                                </button>
                                <button
                                    onClick={() => setScreen('section_select')}
                                    className="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-bold transition-all"
                                >
                                    <i className="fas fa-home mr-2"></i>
                                    返回選單
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (screen === 'all_complete') {
                const allErrorLogs = Object.keys(sectionCompletionStatus).reduce((acc, sectionId) => {
                    const status = sectionCompletionStatus[sectionId];
                    if (status.errorLog && status.errorLog.length > 0) {
                        acc[sectionId] = status.errorLog;
                    }
                    return acc;
                }, {});

                const totalErrors = Object.values(allErrorLogs).reduce((sum, logs) => sum + logs.length, 0);

                return (
                    <div className="min-h-screen bg-gradient-to-br from-yellow-400 via-orange-500 to-red-500 p-4 flex items-center justify-center">
                        <div className="max-w-3xl w-full">
                            <div id="all-complete-certificate" className="bg-white rounded-3xl p-8 shadow-2xl">
                                <div className="text-center mb-6">
                                    <i className="fas fa-medal text-8xl text-yellow-500 mb-4 animate-bounce-slow"></i>
                                    <h1 className="text-5xl font-black text-gray-800 mb-2">
                                        🏆 全章完成！
                                    </h1>
                                    <p className="text-2xl text-gray-600 mb-4">
                                        恭喜你完成第6章所有小節
                                    </p>
                                    <div className="text-lg text-gray-500">
                                        探索物質組成
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    {Object.keys(CHAPTER_DATA).map(sectionId => {
                                        const status = sectionCompletionStatus[sectionId];
                                        return (
                                            <div key={sectionId} className="bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl p-4 text-center">
                                                <div className="text-lg font-bold text-gray-800 mb-2">{sectionId}</div>
                                                <div className="text-sm text-gray-600">{status.totalTime}秒</div>
                                                <div className="text-sm text-gray-600">{status.errors}錯</div>
                                            </div>
                                        );
                                    })}
                                </div>

                                {totalErrors > 0 && (
                                    <div className="bg-red-50 rounded-2xl p-6 mb-6">
                                        <h3 className="text-xl font-bold text-red-800 mb-4">
                                            <i className="fas fa-clipboard-list mr-2"></i>
                                            全章錯誤記錄（共 {totalErrors} 個錯誤）
                                        </h3>
                                        <div className="space-y-4 max-h-96 overflow-y-auto">
                                            {Object.keys(allErrorLogs).map(sectionId => (
                                                <div key={sectionId}>
                                                    <div className="font-bold text-gray-700 mb-2">{sectionId}</div>
                                                    <div className="space-y-2">
                                                        {allErrorLogs[sectionId].map((error, index) => (
                                                            <div key={index} className="bg-white p-3 rounded-lg text-sm">
                                                                <div className="font-bold text-gray-600">{error.levelTitle}</div>
                                                                <div className="text-red-600">✗ {error.wrongAnswer}</div>
                                                                <div className="text-green-600">✓ {error.correctAnswer}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                <div className="text-center">
                                    <div className="text-2xl font-bold text-gray-800 mb-2">
                                        你是化學探索大師！
                                    </div>
                                    <div className="text-gray-600">
                                        繼續保持學習的熱情 💪
                                    </div>
                                </div>
                            </div>

                            <div className="flex justify-center gap-4 mt-6">
                                <button
                                    onClick={() => downloadCertificate('all-complete-certificate', '第6章_全章完成證書.png')}
                                    className="bg-yellow-500 hover:bg-yellow-600 text-white px-8 py-4 rounded-xl font-bold transition-all text-lg"
                                >
                                    <i className="fas fa-download mr-2"></i>
                                    下載完成證書
                                </button>
                                <button
                                    onClick={() => setScreen('section_select')}
                                    className="bg-blue-500 hover:bg-blue-600 text-white px-8 py-4 rounded-xl font-bold transition-all text-lg"
                                >
                                    <i className="fas fa-home mr-2"></i>
                                    返回選單
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
