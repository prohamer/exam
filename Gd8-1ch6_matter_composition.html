<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8ä¸Šç¬¬6ç«  æ¢ç´¢ç‰©è³ªçµ„æˆ - äº’å‹•å¼é—–é—œç³»çµ±</title>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- html2canvas for certificate -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * {
            font-family: 'Noto+Sans TC', sans-serif;
        }
        
        body {
            margin: 0;
            padding: 0;
            overscroll-behavior: none;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .drag-item {
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .drop-zone {
            min-height: 120px;
            transition: all 0.3s ease;
        }
        
        .drop-zone.drag-over {
            background-color: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            transform: scale(1.02);
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        .float {
            animation: float 3s ease-in-out infinite;
        }
        
        .progress-bar {
            max-width: 50%;
        }
        
        @media (max-width: 768px) {
            .progress-bar {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ===========================================
        // GAME DATA - æ‰€æœ‰é—œå¡æ•¸æ“š
        // ===========================================
        const CHAPTER_DATA = {
            "6-1": [
                {
                    id: "6-1-1",
                    section: "6-1",
                    title: "ç¬¬ä¸€é—œï¼šé‡‘å±¬èˆ‡éé‡‘å±¬å…ƒç´ åˆ†é¡",
                    description: "è«‹å°‡ä»¥ä¸‹å…ƒç´ ä¾å…¶æ€§è³ªåˆ†é¡åˆ°é‡‘å±¬æˆ–éé‡‘å±¬",
                    type: "classification",
                    zones: [
                        { id: 'metal', title: 'é‡‘å±¬å…ƒç´ ', icon: 'fa-layer-group' },
                        { id: 'nonmetal', title: 'éé‡‘å±¬å…ƒç´ ', icon: 'fa-cube' }
                    ],
                    items: [
                        { id: 'item1', text: 'éµ (Fe)', val: 'Fe' },
                        { id: 'item2', text: 'éŠ… (Cu)', val: 'Cu' },
                        { id: 'item3', text: 'ç¡« (S)', val: 'S' },
                        { id: 'item4', text: 'ç¢³ (C)', val: 'C' },
                        { id: 'item5', text: 'é‹ (Al)', val: 'Al' },
                        { id: 'item6', text: 'æ°¯ (Cl)', val: 'Cl' },
                        { id: 'item7', text: 'é‡‘ (Au)', val: 'Au' },
                        { id: 'item8', text: 'æ°§ (O)', val: 'O' },
                        { id: 'item9', text: 'éŠ€ (Ag)', val: 'Ag' },
                        { id: 'item10', text: 'æ°® (N)', val: 'N' }
                    ],
                    solution: {
                        metal: ['Fe', 'Cu', 'Al', 'Au', 'Ag'],
                        nonmetal: ['S', 'C', 'Cl', 'O', 'N']
                    }
                },
                {
                    id: "6-1-2",
                    section: "6-1",
                    title: "ç¬¬äºŒé—œï¼šé‡‘å±¬èˆ‡éé‡‘å±¬æ€§è³ªé…å°",
                    description: "è«‹å°‡ä»¥ä¸‹æ€§è³ªåˆ†é¡åˆ°é‡‘å±¬æˆ–éé‡‘å±¬å…ƒç´ ",
                    type: "classification",
                    zones: [
                        { id: 'metal_properties', title: 'é‡‘å±¬å…ƒç´ çš„ç‰¹æ€§', icon: 'fa-gem' },
                        { id: 'nonmetal_properties', title: 'éé‡‘å±¬å…ƒç´ çš„ç‰¹æ€§', icon: 'fa-cube' }
                    ],
                    items: [
                        { id: 'item1', text: 'å…·æœ‰é‡‘å±¬å…‰æ¾¤', val: 'metal_luster' },
                        { id: 'item2', text: 'å¤§éƒ¨åˆ†ç‚ºé›»ç†±ä¸è‰¯å°é«”', val: 'poor_conductor' },
                        { id: 'item3', text: 'å…·æœ‰å»¶æ€§èˆ‡å±•æ€§', val: 'ductile' },
                        { id: 'item4', text: 'å®¹æ˜“è¢«æ•²ç¢', val: 'brittle' },
                        { id: 'item5', text: 'å°é›»æ€§èˆ‡å°ç†±æ€§ä½³', val: 'good_conductor' },
                        { id: 'item6', text: 'é¡è‰²å·®ç•°å¤§', val: 'various_color' }
                    ],
                    solution: {
                        metal_properties: ['metal_luster', 'good_conductor', 'ductile'],
                        nonmetal_properties: ['various_color', 'brittle', 'poor_conductor']
                    }
                },
                {
                    id: "6-1-3",
                    section: "6-1",
                    title: "ç¬¬ä¸‰é—œï¼šç‰¹æ®Šæ€§è³ªé…å°",
                    description: "è«‹å°‡ç‰¹æ€§æ‹–æ‹‰åˆ°å°æ‡‰çš„ç‰©è³ª",
                    type: "classification",
                    zones: [
                        { id: 'graphite', title: 'çŸ³å¢¨', icon: 'fa-atom' },
                        { id: 'diamond', title: 'é‘½çŸ³', icon: 'fa-gem' },
                        { id: 'mercury', title: 'æ±ï¼ˆæ°´éŠ€ï¼‰', icon: 'fa-droplet' },
                        { id: 'gold', title: 'é‡‘', icon: 'fa-coins' },
                        { id: 'copper', title: 'éŠ…', icon: 'fa-circle' },
                        { id: 'activated_carbon', title: 'æ´»æ€§ç¢³', icon: 'fa-filter' }
                    ],
                    items: [
                        { id: 'item1', text: 'ç¢³çš„åŒç´ ç•°å½¢é«”ï¼Œå¯å°é›»', val: 'graphite_prop' },
                        { id: 'item2', text: 'è‡ªç„¶ç•Œæœ€ç¡¬çš„ç‰©è³ª', val: 'diamond_prop' },
                        { id: 'item3', text: 'å¸¸æº«ä¸‹å”¯ä¸€æ¶²æ…‹é‡‘å±¬', val: 'mercury_prop' },
                        { id: 'item4', text: 'å»¶å±•æ€§æœ€å¥½çš„é‡‘å±¬ï¼Œå‘ˆé‡‘é»ƒè‰²', val: 'gold_prop' },
                        { id: 'item5', text: 'å°é›»æ€§åƒ…æ¬¡æ–¼éŠ€çš„é‡‘å±¬', val: 'copper_prop' },
                        { id: 'item6', text: 'å¤šå­”éš™ï¼Œå¸é™„æ€§é«˜ï¼Œå¯ç”¨æ–¼éæ¿¾', val: 'activated_carbon_prop' }
                    ],
                    solution: {
                        graphite: ['graphite_prop'],
                        diamond: ['diamond_prop'],
                        mercury: ['mercury_prop'],
                        gold: ['gold_prop'],
                        copper: ['copper_prop'],
                        activated_carbon: ['activated_carbon_prop']
                    }
                }
            ],
            "6-2": [
                {
                    id: "6-2-1",
                    section: "6-2",
                    title: "ç¬¬ä¸€é—œï¼šå…ƒç´ é€±æœŸè¡¨çš„æ—èˆ‡é€±æœŸ",
                    description: "è«‹å°‡å…ƒç´ åˆ†é¡åˆ°å…¶å°æ‡‰çš„æ—ç¾¤",
                    type: "classification",
                    zones: [
                        { id: 'group1', title: 'ç¬¬1æ—ï¼ˆé¹¼é‡‘å±¬ï¼‰', icon: 'fa-fire' },
                        { id: 'group2', title: 'ç¬¬2æ—ï¼ˆé¹¼åœŸé‡‘å±¬ï¼‰', icon: 'fa-mountain' },
                        { id: 'group17', title: 'ç¬¬17æ—ï¼ˆé¹µç´ ï¼‰', icon: 'fa-flask-vial' },
                        { id: 'group18', title: 'ç¬¬18æ—ï¼ˆéˆæ°£ï¼‰', icon: 'fa-shield-halved' }
                    ],
                    items: [
                        { id: 'item1', text: 'éˆ‰ (Na)', val: 'Na' },
                        { id: 'item2', text: 'é‚ (Mg)', val: 'Mg' },
                        { id: 'item3', text: 'æ°¦ (He)', val: 'He' },
                        { id: 'item4', text: 'æ°¯ (Cl)', val: 'Cl' },
                        { id: 'item5', text: 'é‰€ (K)', val: 'K' },
                        { id: 'item6', text: 'éˆ£ (Ca)', val: 'Ca' },
                        { id: 'item7', text: 'æ°– (Ne)', val: 'Ne' },
                        { id: 'item8', text: 'æ°¬ (Ar)', val: 'Ar' },
                        { id: 'item9', text: 'é‹° (Li)', val: 'Li' },
                        { id: 'item10', text: 'é¶ (Sr)', val: 'Sr' },
                        { id: 'item11', text: 'æ°Ÿ (F)', val: 'F' },
                        { id: 'item12', text: 'æº´ (Br)', val: 'Br' }
                    ],
                    solution: {
                        group1: ['Na', 'K', 'Li'],
                        group2: ['Mg', 'Ca', 'Sr'],
                        group18: ['He', 'Ne', 'Ar'],
                        group17: ['Cl', 'F', 'Br']
                    }
                },
                {
                    id: "6-2-2",
                    section: "6-2",
                    title: "ç¬¬äºŒé—œï¼šåŒæ—å…ƒç´ çš„æ€§è³ª",
                    description: "è«‹å°‡ä»¥ä¸‹å…ƒç´ ä¾å…¶åŒ–å­¸æ€§è³ªæ­¸é¡",
                    type: "classification",
                    zones: [
                        { id: 'alkali', title: 'é¹¼é‡‘å±¬ï¼ˆæ˜“èˆ‡æ°´åæ‡‰ï¼‰', icon: 'fa-flask' },
                        { id: 'noble', title: 'éˆæ°£ï¼ˆåŒ–å­¸æ€§è³ªå®‰å®šï¼‰', icon: 'fa-shield-alt' }
                    ],
                    items: [
                        { id: 'item1', text: 'éˆ‰ (Na)', val: 'Na' },
                        { id: 'item2', text: 'é‰€ (K)', val: 'K' },
                        { id: 'item3', text: 'æ°¦ (He)', val: 'He' },
                        { id: 'item4', text: 'æ°– (Ne)', val: 'Ne' },
                        { id: 'item5', text: 'é‹° (Li)', val: 'Li' },
                        { id: 'item6', text: 'æ°¬ (Ar)', val: 'Ar' }
                    ],
                    solution: {
                        alkali: ['Na', 'K', 'Li'],
                        noble: ['He', 'Ne', 'Ar']
                    }
                }
            ],
            "6-3": [
                {
                    id: "6-3-1",
                    section: "6-3",
                    title: "ç¬¬ä¸€é—œï¼šé“è€³é “çš„åŸå­èªª",
                    description: "è«‹å°‡åŸå­èªªçš„è¦é»èˆ‡å°æ‡‰çš„å¯¦ä¾‹é…å°",
                    type: "formula_match",
                    leftOptions: [
                        { id: 'left1', text: 'ç‰©è³ªç”±åŸå­çµ„æˆ', val: 'concept1' },
                        { id: 'left2', text: 'ç›¸åŒå…ƒç´ çš„åŸå­æ€§è³ªç›¸åŒ', val: 'concept2' },
                        { id: 'left3', text: 'åŒ–åˆç‰©ç”±ä¸åŒåŸå­ä»¥å›ºå®šæ¯”ä¾‹çµ„æˆ', val: 'concept3' },
                        { id: 'left4', text: 'åŒ–å­¸åæ‡‰æ˜¯åŸå­é‡æ–°çµ„åˆ', val: 'concept4' }
                    ],
                    rightOptions: [
                        { id: 'right1', text: 'é‡‘æ˜¯ç”±é‡‘åŸå­çµ„æˆ', val: 'example1' },
                        { id: 'right2', text: 'æ‰€æœ‰æ°§åŸå­çš„è³ªé‡ç›¸åŒ', val: 'example2' },
                        { id: 'right3', text: 'æ°´åˆ†å­ç”±2å€‹æ°«åŸå­å’Œ1å€‹æ°§åŸå­çµ„æˆ', val: 'example3' },
                        { id: 'right4', text: 'æ°«æ°£èˆ‡æ°§æ°£åæ‡‰ç”Ÿæˆæ°´', val: 'example4' }
                    ],
                    solution: {
                        concept1: ['example1'],
                        concept2: ['example2'],
                        concept3: ['example3'],
                        concept4: ['example4']
                    }
                },
                {
                    id: "6-3-2",
                    section: "6-3",
                    title: "ç¬¬äºŒé—œï¼šåŸå­çµæ§‹çš„çµ„æˆ",
                    description: "è«‹å°‡åŸå­çš„çµ„æˆç²’å­å¡«å…¥æ­£ç¢ºä½ç½®",
                    type: "formula",
                    formulaSlots: [
                        { id: 'slot1', position: 'left', placeholder: 'åŸå­æ ¸ = ï¼Ÿ + ï¼Ÿ' },
                        { id: 'slot2', position: 'right', placeholder: 'åŸå­ = åŸå­æ ¸ + ï¼Ÿ' }
                    ],
                    items: [
                        { id: 'item1', text: 'è³ªå­', val: 'proton' },
                        { id: 'item2', text: 'ä¸­å­', val: 'neutron' },
                        { id: 'item3', text: 'é›»å­', val: 'electron' }
                    ],
                    solution: {
                        slot1: ['proton', 'neutron'],
                        slot2: ['electron']
                    }
                },
                {
                    id: "6-3-3",
                    section: "6-3",
                    title: "ç¬¬ä¸‰é—œï¼šè³ªé‡æ•¸èˆ‡åŸå­åºè¨ˆç®—",
                    description: "å·²çŸ¥éˆ¹åŸå­ï¼ˆâ¹â‚„Beï¼‰ï¼Œè«‹è¨ˆç®—å…¶è³ªå­æ•¸ã€ä¸­å­æ•¸èˆ‡é›»å­æ•¸",
                    type: "formula",
                    formulaSlots: [
                        { id: 'slot1', position: 'left', placeholder: 'è³ªå­æ•¸ = ï¼Ÿ' },
                        { id: 'slot2', position: 'middle', placeholder: 'ä¸­å­æ•¸ = ï¼Ÿ' },
                        { id: 'slot3', position: 'right', placeholder: 'é›»å­æ•¸ = ï¼Ÿ' }
                    ],
                    items: [
                        { id: 'item1', text: '4', val: '4' },
                        { id: 'item2', text: '5', val: '5' },
                        { id: 'item3', text: '9', val: '9' }
                    ],
                    solution: {
                        slot1: ['4'],
                        slot2: ['5'],
                        slot3: ['4']
                    }
                }
            ],
            "6-4": [
                {
                    id: "6-4-1",
                    section: "6-4",
                    title: "ç¬¬ä¸€é—œï¼šåˆ†å­çš„çµ„æˆ",
                    description: "è«‹å°‡åˆ†å­èˆ‡å…¶çµ„æˆåŸå­æ•¸é…å°",
                    type: "formula_match",
                    leftOptions: [
                        { id: 'left1', text: 'æ°«æ°£ (Hâ‚‚)', val: 'H2' },
                        { id: 'left2', text: 'æ°´ (Hâ‚‚O)', val: 'H2O' },
                        { id: 'left3', text: 'è‡­æ°§ (Oâ‚ƒ)', val: 'O3' },
                        { id: 'left4', text: 'æ°¦æ°£ (He)', val: 'He' }
                    ],
                    rightOptions: [
                        { id: 'right1', text: '1å€‹åŸå­', val: '1atom' },
                        { id: 'right2', text: '2å€‹åŸå­', val: '2atoms' },
                        { id: 'right3', text: '3å€‹åŸå­ï¼ˆåŒç¨®ï¼‰', val: '3atoms_same' },
                        { id: 'right4', text: '3å€‹åŸå­ï¼ˆä¸åŒç¨®ï¼‰', val: '3atoms_diff' }
                    ],
                    solution: {
                        H2: ['2atoms'],
                        H2O: ['3atoms_diff'],
                        O3: ['3atoms_same'],
                        He: ['1atom']
                    }
                },
                {
                    id: "6-4-2",
                    section: "6-4",
                    title: "ç¬¬äºŒé—œï¼šåŒ–å­¸å¼çš„æ›¸å¯«è¦å‰‡",
                    description: "è«‹å°‡ç‰©è³ªåç¨±èˆ‡å…¶æ­£ç¢ºåŒ–å­¸å¼é…å°",
                    type: "formula_match",
                    leftOptions: [
                        { id: 'left1', text: 'æ°´', val: 'water' },
                        { id: 'left2', text: 'æ°§æ°£', val: 'oxygen' },
                        { id: 'left3', text: 'æ°¯åŒ–éˆ‰', val: 'sodium_chloride' },
                        { id: 'left4', text: 'äºŒæ°§åŒ–ç¢³', val: 'carbon_dioxide' },
                        { id: 'left5', text: 'æ°®æ°£', val: 'nitrogen' },
                        { id: 'left6', text: 'è‡­æ°§', val: 'ozone' },
                        { id: 'left7', text: 'ä¸€æ°§åŒ–ç¢³', val: 'carbon_monoxide' },
                        { id: 'left8', text: 'æ°¨', val: 'ammonia' }
                    ],
                    rightOptions: [
                        { id: 'right1', text: 'Hâ‚‚O', val: 'H2O' },
                        { id: 'right2', text: 'Oâ‚‚', val: 'O2' },
                        { id: 'right3', text: 'NaCl', val: 'NaCl' },
                        { id: 'right4', text: 'COâ‚‚', val: 'CO2' },
                        { id: 'right5', text: 'Nâ‚‚', val: 'N2' },
                        { id: 'right6', text: 'Oâ‚ƒ', val: 'O3' },
                        { id: 'right7', text: 'CO', val: 'CO' },
                        { id: 'right8', text: 'NHâ‚ƒ', val: 'NH3' }
                    ],
                    solution: {
                        water: ['H2O'],
                        oxygen: ['O2'],
                        sodium_chloride: ['NaCl'],
                        carbon_dioxide: ['CO2'],
                        nitrogen: ['N2'],
                        ozone: ['O3'],
                        carbon_monoxide: ['CO'],
                        ammonia: ['NH3']
                    }
                },
                {
                    id: "6-4-3",
                    section: "6-4",
                    title: "ç¬¬ä¸‰é—œï¼šç‰©è³ªçš„åˆ†é¡èˆ‡å®šç¾©é…å°",
                    description: "è«‹å°‡ç‰©è³ªåˆ†é¡èˆ‡å…¶å®šç¾©é…å°",
                    type: "formula_match",
                    leftOptions: [
                        { id: 'left1', text: 'å…ƒç´ ', val: 'element' },
                        { id: 'left2', text: 'åŒ–åˆç‰©', val: 'compound' },
                        { id: 'left3', text: 'æ··åˆç‰©', val: 'mixture' },
                        { id: 'left4', text: 'ç´”ç‰©è³ª', val: 'pure_substance' }
                    ],
                    rightOptions: [
                        { id: 'right1', text: 'ç”±åŒä¸€ç¨®åŸå­æ§‹æˆçš„ç´”ç‰©è³ª', val: 'element_def' },
                        { id: 'right2', text: 'ä¸åŒç¨®é¡çš„åŸå­ä»¥å›ºå®šæ¯”ä¾‹çµåˆè€Œæˆçš„ç´”ç‰©è³ª', val: 'compound_def' },
                        { id: 'right3', text: 'å…©ç¨®æˆ–å…©ç¨®ä»¥ä¸Šç´”ç‰©è³ªæ··åˆè€Œæˆ', val: 'mixture_def' },
                        { id: 'right4', text: 'ç”±å–®ä¸€ç¨®ç‰©è³ªçµ„æˆ', val: 'pure_def' }
                    ],
                    solution: {
                        element: ['element_def'],
                        compound: ['compound_def'],
                        mixture: ['mixture_def'],
                        pure_substance: ['pure_def']
                    }
                }
            ]
        };

        // ===========================================
        // THEME COLORS
        // ===========================================
        const themeColors = {
            '6-1': { 
                primary: 'from-green-400 to-teal-600',
                header: 'from-green-500 to-teal-700', 
                badge: 'bg-green-500' 
            },
            '6-2': { 
                primary: 'from-blue-400 to-cyan-600',
                header: 'from-blue-500 to-cyan-700', 
                badge: 'bg-blue-500' 
            },
            '6-3': { 
                primary: 'from-purple-400 to-pink-600',
                header: 'from-purple-500 to-pink-700', 
                badge: 'bg-purple-500' 
            },
            '6-4': { 
                primary: 'from-orange-400 to-red-600',
                header: 'from-orange-500 to-red-700', 
                badge: 'bg-orange-500' 
            }
        };

        // ===========================================
        // MAIN APP COMPONENT
        // ===========================================
        function App() {
            const [screen, setScreen] = useState('section_select');
            const [currentSection, setCurrentSection] = useState(null);
            const [currentLevelIndex, setCurrentLevelIndex] = useState(0);
            const [gameState, setGameState] = useState('playing');
            const [droppedItems, setDroppedItems] = useState({});
            const [startTime, setStartTime] = useState(null);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [attempts, setAttempts] = useState(0);
            const [draggedItem, setDraggedItem] = useState(null);
            const [sectionCompletionStatus, setSectionCompletionStatus] = useState({});
            const [errorLog, setErrorLog] = useState([]);
            const [fontScale, setFontScale] = useState(100);

            const currentLevel = currentSection ? CHAPTER_DATA[currentSection][currentLevelIndex] : null;
            const totalLevels = currentSection ? CHAPTER_DATA[currentSection].length : 0;

            // Load completion status and font scale from localStorage
            useEffect(() => {
                const saved = localStorage.getItem('chapter6_completion_status');
                if (saved) {
                    setSectionCompletionStatus(JSON.parse(saved));
                }
                const savedFontScale = localStorage.getItem('chapter6_font_scale');
                if (savedFontScale) {
                    setFontScale(parseInt(savedFontScale));
                }
            }, []);

            // Apply font scale
            useEffect(() => {
                document.documentElement.style.fontSize = `${fontScale}%`;
                localStorage.setItem('chapter6_font_scale', fontScale.toString());
            }, [fontScale]);

            // Timer
            useEffect(() => {
                let timer;
                if (gameState === 'playing' && startTime) {
                    timer = setInterval(() => {
                        setElapsedTime(Math.floor((new Date() - startTime) / 1000));
                    }, 1000);
                }
                return () => {
                    if (timer) clearInterval(timer);
                };
            }, [gameState, startTime]);

            // Start section
            const startSection = (sectionId) => {
                setCurrentSection(sectionId);
                setCurrentLevelIndex(0);
                setScreen('game');
                setGameState('playing');
                setDroppedItems({});
                setStartTime(new Date());
                setElapsedTime(0);
                setAttempts(0);
                setErrorLog([]);
            };

            // Drag handlers
            const handleDragStart = (e, item) => {
                setDraggedItem(item);
                e.dataTransfer.effectAllowed = 'move';
                if (e.target) {
                    e.target.style.opacity = '0.5';
                }
            };

            const handleDragEnd = (e) => {
                if (e.target) {
                    e.target.style.opacity = '1';
                }
                setDraggedItem(null);
            };

            const handleDrop = (e, zoneId) => {
                e.preventDefault();
                if (!draggedItem) return;

                const newDroppedItems = { ...droppedItems };
                
                // Remove item from all zones
                Object.keys(newDroppedItems).forEach(key => {
                    newDroppedItems[key] = newDroppedItems[key].filter(val => val !== draggedItem.val);
                });

                // Add to new zone
                if (!newDroppedItems[zoneId]) {
                    newDroppedItems[zoneId] = [];
                }
                newDroppedItems[zoneId].push(draggedItem.val);

                setDroppedItems(newDroppedItems);
                setDraggedItem(null);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            // Touch handlers
            const handleTouchStart = (e, item) => {
                setDraggedItem(item);
                document.body.style.overflow = 'hidden';
            };

            const handleTouchMove = (e) => {
                e.preventDefault();
            };

            const handleTouchEnd = (e, zoneId) => {
                if (!draggedItem) return;
                
                document.body.style.overflow = '';
                
                const touch = e.changedTouches[0];
                const dropZone = document.elementFromPoint(touch.clientX, touch.clientY);
                
                if (dropZone && dropZone.dataset.zone) {
                    const targetZoneId = dropZone.dataset.zone;
                    const newDroppedItems = { ...droppedItems };
                    
                    Object.keys(newDroppedItems).forEach(key => {
                        newDroppedItems[key] = newDroppedItems[key].filter(val => val !== draggedItem.val);
                    });

                    if (!newDroppedItems[targetZoneId]) {
                        newDroppedItems[targetZoneId] = [];
                    }
                    newDroppedItems[targetZoneId].push(draggedItem.val);

                    setDroppedItems(newDroppedItems);
                }
                
                setDraggedItem(null);
            };

            // Check answer
            const checkAnswer = () => {
                setAttempts(prev => prev + 1);
                
                const solution = currentLevel.solution;
                let allCorrect = true;
                const newErrorLog = [...errorLog];

                if (currentLevel.type === 'classification') {
                    Object.keys(solution).forEach(zoneId => {
                        const expected = solution[zoneId].sort();
                        const actual = (droppedItems[zoneId] || []).sort();
                        
                        if (JSON.stringify(expected) !== JSON.stringify(actual)) {
                            allCorrect = false;
                            
                            // Record errors
                            actual.forEach(val => {
                                if (!expected.includes(val)) {
                                    const wrongItem = currentLevel.items.find(item => item.val === val);
                                    const wrongZone = currentLevel.zones.find(zone => zone.id === zoneId);
                                    const correctZoneId = Object.keys(solution).find(key => solution[key].includes(val));
                                    const correctZone = currentLevel.zones.find(zone => zone.id === correctZoneId);
                                    
                                    if (wrongItem && wrongZone && correctZone) {
                                        newErrorLog.push({
                                            levelTitle: currentLevel.title,
                                            wrongAnswer: `${wrongItem.text} â†’ ${wrongZone.title}`,
                                            correctAnswer: `${wrongItem.text} â†’ ${correctZone.title}`
                                        });
                                    }
                                }
                            });
                        }
                    });
                } else if (currentLevel.type === 'formula_match') {
                    Object.keys(solution).forEach(leftId => {
                        const expected = solution[leftId];
                        const actual = droppedItems[leftId] || [];
                        
                        if (JSON.stringify(expected.sort()) !== JSON.stringify(actual.sort())) {
                            allCorrect = false;
                            
                            const wrongLeft = currentLevel.leftOptions.find(opt => opt.val === leftId);
                            if (wrongLeft) {
                                const actualRights = actual.map(val => {
                                    const right = currentLevel.rightOptions.find(opt => opt.val === val);
                                    return right ? right.text : '';
                                }).join(', ');
                                
                                const correctRights = expected.map(val => {
                                    const right = currentLevel.rightOptions.find(opt => opt.val === val);
                                    return right ? right.text : '';
                                }).join(', ');
                                
                                newErrorLog.push({
                                    levelTitle: currentLevel.title,
                                    wrongAnswer: `${wrongLeft.text} â†’ ${actualRights || '(æœªé…å°)'}`,
                                    correctAnswer: `${wrongLeft.text} â†’ ${correctRights}`
                                });
                            }
                        }
                    });
                } else if (currentLevel.type === 'formula') {
                    Object.keys(solution).forEach(slotId => {
                        const expected = solution[slotId].sort();
                        const actual = (droppedItems[slotId] || []).sort();
                        
                        if (JSON.stringify(expected) !== JSON.stringify(actual)) {
                            allCorrect = false;
                            
                            const slot = currentLevel.formulaSlots.find(s => s.id === slotId);
                            if (slot) {
                                const actualItems = actual.map(val => {
                                    const item = currentLevel.items.find(i => i.val === val);
                                    return item ? item.text : '';
                                }).join(', ');
                                
                                const correctItems = expected.map(val => {
                                    const item = currentLevel.items.find(i => i.val === val);
                                    return item ? item.text : '';
                                }).join(', ');
                                
                                newErrorLog.push({
                                    levelTitle: currentLevel.title,
                                    wrongAnswer: `${slot.placeholder} = ${actualItems || '(ç©ºç™½)'}`,
                                    correctAnswer: `${slot.placeholder} = ${correctItems}`
                                });
                            }
                        }
                    });
                }

                setErrorLog(newErrorLog);

                if (allCorrect) {
                    setGameState('completed');
                } else {
                    setGameState('wrong');
                    setTimeout(() => {
                        setGameState('playing');
                    }, 2000);
                }
            };

            // Next level
            const nextLevel = () => {
                if (currentLevelIndex < totalLevels - 1) {
                    setCurrentLevelIndex(prev => prev + 1);
                    setGameState('playing');
                    setDroppedItems({});
                } else {
                    // Section completed
                    const totalTime = elapsedTime;
                    const totalErrors = errorLog.length;
                    
                    const newStatus = {
                        ...sectionCompletionStatus,
                        [currentSection]: {
                            completed: true,
                            completedAt: new Date().toISOString(),
                            totalTime: totalTime,
                            attempts: attempts,
                            errors: totalErrors,
                            errorLog: errorLog
                        }
                    };
                    
                    setSectionCompletionStatus(newStatus);
                    localStorage.setItem('chapter6_completion_status', JSON.stringify(newStatus));
                    
                    setScreen('section_complete');
                }
            };

            // Download certificate
            const downloadCertificate = (elementId, filename) => {
                const element = document.getElementById(elementId);
                if (!element) return;

                html2canvas(element, { scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = canvas.toDataURL();
                    link.click();
                });
            };

            // Clear all progress
            const clearAllProgress = () => {
                if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å®Œæˆè¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                    localStorage.removeItem('chapter6_completion_status');
                    setSectionCompletionStatus({});
                    alert('æ‰€æœ‰è¨˜éŒ„å·²æ¸…é™¤ï¼');
                }
            };

            // Check if all placed
            const checkAllPlaced = () => {
                if (!currentLevel) return false;
                
                let totalItems = 0;
                let placedItems = 0;
                
                if (currentLevel.type === 'classification') {
                    totalItems = currentLevel.items ? currentLevel.items.length : 0;
                    placedItems = Object.values(droppedItems).flat().filter(val => val !== 'items').length;
                } else if (currentLevel.type === 'formula_match') {
                    // For formula_match, count right options that need to be placed
                    totalItems = currentLevel.rightOptions ? currentLevel.rightOptions.length : 0;
                    placedItems = Object.keys(droppedItems).reduce((count, key) => {
                        if (key !== 'options') {
                            return count + droppedItems[key].length;
                        }
                        return count;
                    }, 0);
                } else if (currentLevel.type === 'formula') {
                    totalItems = currentLevel.items ? currentLevel.items.length : 0;
                    placedItems = Object.values(droppedItems).flat().filter(val => val !== 'items').length;
                }
                
                return placedItems === totalItems;
            };

            const allPlaced = checkAllPlaced();
            
            let totalItems = 0;
            let placedItems = 0;
            
            if (currentLevel) {
                if (currentLevel.type === 'classification') {
                    totalItems = currentLevel.items ? currentLevel.items.length : 0;
                    placedItems = Object.values(droppedItems).flat().filter(val => val !== 'items').length;
                } else if (currentLevel.type === 'formula_match') {
                    totalItems = currentLevel.rightOptions ? currentLevel.rightOptions.length : 0;
                    placedItems = Object.keys(droppedItems).reduce((count, key) => {
                        if (key !== 'options') {
                            return count + droppedItems[key].length;
                        }
                        return count;
                    }, 0);
                } else if (currentLevel.type === 'formula') {
                    totalItems = currentLevel.items ? currentLevel.items.length : 0;
                    placedItems = Object.values(droppedItems).flat().filter(val => val !== 'items').length;
                }
            }

            // Check if all sections completed
            const allSectionsCompleted = Object.keys(CHAPTER_DATA).every(
                sectionId => sectionCompletionStatus[sectionId]?.completed
            );

            // ===========================================
            // RENDER: SECTION SELECT
            // ===========================================
            if (screen === 'section_select') {
                const sections = [
                    { id: '6-1', title: '6-1 å…ƒç´ çš„æ¢ç´¢', icon: 'fa-flask', levels: 3, color: 'from-green-400 to-teal-600' },
                    { id: '6-2', title: '6-2 å…ƒç´ é€±æœŸè¡¨', icon: 'fa-table', levels: 2, color: 'from-blue-400 to-cyan-600' },
                    { id: '6-3', title: '6-3 åŒ–åˆç‰©èˆ‡åŸå­æ¦‚å¿µçš„ç™¼å±•', icon: 'fa-atom', levels: 3, color: 'from-purple-400 to-pink-600' },
                    { id: '6-4', title: '6-4 åˆ†å­èˆ‡åŒ–å­¸å¼', icon: 'fa-dna', levels: 3, color: 'from-orange-400 to-red-600' }
                ];

                return (
                    <div className="min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-4">
                        <div className="max-w-6xl mx-auto">
                            {/* Header */}
                            <div className="text-center mb-8 mt-8">
                                <div className="flex justify-between items-center mb-4">
                                    <div className="flex-1"></div>
                                    <h1 className="flex-1 text-4xl md:text-5xl font-black text-white drop-shadow-lg">
                                        ç¬¬6ç«  æ¢ç´¢ç‰©è³ªçµ„æˆ
                                    </h1>
                                    <div className="flex-1 flex justify-end items-center gap-2">
                                        <button
                                            onClick={() => setFontScale(Math.max(70, fontScale - 10))}
                                            className="bg-white/20 hover:bg-white/30 text-white px-3 py-2 rounded-lg backdrop-blur-sm transition-all"
                                            title="ç¸®å°å­—é«”"
                                        >
                                            Aâ»
                                        </button>
                                        <button
                                            onClick={() => setFontScale(Math.min(150, fontScale + 10))}
                                            className="bg-white/20 hover:bg-white/30 text-white px-3 py-2 rounded-lg backdrop-blur-sm transition-all"
                                            title="æ”¾å¤§å­—é«”"
                                        >
                                            Aâº
                                        </button>
                                    </div>
                                </div>
                                <p className="text-xl text-white/90 mt-2">é¸æ“‡å°ç¯€é–‹å§‹é—–é—œ</p>
                            </div>

                            {/* Sections Grid */}
                            <div className="grid md:grid-cols-2 gap-6 mb-8">
                                {sections.map(section => {
                                    const isCompleted = sectionCompletionStatus[section.id]?.completed;
                                    return (
                                        <div
                                            key={section.id}
                                            onClick={() => startSection(section.id)}
                                            className="glass-effect rounded-2xl p-6 cursor-pointer hover:scale-105 transition-transform relative overflow-hidden group"
                                        >
                                            <div className={`absolute inset-0 bg-gradient-to-br ${section.color} opacity-20 group-hover:opacity-30 transition-opacity`}></div>
                                            <div className="relative z-10">
                                                <div className="flex items-center justify-between mb-4">
                                                    <div className="flex items-center gap-3">
                                                        <i className={`fas ${section.icon} text-3xl text-white`}></i>
                                                        <h3 className="text-xl font-bold text-white">{section.title}</h3>
                                                    </div>
                                                    {isCompleted && (
                                                        <div className="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold">
                                                            <i className="fas fa-check mr-1"></i>
                                                            å·²å®Œæˆ
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="text-white/80">
                                                    <i className="fas fa-gamepad mr-2"></i>
                                                    å…± {section.levels} å€‹é—œå¡
                                                </div>
                                                {isCompleted && sectionCompletionStatus[section.id] && (
                                                    <div className="mt-3 text-sm text-white/70">
                                                        <div>å®Œæˆæ™‚é–“ï¼š{sectionCompletionStatus[section.id].totalTime} ç§’</div>
                                                        <div>å˜—è©¦æ¬¡æ•¸ï¼š{sectionCompletionStatus[section.id].attempts} æ¬¡</div>
                                                        <div>éŒ¯èª¤æ¬¡æ•¸ï¼š{sectionCompletionStatus[section.id].errors} æ¬¡</div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>

                            {/* All Complete Certificate */}
                            {allSectionsCompleted && (
                                <div className="glass-effect rounded-2xl p-6 mb-8">
                                    <div className="text-center">
                                        <i className="fas fa-trophy text-6xl text-yellow-300 mb-4"></i>
                                        <h2 className="text-3xl font-bold text-white mb-4">ğŸ‰ æ­å–œå®Œæˆæ‰€æœ‰å°ç¯€ï¼</h2>
                                        <button
                                            onClick={() => setScreen('all_complete')}
                                            className="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-8 py-3 rounded-xl font-bold hover:scale-105 transition-transform"
                                        >
                                            <i className="fas fa-certificate mr-2"></i>
                                            æŸ¥çœ‹å®Œæˆè­‰æ›¸
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* Clear Progress Button */}
                            <div className="text-center">
                                <button
                                    onClick={clearAllProgress}
                                    className="bg-red-500/80 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-bold transition-all"
                                >
                                    <i className="fas fa-trash-alt mr-2"></i>
                                    æ¸…é™¤æ‰€æœ‰å®Œæˆè¨˜éŒ„
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // ===========================================
            // RENDER: GAME SCREEN
            // ===========================================
            if (screen === 'game' && currentLevel) {
                const colors = themeColors[currentSection];
                
                return (
                    <div className={`min-h-screen bg-gradient-to-br ${colors.primary} p-4`}>
                        <div className="max-w-6xl mx-auto">
                            {/* Header */}
                            <div className={`bg-gradient-to-r ${colors.header} rounded-2xl p-4 mb-6 shadow-lg`}>
                                <div className="flex flex-wrap items-center justify-between gap-4">
                                    <div className="flex items-center gap-2">
                                        <button
                                            onClick={() => setFontScale(Math.max(70, fontScale - 10))}
                                            className="bg-white/20 hover:bg-white/30 text-white px-2 py-1 rounded text-sm"
                                        >
                                            Aâ»
                                        </button>
                                        <button
                                            onClick={() => setFontScale(Math.min(150, fontScale + 10))}
                                            className="bg-white/20 hover:bg-white/30 text-white px-2 py-1 rounded text-sm"
                                        >
                                            Aâº
                                        </button>
                                        <h2 className="text-2xl font-bold text-white ml-2">{currentLevel.title}</h2>
                                    </div>
                                    <div className="flex items-center gap-4 text-white">
                                        <div className="progress-bar bg-white/20 rounded-full px-4 py-2">
                                            <i className="fas fa-layer-group mr-2"></i>
                                            é—œå¡ {currentLevelIndex + 1}/{totalLevels}
                                        </div>
                                        <div className="bg-white/20 rounded-full px-4 py-2">
                                            <i className="fas fa-clock mr-2"></i>
                                            {elapsedTime} ç§’
                                        </div>
                                        <div className="bg-white/20 rounded-full px-4 py-2">
                                            <i className="fas fa-redo mr-2"></i>
                                            {attempts} æ¬¡
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Description */}
                            <div className="bg-white rounded-xl p-6 mb-6 shadow-lg">
                                <p className="text-lg text-gray-700">{currentLevel.description}</p>
                            </div>

                            {/* Classification Type */}
                            {currentLevel.type === 'classification' && (
                                <>
                                    {/* Layout based on zone count: 2-3 zones = left-right, 4+ zones = top-bottom */}
                                    {currentLevel.zones.length <= 3 ? (
                                        // Left-Right Layout for 2-3 zones
                                        <div className="grid md:grid-cols-2 gap-6 mb-6">
                                            {/* Left: Items Pool */}
                                            <div>
                                                <h3 className="text-2xl font-bold text-white mb-4">å¾…åˆ†é¡é …ç›®</h3>
                                                <div
                                                    data-zone="items"
                                                    onDrop={(e) => handleDrop(e, 'items')}
                                                    onDragOver={handleDragOver}
                                                    onTouchEnd={(e) => handleTouchEnd(e, 'items')}
                                                    className="drop-zone bg-white rounded-xl p-6 min-h-[400px] border-4 border-dashed border-gray-300"
                                                >
                                                    <div className="space-y-3">
                                                        {currentLevel.items.filter(item => {
                                                            const isPlaced = Object.values(droppedItems).flat().includes(item.val);
                                                            return !isPlaced;
                                                        }).map(item => (
                                                            <div
                                                                key={item.id}
                                                                draggable
                                                                onDragStart={(e) => handleDragStart(e, item)}
                                                                onDragEnd={handleDragEnd}
                                                                onTouchStart={(e) => handleTouchStart(e, item)}
                                                                onTouchMove={handleTouchMove}
                                                                className="drag-item bg-blue-500 text-white px-6 py-3 rounded-lg cursor-move hover:bg-blue-600 transition-colors font-medium text-center"
                                                            >
                                                                {item.text}
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Right: Classification Zones */}
                                            <div className="space-y-4">
                                                {currentLevel.zones.map(zone => (
                                                    <div
                                                        key={zone.id}
                                                        data-zone={zone.id}
                                                        onDrop={(e) => handleDrop(e, zone.id)}
                                                        onDragOver={handleDragOver}
                                                        onTouchEnd={(e) => handleTouchEnd(e, zone.id)}
                                                        className={`drop-zone bg-white rounded-xl p-6 border-4 min-h-[120px] ${
                                                            gameState === 'wrong' && 
                                                            JSON.stringify((droppedItems[zone.id] || []).sort()) !== 
                                                            JSON.stringify((currentLevel.solution[zone.id] || []).sort())
                                                                ? 'border-red-500 shake' 
                                                                : gameState === 'completed'
                                                                ? 'border-green-500'
                                                                : 'border-dashed border-gray-300'
                                                        }`}
                                                    >
                                                        <div className="flex items-center gap-3 mb-4">
                                                            <i className={`fas ${zone.icon} text-2xl ${colors.badge} text-white p-3 rounded-lg`}></i>
                                                            <h3 className="text-lg font-bold text-gray-800">{zone.title}</h3>
                                                        </div>
                                                        <div className="space-y-2">
                                                            {(droppedItems[zone.id] || []).map(val => {
                                                                const item = currentLevel.items.find(i => i.val === val);
                                                                return item ? (
                                                                    <div
                                                                        key={item.id}
                                                                        draggable
                                                                        onDragStart={(e) => handleDragStart(e, item)}
                                                                        onDragEnd={handleDragEnd}
                                                                        onTouchStart={(e) => handleTouchStart(e, item)}
                                                                        onTouchMove={handleTouchMove}
                                                                        className="drag-item bg-blue-500 text-white px-4 py-2 rounded-lg cursor-move hover:bg-blue-600 transition-colors text-sm"
                                                                    >
                                                                        {item.text}
                                                                    </div>
                                                                ) : null;
                                                            })}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ) : (
                                        // Top-Bottom Layout for 4+ zones
                                        <>
                                            <div className={`grid gap-6 mb-6 ${
                                                currentLevel.zones.length === 4 ? 'md:grid-cols-2' : 'md:grid-cols-3'
                                            }`}>
                                                {currentLevel.zones.map(zone => (
                                                    <div
                                                        key={zone.id}
                                                        data-zone={zone.id}
                                                        onDrop={(e) => handleDrop(e, zone.id)}
                                                        onDragOver={handleDragOver}
                                                        onTouchEnd={(e) => handleTouchEnd(e, zone.id)}
                                                        className={`drop-zone bg-white rounded-xl p-4 border-4 min-h-[100px] ${
                                                            gameState === 'wrong' && 
                                                            JSON.stringify((droppedItems[zone.id] || []).sort()) !== 
                                                            JSON.stringify((currentLevel.solution[zone.id] || []).sort())
                                                                ? 'border-red-500 shake' 
                                                                : gameState === 'completed'
                                                                ? 'border-green-500'
                                                                : 'border-dashed border-gray-300'
                                                        }`}
                                                    >
                                                        <div className="flex items-center gap-2 mb-3">
                                                            <i className={`fas ${zone.icon} text-xl ${colors.badge} text-white p-2 rounded-lg`}></i>
                                                            <h3 className="text-base font-bold text-gray-800">{zone.title}</h3>
                                                        </div>
                                                        <div className="space-y-2">
                                                            {(droppedItems[zone.id] || []).map(val => {
                                                                const item = currentLevel.items.find(i => i.val === val);
                                                                return item ? (
                                                                    <div
                                                                        key={item.id}
                                                                        draggable
                                                                        onDragStart={(e) => handleDragStart(e, item)}
                                                                        onDragEnd={handleDragEnd}
                                                                        onTouchStart={(e) => handleTouchStart(e, item)}
                                                                        onTouchMove={handleTouchMove}
                                                                        className="drag-item bg-blue-500 text-white px-3 py-2 rounded-lg cursor-move hover:bg-blue-600 transition-colors text-sm"
                                                                    >
                                                                        {item.text}
                                                                    </div>
                                                                ) : null;
                                                            })}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>

                                            {/* Items Pool at Bottom */}
                                            <div>
                                                <h3 className="text-2xl font-bold text-white mb-4">å¾…åˆ†é¡é …ç›®</h3>
                                                <div
                                                    data-zone="items"
                                                    onDrop={(e) => handleDrop(e, 'items')}
                                                    onDragOver={handleDragOver}
                                                    onTouchEnd={(e) => handleTouchEnd(e, 'items')}
                                                    className="drop-zone bg-white rounded-xl p-6 min-h-[120px] border-4 border-dashed border-gray-300"
                                                >
                                                    <div className="flex flex-wrap gap-3">
                                                        {currentLevel.items.filter(item => {
                                                            const isPlaced = Object.values(droppedItems).flat().includes(item.val);
                                                            return !isPlaced;
                                                        }).map(item => (
                                                            <div
                                                                key={item.id}
                                                                draggable
                                                                onDragStart={(e) => handleDragStart(e, item)}
                                                                onDragEnd={handleDragEnd}
                                                                onTouchStart={(e) => handleTouchStart(e, item)}
                                                                onTouchMove={handleTouchMove}
                                                                className="drag-item bg-blue-500 text-white px-6 py-3 rounded-lg cursor-move hover:bg-blue-600 transition-colors font-medium"
                                                            >
                                                                {item.text}
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        </>
                                    )}
                                </>
                            )}
                            {currentLevel.type === 'formula_match' && (
                                <div className="grid md:grid-cols-2 gap-6 mb-6">
                                    <div className="space-y-4">
                                        <h3 className="text-xl font-bold text-white mb-4">å·¦å´é¸é …</h3>
                                        {currentLevel.leftOptions.map(left => (
                                            <div
                                                key={left.id}
                                                data-zone={left.val}
                                                onDrop={(e) => handleDrop(e, left.val)}
                                                onDragOver={handleDragOver}
                                                onTouchEnd={(e) => handleTouchEnd(e, left.val)}
                                                className={`drop-zone bg-white rounded-xl p-4 border-4 ${
                                                    gameState === 'wrong' && 
                                                    JSON.stringify((droppedItems[left.val] || []).sort()) !== 
                                                    JSON.stringify((currentLevel.solution[left.val] || []).sort())
                                                        ? 'border-red-500 shake' 
                                                        : gameState === 'completed'
                                                        ? 'border-green-500'
                                                        : 'border-dashed border-gray-300'
                                                }`}
                                            >
                                                <div className="font-bold text-gray-800 mb-2">{left.text}</div>
                                                <div className="min-h-[60px] space-y-2">
                                                    {(droppedItems[left.val] || []).map(val => {
                                                        const right = currentLevel.rightOptions.find(r => r.val === val);
                                                        return right ? (
                                                            <div
                                                                key={right.id}
                                                                draggable
                                                                onDragStart={(e) => handleDragStart(e, right)}
                                                                onDragEnd={handleDragEnd}
                                                                onTouchStart={(e) => handleTouchStart(e, right)}
                                                                onTouchMove={handleTouchMove}
                                                                className="drag-item bg-purple-500 text-white px-3 py-2 rounded-lg cursor-move hover:bg-purple-600 transition-colors text-sm"
                                                            >
                                                                {right.text}
                                                            </div>
                                                        ) : null;
                                                    })}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div>
                                        <h3 className="text-xl font-bold text-white mb-4">å³å´é¸é …</h3>
                                        <div
                                            data-zone="options"
                                            onDrop={(e) => handleDrop(e, 'options')}
                                            onDragOver={handleDragOver}
                                            onTouchEnd={(e) => handleTouchEnd(e, 'options')}
                                            className="drop-zone bg-white rounded-xl p-4 min-h-[200px] border-4 border-dashed border-gray-300"
                                        >
                                            <div className="space-y-2">
                                                {currentLevel.rightOptions.filter(right => {
                                                    const isPlaced = Object.values(droppedItems).flat().includes(right.val);
                                                    return !isPlaced;
                                                }).map(right => (
                                                    <div
                                                        key={right.id}
                                                        draggable
                                                        onDragStart={(e) => handleDragStart(e, right)}
                                                        onDragEnd={handleDragEnd}
                                                        onTouchStart={(e) => handleTouchStart(e, right)}
                                                        onTouchMove={handleTouchMove}
                                                        className="drag-item bg-purple-500 text-white px-4 py-3 rounded-lg cursor-move hover:bg-purple-600 transition-colors"
                                                    >
                                                        {right.text}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Formula Type */}
                            {currentLevel.type === 'formula' && (
                                <div className="space-y-6 mb-6">
                                    <div className="grid md:grid-cols-3 gap-4">
                                        {currentLevel.formulaSlots.map(slot => (
                                            <div
                                                key={slot.id}
                                                data-zone={slot.id}
                                                onDrop={(e) => handleDrop(e, slot.id)}
                                                onDragOver={handleDragOver}
                                                onTouchEnd={(e) => handleTouchEnd(e, slot.id)}
                                                className={`drop-zone bg-white rounded-xl p-4 border-4 ${
                                                    gameState === 'wrong' && 
                                                    JSON.stringify((droppedItems[slot.id] || []).sort()) !== 
                                                    JSON.stringify((currentLevel.solution[slot.id] || []).sort())
                                                        ? 'border-red-500 shake' 
                                                        : gameState === 'completed'
                                                        ? 'border-green-500'
                                                        : 'border-dashed border-gray-300'
                                                }`}
                                            >
                                                <div className="font-bold text-gray-700 mb-2">{slot.placeholder}</div>
                                                <div className="min-h-[60px] space-y-2">
                                                    {(droppedItems[slot.id] || []).map(val => {
                                                        const item = currentLevel.items.find(i => i.val === val);
                                                        return item ? (
                                                            <div
                                                                key={item.id}
                                                                draggable
                                                                onDragStart={(e) => handleDragStart(e, item)}
                                                                onDragEnd={handleDragEnd}
                                                                onTouchStart={(e) => handleTouchStart(e, item)}
                                                                onTouchMove={handleTouchMove}
                                                                className="drag-item bg-orange-500 text-white px-3 py-2 rounded-lg cursor-move hover:bg-orange-600 transition-colors"
                                                            >
                                                                {item.text}
                                                            </div>
                                                        ) : null;
                                                    })}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div>
                                        <h3 className="text-xl font-bold text-white mb-4">å¾…åˆ†é¡é …ç›®</h3>
                                        <div
                                            data-zone="items"
                                            onDrop={(e) => handleDrop(e, 'items')}
                                            onDragOver={handleDragOver}
                                            onTouchEnd={(e) => handleTouchEnd(e, 'items')}
                                            className="drop-zone bg-white rounded-xl p-4 min-h-[100px] border-4 border-dashed border-gray-300"
                                        >
                                            <div className="flex flex-wrap gap-2">
                                                {currentLevel.items.filter(item => {
                                                    const isPlaced = Object.values(droppedItems).flat().includes(item.val);
                                                    return !isPlaced;
                                                }).map(item => (
                                                    <div
                                                        key={item.id}
                                                        draggable
                                                        onDragStart={(e) => handleDragStart(e, item)}
                                                        onDragEnd={handleDragEnd}
                                                        onTouchStart={(e) => handleTouchStart(e, item)}
                                                        onTouchMove={handleTouchMove}
                                                        className="drag-item bg-orange-500 text-white px-4 py-3 rounded-lg cursor-move hover:bg-orange-600 transition-colors"
                                                    >
                                                        {item.text}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Formula Match Type */}
                            <div className="flex justify-center gap-4 mt-8">
                                <button
                                    onClick={() => {
                                        setScreen('section_select');
                                        setCurrentSection(null);
                                    }}
                                    className="bg-gray-500 hover:bg-gray-600 text-white px-8 py-4 rounded-xl font-bold transition-all"
                                >
                                    <i className="fas fa-home mr-2"></i>
                                    è¿”å›é¸å–®
                                </button>
                                
                                {gameState === 'playing' && (
                                    <button
                                        onClick={checkAnswer}
                                        disabled={!allPlaced}
                                        className={`px-8 py-4 rounded-xl font-bold transition-all ${
                                            allPlaced 
                                                ? 'bg-green-500 hover:bg-green-600 text-white cursor-pointer' 
                                                : 'bg-gray-400 text-gray-200 cursor-not-allowed'
                                        }`}
                                    >
                                        <i className="fas fa-check mr-2"></i>
                                        {allPlaced ? 'æª¢æŸ¥ç­”æ¡ˆ' : `å°šæœªå®Œæˆ (${placedItems}/${totalItems})`}
                                    </button>
                                )}
                                
                                {gameState === 'completed' && (
                                    <button
                                        onClick={nextLevel}
                                        className="bg-green-500 hover:bg-green-600 text-white px-8 py-4 rounded-xl font-bold transition-all"
                                    >
                                        <i className="fas fa-arrow-right mr-2"></i>
                                        {currentLevelIndex < totalLevels - 1 ? 'ä¸‹ä¸€é—œ' : 'å®Œæˆå°ç¯€'}
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // ===========================================
            // RENDER: SECTION COMPLETE
            // ===========================================
            if (screen === 'section_complete') {
                const colors = themeColors[currentSection];
                const status = sectionCompletionStatus[currentSection];
                
                return (
                    <div className={`min-h-screen bg-gradient-to-br ${colors.primary} p-4 flex items-center justify-center`}>
                        <div className="max-w-2xl w-full">
                            <div id="section-certificate" className="bg-white rounded-3xl p-8 shadow-2xl">
                                <div className="text-center mb-6">
                                    <i className="fas fa-trophy text-6xl text-yellow-500 mb-4 float"></i>
                                    <h1 className="text-4xl font-black text-gray-800 mb-2">
                                        ğŸ‰ æ­å–œå®Œæˆï¼
                                    </h1>
                                    <p className="text-xl text-gray-600">
                                        ä½ å·²å®Œæˆã€Œ{currentSection}ã€æ‰€æœ‰é—œå¡
                                    </p>
                                </div>
                                
                                <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6 mb-6">
                                    <div className="grid grid-cols-2 gap-4 text-center">
                                        <div>
                                            <div className="text-3xl font-bold text-blue-600">{status.totalTime}</div>
                                            <div className="text-gray-600">ç¸½æ™‚é–“ï¼ˆç§’ï¼‰</div>
                                        </div>
                                        <div>
                                            <div className="text-3xl font-bold text-green-600">{totalLevels}</div>
                                            <div className="text-gray-600">å®Œæˆé—œå¡</div>
                                        </div>
                                        <div>
                                            <div className="text-3xl font-bold text-orange-600">{status.attempts}</div>
                                            <div className="text-gray-600">å˜—è©¦æ¬¡æ•¸</div>
                                        </div>
                                        <div>
                                            <div className="text-3xl font-bold text-red-600">{status.errors}</div>
                                            <div className="text-gray-600">éŒ¯èª¤æ¬¡æ•¸</div>
                                        </div>
                                    </div>
                                </div>

                                {status.errorLog && status.errorLog.length > 0 && (
                                    <div className="bg-red-50 rounded-2xl p-6 mb-6">
                                        <h3 className="text-lg font-bold text-red-800 mb-3">
                                            <i className="fas fa-exclamation-triangle mr-2"></i>
                                            éŒ¯èª¤è¨˜éŒ„ï¼ˆä¾›è¤‡ç¿’ï¼‰
                                        </h3>
                                        <div className="space-y-2 max-h-60 overflow-y-auto">
                                            {status.errorLog.map((error, index) => (
                                                <div key={index} className="bg-white p-3 rounded-lg text-sm">
                                                    <div className="font-bold text-gray-700">{error.levelTitle}</div>
                                                    <div className="text-red-600">âœ— ä½ çš„ç­”æ¡ˆï¼š{error.wrongAnswer}</div>
                                                    <div className="text-green-600">âœ“ æ­£ç¢ºç­”æ¡ˆï¼š{error.correctAnswer}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                <div className="text-center text-sm text-gray-500">
                                    å®Œæˆæ™‚é–“ï¼š{new Date(status.completedAt).toLocaleString('zh-TW')}
                                </div>
                            </div>
                            
                            <div className="flex justify-center gap-4 mt-6">
                                <button
                                    onClick={() => downloadCertificate('section-certificate', `ç¬¬6ç« _${currentSection}_å®Œæˆè­‰æ›¸.png`)}
                                    className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-bold transition-all"
                                >
                                    <i className="fas fa-download mr-2"></i>
                                    ä¸‹è¼‰è­‰æ›¸
                                </button>
                                <button
                                    onClick={() => setScreen('section_select')}
                                    className="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-bold transition-all"
                                >
                                    <i className="fas fa-home mr-2"></i>
                                    è¿”å›é¸å–®
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // ===========================================
            // RENDER: ALL COMPLETE
            // ===========================================
            if (screen === 'all_complete') {
                const allErrorLogs = Object.keys(sectionCompletionStatus).reduce((acc, sectionId) => {
                    const status = sectionCompletionStatus[sectionId];
                    if (status.errorLog && status.errorLog.length > 0) {
                        acc[sectionId] = status.errorLog;
                    }
                    return acc;
                }, {});

                const totalErrors = Object.values(allErrorLogs).reduce((sum, logs) => sum + logs.length, 0);

                return (
                    <div className="min-h-screen bg-gradient-to-br from-yellow-400 via-orange-500 to-red-500 p-4 flex items-center justify-center">
                        <div className="max-w-3xl w-full">
                            <div id="all-complete-certificate" className="bg-white rounded-3xl p-8 shadow-2xl">
                                <div className="text-center mb-6">
                                    <i className="fas fa-medal text-8xl text-yellow-500 mb-4 float"></i>
                                    <h1 className="text-5xl font-black text-gray-800 mb-2">
                                        ğŸ† å…¨ç« å®Œæˆï¼
                                    </h1>
                                    <p className="text-2xl text-gray-600 mb-4">
                                        æ­å–œä½ å®Œæˆç¬¬6ç« æ‰€æœ‰å°ç¯€
                                    </p>
                                    <div className="text-lg text-gray-500">
                                        æ¢ç´¢ç‰©è³ªçµ„æˆ
                                    </div>
                                </div>

                                <div className="grid grid-cols-4 gap-4 mb-6">
                                    {Object.keys(CHAPTER_DATA).map(sectionId => {
                                        const status = sectionCompletionStatus[sectionId];
                                        return (
                                            <div key={sectionId} className="bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl p-4 text-center">
                                                <div className="text-lg font-bold text-gray-800 mb-2">{sectionId}</div>
                                                <div className="text-sm text-gray-600">{status.totalTime}ç§’</div>
                                                <div className="text-sm text-gray-600">{status.errors}éŒ¯</div>
                                            </div>
                                        );
                                    })}
                                </div>

                                {totalErrors > 0 && (
                                    <div className="bg-red-50 rounded-2xl p-6 mb-6">
                                        <h3 className="text-xl font-bold text-red-800 mb-4">
                                            <i className="fas fa-clipboard-list mr-2"></i>
                                            å…¨ç« éŒ¯èª¤è¨˜éŒ„ï¼ˆå…± {totalErrors} å€‹éŒ¯èª¤ï¼‰
                                        </h3>
                                        <div className="space-y-4 max-h-96 overflow-y-auto">
                                            {Object.keys(allErrorLogs).map(sectionId => (
                                                <div key={sectionId}>
                                                    <div className="font-bold text-gray-700 mb-2">{sectionId}</div>
                                                    <div className="space-y-2">
                                                        {allErrorLogs[sectionId].map((error, index) => (
                                                            <div key={index} className="bg-white p-3 rounded-lg text-sm">
                                                                <div className="font-bold text-gray-600">{error.levelTitle}</div>
                                                                <div className="text-red-600">âœ— {error.wrongAnswer}</div>
                                                                <div className="text-green-600">âœ“ {error.correctAnswer}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                <div className="text-center">
                                    <div className="text-2xl font-bold text-gray-800 mb-2">
                                        ä½ æ˜¯åŒ–å­¸æ¢ç´¢å¤§å¸«ï¼
                                    </div>
                                    <div className="text-gray-600">
                                        ç¹¼çºŒä¿æŒå­¸ç¿’çš„ç†±æƒ… ğŸ’ª
                                    </div>
                                </div>
                            </div>

                            <div className="flex justify-center gap-4 mt-6">
                                <button
                                    onClick={() => downloadCertificate('all-complete-certificate', 'ç¬¬6ç« _å…¨ç« å®Œæˆè­‰æ›¸.png')}
                                    className="bg-yellow-500 hover:bg-yellow-600 text-white px-8 py-4 rounded-xl font-bold transition-all text-lg"
                                >
                                    <i className="fas fa-download mr-2"></i>
                                    ä¸‹è¼‰å®Œæˆè­‰æ›¸
                                </button>
                                <button
                                    onClick={() => setScreen('section_select')}
                                    className="bg-blue-500 hover:bg-blue-600 text-white px-8 py-4 rounded-xl font-bold transition-all text-lg"
                                >
                                    <i className="fas fa-home mr-2"></i>
                                    è¿”å›é¸å–®
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        }

        // ===========================================
        // RENDER TO DOM
        // ===========================================
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
