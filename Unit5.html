<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Unit 5: London Trip Challenge</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Screenshot Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* Âü∫Á§éË®≠ÂÆöÔºöÂÑ™ÂåñËß∏ÊéßÈ´îÈ©ó */
        body {
            overscroll-behavior: none;
            touch-action: pan-y;
            user-select: none;
            -webkit-user-select: none;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc;
        }

        /* Èö±Ëóè Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- ÈÅäÊà≤ÂÖÉ‰ª∂Ê®£Âºè --- */

        /* ÂñÆÂ≠óÂç° (Word Bank) */
        .word-card {
            touch-action: none; /* ÈóúÈçµÔºöÈò≤Ê≠¢Ëß∏ÊéßÊôÇÊç≤ÂãïÈ†ÅÈù¢ */
            transition: transform 0.1s;
            cursor: grab;
            font-size: 0.95rem;
            padding: 6px 10px;
            background-color: white;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            font-weight: 600;
            color: #334155;
            user-select: none;
        }
        .word-card:active { transform: scale(1.05); }
        .word-card.selected {
            background-color: #fbbf24; /* Amber */
            border-color: #d97706;
            color: #78350f;
            transform: scale(1.05);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        /* ÊâãÊ©üÊãñÊõ≥ÊôÇÁöÑÊÆòÂΩ±Ê®£Âºè */
        .dragging-clone {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.8;
            transform: scale(1.1);
            background-color: #e0e7ff;
            border: 2px solid #6366f1;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: bold;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* ÊîæÁΩÆÂçÄ (Slot) */
        .drop-zone {
            transition: all 0.2s;
            min-width: 40px;
            min-height: 34px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 2px;
            vertical-align: middle;
            cursor: pointer;
            border-bottom: 2px solid #cbd5e1;
            background-color: #f1f5f9;
        }
        .drop-zone.hovered {
            background-color: #dbeafe;
            border-color: #3b82f6;
            transform: scale(1.05);
        }
        .drop-zone.filled {
            background-color: #e0e7ff; /* Indigo-100 */
            border: 1px solid #818cf8;
            border-radius: 4px;
            padding: 0 8px;
            color: #4338ca;
            cursor: grab;
        }

        /* ÈÅ∏ÂèñÁãÄÊÖã (Ê∫ñÂÇôÁßªÂãï) */
        .drop-zone.slot-selected {
            background-color: #fef3c7 !important;
            border-color: #f59e0b !important;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.5);
        }
        
        /* Âõ∫ÂÆöÊèêÁ§∫Â≠ó (30%) */
        .fixed-word {
            display: inline-block;
            padding: 0 3px;
            font-weight: 700;
            color: #475569;
        }
        
        /* ÂãïÁï´ */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
        .shake {
            animation: shake 0.3s ease-in-out;
            border-color: #ef4444 !important;
            background-color: #fee2e2 !important;
        }
        
        .correct-lock {
            background-color: #dcfce7 !important; /* Green */
            border: 1px solid #22c55e !important;
            color: #15803d;
            pointer-events: none;
            border-radius: 4px;
            padding: 0 8px;
        }
        
        .error-mark {
            color: #dc2626;
            text-decoration: underline;
            font-weight: bold;
        }

        /* ‰∏ªÈÅ∏ÂñÆÈóúÂç°ÊåâÈàïÊ®£Âºè */
        .level-btn {
            transition: all 0.2s;
        }
        .level-btn.completed {
            background-color: #ecfdf5; /* Green-50 */
            border-color: #10b981; /* Green-500 */
            color: #065f46;
        }
        .level-btn.completed::after {
            content: '‚úÖ';
            margin-left: auto;
            font-size: 1.2rem;
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label:before {
            transform: translateX(100%);
        }
        
        .toggle-label {
            width: 40px;
            height: 20px;
            position: relative;
            display: block;
            background: #cbd5e1;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.3s;
        }
        .toggle-label:before {
            content: '';
            position: absolute;
            left: 2px;
            top: 2px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #fff;
            transition: 0.3s;
        }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden text-slate-800">

    <!-- Header -->
    <header class="bg-indigo-600 text-white py-3 px-4 shadow-md shrink-0 z-30 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <button id="back-home-btn" onclick="goHome()" class="hidden text-sm bg-indigo-700 px-2 py-1 rounded hover:bg-indigo-500 font-bold border border-indigo-400">
                ‚¨Ö Menu
            </button>
            <h1 class="text-lg font-bold truncate">üá¨üáß London Trip</h1>
        </div>
        <div id="game-timer" class="font-mono text-lg bg-indigo-800 px-3 py-0.5 rounded hidden shadow-inner border border-indigo-500">00:00</div>
    </header>

    <!-- 1. HOME SCREEN (Menu) -->
    <div id="home-screen" class="flex-1 overflow-y-auto p-4 flex flex-col items-center max-w-md mx-auto w-full">
        <div class="text-center mb-6 mt-2">
            <div class="text-6xl mb-2">üá¨üáß</div>
            <h2 class="text-2xl font-bold text-slate-800">Unit 5 Challenge</h2>
            <p class="text-slate-500 text-sm">How Do We Go to the Hotel?</p>
        </div>

        <!-- Level Buttons -->
        <div class="w-full space-y-3 flex-1 mb-6">
            <button onclick="startGame('dialogue1')" id="btn-dialogue1" class="level-btn w-full bg-white border-2 border-slate-200 p-3 rounded-xl shadow-sm text-left flex items-center hover:border-indigo-400 active:scale-95">
                <div class="flex flex-col">
                    <span class="text-xs font-bold text-indigo-500 uppercase tracking-wider">Part 1</span>
                    <span class="text-lg font-bold">Dialogue: Getting Lost</span>
                </div>
            </button>

            <button onclick="startGame('dialogue2')" id="btn-dialogue2" class="level-btn w-full bg-white border-2 border-slate-200 p-3 rounded-xl shadow-sm text-left flex items-center hover:border-indigo-400 active:scale-95">
                <div class="flex flex-col">
                    <span class="text-xs font-bold text-indigo-500 uppercase tracking-wider">Part 2</span>
                    <span class="text-lg font-bold">Dialogue: At the Hotel</span>
                </div>
            </button>

            <button onclick="startGame('reading')" id="btn-reading" class="level-btn w-full bg-white border-2 border-slate-200 p-3 rounded-xl shadow-sm text-left flex items-center hover:border-indigo-400 active:scale-95">
                <div class="flex flex-col">
                    <span class="text-xs font-bold text-pink-500 uppercase tracking-wider">Challenge</span>
                    <span class="text-lg font-bold">Reading: Travel Diary</span>
                </div>
            </button>
        </div>

        <!-- Progress Footer -->
        <div class="mt-auto w-full border-t border-slate-200 pt-4">
            <div class="flex justify-between items-center mb-3">
                <span class="text-sm text-slate-500 font-bold">Total Progress</span>
                <span id="progress-text" class="text-sm font-bold text-indigo-600">0/3</span>
            </div>
            
            <!-- Final Certificate Area (Hidden until complete) -->
            <div id="final-certificate-area" class="hidden mb-4 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                <h3 class="text-center text-yellow-800 font-bold mb-2">üèÜ All Levels Completed!</h3>
                <div id="cert-details" class="text-xs text-slate-600 mb-2 space-y-1"></div>
                <button onclick="downloadFullReport()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 rounded shadow">
                    üì• Download Full Report
                </button>
            </div>

            <button onclick="clearProgress()" class="w-full py-2 text-xs text-slate-400 hover:text-red-500 border border-transparent hover:border-red-200 rounded">
                Reset All Progress
            </button>
        </div>
    </div>

    <!-- 2. GAME AREA (Hidden by default) -->
    <main id="game-container" class="flex-1 flex flex-col max-w-2xl mx-auto w-full overflow-hidden relative hidden">
        
        <!-- Level Content -->
        <div id="level-content" class="flex-1 flex flex-col overflow-hidden">
            
            <!-- Translation (Top) -->
            <div class="bg-amber-50 border-b border-amber-200 p-3 shrink-0 shadow-sm z-10">
                <div id="translation-display" class="text-sm font-medium text-slate-800 leading-snug space-y-2">
                    <!-- Dynamic Content -->
                </div>
            </div>

            <!-- Sentence Area (Middle) -->
            <div class="flex-1 bg-white p-4 overflow-y-auto no-scrollbar relative flex flex-col gap-5" id="sentence-area">
                <!-- Dynamic Content -->
            </div>

            <!-- Controls Bar -->
            <div class="h-12 flex items-center justify-between px-3 bg-slate-50 border-t border-slate-200 shrink-0 select-none">
                
                <!-- Quick Fill Toggle -->
                <div class="flex items-center gap-2">
                    <div class="relative inline-block w-10 mr-1 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="quick-fill-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="quick-fill-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                    <span class="text-xs font-bold text-slate-600 flex flex-col">
                        <span>Quick Fill</span>
                        <span class="text-[9px] text-slate-400" id="quick-fill-status">OFF</span>
                    </span>
                </div>

                <button onclick="checkLevel()" class="bg-green-600 text-white px-5 py-2 rounded-lg text-sm font-bold shadow-lg active:scale-95 hover:bg-green-700 transition">
                    Check Answer ‚úì
                </button>
            </div>

            <!-- Word Bank (Bottom) -->
            <div class="h-[200px] bg-slate-100 border-t border-slate-300 p-2 shrink-0 flex flex-col">
                <div class="flex justify-between items-center mb-2 px-1">
                    <span class="text-xs text-slate-500 font-bold uppercase tracking-wider">Word Bank</span>
                    <button onclick="resetCurrentLevel()" class="text-xs text-red-500 hover:text-red-700 font-bold bg-white px-2 py-0.5 rounded border border-red-100">Reset</button>
                </div>
                <div id="word-bank" class="flex-1 flex flex-wrap content-start gap-2 overflow-y-auto pb-8 pr-1">
                    <!-- Dynamic Content -->
                </div>
            </div>
        </div>

        <!-- 3. END SCREEN (Result) -->
        <div id="end-screen" class="absolute inset-0 bg-white z-50 flex flex-col p-5 hidden overflow-y-auto">
            <div class="text-center mb-6">
                <div class="text-5xl mb-2">üéâ</div>
                <h2 class="text-2xl font-bold text-indigo-700">Level Complete!</h2>
            </div>
            
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-6 shadow-sm">
                <div class="flex justify-between mb-2 text-sm border-b border-slate-200 pb-2">
                    <span class="text-slate-500">Level:</span>
                    <span class="font-bold text-slate-800" id="result-level-name">-</span>
                </div>
                <div class="flex justify-between mb-2 text-sm">
                    <span class="text-slate-500">Time:</span>
                    <span class="font-mono font-bold" id="final-time">00:00</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-slate-500">Completed:</span>
                    <span class="font-mono text-xs mt-1" id="final-date">-</span>
                </div>
            </div>

            <h3 class="font-bold text-slate-700 mb-2 border-b pb-1">Review</h3>
            <div id="review-content" class="text-sm leading-loose space-y-3 mb-6 font-serif text-slate-700">
                <!-- Dynamic Content -->
            </div>

            <div class="mt-auto flex gap-3 pb-4">
                <button onclick="downloadScreenshot('level')" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold shadow text-sm active:scale-95">
                    üì• Save Image
                </button>
                <button onclick="goHome()" class="flex-1 bg-slate-200 text-slate-700 py-3 rounded-xl font-bold text-sm active:scale-95 hover:bg-slate-300">
                    üè† Menu
                </button>
            </div>
        </div>

    </main>

    <!-- Hidden Container for Full Report Generation -->
    <div id="full-report-container" class="fixed top-0 left-[-9999px] w-[600px] bg-white p-8">
        <h1 class="text-3xl font-bold text-center mb-6 text-indigo-800">üá¨üáß London Trip Certificate</h1>
        <div id="report-stats" class="grid grid-cols-1 gap-4 mb-8"></div>
        <div class="text-center text-slate-400 text-sm">Generated by EdTech Tool</div>
    </div>

    <script>
        // --- DATA ---
        const levelsDB = {
            'dialogue1': {
                title: "Dialogue Part 1",
                sentences: [
                    { en: "How do we go to our hotel, Dad?", zh: "Áà∏ÔºåÊàëÂÄëË¶ÅÊÄéÈ∫ºÂéªÊàëÂÄëÁöÑÈ£ØÂ∫óÔºü" },
                    { en: "We can take the train or the Tube.", zh: "ÊàëÂÄëÂèØ‰ª•Êê≠ÁÅ´ËªäÊàñÂú∞Èêµ(Tube)„ÄÇ" },
                    { en: "We are lost, but we don't have a map.", zh: "ÊàëÂÄëËø∑Ë∑Ø‰∫ÜÔºå‰ΩÜÊàëÂÄëÊ≤íÊúâÂú∞Âúñ„ÄÇ" },
                    { en: "Go straight and turn left on Berkeley Street.", zh: "Áõ¥Ëµ∞‰∏¶Âú® Berkeley Ë°óÂ∑¶ËΩâ„ÄÇ" }
                ]
            },
            'dialogue2': {
                title: "Dialogue Part 2",
                sentences: [
                    { en: "Excuse me. Where is Room 101?", zh: "Ë´ãÂïè‰∏Ä‰∏ãÔºå101 ËôüÊàøÂú®Âì™Ë£°Ôºü" },
                    { en: "It's on the first floor.", zh: "ÂÆÉÂú®‰∫åÊ®ì(Ëã±ÂºèÁöÑ‰∏ÄÊ®ì)„ÄÇ" },
                    { en: "Go up the stairs, and it's the first one on the right.", zh: "‰∏äÊ®ìÊ¢ØÂæåÔºåÂè≥ÈÇäÁ¨¨‰∏ÄÈñìÂ∞±ÊòØ‰∫Ü„ÄÇ" },
                    { en: "This is the ground floor, sir.", zh: "ÂÖàÁîüÔºåÈÄôË£°ÊòØÂú∞Èù¢Â±§„ÄÇ" }
                ]
            },
            'reading': {
                title: "Reading Challenge",
                sentences: [
                    { en: "Today was our second day in London.", zh: "‰ªäÂ§©ÊòØÊàëÂÄëÂú®ÂÄ´Êï¶ÁöÑÁ¨¨‰∫åÂ§©„ÄÇ" },
                    { en: "First, we took a bus to Hyde Park and went bird watching.", zh: "È¶ñÂÖàÔºåÊàëÂÄëÊê≠ÂÖ¨ËªäÂéªÊµ∑Âæ∑ÂÖ¨Âúí‰∏¶Ë≥ûÈ≥•„ÄÇ" },
                    { en: "After that, we went to Big Ben by metro.", zh: "Âú®ÈÇ£‰πãÂæåÔºåÊàëÂÄëÊê≠Âú∞ÈêµÂéªÂ§ßÁ¨®Èêò„ÄÇ" },
                    { en: "Finally, we went on a boat ride on the River Thames.", zh: "ÊúÄÂæåÔºåÊàëÂÄëÂú®Ê≥∞Êô§Â£´Ê≤≥Êê≠ËàπÈÅäÊ≤≥„ÄÇ" }
                ]
            }
        };

        // --- STATE ---
        let currentLevelId = null;
        let startTime = 0;
        let timerInterval = null;
        let errorLog = new Set();
        // New Data Structure: Object storing details: { 'levelId': { time: '00:12', date: '...' } }
        let progressData = JSON.parse(localStorage.getItem('londonTripData_v2') || '{}');

        let selectedWord = null;
        let selectedSlot = null;
        let isQuickFill = false;

        // --- INIT ---
        window.onload = function() {
            updateHomeUI();
            
            // Toggle Listener
            const toggle = document.getElementById('quick-fill-toggle');
            toggle.addEventListener('change', function() {
                isQuickFill = this.checked;
                document.getElementById('quick-fill-status').innerText = isQuickFill ? "ON" : "OFF";
                // Color change logic
                document.getElementById('quick-fill-status').className = isQuickFill ? 
                    "text-[9px] text-green-600 font-bold" : "text-[9px] text-slate-400";
            });
        };

        // --- HOME SCREEN LOGIC ---
        function updateHomeUI() {
            const completedKeys = Object.keys(progressData);
            
            // Update Buttons
            ['dialogue1', 'dialogue2', 'reading'].forEach(id => {
                const btn = document.getElementById(`btn-${id}`);
                if (progressData[id]) {
                    btn.classList.add('completed');
                } else {
                    btn.classList.remove('completed');
                }
            });

            // Update Text
            document.getElementById('progress-text').innerText = `${completedKeys.length}/3 Completed`;

            // Check for Full Completion
            const certArea = document.getElementById('final-certificate-area');
            const certDetails = document.getElementById('cert-details');
            
            if (completedKeys.length === 3) {
                certArea.classList.remove('hidden');
                certDetails.innerHTML = '';
                // Generate simple list
                for (const [id, data] of Object.entries(progressData)) {
                    certDetails.innerHTML += `<div class="flex justify-between"><span>${levelsDB[id].title}</span><span class="font-mono">${data.time}</span></div>`;
                }
            } else {
                certArea.classList.add('hidden');
            }
        }

        function goHome() {
            clearInterval(timerInterval);
            document.getElementById('game-container').classList.add('hidden');
            document.getElementById('home-screen').classList.remove('hidden');
            updateHomeUI();
        }

        // --- GAME START ---
        function startGame(levelId) {
            currentLevelId = levelId;
            const levelData = levelsDB[levelId];
            
            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            document.getElementById('level-content').classList.remove('hidden');
            document.getElementById('end-screen').classList.add('hidden');
            
            document.getElementById('back-home-btn').classList.remove('hidden');
            document.getElementById('game-timer').classList.remove('hidden');
            
            errorLog.clear();
            deselectAll();
            
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();
            loadLevelData(levelData);
        }

        function updateTimer() {
            const delta = Math.floor((Date.now() - startTime) / 1000);
            const m = Math.floor(delta / 60).toString().padStart(2, '0');
            const s = (delta % 60).toString().padStart(2, '0');
            document.getElementById('game-timer').innerText = `${m}:${s}`;
        }

        // --- RENDERING ---
        function loadLevelData(data) {
            // Translation
            const translationHTML = data.sentences.map((s, i) => 
                `<div class="flex items-start gap-2"><span class="bg-indigo-100 text-indigo-700 px-1.5 rounded text-xs font-bold mt-0.5">${i+1}</span><span>${s.zh}</span></div>`
            ).join('');
            document.getElementById('translation-display').innerHTML = translationHTML;

            // Sentences
            const sentenceArea = document.getElementById('sentence-area');
            sentenceArea.innerHTML = '';
            let allWords = [];

            data.sentences.forEach((s, sIdx) => {
                const words = s.en.split(/\s+/);
                const fixedIndices = getFixedIndices(words.length, 0.3);

                const row = document.createElement('div');
                row.className = "border-b border-dashed border-slate-200 pb-3 last:border-0";
                
                // Sentence container
                const slotContainer = document.createElement('div');
                slotContainer.className = "leading-loose text-lg flex flex-wrap gap-y-3 gap-x-1 items-center";
                
                // Add number
                const num = document.createElement('span');
                num.className = "text-xs font-bold text-slate-400 mr-1 select-none";
                num.innerText = `${sIdx+1}.`;
                slotContainer.appendChild(num);

                words.forEach((word, wIdx) => {
                    const match = word.match(/^([a-zA-Z0-9'-]+)(.*)$/);
                    if (match) {
                        const coreWord = match[1];
                        const punctuation = match[2];

                        if (fixedIndices.has(wIdx)) {
                            const span = document.createElement('span');
                            span.className = "fixed-word mr-1";
                            span.innerText = word; 
                            slotContainer.appendChild(span);
                        } else {
                            const slot = document.createElement('div');
                            slot.id = `slot-${sIdx}-${wIdx}`; 
                            slot.className = "drop-zone";
                            slot.style.width = Math.max(40, coreWord.length * 10) + "px";
                            slot.dataset.sentenceIdx = sIdx;
                            slot.dataset.correctWord = coreWord;

                            // Events
                            slot.addEventListener('click', () => handleSlotClick(slot));
                            // Desktop Drag
                            slot.addEventListener('dragover', (e) => e.preventDefault());
                            slot.addEventListener('drop', (e) => handleDrop(e, slot));
                            
                            slotContainer.appendChild(slot);

                            if (punctuation) {
                                const puncSpan = document.createElement('span');
                                puncSpan.className = "mr-1 text-slate-500 font-bold";
                                puncSpan.innerText = punctuation;
                                slotContainer.appendChild(puncSpan);
                            } else {
                                const spacer = document.createElement('span');
                                spacer.className = "mr-1";
                                slotContainer.appendChild(spacer);
                            }

                            allWords.push({ id: `w-${sIdx}-${wIdx}`, text: coreWord });
                        }
                    } else {
                        const span = document.createElement('span');
                        span.className = "mr-1";
                        span.innerText = word;
                        slotContainer.appendChild(span);
                    }
                });
                row.appendChild(slotContainer);
                sentenceArea.appendChild(row);
            });

            renderWordBank(allWords);
        }

        function getFixedIndices(length, ratio) {
            const count = Math.max(1, Math.floor(length * ratio)); 
            const indices = Array.from({length}, (_, i) => i);
            for (let i = indices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [indices[i], indices[j]] = [indices[j], indices[i]];
            }
            return new Set(indices.slice(0, count));
        }

        // --- WORD BANK & DRAG LOGIC ---

        function renderWordBank(words) {
            const bank = document.getElementById('word-bank');
            bank.innerHTML = '';
            words.sort((a, b) => a.text.toLowerCase().localeCompare(b.text.toLowerCase()));
            words.forEach(w => {
                bank.appendChild(createWordCard(w.id, w.text));
            });
        }

        function createWordCard(id, text) {
            const div = document.createElement('div');
            div.id = id;
            div.className = "word-card";
            div.innerText = text;
            div.draggable = true;
            div.dataset.text = text;

            // Click Handler
            div.addEventListener('click', (e) => handleWordBankClick(e, div));
            
            // Desktop Drag
            div.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('type', 'bank');
                e.dataTransfer.setData('sourceId', id);
                div.classList.add('opacity-50');
                deselectAll();
            });
            div.addEventListener('dragend', () => div.classList.remove('opacity-50'));

            // MOBILE TOUCH DRAG IMPLEMENTATION
            div.addEventListener('touchstart', handleTouchStart, {passive: false});
            div.addEventListener('touchmove', handleTouchMove, {passive: false});
            div.addEventListener('touchend', handleTouchEnd);

            return div;
        }

        // --- CUSTOM TOUCH HANDLERS (Mobile Drag Fix) ---
        let dragSrcEl = null;
        let dragClone = null;
        let touchOffsetX = 0;
        let touchOffsetY = 0;

        function handleTouchStart(e) {
            if (e.touches.length > 1) return; // Ignore multi-touch
            
            dragSrcEl = e.target;
            // Prevent scrolling
            e.preventDefault(); 
            
            // Create a clone for visual feedback
            dragClone = dragSrcEl.cloneNode(true);
            dragClone.classList.add('dragging-clone');
            
            const touch = e.touches[0];
            const rect = dragSrcEl.getBoundingClientRect();
            
            // Calculate offset to keep finger relative to element
            touchOffsetX = touch.clientX - rect.left;
            touchOffsetY = touch.clientY - rect.top;
            
            // Position clone
            dragClone.style.left = (rect.left) + 'px';
            dragClone.style.top = (rect.top) + 'px';
            
            document.body.appendChild(dragClone);
            dragSrcEl.style.opacity = '0.4';
            
            deselectAll(); // Clear specific selection
        }

        function handleTouchMove(e) {
            if (!dragClone) return;
            e.preventDefault(); // Stop scroll
            
            const touch = e.touches[0];
            dragClone.style.left = (touch.clientX - touchOffsetX) + 'px';
            dragClone.style.top = (touch.clientY - touchOffsetY) + 'px';
        }

        function handleTouchEnd(e) {
            if (!dragClone) return;
            
            // Hide clone to detect element underneath
            dragClone.style.display = 'none';
            const touch = e.changedTouches[0];
            const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            
            // Find closest drop zone
            const dropZone = elemBelow ? elemBelow.closest('.drop-zone') : null;
            
            if (dropZone) {
                // Logic same as 'Drop'
                fillSlot(dropZone, { id: dragSrcEl.id, text: dragSrcEl.dataset.text });
                dragSrcEl.remove();
            } else {
                // Return to normal
                dragSrcEl.style.opacity = '1';
            }

            // Cleanup
            dragClone.remove();
            dragClone = null;
            dragSrcEl = null;
        }

        // --- INTERACTION LOGIC (Click & Quick Fill) ---

        function handleWordBankClick(e, card) {
            e.stopPropagation();

            if (isQuickFill) {
                // ‚ö° Quick Fill Logic
                const emptySlots = Array.from(document.querySelectorAll('.drop-zone:not(.filled)'));
                if (emptySlots.length > 0) {
                    // Fill the first empty slot
                    fillSlot(emptySlots[0], { id: card.id, text: card.dataset.text });
                    card.remove();
                    // Animation feedback could go here
                } else {
                    // No slots available, maybe shake?
                    card.classList.add('shake');
                    setTimeout(() => card.classList.remove('shake'), 300);
                }
            } else {
                // üëÜ Standard Selection Logic
                if (selectedWord === card) {
                    deselectAll();
                } else {
                    deselectAll();
                    selectedWord = card;
                    card.classList.add('selected');
                }
            }
        }

        function handleSlotClick(slot) {
            // 1. Fill from selected Bank Word
            if (selectedWord) {
                fillSlot(slot, { id: selectedWord.id, text: selectedWord.dataset.text });
                selectedWord.remove();
                deselectAll();
            }
            // 2. Move from another Slot
            else if (selectedSlot) {
                if (selectedSlot !== slot) {
                    const sourceData = { id: selectedSlot.dataset.filledWordId, text: selectedSlot.innerText };
                    fillSlot(slot, sourceData);
                    emptySlot(selectedSlot);
                }
                deselectAll();
            }
            // 3. Select Slot (to move)
            else if (slot.classList.contains('filled') && !slot.classList.contains('correct-lock')) {
                if (slot.classList.contains('slot-selected')) {
                    deselectAll();
                } else {
                    deselectAll();
                    selectedSlot = slot;
                    slot.classList.add('slot-selected');
                }
            }
        }

        function handleDrop(e, slot) {
            e.preventDefault();
            const type = e.dataTransfer.getData('type');
            const sourceId = e.dataTransfer.getData('sourceId');

            if (type === 'bank') {
                const card = document.getElementById(sourceId);
                if (card) {
                    fillSlot(slot, { id: card.id, text: card.dataset.text });
                    card.remove();
                }
            }
        }

        // --- CORE SLOT OPERATIONS ---

        function fillSlot(slot, wordData) {
            // Overwrite existing? Return to bank
            if (slot.classList.contains('filled')) {
                returnWordToBank(slot);
            }

            slot.innerText = wordData.text;
            slot.classList.add('filled');
            slot.dataset.filledWordId = wordData.id;
            
            // Make slot draggable for future moves (desktop)
            slot.draggable = true;
            slot.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('type', 'slot');
                e.dataTransfer.setData('sourceId', e.target.id);
            });
            
            // Add Touch support for Slot moving (Optional advanced feature, skipping for simplicity to focus on Bank->Slot)
            // But we can add basic return-on-tap logic via handleSlotClick
        }

        function emptySlot(slot) {
            slot.innerText = "";
            slot.classList.remove('filled', 'slot-selected', 'shake');
            delete slot.dataset.filledWordId;
            slot.draggable = false;
        }

        function returnWordToBank(slot) {
            if (!slot.dataset.filledWordId) return;
            const bank = document.getElementById('word-bank');
            // Re-create card
            const card = createWordCard(slot.dataset.filledWordId, slot.innerText);
            bank.appendChild(card);
            
            // Sort
            const cards = Array.from(bank.children);
            cards.sort((a, b) => a.innerText.toLowerCase().localeCompare(b.innerText.toLowerCase()));
            cards.forEach(c => bank.appendChild(c));
            
            emptySlot(slot);
        }

        function deselectAll() {
            if (selectedWord) selectedWord.classList.remove('selected');
            if (selectedSlot) selectedSlot.classList.remove('slot-selected');
            selectedWord = null;
            selectedSlot = null;
        }

        function resetCurrentLevel() {
            if(confirm("Reset words?")) loadLevelData(levelsDB[currentLevelId]);
        }

        // --- COMPLETION LOGIC ---

        function checkLevel() {
            const slots = document.querySelectorAll('.drop-zone');
            let allCorrect = true;

            slots.forEach(slot => {
                if (slot.classList.contains('correct-lock')) return;

                const userWord = slot.innerText.trim();
                const targetWord = slot.dataset.correctWord;

                if (userWord === targetWord) {
                    slot.classList.add('correct-lock');
                    slot.classList.remove('filled', 'slot-selected');
                    slot.draggable = false;
                    // Remove listeners by cloning
                    const newSlot = slot.cloneNode(true);
                    slot.replaceWith(newSlot);
                } else {
                    allCorrect = false;
                    if (userWord !== "") {
                        slot.classList.add('shake');
                        setTimeout(() => slot.classList.remove('shake'), 500);
                        errorLog.add(targetWord);
                    }
                }
            });

            if (allCorrect) {
                setTimeout(showEndScreen, 500);
            }
        }

        function showEndScreen() {
            clearInterval(timerInterval);
            
            const now = new Date();
            const dateStr = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            const timeStr = document.getElementById('game-timer').innerText;

            // Save Data
            progressData[currentLevelId] = {
                time: timeStr,
                date: dateStr
            };
            localStorage.setItem('londonTripData_v2', JSON.stringify(progressData));

            // UI
            document.getElementById('level-content').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');

            const levelData = levelsDB[currentLevelId];
            document.getElementById('result-level-name').innerText = levelData.title;
            document.getElementById('final-time').innerText = timeStr;
            document.getElementById('final-date').innerText = dateStr;

            // Review Generation
            const reviewDiv = document.getElementById('review-content');
            reviewDiv.innerHTML = '';
            levelData.sentences.forEach(s => {
                const words = s.en.split(/\s+/);
                const htmlWords = words.map(w => {
                    const match = w.match(/^([a-zA-Z0-9'-]+)(.*)$/);
                    if(match && errorLog.has(match[1])) {
                        return `<span class="error-mark">${match[1]}</span>${match[2]}`;
                    }
                    return w;
                }).join(' ');
                reviewDiv.innerHTML += `<div class="mb-2 border-b border-slate-100 pb-1"><div class="text-xs text-slate-400">${s.zh}</div><div class="font-medium">${htmlWords}</div></div>`;
            });
        }

        function clearProgress() {
            if(confirm("Clear all progress history?")) {
                localStorage.removeItem('londonTripData_v2');
                progressData = {};
                updateHomeUI();
            }
        }

        // --- DOWNLOADS ---

        async function downloadScreenshot(mode) {
            let target, filename;
            if (mode === 'level') {
                target = document.getElementById('end-screen');
                filename = `Result_${currentLevelId}.jpg`;
            }

            // Hide buttons momentarily
            const buttons = target.querySelectorAll('button');
            buttons.forEach(b => b.style.display = 'none');
            
            const clone = target.cloneNode(true);
            clone.style.width = '600px'; 
            clone.style.position = 'fixed'; clone.style.left = '-9999px'; clone.style.top = '0';
            clone.classList.remove('hidden');
            document.body.appendChild(clone);

            try {
                const canvas = await html2canvas(clone, { scale: 2 });
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.download = filename;
                link.click();
            } finally {
                clone.remove();
                buttons.forEach(b => b.style.display = 'block');
            }
        }

        async function downloadFullReport() {
            const container = document.getElementById('full-report-container');
            const statsDiv = document.getElementById('report-stats');
            
            // Build Report HTML
            statsDiv.innerHTML = '';
            let totalSeconds = 0;
            
            for (const [id, data] of Object.entries(progressData)) {
                // Parse time to seconds for total
                const parts = data.time.split(':');
                totalSeconds += parseInt(parts[0])*60 + parseInt(parts[1]);

                const levelTitle = levelsDB[id].title;
                const html = `
                    <div class="border-b-2 border-slate-200 pb-4">
                        <h3 class="font-bold text-lg text-slate-700">${levelTitle}</h3>
                        <div class="flex justify-between mt-2 text-sm">
                            <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded">Time: ${data.time}</span>
                            <span class="text-slate-500">${data.date}</span>
                        </div>
                    </div>
                `;
                statsDiv.innerHTML += html;
            }

            // Add Total Time
            const totalM = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const totalS = (totalSeconds % 60).toString().padStart(2, '0');
            statsDiv.innerHTML += `
                <div class="mt-4 text-center bg-slate-100 p-4 rounded-lg">
                    <span class="text-slate-500 font-bold uppercase text-xs">Total Time</span>
                    <div class="text-2xl font-mono font-bold text-indigo-600">${totalM}:${totalS}</div>
                </div>
            `;

            // Capture
            try {
                const canvas = await html2canvas(container, { scale: 2 });
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.download = `London_Trip_Full_Report.jpg`;
                link.click();
            } catch(e) {
                alert("Error generating report");
            }
        }
    </script>
</body>
</html>