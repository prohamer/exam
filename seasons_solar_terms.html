<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å››å­£ç¯€æ°£ - äº’å‹•å¼æ¸¬é©—ç³»çµ±</title>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor: default;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #FFB6C1 0%, #DDA0DD 50%, #B0E0E6 100%);
            min-height: 100vh;
            overscroll-behavior: none;
            -webkit-user-select: none;
            user-select: none;
            overflow-x: hidden;
        }

        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            cursor: text;
        }

        button, a, .clickable {
            cursor: pointer !important;
        }

        .drag-item {
            transition: all 0.2s ease;
            cursor: grab !important;
            touch-action: none;
            -webkit-touch-callout: none;
        }

        .drag-item:active {
            cursor: grabbing !important;
        }

        @media (hover: hover) {
            .drag-item:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            }
        }

        .dragging {
            opacity: 0.5;
            transform: scale(1.05);
            z-index: 1000;
            position: fixed;
            pointer-events: none;
        }

        .cursor-move {
            cursor: move !important;
            touch-action: none;
            -webkit-touch-callout: none;
        }

        .cursor-move:active {
            cursor: grabbing !important;
        }

        .drop-zone {
            transition: all 0.2s ease;
            min-height: 80px;
        }

        .drop-zone.drag-over {
            background: rgba(59, 130, 246, 0.2);
            border: 3px dashed #3b82f6 !important;
            transform: scale(1.02);
        }

        .saying-slot {
            transition: all 0.2s ease;
            min-height: 60px;
            min-width: 80px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
        }

        .saying-slot.drag-over {
            background: rgba(59, 130, 246, 0.3);
            border: 3px dashed #3b82f6 !important;
            transform: scale(1.05);
        }

        .correct-answer {
            animation: correctPulse 0.6s ease-out;
            border: 3px solid #10b981 !important;
            background: rgba(16, 185, 129, 0.1);
        }

        .wrong-answer {
            animation: shake 0.5s ease-out;
            border: 3px solid #ef4444 !important;
            background: rgba(239, 68, 68, 0.1);
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .animate-bounce-slow {
            animation: bounce-slow 2s ease-in-out infinite;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // è§¸æ§æ‹–æ›³æ”¯æ´è®Šæ•¸
        let touchDragData = null;
        let touchDragElement = null;
        let touchClone = null;
        let touchRemoveCallback = null;
        let touchSourceZoneId = null;

        function handleTouchStart(e, item, removeCallback) {
            e.preventDefault();
            touchDragData = item;
            touchDragElement = e.currentTarget;
            touchRemoveCallback = removeCallback;
            
            const scrollContainer = document.querySelector('.overflow-y-auto');
            if (scrollContainer) {
                scrollContainer.style.overflowY = 'hidden';
                scrollContainer.style.touchAction = 'none';
            }
            
            const sourceZone = touchDragElement.closest('.drop-zone, .saying-slot');
            touchSourceZoneId = sourceZone ? sourceZone.getAttribute('data-zone-id') : null;
            
            const touch = e.touches[0];
            touchClone = touchDragElement.cloneNode(true);
            touchClone.style.position = 'fixed';
            touchClone.style.zIndex = '10000';
            touchClone.style.opacity = '0.8';
            touchClone.style.pointerEvents = 'none';
            touchClone.style.width = touchDragElement.offsetWidth + 'px';
            touchClone.style.left = (touch.clientX - touchDragElement.offsetWidth / 2) + 'px';
            touchClone.style.top = (touch.clientY - touchDragElement.offsetHeight / 2) + 'px';
            touchClone.style.transition = 'none';
            document.body.appendChild(touchClone);
            
            touchDragElement.style.opacity = '0.2';
            touchDragElement.style.transform = 'scale(0.95)';
            touchDragElement.style.transition = 'opacity 0.2s, transform 0.2s';
        }

        function handleTouchMove(e) {
            if (!touchClone) return;
            e.preventDefault();
            e.stopPropagation();
            
            const touch = e.touches[0];
            touchClone.style.left = (touch.clientX - touchClone.offsetWidth / 2) + 'px';
            touchClone.style.top = (touch.clientY - touchClone.offsetHeight / 2) + 'px';
            
            const dropZones = document.querySelectorAll('.drop-zone, .saying-slot');
            dropZones.forEach(zone => zone.classList.remove('drag-over'));
            
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            if (elementBelow) {
                const dropZone = elementBelow.closest('.drop-zone, .saying-slot');
                if (dropZone) {
                    const targetZoneId = dropZone.getAttribute('data-zone-id');
                    if (targetZoneId !== touchSourceZoneId) {
                        dropZone.classList.add('drag-over');
                    }
                }
            }
        }

        function handleTouchEnd(e, dropCallback) {
            if (!touchClone) return;
            
            const touch = e.changedTouches[0];
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            
            let targetZone = null;
            let targetZoneId = null;
            if (elementBelow) {
                targetZone = elementBelow.closest('.drop-zone, .saying-slot');
                if (targetZone) {
                    targetZoneId = targetZone.getAttribute('data-zone-id');
                }
            }
            
            if (touchClone && touchClone.parentNode) {
                touchClone.parentNode.removeChild(touchClone);
            }
            touchClone = null;
            
            const scrollContainer = document.querySelector('.overflow-y-auto');
            if (scrollContainer) {
                scrollContainer.style.overflowY = 'auto';
                scrollContainer.style.touchAction = '';
            }
            
            const dropZones = document.querySelectorAll('.drop-zone, .saying-slot');
            dropZones.forEach(zone => zone.classList.remove('drag-over'));
            
            const isDifferentZone = targetZone && targetZoneId && touchDragData && 
                                   targetZoneId !== touchSourceZoneId;
            
            if (isDifferentZone && dropCallback) {
                if (touchRemoveCallback) {
                    touchRemoveCallback();
                }
                
                if (targetZoneId !== 'items') {
                    dropCallback(touchDragData, targetZoneId);
                }
                
                if (touchDragElement && touchDragElement.parentNode) {
                    touchDragElement.style.opacity = '';
                    touchDragElement.style.transform = '';
                }
            } else {
                if (touchDragElement && touchDragElement.parentNode) {
                    touchDragElement.style.opacity = '1';
                    touchDragElement.style.transform = 'scale(1)';
                    touchDragElement.style.transition = 'opacity 0.2s, transform 0.2s';
                    void touchDragElement.offsetHeight;
                }
            }
            
            touchDragData = null;
            touchDragElement = null;
            touchRemoveCallback = null;
            touchSourceZoneId = null;
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // é¡Œç›®è³‡æ–™
        const TESTS_DATA = {
            "test-1": {
                id: "test-1",
                title: "å››å­£ç‰¹è‰²è¾¨è­˜",
                subtitle: "æ™¯ç‰©èˆ‡ç‰©å€™",
                difficulty: "â­â­",
                itemCount: 16,
                description: "è«‹å°‡ä»¥ä¸‹æ™¯ç‰©ã€æ´»å‹•ã€ç‰©å€™åˆ†é¡åˆ°å°æ‡‰çš„å­£ç¯€",
                color: "from-pink-200 to-rose-300",
                icon: "fa-leaf",
                type: "classification",
                zones: [
                    { id: 'spring', title: 'æ˜¥å­£', icon: 'fa-seedling' },
                    { id: 'summer', title: 'å¤å­£', icon: 'fa-sun' },
                    { id: 'autumn', title: 'ç§‹å­£', icon: 'fa-wind' },
                    { id: 'winter', title: 'å†¬å­£', icon: 'fa-snowflake' }
                ],
                items: [
                    { id: 'item1', text: 'æ¡ƒèŠ±ç››é–‹', val: 'taohua' },
                    { id: 'item2', text: 'æ˜¥è€•æ’­ç¨®', val: 'chungeng' },
                    { id: 'item3', text: 'ç‡•å­æ­¸ä¾†', val: 'yanzi' },
                    { id: 'item4', text: 'æŸ³æ¨¹ç™¼èŠ½', val: 'liushu' },
                    { id: 'item5', text: 'èŸ¬é³´è›™å«', val: 'chanming' },
                    { id: 'item6', text: 'è·èŠ±ç››é–‹', val: 'hehua' },
                    { id: 'item7', text: 'åˆå¾Œé›·é™£é›¨', val: 'leizhenyu' },
                    { id: 'item8', text: 'è¥¿ç“œæˆç†Ÿ', val: 'xigua' },
                    { id: 'item9', text: 'æ¥“è‘‰è½‰ç´…', val: 'fengye' },
                    { id: 'item10', text: 'ç¨»ç©—é‡‘é»ƒ', val: 'daosui' },
                    { id: 'item11', text: 'ç§‹æ”¶è¾²å¿™', val: 'qiushou' },
                    { id: 'item12', text: 'å¤§é›å—é£›', val: 'dayan' },
                    { id: 'item13', text: 'æ¢…èŠ±ç¶»æ”¾', val: 'meihua' },
                    { id: 'item14', text: 'å€™é³¥éå¢ƒ', val: 'houniao' },
                    { id: 'item15', text: 'å¯’é¢¨åˆºéª¨', val: 'hanfeng' },
                    { id: 'item16', text: 'ç™½é›ªé£„é£„', val: 'baixue' }
                ],
                solution: {
                    spring: ['taohua', 'chungeng', 'yanzi', 'liushu'],
                    summer: ['chanming', 'hehua', 'leizhenyu', 'xigua'],
                    autumn: ['fengye', 'daosui', 'qiushou', 'dayan'],
                    winter: ['meihua', 'houniao', 'hanfeng', 'baixue']
                }
            },
            "test-2": {
                id: "test-2",
                title: "ç¯€æ°£èˆ‡å­£ç¯€å°æ‡‰",
                subtitle: "äºŒåå››ç¯€æ°£",
                difficulty: "â­â­",
                itemCount: 12,
                description: "è«‹å°‡ä»¥ä¸‹ç¯€æ°£åˆ†é¡åˆ°å°æ‡‰çš„å­£ç¯€",
                color: "from-yellow-200 to-amber-300",
                icon: "fa-calendar-days",
                type: "classification",
                zones: [
                    { id: 'spring', title: 'æ˜¥å­£ç¯€æ°£', icon: 'fa-seedling' },
                    { id: 'summer', title: 'å¤å­£ç¯€æ°£', icon: 'fa-sun' },
                    { id: 'autumn', title: 'ç§‹å­£ç¯€æ°£', icon: 'fa-wind' },
                    { id: 'winter', title: 'å†¬å­£ç¯€æ°£', icon: 'fa-snowflake' }
                ],
                items: [
                    { id: 'item1', text: 'ç«‹æ˜¥', val: 'lichun' },
                    { id: 'item2', text: 'é©šèŸ„', val: 'jingzhe' },
                    { id: 'item3', text: 'æ¸…æ˜', val: 'qingming' },
                    { id: 'item4', text: 'ç«‹å¤', val: 'lixia' },
                    { id: 'item5', text: 'èŠ’ç¨®', val: 'mangzhong' },
                    { id: 'item6', text: 'å¤è‡³', val: 'xiazhi' },
                    { id: 'item7', text: 'ç«‹ç§‹', val: 'liqiu' },
                    { id: 'item8', text: 'ç™½éœ²', val: 'bailu' },
                    { id: 'item9', text: 'ç§‹åˆ†', val: 'qiufen' },
                    { id: 'item10', text: 'ç«‹å†¬', val: 'lidong' },
                    { id: 'item11', text: 'å¤§é›ª', val: 'daxue' },
                    { id: 'item12', text: 'å†¬è‡³', val: 'dongzhi' }
                ],
                solution: {
                    spring: ['lichun', 'jingzhe', 'qingming'],
                    summer: ['lixia', 'mangzhong', 'xiazhi'],
                    autumn: ['liqiu', 'bailu', 'qiufen'],
                    winter: ['lidong', 'daxue', 'dongzhi']
                }
            },
            "test-3": {
                id: "test-3",
                title: "ç¯€æ°£ä¿—è«ºé…å°",
                subtitle: "è¾²è«ºæ™ºæ…§",
                difficulty: "â­â­â­",
                itemCount: 18,
                description: "è«‹å°‡ç¯€æ°£æ‹–æ›³åˆ°å°æ‡‰çš„ä¿—è«ºç©ºæ ¼ä¸­",
                color: "from-orange-200 to-red-300",
                icon: "fa-book-open",
                type: "saying_match",
                terms: [
                    { id: 'term1', text: 'ç«‹æ˜¥', val: 'lichun' },
                    { id: 'term2', text: 'é›¨æ°´', val: 'yushui' },
                    { id: 'term3', text: 'é©šèŸ„', val: 'jingzhe' },
                    { id: 'term4', text: 'æ˜¥åˆ†', val: 'chunfen' },
                    { id: 'term5', text: 'æ¸…æ˜', val: 'qingming' },
                    { id: 'term6', text: 'ç«‹å¤', val: 'lixia' },
                    { id: 'term7', text: 'å°æ»¿', val: 'xiaoman' },
                    { id: 'term8', text: 'èŠ’ç¨®', val: 'mangzhong' },
                    { id: 'term9', text: 'å¤è‡³', val: 'xiazhi' },
                    { id: 'term10', text: 'å¤§æš‘', val: 'dashu' },
                    { id: 'term11', text: 'ç«‹ç§‹', val: 'liqiu' },
                    { id: 'term12', text: 'ç™½éœ²', val: 'bailu' },
                    { id: 'term13', text: 'ç§‹åˆ†', val: 'qiufen' },
                    { id: 'term14', text: 'éœœé™', val: 'shuangjiang' },
                    { id: 'term15', text: 'ç«‹å†¬', val: 'lidong' },
                    { id: 'term16', text: 'å°é›ª', val: 'xiaoxue' },
                    { id: 'term17', text: 'å¤§é›ª', val: 'daxue' },
                    { id: 'term18', text: 'å†¬è‡³', val: 'dongzhi' }
                ],
                sayings: [
                    { id: 'say1', before: 'ã€Œ', after: 'ã€ä¸€æ—¥ï¼Œç™¾è‰å›èŠ½', correctVal: 'lichun', slotId: 'slot1' },
                    { id: 'say2', before: 'ã€Œ', after: 'ã€é€£ç¶¿æ˜¯è±å¹´ï¼Œè¾²æ°‘ä¸ç”¨åŠ›è€•ç”°', correctVal: 'yushui', slotId: 'slot2' },
                    { id: 'say3', before: 'ã€Œ', after: 'ã€éï¼Œæš–å’Œå’Œï¼Œè›¤èŸ†è€è§’å”±å±±æ­Œ', correctVal: 'jingzhe', slotId: 'slot3' },
                    { id: 'say4', before: 'ã€Œ', after: 'ã€æœ‰é›¨ç—…äººç¨€', correctVal: 'chunfen', slotId: 'slot4' },
                    { id: 'say5', before: 'ã€Œ', after: 'ã€æ™‚ç¯€é›¨ç´›ç´›', correctVal: 'qingming', slotId: 'slot5' },
                    { id: 'say6', before: 'ã€Œ', after: 'ã€è£œè€çˆ¶ï¼Œä¸€å¹´è½‰é ­é¡§', correctVal: 'lixia', slotId: 'slot6' },
                    { id: 'say7', before: 'ã€Œ', after: 'ã€é›¨æ°´ç›¸è¶•ï¼ŒèŠ’ç¨®ç«ç‡’åŸ”', correctVal: 'xiaoman', slotId: 'slot7' },
                    { id: 'say8', before: 'ã€Œ', after: 'ã€å¤è‡³å¤©ï¼Œèµ°è·¯è¦äººç‰½', correctVal: 'mangzhong', slotId: 'slot8' },
                    { id: 'say9', before: 'ã€Œ', after: 'ã€ä¸éä¸ç†±ï¼Œå†¬è‡³ä¸éä¸å†·', correctVal: 'xiazhi', slotId: 'slot9' },
                    { id: 'say10', before: 'å°æš‘ä¸ç®—ç†±ï¼Œã€Œ', after: 'ã€ä¸‰ä¼å¤©', correctVal: 'dashu', slotId: 'slot10' },
                    { id: 'say11', before: 'ã€Œ', after: 'ã€å¾Œåæ—¥éåœ°ç´…', correctVal: 'liqiu', slotId: 'slot11' },
                    { id: 'say12', before: 'ã€Œ', after: 'ã€ç§‹åˆ†å¤œï¼Œä¸€å¤œå†·ä¸€å¤œ', correctVal: 'bailu', slotId: 'slot12' },
                    { id: 'say13', before: 'ã€Œ', after: 'ã€å¤©æ°£ç™½é›²ä¾†ï¼Œè™•è™•å¥½æ­Œå¹', correctVal: 'qiufen', slotId: 'slot13' },
                    { id: 'say14', before: 'ã€Œ', after: 'ã€æœ‰éœœï¼Œç©€ç±³æ»¿å€‰', correctVal: 'shuangjiang', slotId: 'slot14' },
                    { id: 'say15', before: 'ã€Œ', after: 'ã€æ™´ï¼Œä¸€å†¬å‡Œï¼›ç«‹å†¬é™°ï¼Œä¸€å†¬æº«', correctVal: 'lidong', slotId: 'slot15' },
                    { id: 'say16', before: 'ã€Œ', after: 'ã€é›ªæ»¿å¤©ï¼Œä¾†å¹´å¿…è±å¹´', correctVal: 'xiaoxue', slotId: 'slot16' },
                    { id: 'say17', before: 'ã€Œ', after: 'ã€ä¸å¯’æ˜å¹´æ—±ï¼Œå†¬è‡³ä¸å†·æ˜å¹´æ—±', correctVal: 'daxue', slotId: 'slot17' },
                    { id: 'say18', before: 'ã€Œ', after: 'ã€åƒæ¹¯åœ“ï¼Œä¸€å¹´åˆä¸€å¹´', correctVal: 'dongzhi', slotId: 'slot18' }
                ],
                solution: {
                    slot1: 'lichun',
                    slot2: 'yushui',
                    slot3: 'jingzhe',
                    slot4: 'chunfen',
                    slot5: 'qingming',
                    slot6: 'lixia',
                    slot7: 'xiaoman',
                    slot8: 'mangzhong',
                    slot9: 'xiazhi',
                    slot10: 'dashu',
                    slot11: 'liqiu',
                    slot12: 'bailu',
                    slot13: 'qiufen',
                    slot14: 'shuangjiang',
                    slot15: 'lidong',
                    slot16: 'xiaoxue',
                    slot17: 'daxue',
                    slot18: 'dongzhi'
                }
            },
            "test-4": {
                id: "test-4",
                title: "å­£ç¯€æˆèªåˆ†é¡",
                subtitle: "æˆèªèˆ‡å­£ç¯€",
                difficulty: "â­â­â­",
                itemCount: 16,
                description: "è«‹å°‡æå¯«å­£ç¯€çš„æˆèªåˆ†é¡åˆ°å°æ‡‰çš„å­£ç¯€",
                color: "from-sky-200 to-blue-300",
                icon: "fa-book",
                type: "classification",
                zones: [
                    { id: 'spring', title: 'æ˜¥å­£æˆèª', icon: 'fa-seedling' },
                    { id: 'summer', title: 'å¤å­£æˆèª', icon: 'fa-sun' },
                    { id: 'autumn', title: 'ç§‹å­£æˆèª', icon: 'fa-wind' },
                    { id: 'winter', title: 'å†¬å­£æˆèª', icon: 'fa-snowflake' }
                ],
                items: [
                    { id: 'item1', text: 'æ˜¥æš–èŠ±é–‹', val: 'chunnuanhuakai' },
                    { id: 'item2', text: 'é³¥èªèŠ±é¦™', val: 'niaoyuhuaxiang' },
                    { id: 'item3', text: 'æ˜¥æ„ç›ç„¶', val: 'chunyiangran' },
                    { id: 'item4', text: 'è¬ç´«åƒç´…', val: 'wanziqianhong' },
                    { id: 'item5', text: 'çƒˆæ—¥ç‚ç‚', val: 'lieriyanyan' },
                    { id: 'item6', text: 'æ®æ±—å¦‚é›¨', val: 'huihanruyu' },
                    { id: 'item7', text: 'å¤æ—¥ç‚ç‚', val: 'xiariyanyan' },
                    { id: 'item8', text: 'ç¶ æ¨¹æˆè”­', val: 'lvshuchengyin' },
                    { id: 'item9', text: 'ç§‹é«˜æ°£çˆ½', val: 'qiugaoqishuang' },
                    { id: 'item10', text: 'ç§‹é¢¨è½è‘‰', val: 'qiufengluoye' },
                    { id: 'item11', text: 'ä¸€è‘‰çŸ¥ç§‹', val: 'yiyezhiqiu' },
                    { id: 'item12', text: 'é‡‘é¢¨é€çˆ½', val: 'jinfengsongshuang' },
                    { id: 'item13', text: 'å†°å¤©é›ªåœ°', val: 'bingti anxuedi' },
                    { id: 'item14', text: 'å¯’é¢¨åˆºéª¨', val: 'hanfengcigu' },
                    { id: 'item15', text: 'æ»´æ°´æˆå†°', val: 'dishuichengbing' },
                    { id: 'item16', text: 'å¤©å¯’åœ°å‡', val: 'tianhandidong' }
                ],
                solution: {
                    spring: ['chunnuanhuakai', 'niaoyuhuaxiang', 'chunyiangran', 'wanziqianhong'],
                    summer: ['lieriyanyan', 'huihanruyu', 'xiariyanyan', 'lvshuchengyin'],
                    autumn: ['qiugaoqishuang', 'qiufengluoye', 'yiyezhiqiu', 'jinfengsongshuang'],
                    winter: ['bingtianxuedi', 'hanfengcigu', 'dishuichengbing', 'tianhandidong']
                }
            }
        };

        function App() {
            const [screen, setScreen] = useState('home');
            const [currentTest, setCurrentTest] = useState(null);
            const [gameState, setGameState] = useState('playing');
            const [droppedItems, setDroppedItems] = useState({});
            const [sayingSlots, setSayingSlots] = useState({});
            const [feedback, setFeedback] = useState({});
            const [startTime, setStartTime] = useState(null);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [attempts, setAttempts] = useState(0);
            const [shuffledItems, setShuffledItems] = useState([]);
            const [shuffledZones, setShuffledZones] = useState([]);
            const [draggedItem, setDraggedItem] = useState(null);
            const [dragSourceZone, setDragSourceZone] = useState(null);
            
            const [completionStatus, setCompletionStatus] = useState(() => {
                try {
                    const saved = localStorage.getItem('seasons_tests_status');
                    return saved ? JSON.parse(saved) : {};
                } catch {
                    return {};
                }
            });
            
            const [fontScale, setFontScale] = useState(() => {
                try {
                    const saved = localStorage.getItem('seasons_font_scale');
                    return saved ? parseFloat(saved) : 100;
                } catch {
                    return 100;
                }
            });
            
            useEffect(() => {
                document.documentElement.style.fontSize = `${fontScale}%`;
            }, [fontScale]);
            
            const increaseFontSize = () => {
                const newScale = Math.min(fontScale + 10, 150);
                setFontScale(newScale);
                localStorage.setItem('seasons_font_scale', newScale.toString());
            };
            
            const decreaseFontSize = () => {
                const newScale = Math.max(fontScale - 10, 70);
                setFontScale(newScale);
                localStorage.setItem('seasons_font_scale', newScale.toString());
            };

            useEffect(() => {
                let timer;
                if (gameState === 'playing' && startTime) {
                    timer = setInterval(() => {
                        setElapsedTime(Math.floor((new Date() - startTime) / 1000));
                    }, 1000);
                }
                return () => {
                    if (timer) clearInterval(timer);
                };
            }, [gameState, startTime]);

            const selectTest = (testId) => {
                const test = TESTS_DATA[testId];
                setCurrentTest(test);
                setScreen('playing');
                setGameState('playing');
                setStartTime(new Date());
                setElapsedTime(0);
                setAttempts(0);
                setDroppedItems({});
                setSayingSlots({});
                setFeedback({});
                setDraggedItem(null);
                setDragSourceZone(null);
                
                if (test.type === 'classification') {
                    setShuffledItems(shuffleArray(test.items));
                    setShuffledZones(shuffleArray(test.zones));
                } else if (test.type === 'saying_match') {
                    setShuffledItems(shuffleArray(test.terms));
                }
            };

            const handleDragStart = (e, item, sourceZone) => {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('application/json', JSON.stringify({ item, sourceZone }));
                setDraggedItem(item);
                setDragSourceZone(sourceZone);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDragEnd = (e) => {
                setDraggedItem(null);
                setDragSourceZone(null);
            };

            const handleDrop = (e, targetZone) => {
                e.preventDefault();
                
                try {
                    const data = JSON.parse(e.dataTransfer.getData('application/json'));
                    const { item, sourceZone } = data;
                    
                    if (sourceZone === targetZone) {
                        return;
                    }
                    
                    if (currentTest.type === 'classification') {
                        if (sourceZone && sourceZone !== 'items') {
                            setDroppedItems(prev => ({
                                ...prev,
                                [sourceZone]: (prev[sourceZone] || []).filter(i => i.id !== item.id)
                            }));
                        }
                        
                        if (targetZone !== 'items') {
                            setDroppedItems(prev => {
                                const existing = prev[targetZone] || [];
                                if (existing.some(i => i.id === item.id)) {
                                    return prev;
                                }
                                return {
                                    ...prev,
                                    [targetZone]: [...existing, item]
                                };
                            });
                        }
                    } else if (currentTest.type === 'saying_match') {
                        if (sourceZone && sourceZone !== 'items') {
                            setSayingSlots(prev => ({
                                ...prev,
                                [sourceZone]: null
                            }));
                        }
                        
                        if (targetZone !== 'items') {
                            setSayingSlots(prev => ({
                                ...prev,
                                [targetZone]: item
                            }));
                        }
                    }
                } catch (error) {
                    console.error('Drop error:', error);
                }
            };

            const handleTouchDrop = (item, targetZone) => {
                if (currentTest.type === 'classification') {
                    const currentItems = droppedItems[targetZone] || [];
                    const alreadyExists = currentItems.some(i => i.id === item.id);
                    
                    if (!alreadyExists) {
                        setDroppedItems(prev => ({
                            ...prev,
                            [targetZone]: [...(prev[targetZone] || []), item]
                        }));
                    }
                } else if (currentTest.type === 'saying_match') {
                    setSayingSlots(prev => ({
                        ...prev,
                        [targetZone]: item
                    }));
                }
            };

            const removeItem = (zoneId, itemId) => {
                setDroppedItems(prev => ({
                    ...prev,
                    [zoneId]: prev[zoneId].filter(item => item.id !== itemId)
                }));
            };

            const removeSayingSlot = (slotId) => {
                setSayingSlots(prev => ({
                    ...prev,
                    [slotId]: null
                }));
            };

            const checkAnswers = () => {
                setAttempts(prev => prev + 1);
                const newFeedback = {};
                let allCorrect = true;

                if (currentTest.type === 'classification') {
                    Object.keys(currentTest.solution).forEach(zoneId => {
                        const correctVals = currentTest.solution[zoneId];
                        const userVals = (droppedItems[zoneId] || []).map(item => item.val);
                        
                        const isCorrect = userVals.length > 0 &&
                                        userVals.every(val => correctVals.includes(val));
                        
                        newFeedback[zoneId] = isCorrect;
                        if (!isCorrect && userVals.length > 0) {
                            allCorrect = false;
                        }
                    });

                    const allItemsPlaced = Object.values(droppedItems).flat().length === currentTest.items.length;
                    if (!allItemsPlaced) {
                        allCorrect = false;
                    }
                } else if (currentTest.type === 'saying_match') {
                    Object.keys(currentTest.solution).forEach(slotId => {
                        const correctVal = currentTest.solution[slotId];
                        const userItem = sayingSlots[slotId];
                        
                        const isCorrect = userItem && userItem.val === correctVal;
                        newFeedback[slotId] = isCorrect;
                        
                        if (!isCorrect) {
                            allCorrect = false;
                        }
                    });
                }

                setFeedback(newFeedback);

                if (allCorrect) {
                    const completionTime = elapsedTime;
                    const newStatus = {
                        ...completionStatus,
                        [currentTest.id]: {
                            completed: true,
                            completedAt: new Date().toISOString(),
                            time: completionTime,
                            attempts: attempts + 1
                        }
                    };
                    setCompletionStatus(newStatus);
                    localStorage.setItem('seasons_tests_status', JSON.stringify(newStatus));
                    setGameState('completed');
                }
            };

            const restart = () => {
                setGameState('playing');
                setStartTime(new Date());
                setElapsedTime(0);
                setAttempts(0);
                setDroppedItems({});
                setSayingSlots({});
                setFeedback({});
                
                if (currentTest.type === 'classification') {
                    setShuffledItems(shuffleArray(currentTest.items));
                    setShuffledZones(shuffleArray(currentTest.zones));
                } else if (currentTest.type === 'saying_match') {
                    setShuffledItems(shuffleArray(currentTest.terms));
                }
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            // é¦–é 
            if (screen === 'home') {
                const allTests = Object.values(TESTS_DATA);
                const completedCount = allTests.filter(test => completionStatus[test.id]?.completed).length;
                const allCompleted = completedCount === allTests.length;

                const downloadAllCertificate = () => {
                    const element = document.getElementById('all-certificate-content');
                    html2canvas(element, {
                        backgroundColor: '#FFB6C1',
                        scale: 2,
                        width: 1200
                    }).then(canvas => {
                        const link = document.createElement('a');
                        const date = new Date();
                        link.download = `å››å­£ç¯€æ°£-å…¨éƒ¨å®Œæˆè­‰æ›¸-${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                    });
                };

                return (
                    <div className="min-h-screen flex items-center justify-center p-4 md:p-6">
                        <div className="fixed top-4 right-4 z-50 flex items-center gap-2 glass-effect rounded-xl p-2 shadow-xl">
                            <button
                                onClick={decreaseFontSize}
                                disabled={fontScale <= 70}
                                className={`px-3 py-2 rounded-lg font-bold transition-all ${
                                    fontScale <= 70
                                        ? 'bg-white/10 text-white/30 cursor-not-allowed'
                                        : 'bg-white/20 text-white hover:bg-white/30 hover:scale-110'
                                }`}
                            >
                                <span className="text-sm">A<sup className="text-xs">-</sup></span>
                            </button>
                            
                            <button
                                onClick={increaseFontSize}
                                disabled={fontScale >= 150}
                                className={`px-3 py-2 rounded-lg font-bold transition-all ${
                                    fontScale >= 150
                                        ? 'bg-white/10 text-white/30 cursor-not-allowed'
                                        : 'bg-white/20 text-white hover:bg-white/30 hover:scale-110'
                                }`}
                            >
                                <span className="text-sm">A<sup className="text-xs">+</sup></span>
                            </button>
                        </div>
                        
                        <div className="max-w-4xl w-full">
                            <div className="text-center mb-8 md:mb-12 fade-in">
                                <h1 className="text-4xl md:text-5xl font-black text-white mb-4">
                                    <i className="fas fa-cloud-sun mr-3 md:mr-4"></i>
                                    å››å­£ç¯€æ°£
                                </h1>
                                <p className="text-lg md:text-xl text-white/90 mb-2">åœ‹ä¸­åœ‹æ–‡ å‚³çµ±æ–‡åŒ–</p>
                                <p className="text-sm md:text-base text-white/70">
                                    å®Œæˆé€²åº¦ï¼š{completedCount} / {allTests.length}
                                </p>
                                
                                {allCompleted && (
                                    <div className="mt-4 glass-effect rounded-2xl p-4 md:p-6 animate-bounce-slow inline-block">
                                        <div className="text-3xl md:text-4xl mb-2">ğŸ†</div>
                                        <div className="text-lg md:text-xl font-bold text-yellow-300 mb-3">
                                            æ­å–œå®Œæˆæ‰€æœ‰æ¸¬é©—ï¼
                                        </div>
                                        <button
                                            onClick={downloadAllCertificate}
                                            className="bg-gradient-to-r from-yellow-300 to-orange-400 text-white px-6 md:px-8 py-3 md:py-4 rounded-xl font-bold text-base md:text-lg hover:scale-110 transition-all shadow-2xl"
                                        >
                                            <i className="fas fa-download mr-2"></i>
                                            ä¸‹è¼‰å®Œæ•´å­¸ç¿’è­‰æ›¸
                                        </button>
                                    </div>
                                )}
                                
                                {Object.keys(completionStatus).length > 0 && (
                                    <button
                                        onClick={() => {
                                            if (confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å®Œæˆè¨˜éŒ„å—ï¼Ÿ')) {
                                                setCompletionStatus({});
                                                localStorage.removeItem('seasons_tests_status');
                                                alert('âœ… å·²æ¸…é™¤æ‰€æœ‰è¨˜éŒ„ï¼');
                                            }
                                        }}
                                        className="mt-4 bg-red-400/80 hover:bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all shadow-lg hover:scale-105"
                                    >
                                        <i className="fas fa-trash-alt mr-2"></i>
                                        æ¸…é™¤æ‰€æœ‰è¨˜éŒ„
                                    </button>
                                )}
                            </div>

                            <div className="grid md:grid-cols-2 gap-4 md:gap-6">
                                {allTests.map((test, index) => {
                                    const isCompleted = completionStatus[test.id]?.completed;
                                    const status = completionStatus[test.id];
                                    
                                    return (
                                        <div
                                            key={test.id}
                                            className="glass-effect rounded-2xl p-6 md:p-8 hover:scale-105 transition-all duration-300 cursor-pointer fade-in relative"
                                            style={{ animationDelay: `${index * 0.1}s` }}
                                            onClick={() => selectTest(test.id)}
                                        >
                                            {isCompleted && (
                                                <div className="absolute top-3 md:top-4 right-3 md:right-4 bg-green-400 text-white px-2 md:px-3 py-1 rounded-full text-xs md:text-sm font-bold flex items-center gap-1 shadow-lg">
                                                    <i className="fas fa-check-circle"></i>
                                                    å·²å®Œæˆ
                                                </div>
                                            )}
                                            
                                            <div className="flex items-center gap-3 md:gap-4 mb-4">
                                                <div className={`w-14 h-14 md:w-16 md:h-16 bg-gradient-to-br ${test.color} rounded-xl md:rounded-2xl flex items-center justify-center flex-shrink-0 shadow-lg`}>
                                                    <i className={`${test.icon} text-2xl md:text-3xl text-white`}></i>
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <h2 className="text-lg md:text-xl font-bold text-white truncate">
                                                            {test.title}
                                                        </h2>
                                                        <span className="text-xs md:text-sm text-yellow-300 whitespace-nowrap">
                                                            {test.difficulty}
                                                        </span>
                                                    </div>
                                                    <p className="text-xs md:text-sm text-white/70">
                                                        {test.subtitle}
                                                    </p>
                                                </div>
                                            </div>
                                            
                                            <div className="text-white/80 text-sm md:text-base mb-3">
                                                é¡Œæ•¸ï¼š{test.itemCount} é¡Œ
                                            </div>
                                            
                                            {isCompleted && status && (
                                                <div className="text-white/60 text-xs md:text-sm space-y-1">
                                                    <div>â±ï¸ ç”¨æ™‚ï¼š{formatTime(status.time)}</div>
                                                    <div>ğŸ¯ å˜—è©¦ï¼š{status.attempts} æ¬¡</div>
                                                </div>
                                            )}
                                            
                                            {!isCompleted && (
                                                <div className="text-white/60 text-xs md:text-sm">
                                                    é»æ“Šé–‹å§‹æ¸¬é©—
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                            
                            {/* å…¨éƒ¨å®Œæˆè­‰æ›¸ï¼ˆéš±è—ï¼‰ */}
                            {allCompleted && (
                                <div 
                                    id="all-certificate-content" 
                                    style={{
                                        position: 'fixed',
                                        left: '-9999px',
                                        width: '1200px',
                                        backgroundColor: '#FFB6C1',
                                        padding: '60px',
                                        fontFamily: 'Noto Sans TC, sans-serif'
                                    }}
                                >
                                    <div style={{textAlign: 'center', marginBottom: '40px'}}>
                                        <div style={{fontSize: '80px', marginBottom: '20px'}}>ğŸ†</div>
                                        <h1 style={{fontSize: '48px', fontWeight: '900', color: 'white', marginBottom: '10px'}}>
                                            å­¸ç¿’å®Œæˆè­‰æ›¸
                                        </h1>
                                        <h2 style={{fontSize: '36px', fontWeight: 'bold', color: '#fff3cd', marginBottom: '20px'}}>
                                            å››å­£ç¯€æ°£ - å…¨éƒ¨é€šé—œ
                                        </h2>
                                    </div>

                                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '20px', marginBottom: '40px'}}>
                                        <div style={{backgroundColor: 'rgba(255,255,255,0.15)', borderRadius: '16px', padding: '30px', textAlign: 'center'}}>
                                            <div style={{fontSize: '40px', marginBottom: '10px'}}>ğŸ“š</div>
                                            <div style={{fontSize: '14px', color: 'rgba(255,255,255,0.8)', marginBottom: '8px'}}>å®Œæˆæ¸¬é©—</div>
                                            <div style={{fontSize: '32px', fontWeight: 'bold', color: '#4ade80'}}>4 / 4</div>
                                        </div>
                                        <div style={{backgroundColor: 'rgba(255,255,255,0.15)', borderRadius: '16px', padding: '30px', textAlign: 'center'}}>
                                            <div style={{fontSize: '40px', marginBottom: '10px'}}>ğŸ“</div>
                                            <div style={{fontSize: '14px', color: 'rgba(255,255,255,0.8)', marginBottom: '8px'}}>ç¸½é¡Œæ•¸</div>
                                            <div style={{fontSize: '32px', fontWeight: 'bold', color: 'white'}}>
                                                {allTests.reduce((sum, test) => sum + test.itemCount, 0)}
                                            </div>
                                        </div>
                                        <div style={{backgroundColor: 'rgba(255,255,255,0.15)', borderRadius: '16px', padding: '30px', textAlign: 'center'}}>
                                            <div style={{fontSize: '40px', marginBottom: '10px'}}>â±ï¸</div>
                                            <div style={{fontSize: '14px', color: 'rgba(255,255,255,0.8)', marginBottom: '8px'}}>ç¸½æ™‚é–“</div>
                                            <div style={{fontSize: '32px', fontWeight: 'bold', color: 'white'}}>
                                                {formatTime(allTests.reduce((sum, test) => {
                                                    const status = completionStatus[test.id];
                                                    return sum + (status?.time || 0);
                                                }, 0))}
                                            </div>
                                        </div>
                                        <div style={{backgroundColor: 'rgba(255,255,255,0.15)', borderRadius: '16px', padding: '30px', textAlign: 'center'}}>
                                            <div style={{fontSize: '40px', marginBottom: '10px'}}>ğŸ¯</div>
                                            <div style={{fontSize: '14px', color: 'rgba(255,255,255,0.8)', marginBottom: '8px'}}>ç¸½å˜—è©¦</div>
                                            <div style={{fontSize: '32px', fontWeight: 'bold', color: 'white'}}>
                                                {allTests.reduce((sum, test) => {
                                                    const status = completionStatus[test.id];
                                                    return sum + (status?.attempts || 0);
                                                }, 0)}
                                            </div>
                                        </div>
                                    </div>

                                    <div style={{backgroundColor: 'rgba(255,255,255,0.15)', borderRadius: '16px', padding: '30px', marginBottom: '30px'}}>
                                        <h3 style={{fontSize: '24px', fontWeight: 'bold', color: 'white', marginBottom: '20px'}}>
                                            ğŸ“‹ å„æ¸¬é©—å®Œæˆè©³æƒ…
                                        </h3>
                                        {allTests.map((test, idx) => {
                                            const status = completionStatus[test.id];
                                            return (
                                                <div key={idx} style={{
                                                    backgroundColor: 'rgba(255,255,255,0.1)',
                                                    borderRadius: '12px',
                                                    padding: '20px',
                                                    marginBottom: '15px',
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center'
                                                }}>
                                                    <div style={{display: 'flex', alignItems: 'center', gap: '15px'}}>
                                                        <div style={{
                                                            width: '50px',
                                                            height: '50px',
                                                            backgroundColor: '#22c55e',
                                                            borderRadius: '12px',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'center',
                                                            fontSize: '24px',
                                                            color: 'white',
                                                            fontWeight: 'bold'
                                                        }}>âœ“</div>
                                                        <div>
                                                            <div style={{fontSize: '20px', fontWeight: 'bold', color: 'white', marginBottom: '5px'}}>
                                                                {test.title}
                                                            </div>
                                                            <div style={{fontSize: '14px', color: 'rgba(255,255,255,0.7)'}}>
                                                                {test.subtitle} Â· {test.itemCount}é¡Œ Â· å˜—è©¦ {status?.attempts} æ¬¡
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div style={{fontSize: '20px', color: 'rgba(255,255,255,0.8)', fontFamily: 'monospace'}}>
                                                        {formatTime(status?.time || 0)}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>

                                    <div style={{backgroundColor: 'rgba(255,255,255,0.15)', borderRadius: '16px', padding: '30px', textAlign: 'center', marginBottom: '30px'}}>
                                        <h3 style={{fontSize: '24px', fontWeight: 'bold', color: 'white', marginBottom: '20px'}}>
                                            ğŸŒŸ ç¸½é«”è©•ç´š
                                        </h3>
                                        <div style={{fontSize: '80px', marginBottom: '15px'}}>
                                            {allTests.every(test => completionStatus[test.id]?.attempts === 1) ? 'ğŸ†' :
                                             allTests.every(test => completionStatus[test.id]?.attempts <= 2) ? 'ğŸ¥‡' : 'ğŸ¥ˆ'}
                                        </div>
                                        <div style={{fontSize: '32px', fontWeight: 'bold', color: 'white', marginBottom: '10px'}}>
                                            {allTests.every(test => completionStatus[test.id]?.attempts === 1) ? 'å®Œç¾å¤§å¸«' :
                                             allTests.every(test => completionStatus[test.id]?.attempts <= 2) ? 'å„ªç§€å­¸ç¿’è€…' : 'èªçœŸå­¸ç¿’è€…'}
                                        </div>
                                        <div style={{fontSize: '16px', color: 'rgba(255,255,255,0.8)'}}>
                                            {allTests.every(test => completionStatus[test.id]?.attempts === 1) ? 'æ‰€æœ‰æ¸¬é©—ä¸€æ¬¡é€šéï¼ŒçœŸæ­£çš„å››å­£ç¯€æ°£å°ˆå®¶ï¼' :
                                             allTests.every(test => completionStatus[test.id]?.attempts <= 2) ? 'å„ªç§€çš„å­¸ç¿’è¡¨ç¾ï¼Œå°ç¯€æ°£çŸ¥è­˜æŒæ¡è‰¯å¥½ï¼' :
                                             'å®Œæˆå°±æ˜¯å‹åˆ©ï¼Œå°å‚³çµ±æ–‡åŒ–æœ‰æ·±å…¥ç†è§£ï¼'}
                                        </div>
                                    </div>

                                    <div style={{marginTop: '40px', textAlign: 'center', fontSize: '14px', color: 'rgba(255,255,255,0.6)'}}>
                                        æ­¤è­‰æ›¸è­‰æ˜å­¸ç¿’è€…å·²å®Œæˆå››å­£ç¯€æ°£æ‰€æœ‰æ¸¬é©—çš„å­¸ç¿’èˆ‡æ¸¬é©—
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // æ¸¬é©—é€²è¡Œä¸­ - åˆ†é¡é¡Œå‹
            if (screen === 'playing' && currentTest && currentTest.type === 'classification') {
                const placedItemIds = Object.values(droppedItems).flat().map(item => item.id);
                const availableItems = shuffledItems.filter(item => !placedItemIds.includes(item.id));
                const totalItems = currentTest.items.length;
                const placedCount = placedItemIds.length;
                const allPlaced = placedCount === totalItems;

                return (
                    <div className="h-screen flex flex-col overflow-hidden">
                        <div className={`flex-shrink-0 bg-gradient-to-r ${currentTest.color} p-2 md:p-3 text-white shadow-xl`}>
                            <div className="flex items-center gap-2 mb-2">
                                <div className="flex items-center gap-2 flex-shrink-0">
                                    <div className="flex items-center gap-1 bg-black/20 rounded-lg p-1">
                                        <button onClick={decreaseFontSize} disabled={fontScale <= 70}
                                            className={`px-1.5 py-0.5 rounded text-xs font-bold transition-all ${
                                                fontScale <= 70 ? 'text-white/30 cursor-not-allowed' : 'text-white hover:bg-white/20'
                                            }`}>
                                            A<sup style={{ fontSize: '8px' }}>-</sup>
                                        </button>
                                        <button onClick={increaseFontSize} disabled={fontScale >= 150}
                                            className={`px-1.5 py-0.5 rounded text-xs font-bold transition-all ${
                                                fontScale >= 150 ? 'text-white/30 cursor-not-allowed' : 'text-white hover:bg-white/20'
                                            }`}>
                                            A<sup style={{ fontSize: '8px' }}>+</sup>
                                        </button>
                                    </div>
                                    <h2 className="text-sm md:text-base font-bold truncate leading-tight">{currentTest.title}</h2>
                                </div>
                                
                                <div className="flex-1 min-w-0"></div>
                                
                                <div className="flex items-center gap-2 flex-shrink-0">
                                    <span className="text-xs opacity-80 whitespace-nowrap hidden sm:inline">â±ï¸ {formatTime(elapsedTime)}</span>
                                    <span className="text-xs bg-black/20 px-2 py-0.5 rounded whitespace-nowrap">ğŸ¯ {attempts}</span>
                                    <button onClick={() => setScreen('home')}
                                        className="bg-white/20 hover:bg-white/30 px-2 py-1 rounded transition-all text-xs">
                                        <i className="fas fa-home"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-2 md:p-4" style={{WebkitOverflowScrolling: 'touch', maxHeight: '90%'}}>
                            <div className="grid lg:grid-cols-3 gap-2 md:gap-3">
                                <div className="lg:col-span-1">
                                    <div className="glass-effect rounded-lg p-2 md:p-3 lg:sticky lg:top-2">
                                        <h3 className="text-sm md:text-base font-bold text-white mb-2 flex items-center">
                                            <i className="fas fa-cube mr-1 text-xs"></i>
                                            å¾…åˆ†é¡é …ç›®
                                        </h3>
                                        <div 
                                            data-zone-id="items"
                                            onDragOver={handleDragOver}
                                            onDrop={(e) => handleDrop(e, 'items')}
                                            className="drop-zone space-y-1.5 min-h-[100px]"
                                        >
                                            {availableItems.map(item => (
                                                <div
                                                    key={item.id}
                                                    draggable
                                                    onDragStart={(e) => handleDragStart(e, item, 'items')}
                                                    onDragEnd={handleDragEnd}
                                                    onTouchStart={(e) => handleTouchStart(e, item, null)}
                                                    onTouchMove={handleTouchMove}
                                                    onTouchEnd={(e) => handleTouchEnd(e, handleTouchDrop)}
                                                    className="drag-item bg-white rounded-lg p-2 shadow-lg"
                                                >
                                                    <p className="text-gray-800 font-medium text-center text-xs md:text-sm">
                                                        {item.text}
                                                    </p>
                                                </div>
                                            ))}
                                            {availableItems.length === 0 && (
                                                <div className="text-center text-white/70 py-3 text-xs">
                                                    æ‰€æœ‰é …ç›®éƒ½å·²åˆ†é¡
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                <div className="lg:col-span-2">
                                    <div className="grid gap-2">
                                        {shuffledZones.map(zone => (
                                            <div
                                                key={zone.id}
                                                data-zone-id={zone.id}
                                                onDragOver={handleDragOver}
                                                onDrop={(e) => handleDrop(e, zone.id)}
                                                className={`drop-zone glass-effect rounded-lg p-2 md:p-3
                                                    ${feedback[zone.id] === true ? 'correct-answer' : ''}
                                                    ${feedback[zone.id] === false ? 'wrong-answer' : ''}
                                                    ${!feedback[zone.id] ? 'border-2 border-white/30' : ''}`}
                                            >
                                                <h4 className="text-sm md:text-base font-bold text-white mb-2 flex items-center">
                                                    <i className={`${zone.icon} mr-1 text-xs`}></i>
                                                    <span className="flex-1 text-xs md:text-sm">{zone.title}</span>
                                                    {feedback[zone.id] === true && (
                                                        <i className="fas fa-check-circle text-green-400 text-base"></i>
                                                    )}
                                                    {feedback[zone.id] === false && (
                                                        <i className="fas fa-times-circle text-red-400 text-base"></i>
                                                    )}
                                                </h4>
                                                <div className="grid grid-cols-2 gap-1.5">
                                                    {(droppedItems[zone.id] || []).map(item => (
                                                        <div
                                                            key={item.id}
                                                            draggable
                                                            onDragStart={(e) => {
                                                                handleDragStart(e, item, zone.id);
                                                            }}
                                                            onDragEnd={handleDragEnd}
                                                            onTouchStart={(e) => handleTouchStart(e, item, () => removeItem(zone.id, item.id))}
                                                            onTouchMove={handleTouchMove}
                                                            onTouchEnd={(e) => handleTouchEnd(e, handleTouchDrop)}
                                                            className="bg-white rounded-lg p-2 shadow-lg group relative cursor-move"
                                                        >
                                                            <p className="text-gray-800 font-medium text-xs text-center pr-5">
                                                                {item.text}
                                                            </p>
                                                            <button
                                                                onClick={() => removeItem(zone.id, item.id)}
                                                                className="absolute top-1 right-1 w-4 h-4 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-xs"
                                                            >
                                                                Ã—
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>

                                    <div className="mt-2 flex gap-2">
                                        {gameState === 'playing' && (
                                            <button
                                                onClick={checkAnswers}
                                                className={`flex-1 py-2.5 rounded-lg font-bold text-sm transition-all shadow-xl ${
                                                    allPlaced 
                                                        ? 'bg-gradient-to-r from-green-400 to-emerald-500 text-white hover:scale-105 cursor-pointer'
                                                        : 'bg-gray-400 text-gray-200 cursor-not-allowed'
                                                }`}
                                                disabled={!allPlaced}
                                            >
                                                <i className="fas fa-check mr-1"></i>
                                                {allPlaced ? 'æª¢æŸ¥ç­”æ¡ˆ' : `å°šæœªå®Œæˆ (${placedCount}/${totalItems})`}
                                            </button>
                                        )}
                                        <button
                                            onClick={restart}
                                            className="bg-white/20 text-white px-3 py-2.5 rounded-lg hover:bg-white/30 transition-all text-sm"
                                        >
                                            <i className="fas fa-redo"></i>
                                            <span className="ml-1 hidden sm:inline">é‡ä¾†</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // æ¸¬é©—é€²è¡Œä¸­ - ç¯€æ°£ä¿—è«ºé…å°é¡Œå‹
            if (screen === 'playing' && currentTest && currentTest.type === 'saying_match') {
                const placedTerms = Object.values(sayingSlots).filter(term => term !== null);
                const availableTerms = shuffledItems.filter(term => 
                    !placedTerms.some(placed => placed.id === term.id)
                );
                const totalSlots = currentTest.sayings.length;
                const filledSlots = Object.keys(sayingSlots).filter(key => sayingSlots[key] !== null).length;
                const allFilled = filledSlots === totalSlots;

                return (
                    <div className="h-screen flex flex-col overflow-hidden">
                        <div className={`flex-shrink-0 bg-gradient-to-r ${currentTest.color} p-2 md:p-3 text-white shadow-xl`}>
                            <div className="flex items-center gap-2 mb-2">
                                <div className="flex items-center gap-2 flex-shrink-0">
                                    <div className="flex items-center gap-1 bg-black/20 rounded-lg p-1">
                                        <button onClick={decreaseFontSize} disabled={fontScale <= 70}
                                            className={`px-1.5 py-0.5 rounded text-xs font-bold transition-all ${
                                                fontScale <= 70 ? 'text-white/30 cursor-not-allowed' : 'text-white hover:bg-white/20'
                                            }`}>
                                            A<sup style={{ fontSize: '8px' }}>-</sup>
                                        </button>
                                        <button onClick={increaseFontSize} disabled={fontScale >= 150}
                                            className={`px-1.5 py-0.5 rounded text-xs font-bold transition-all ${
                                                fontScale >= 150 ? 'text-white/30 cursor-not-allowed' : 'text-white hover:bg-white/20'
                                            }`}>
                                            A<sup style={{ fontSize: '8px' }}>+</sup>
                                        </button>
                                    </div>
                                    <h2 className="text-sm md:text-base font-bold truncate leading-tight">{currentTest.title}</h2>
                                </div>
                                
                                <div className="flex-1 min-w-0"></div>
                                
                                <div className="flex items-center gap-2 flex-shrink-0">
                                    <span className="text-xs opacity-80 whitespace-nowrap hidden sm:inline">â±ï¸ {formatTime(elapsedTime)}</span>
                                    <span className="text-xs bg-black/20 px-2 py-0.5 rounded whitespace-nowrap">ğŸ¯ {attempts}</span>
                                    <button onClick={() => setScreen('home')}
                                        className="bg-white/20 hover:bg-white/30 px-2 py-1 rounded transition-all text-xs">
                                        <i className="fas fa-home"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-2 md:p-4" style={{WebkitOverflowScrolling: 'touch'}}>
                            <div className="max-w-7xl mx-auto">
                                {/* å·¦å³é…ç½®ï¼šå·¦å´å¾…é¸ç¯€æ°£ï¼Œå³å´ä¿—è«ºé…å° */}
                                <div className="grid lg:grid-cols-3 gap-3">
                                    {/* å·¦å´ï¼šå¾…é¸ç¯€æ°£ (1/3å¯¬åº¦) */}
                                    <div className="lg:col-span-1">
                                        <div className="glass-effect rounded-lg p-3 lg:sticky lg:top-2">
                                            <h3 className="text-sm md:text-base font-bold text-gray-900 mb-3 flex items-center">
                                                <i className="fas fa-calendar-alt mr-2"></i>
                                                å¾…é¸ç¯€æ°£
                                            </h3>
                                            <div 
                                                data-zone-id="items"
                                                onDragOver={handleDragOver}
                                                onDrop={(e) => handleDrop(e, 'items')}
                                                className="drop-zone grid grid-cols-2 gap-2"
                                            >
                                                {availableTerms.map(term => (
                                                    <div
                                                        key={term.id}
                                                        draggable
                                                        onDragStart={(e) => handleDragStart(e, term, 'items')}
                                                        onDragEnd={handleDragEnd}
                                                        onTouchStart={(e) => handleTouchStart(e, term, null)}
                                                        onTouchMove={handleTouchMove}
                                                        onTouchEnd={(e) => handleTouchEnd(e, handleTouchDrop)}
                                                        className="drag-item bg-white rounded-lg px-3 py-2 shadow-lg"
                                                    >
                                                        <p className="text-gray-900 font-bold text-sm text-center">
                                                            {term.text}
                                                        </p>
                                                    </div>
                                                ))}
                                                {availableTerms.length === 0 && (
                                                    <div className="col-span-2 text-center text-gray-600 py-2 text-xs">
                                                        æ‰€æœ‰ç¯€æ°£éƒ½å·²ä½¿ç”¨
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>

                                    {/* å³å´ï¼šä¿—è«ºé…å° (2/3å¯¬åº¦) */}
                                    <div className="lg:col-span-2">
                                        <div className="glass-effect rounded-lg p-3 mb-3">
                                            <h3 className="text-sm md:text-base font-bold text-gray-900 mb-3 flex items-center">
                                                <i className="fas fa-comment-dots mr-2"></i>
                                                ä¿—è«ºé…å°
                                            </h3>
                                            <div className="space-y-2">
                                                {currentTest.sayings.map((saying, index) => {
                                                    const isCorrect = feedback[saying.slotId];
                                                    const currentTerm = sayingSlots[saying.slotId];
                                                    
                                                    return (
                                                        <div 
                                                            key={saying.id}
                                                            className={`bg-white/20 rounded-lg p-2 md:p-3 ${
                                                                isCorrect === true ? 'correct-answer' : ''
                                                            } ${isCorrect === false ? 'wrong-answer' : ''}`}
                                                        >
                                                            <div className="flex items-center gap-2 text-gray-900 text-sm md:text-base flex-wrap">
                                                                <span className="text-gray-700 font-bold">{index + 1}.</span>
                                                                <span className="font-medium">{saying.before}</span>
                                                                <div
                                                                    data-zone-id={saying.slotId}
                                                                    onDragOver={handleDragOver}
                                                                    onDrop={(e) => handleDrop(e, saying.slotId)}
                                                                    className="saying-slot border-2 border-dashed border-gray-400 rounded-lg px-3 py-1.5 bg-white/30 inline-flex"
                                                                >
                                                                    {currentTerm ? (
                                                                        <div
                                                                            draggable
                                                                            onDragStart={(e) => handleDragStart(e, currentTerm, saying.slotId)}
                                                                            onDragEnd={handleDragEnd}
                                                                            onTouchStart={(e) => handleTouchStart(e, currentTerm, () => removeSayingSlot(saying.slotId))}
                                                                            onTouchMove={handleTouchMove}
                                                                            onTouchEnd={(e) => handleTouchEnd(e, handleTouchDrop)}
                                                                            className="bg-yellow-400 text-gray-900 font-bold px-2 py-1 rounded cursor-move group relative"
                                                                        >
                                                                            {currentTerm.text}
                                                                            <button
                                                                                onClick={() => removeSayingSlot(saying.slotId)}
                                                                                className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-xs"
                                                                            >
                                                                                Ã—
                                                                            </button>
                                                                        </div>
                                                                    ) : (
                                                                        <span className="text-gray-500 text-xs">æ‹–æ›³ç¯€æ°£è‡³æ­¤</span>
                                                                    )}
                                                                </div>
                                                                <span className="font-medium">{saying.after}</span>
                                                                {isCorrect === true && (
                                                                    <i className="fas fa-check-circle text-green-500 ml-2"></i>
                                                                )}
                                                                {isCorrect === false && (
                                                                    <i className="fas fa-times-circle text-red-500 ml-2"></i>
                                                                )}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>

                                        <div className="flex gap-2">
                                            {gameState === 'playing' && (
                                                <button
                                                    onClick={checkAnswers}
                                                    className={`flex-1 py-3 rounded-lg font-bold text-base transition-all shadow-xl ${
                                                        allFilled 
                                                            ? 'bg-gradient-to-r from-green-400 to-emerald-500 text-white hover:scale-105 cursor-pointer'
                                                            : 'bg-gray-400 text-gray-200 cursor-not-allowed'
                                                    }`}
                                                    disabled={!allFilled}
                                                >
                                                    <i className="fas fa-check mr-2"></i>
                                                    {allFilled ? 'æª¢æŸ¥ç­”æ¡ˆ' : `å°šæœªå®Œæˆ (${filledSlots}/${totalSlots})`}
                                                </button>
                                            )}
                                            <button
                                                onClick={restart}
                                                className="bg-white/20 text-white px-6 py-3 rounded-lg hover:bg-white/30 transition-all"
                                            >
                                                <i className="fas fa-redo mr-2"></i>
                                                é‡ä¾†
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // æ¸¬é©—å®Œæˆç•«é¢
            if (screen === 'playing' && gameState === 'completed' && currentTest) {
                const status = completionStatus[currentTest.id];
                const achievementEmoji = status.attempts === 1 ? 'ğŸ†' : 
                                        status.attempts === 2 ? 'ğŸ¥‡' : 
                                        status.attempts === 3 ? 'ğŸ¥ˆ' : 'ğŸ¥‰';
                const achievementTitle = status.attempts === 1 ? 'å®Œç¾é€šé—œ' : 
                                        status.attempts === 2 ? 'å„ªç§€è¡¨ç¾' : 
                                        status.attempts === 3 ? 'è¡¨ç¾è‰¯å¥½' : 'ç¹¼çºŒåŠ æ²¹';
                const achievementDesc = status.attempts === 1 ? 'ä¸€æ¬¡å°±å®Œæˆæ‰€æœ‰é¡Œç›®ï¼Œå¤ªå²å®³äº†ï¼' : 
                                       status.attempts === 2 ? 'åªå˜—è©¦å°‘æ•¸æ¬¡å°±å®Œæˆï¼Œéå¸¸æ£’ï¼' : 
                                       status.attempts === 3 ? 'ç©©å®šå®Œæˆæ¸¬é©—ï¼Œç¹¼çºŒä¿æŒï¼' : 'å®Œæˆå°±æ˜¯å‹åˆ©ï¼Œä¸‹æ¬¡æœƒæ›´å¥½ï¼';

                const downloadCertificate = () => {
                    const element = document.getElementById('certificate-content');
                    html2canvas(element, {
                        backgroundColor: '#FFB6C1',
                        scale: 2,
                        width: 1000
                    }).then(canvas => {
                        const link = document.createElement('a');
                        const date = new Date();
                        link.download = `${currentTest.title}-å®Œæˆè­‰æ›¸-${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                    });
                };

                return (
                    <div className="min-h-screen flex items-center justify-center p-4 md:p-6">
                        <div className="max-w-2xl w-full glass-effect rounded-3xl p-8 md:p-12 text-center fade-in">
                            <div className="text-6xl md:text-8xl mb-4 md:mb-6">ğŸ‰</div>
                            <h2 className="text-3xl md:text-5xl font-black text-white mb-3 md:mb-4">
                                æ¸¬é©—å®Œæˆï¼
                            </h2>
                            <p className="text-xl md:text-2xl text-white/90 mb-6 md:mb-8">
                                {currentTest.title}
                            </p>
                            
                            <div className="grid grid-cols-3 gap-3 md:gap-6 mb-6 md:mb-8">
                                <div className="bg-white/10 rounded-2xl p-4 md:p-6">
                                    <div className="text-3xl md:text-4xl font-bold text-white mb-2">
                                        {formatTime(status.time)}
                                    </div>
                                    <div className="text-white/80 text-xs md:text-sm">å®Œæˆæ™‚é–“</div>
                                </div>
                                <div className="bg-white/10 rounded-2xl p-4 md:p-6">
                                    <div className="text-3xl md:text-4xl font-bold text-white mb-2">
                                        {currentTest.itemCount}
                                    </div>
                                    <div className="text-white/80 text-xs md:text-sm">é¡Œç›®æ•¸é‡</div>
                                </div>
                                <div className="bg-white/10 rounded-2xl p-4 md:p-6">
                                    <div className="text-3xl md:text-4xl font-bold text-white mb-2">
                                        {status.attempts}
                                    </div>
                                    <div className="text-white/80 text-xs md:text-sm">å˜—è©¦æ¬¡æ•¸</div>
                                </div>
                            </div>

                            <div className="bg-white/10 rounded-2xl p-4 md:p-6 mb-6 md:mb-8">
                                <div className="text-4xl md:text-6xl mb-2 md:mb-3">{achievementEmoji}</div>
                                <div className="text-xl md:text-2xl font-bold text-white mb-2">{achievementTitle}</div>
                                <div className="text-sm md:text-base text-white/80">{achievementDesc}</div>
                            </div>

                            <div className="flex flex-col sm:flex-row gap-3 md:gap-4 justify-center">
                                <button
                                    onClick={downloadCertificate}
                                    className="bg-gradient-to-r from-blue-400 to-purple-500 text-white px-6 md:px-8 py-3 md:py-4 rounded-xl font-bold text-base md:text-lg hover:scale-105 transition-all shadow-xl"
                                >
                                    <i className="fas fa-download mr-2"></i>
                                    ä¸‹è¼‰è­‰æ›¸
                                </button>
                                <button
                                    onClick={restart}
                                    className="bg-gradient-to-r from-green-400 to-emerald-500 text-white px-6 md:px-8 py-3 md:py-4 rounded-xl font-bold text-base md:text-lg hover:scale-105 transition-all shadow-xl"
                                >
                                    <i className="fas fa-redo mr-2"></i>
                                    å†æ¸¬ä¸€æ¬¡
                                </button>
                                <button
                                    onClick={() => setScreen('home')}
                                    className="bg-white/20 text-white px-6 md:px-8 py-3 md:py-4 rounded-xl font-bold text-base md:text-lg hover:bg-white/30 transition-all"
                                >
                                    <i className="fas fa-home mr-2"></i>
                                    è¿”å›é¦–é 
                                </button>
                            </div>
                        </div>

                        {/* è­‰æ›¸å…§å®¹ï¼ˆéš±è—ï¼‰ */}
                        <div 
                            id="certificate-content" 
                            style={{
                                position: 'fixed',
                                left: '-9999px',
                                width: '1000px',
                                backgroundColor: '#FFB6C1',
                                padding: '60px',
                                fontFamily: 'Noto Sans TC, sans-serif'
                            }}
                        >
                            <div style={{textAlign: 'center', marginBottom: '40px'}}>
                                <div style={{fontSize: '80px', marginBottom: '20px'}}>ğŸ“</div>
                                <h1 style={{fontSize: '48px', fontWeight: '900', color: 'white', marginBottom: '10px'}}>
                                    æ¸¬é©—å®Œæˆè­‰æ›¸
                                </h1>
                                <h2 style={{fontSize: '36px', fontWeight: 'bold', color: '#fff', marginBottom: '10px'}}>
                                    {currentTest.title}
                                </h2>
                                <p style={{fontSize: '20px', color: 'rgba(255,255,255,0.8)'}}>
                                    {currentTest.subtitle} {currentTest.difficulty}
                                </p>
                            </div>

                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '20px', marginBottom: '40px'}}>
                                <div style={{backgroundColor: 'rgba(255,255,255,0.15)', borderRadius: '16px', padding: '30px', textAlign: 'center'}}>
                                    <div style={{fontSize: '14px', color: 'rgba(255,255,255,0.8)', marginBottom: '8px'}}>å®Œæˆæ™‚é–“</div>
                                    <div style={{fontSize: '36px', fontWeight: 'bold', color: 'white'}}>
                                        {formatTime(status.time)}
                                    </div>
                                </div>
                                <div style={{backgroundColor: 'rgba(255,255,255,0.15)', borderRadius: '16px', padding: '30px', textAlign: 'center'}}>
                                    <div style={{fontSize: '14px', color: 'rgba(255,255,255,0.8)', marginBottom: '8px'}}>é¡Œç›®æ•¸é‡</div>
                                    <div style={{fontSize: '36px', fontWeight: 'bold', color: 'white'}}>
                                        {currentTest.itemCount}
                                    </div>
                                </div>
                                <div style={{backgroundColor: 'rgba(255,255,255,0.15)', borderRadius: '16px', padding: '30px', textAlign: 'center'}}>
                                    <div style={{fontSize: '14px', color: 'rgba(255,255,255,0.8)', marginBottom: '8px'}}>å˜—è©¦æ¬¡æ•¸</div>
                                    <div style={{fontSize: '36px', fontWeight: 'bold', color: 'white'}}>
                                        {status.attempts}
                                    </div>
                                </div>
                            </div>

                            <div style={{backgroundColor: 'rgba(255,255,255,0.15)', borderRadius: '16px', padding: '40px', textAlign: 'center', marginBottom: '30px'}}>
                                <div style={{fontSize: '80px', marginBottom: '15px'}}>{achievementEmoji}</div>
                                <div style={{fontSize: '32px', fontWeight: 'bold', color: 'white', marginBottom: '10px'}}>
                                    {achievementTitle}
                                </div>
                                <div style={{fontSize: '18px', color: 'rgba(255,255,255,0.8)'}}>
                                    {achievementDesc}
                                </div>
                            </div>

                            <div style={{marginTop: '40px', textAlign: 'center', fontSize: '14px', color: 'rgba(255,255,255,0.6)'}}>
                                å®Œæˆæ™‚é–“ï¼š{new Date(status.completedAt).toLocaleString('zh-TW')}
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
