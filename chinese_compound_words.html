<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¤‡è©çš„ç¨®é¡ - äº’å‹•å¼æ¸¬é©—ç³»çµ±</title>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- html2canvas for screenshot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor: default;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overscroll-behavior: none;
            -webkit-user-select: none;
            user-select: none;
            overflow-x: hidden;
        }

        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            cursor: text;
        }

        button, a, .clickable {
            cursor: pointer !important;
        }

        .drag-item {
            transition: all 0.2s ease;
            cursor: grab !important;
            touch-action: none;
            -webkit-touch-callout: none;
        }

        .drag-item:active {
            cursor: grabbing !important;
        }

        @media (hover: hover) {
            .drag-item:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            }
        }

        .dragging {
            opacity: 0.5;
            transform: scale(1.05);
            z-index: 1000;
            position: fixed;
            pointer-events: none;
        }

        .cursor-move {
            cursor: move !important;
            touch-action: none;
            -webkit-touch-callout: none;
        }

        .cursor-move:active {
            cursor: grabbing !important;
        }

        .drop-zone {
            transition: all 0.2s ease;
            min-height: 80px;
        }

        .drop-zone.drag-over {
            background: rgba(59, 130, 246, 0.2);
            border: 3px dashed #3b82f6 !important;
            transform: scale(1.02);
        }

        .correct-answer {
            animation: correctPulse 0.6s ease-out;
            border: 3px solid #10b981 !important;
            background: rgba(16, 185, 129, 0.1);
        }

        .wrong-answer {
            animation: shake 0.5s ease-out;
            border: 3px solid #ef4444 !important;
            background: rgba(239, 68, 68, 0.1);
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .animate-bounce-slow {
            animation: bounce-slow 2s ease-in-out infinite;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // è§¸æ§æ‹–æ›³æ”¯æ´è®Šæ•¸
        let touchDragData = null;
        let touchDragElement = null;
        let touchClone = null;
        let touchRemoveCallback = null;
        let touchSourceZoneId = null;

        function handleTouchStart(e, item, removeCallback) {
            e.preventDefault();
            touchDragData = item;
            touchDragElement = e.currentTarget;
            touchRemoveCallback = removeCallback;
            
            const scrollContainer = document.querySelector('.overflow-y-auto');
            if (scrollContainer) {
                scrollContainer.style.overflowY = 'hidden';
                scrollContainer.style.touchAction = 'none';
            }
            
            const sourceZone = touchDragElement.closest('.drop-zone');
            touchSourceZoneId = sourceZone ? sourceZone.getAttribute('data-zone-id') : null;
            
            const touch = e.touches[0];
            touchClone = touchDragElement.cloneNode(true);
            touchClone.style.position = 'fixed';
            touchClone.style.zIndex = '10000';
            touchClone.style.opacity = '0.8';
            touchClone.style.pointerEvents = 'none';
            touchClone.style.width = touchDragElement.offsetWidth + 'px';
            touchClone.style.left = (touch.clientX - touchDragElement.offsetWidth / 2) + 'px';
            touchClone.style.top = (touch.clientY - touchDragElement.offsetHeight / 2) + 'px';
            touchClone.style.transition = 'none';
            document.body.appendChild(touchClone);
            
            touchDragElement.style.opacity = '0.2';
            touchDragElement.style.transform = 'scale(0.95)';
            touchDragElement.style.transition = 'opacity 0.2s, transform 0.2s';
        }

        function handleTouchMove(e) {
            if (!touchClone) return;
            e.preventDefault();
            e.stopPropagation();
            
            const touch = e.touches[0];
            touchClone.style.left = (touch.clientX - touchClone.offsetWidth / 2) + 'px';
            touchClone.style.top = (touch.clientY - touchClone.offsetHeight / 2) + 'px';
            
            const dropZones = document.querySelectorAll('.drop-zone');
            dropZones.forEach(zone => zone.classList.remove('drag-over'));
            
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            if (elementBelow) {
                const dropZone = elementBelow.closest('.drop-zone');
                if (dropZone) {
                    const targetZoneId = dropZone.getAttribute('data-zone-id');
                    if (targetZoneId !== touchSourceZoneId) {
                        dropZone.classList.add('drag-over');
                    }
                }
            }
        }

        function handleTouchEnd(e, dropCallback) {
            if (!touchClone) return;
            
            const touch = e.changedTouches[0];
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            
            let targetZone = null;
            let targetZoneId = null;
            if (elementBelow) {
                targetZone = elementBelow.closest('.drop-zone');
                if (targetZone) {
                    targetZoneId = targetZone.getAttribute('data-zone-id');
                }
            }
            
            // æ¸…é™¤è¤‡è£½çš„è¦–è¦ºå…ƒç´ 
            if (touchClone && touchClone.parentNode) {
                touchClone.parentNode.removeChild(touchClone);
            }
            touchClone = null;
            
            // æ¢å¾©æ»¾å‹•å®¹å™¨
            const scrollContainer = document.querySelector('.overflow-y-auto');
            if (scrollContainer) {
                scrollContainer.style.overflowY = 'auto';
                scrollContainer.style.touchAction = '';
            }
            
            // æ¸…é™¤æ‰€æœ‰é«˜äº®
            const dropZones = document.querySelectorAll('.drop-zone');
            dropZones.forEach(zone => zone.classList.remove('drag-over'));
            
            // åˆ¤æ–·æ˜¯å¦æˆåŠŸæ”¾ç½®åˆ°ã€ä¸åŒã€‘çš„å€åŸŸ
            const isDifferentZone = targetZone && targetZoneId && touchDragData && 
                                   targetZoneId !== touchSourceZoneId;
            
            if (isDifferentZone && dropCallback) {
                // æˆåŠŸæ”¾ç½®åˆ°ä¸åŒå€åŸŸ
                
                // å…ˆå¾ä¾†æºç§»é™¤ï¼ˆå¦‚æœæœ‰ removeCallbackï¼‰
                if (touchRemoveCallback) {
                    touchRemoveCallback();
                }
                
                // å†æ·»åŠ åˆ°ç›®æ¨™å€åŸŸï¼ˆä½† items å€ä¸éœ€è¦æ·»åŠ ï¼Œæœƒè‡ªå‹•é¡¯ç¤ºï¼‰
                if (targetZoneId !== 'items') {
                    dropCallback(touchDragData, targetZoneId);
                }
                
                // æ¸…é™¤åŸå…ƒç´ çš„æ¨£å¼
                if (touchDragElement && touchDragElement.parentNode) {
                    touchDragElement.style.opacity = '';
                    touchDragElement.style.transform = '';
                }
            } else {
                // æ”¾å›åŸä½æˆ–ç„¡æ•ˆæ”¾ç½®ï¼šæ¢å¾©åŸå…ƒç´ 
                if (touchDragElement && touchDragElement.parentNode) {
                    touchDragElement.style.opacity = '1';
                    touchDragElement.style.transform = 'scale(1)';
                    touchDragElement.style.transition = 'opacity 0.2s, transform 0.2s';
                    // å¼·åˆ¶é‡ç¹ª
                    void touchDragElement.offsetHeight;
                }
            }
            
            // é‡ç½®æ‰€æœ‰è®Šæ•¸
            touchDragData = null;
            touchDragElement = null;
            touchRemoveCallback = null;
            touchSourceZoneId = null;
        }

        // éš¨æ©Ÿæ’åºå‡½æ•¸
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // é¡Œç›®è³‡æ–™ - æ”¹ç‚º4å€‹ç¨ç«‹æ¸¬é©—
        const TESTS_DATA = {
            "test-1": {
                id: "test-1",
                title: "åç¾©è¤‡è©è¾¨è­˜",
                subtitle: "åŸºç¤åˆ¤æ–·",
                difficulty: "â­â­",
                itemCount: 12,
                description: "è«‹åˆ¤æ–·ä»¥ä¸‹è©èªæ˜¯å¦ç‚ºã€åç¾©è¤‡è©ã€ã€‚åç¾©è¤‡è©æ˜¯ç”±å…©å­—çµ„æˆï¼Œä½†åªå–å…¶ä¸­ä¸€å­—çš„æ„æ€ã€‚",
                color: "from-sky-300 to-blue-400",
                icon: "fa-check-circle",
                zones: [
                    { id: 'zone1', title: 'æ˜¯åç¾©è¤‡è©', icon: 'fa-check-circle' },
                    { id: 'zone2', title: 'ä¸æ˜¯åç¾©è¤‡è©', icon: 'fa-times-circle' }
                ],
                items: [
                    { id: 'item1', text: 'ä»¥ã€Œåœ‹å®¶ã€ç‚ºå‰æ', val: 'guojia' },
                    { id: 'item2', text: 'ä¸å®œæœ‰æ‰€ã€Œç•°åŒã€', val: 'yitong' },
                    { id: 'item3', text: 'äººæœ‰æ—¦å¤•ã€Œç¦ç¦ã€', val: 'huofu' },
                    { id: 'item4', text: 'ä¸€æ‰‡ã€Œçª—æˆ¶ã€', val: 'chuanghu' },
                    { id: 'item5', text: 'ä¸èƒ½ã€Œå¿˜è¨˜ã€', val: 'wangji' },
                    { id: 'item6', text: 'æ›¾ä¸åæƒ…ã€Œå»ç•™ã€', val: 'quliu' },
                    { id: 'item7', text: 'å°ˆå¿ƒã€Œè†è½ã€', val: 'lingting' },
                    { id: 'item8', text: 'å§£å¥½ã€Œå®¹è²Œã€', val: 'rongmao' },
                    { id: 'item9', text: 'ã€Œä¾†å›ã€æ©Ÿç¥¨', val: 'laihui' },
                    { id: 'item10', text: 'ã€Œæœé‡ã€åŒå¿ƒ', val: 'chaoye' },
                    { id: 'item11', text: 'æ‹›æƒ¹ã€Œæ˜¯éã€', val: 'shifei' },
                    { id: 'item12', text: 'å……æ»¿ã€Œå¸Œæœ›ã€', val: 'xiwang' }
                ],
                solution: {
                    zone1: ['guojia', 'yitong', 'huofu', 'chuanghu', 'wangji', 'quliu', 'shifei'],
                    zone2: ['lingting', 'rongmao', 'laihui', 'chaoye', 'xiwang']
                }
            },
            "test-2": {
                id: "test-2",
                title: "åŒç¾©è¤‡è©è¾¨è­˜",
                subtitle: "æ„ç¾©ç›¸è¿‘",
                difficulty: "â­â­",
                itemCount: 16,
                description: "è«‹åˆ¤æ–·ä»¥ä¸‹è©èªæ˜¯å¦ç‚ºã€åŒç¾©è¤‡è©ã€ã€‚åŒç¾©è¤‡è©æ˜¯ç”±å…©å€‹æ„æ€ç›¸åŒæˆ–ç›¸è¿‘çš„å­—çµ„æˆã€‚",
                color: "from-emerald-300 to-teal-400",
                icon: "fa-equals",
                zones: [
                    { id: 'zone1', title: 'æ˜¯åŒç¾©è¤‡è©', icon: 'fa-check-circle' },
                    { id: 'zone2', title: 'ä¸æ˜¯åŒç¾©è¤‡è©', icon: 'fa-times-circle' }
                ],
                items: [
                    { id: 'item1', text: 'è†è½', val: 'lingting' },
                    { id: 'item2', text: 'å®¹è²Œ', val: 'rongmao' },
                    { id: 'item3', text: 'æ‘©æ“¦', val: 'moca' },
                    { id: 'item4', text: 'ç·£æ•…', val: 'yuangu' },
                    { id: 'item5', text: 'å¸Œæœ›', val: 'xiwang' },
                    { id: 'item6', text: 'ç½¹æ‚£', val: 'lihuan' },
                    { id: 'item7', text: 'ç«¥ç¨š', val: 'tongzhi' },
                    { id: 'item8', text: 'è—å°', val: 'miaoxiao' },
                    { id: 'item9', text: 'é­é‡', val: 'zaoyu' },
                    { id: 'item10', text: 'ç«¶çˆ­', val: 'jingzheng' },
                    { id: 'item11', text: 'æŠ‘æˆ–', val: 'yihuo' },
                    { id: 'item12', text: 'æ‹‹æ£„', val: 'paoqi' },
                    { id: 'item13', text: 'ä¾†å›', val: 'laihui' },
                    { id: 'item14', text: 'æœé‡', val: 'chaoye' },
                    { id: 'item15', text: 'å¾—å¤±', val: 'deshi' },
                    { id: 'item16', text: 'åœ‹å®¶', val: 'guojia' }
                ],
                solution: {
                    zone1: ['lingting', 'rongmao', 'moca', 'yuangu', 'xiwang', 'lihuan', 'tongzhi', 'miaoxiao', 'zaoyu', 'jingzheng', 'yihuo', 'paoqi'],
                    zone2: ['laihui', 'chaoye', 'deshi', 'guojia']
                }
            },
            "test-3": {
                id: "test-3",
                title: "åç¾©è¤‡è©è¾¨è­˜",
                subtitle: "æ„ç¾©ç›¸å",
                difficulty: "â­â­â­",
                itemCount: 17,
                description: "è«‹åˆ¤æ–·ä»¥ä¸‹è©èªæ˜¯å¦ç‚ºã€åç¾©è¤‡è©ã€ã€‚åç¾©è¤‡è©æ˜¯ç”±å…©å€‹æ„æ€ç›¸åçš„å­—çµ„æˆï¼Œä¸”å…©å­—æ„æ€éƒ½å…·å‚™ã€‚",
                color: "from-violet-300 to-purple-400",
                icon: "fa-arrows-left-right",
                zones: [
                    { id: 'zone1', title: 'æ˜¯åç¾©è¤‡è©', icon: 'fa-arrows-left-right' },
                    { id: 'zone2', title: 'ä¸æ˜¯åç¾©è¤‡è©', icon: 'fa-ban' }
                ],
                items: [
                    { id: 'item1', text: 'ã€Œä¾†å›ã€æ©Ÿç¥¨', val: 'laihui' },
                    { id: 'item2', text: 'ã€Œæœé‡ã€åŒå¿ƒ', val: 'chaoye' },
                    { id: 'item3', text: 'ã€Œèšæ•£ã€ç„¡å¸¸', val: 'jusan' },
                    { id: 'item4', text: 'ã€Œåç«‹ã€é›£å®‰', val: 'zuoli' },
                    { id: 'item5', text: 'ã€Œè‰¯è ã€ä¸é½Š', val: 'liangyou' },
                    { id: 'item6', text: 'ã€Œè¤’è²¶ã€ä¸ä¸€', val: 'baobian' },
                    { id: 'item7', text: 'ã€Œæ­£åã€æ„è¦‹', val: 'zhengfan' },
                    { id: 'item8', text: 'è¶…è¶Šã€Œå‹æ•—ã€', val: 'shengbai' },
                    { id: 'item9', text: 'ã€Œç«¥åŸã€ç„¡æ¬º', val: 'tongsou' },
                    { id: 'item10', text: 'ç¸±æ©«ã€Œæ­é—”ã€', val: 'baihe' },
                    { id: 'item11', text: 'ã€Œé–‹é—”ã€è‡ªå¦‚', val: 'kaihe' },
                    { id: 'item12', text: 'å¦„è¡Œã€Œå‡ºå…¥ã€', val: 'churu' },
                    { id: 'item13', text: 'å°ˆå¿ƒã€Œè†è½ã€', val: 'lingting' },
                    { id: 'item14', text: 'å§£å¥½ã€Œå®¹è²Œã€', val: 'rongmao' },
                    { id: 'item15', text: 'ä»¥ã€Œåœ‹å®¶ã€ç‚ºå‰æ', val: 'guojia' },
                    { id: 'item16', text: 'ä¸€æ‰‡ã€Œçª—æˆ¶ã€', val: 'chuanghu' },
                    { id: 'item17', text: 'ä¸è¨ˆã€Œå¾—å¤±ã€', val: 'deshi' }
                ],
                solution: {
                    zone1: ['laihui', 'chaoye', 'jusan', 'zuoli', 'liangyou', 'baobian', 'zhengfan', 'shengbai', 'tongsou', 'baihe', 'kaihe', 'churu', 'deshi'],
                    zone2: ['lingting', 'rongmao', 'guojia', 'chuanghu']
                }
            },
            "test-4": {
                id: "test-4",
                title: "åç¾©è¤‡è©æ·±å…¥è¾¨è­˜",
                subtitle: "é€²éšåˆ†æ",
                difficulty: "â­â­â­â­",
                itemCount: 10,
                description: "è«‹å°‡ä»¥ä¸‹ã€åç¾©è¤‡è©ã€ä¾æ“šåé‡çš„æ„æ€åˆ†é¡ã€‚é€™äº›è©èªéƒ½æ˜¯åç¾©è¤‡è©ï¼Œè«‹åˆ¤æ–·å¯¦éš›ä¸Šæ˜¯åé‡å“ªä¸€å€‹å­—ã€‚",
                color: "from-amber-300 to-orange-400",
                icon: "fa-magnifying-glass",
                zones: [
                    { id: 'zone1', title: 'åé‡ã€Œå‰å­—ã€', icon: 'fa-arrow-left' },
                    { id: 'zone2', title: 'åé‡ã€Œå¾Œå­—ã€', icon: 'fa-arrow-right' }
                ],
                items: [
                    { id: 'item1', text: 'ä»¥ã€Œåœ‹å®¶ã€ç‚ºå‰æ', val: 'guojia' },
                    { id: 'item2', text: 'ã€Œå¿˜æ‡·ã€å¾—å¤±', val: 'wanghuai' },
                    { id: 'item3', text: 'ç½®ã€Œæ­»ç”Ÿã€æ–¼åº¦å¤–', val: 'sisheng' },
                    { id: 'item4', text: 'ä¸€æ‰‡ã€Œçª—æˆ¶ã€', val: 'chuanghu' },
                    { id: 'item5', text: 'ä¸å®œæœ‰æ‰€ã€Œç•°åŒã€', val: 'yitong' },
                    { id: 'item6', text: 'äººæœ‰æ—¦å¤•ã€Œç¦ç¦ã€', val: 'huofu' },
                    { id: 'item7', text: 'ä¸èƒ½ã€Œå¿˜è¨˜ã€', val: 'wangji' },
                    { id: 'item8', text: 'æ›¾ä¸åæƒ…ã€Œå»ç•™ã€', val: 'quliu' },
                    { id: 'item9', text: 'æ‹›æƒ¹ã€Œæ˜¯éã€', val: 'shifei' },
                    { id: 'item10', text: 'ã€Œæ²æµ´ã€ä¹³', val: 'muyu' }
                ],
                solution: {
                    zone1: ['guojia', 'wanghuai', 'sisheng', 'chuanghu'],
                    zone2: ['yitong', 'huofu', 'wangji', 'quliu', 'shifei', 'muyu']
                }
            }
        };

        function App() {
            const [screen, setScreen] = useState('home');
            const [currentTest, setCurrentTest] = useState(null);
            const [gameState, setGameState] = useState('playing');
            const [droppedItems, setDroppedItems] = useState({});
            const [feedback, setFeedback] = useState({});
            const [startTime, setStartTime] = useState(null);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [attempts, setAttempts] = useState(0);
            const [shuffledItems, setShuffledItems] = useState([]);
            const [shuffledZones, setShuffledZones] = useState([]);
            const [draggedItem, setDraggedItem] = useState(null); // è¿½è¹¤æ­£åœ¨æ‹–æ‹‰çš„é …ç›®
            const [dragSourceZone, setDragSourceZone] = useState(null); // è¿½è¹¤ä¾†æºå€åŸŸ
            
            const [completionStatus, setCompletionStatus] = useState(() => {
                try {
                    const saved = localStorage.getItem('chinese_compound_tests_status');
                    return saved ? JSON.parse(saved) : {};
                } catch {
                    return {};
                }
            });
            
            const [fontScale, setFontScale] = useState(() => {
                try {
                    const saved = localStorage.getItem('chinese_compound_font_scale');
                    return saved ? parseFloat(saved) : 100;
                } catch {
                    return 100;
                }
            });
            
            useEffect(() => {
                document.documentElement.style.fontSize = `${fontScale}%`;
            }, [fontScale]);
            
            const increaseFontSize = () => {
                const newScale = Math.min(fontScale + 10, 150);
                setFontScale(newScale);
                localStorage.setItem('chinese_compound_font_scale', newScale.toString());
            };
            
            const decreaseFontSize = () => {
                const newScale = Math.max(fontScale - 10, 70);
                setFontScale(newScale);
                localStorage.setItem('chinese_compound_font_scale', newScale.toString());
            };

            useEffect(() => {
                let timer;
                if (gameState === 'playing' && startTime) {
                    timer = setInterval(() => {
                        setElapsedTime(Math.floor((new Date() - startTime) / 1000));
                    }, 1000);
                }
                return () => {
                    if (timer) clearInterval(timer);
                };
            }, [gameState, startTime]);

            const selectTest = (testId) => {
                const test = TESTS_DATA[testId];
                setCurrentTest(test);
                setScreen('playing');
                setGameState('playing');
                setStartTime(new Date());
                setElapsedTime(0);
                setAttempts(0);
                setDroppedItems({});
                setFeedback({});
                setShuffledItems(shuffleArray(test.items));
                setShuffledZones(shuffleArray(test.zones));
                setDraggedItem(null);
                setDragSourceZone(null);
            };

            const handleDragStart = (e, item, sourceZone) => {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('application/json', JSON.stringify({ item, sourceZone }));
                setDraggedItem(item);
                setDragSourceZone(sourceZone);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDragEnd = (e) => {
                setDraggedItem(null);
                setDragSourceZone(null);
            };

            const handleDrop = (e, targetZone) => {
                e.preventDefault();
                
                try {
                    const data = JSON.parse(e.dataTransfer.getData('application/json'));
                    const { item, sourceZone } = data;
                    
                    // å¦‚æœæ˜¯åŒä¸€å€‹å€åŸŸï¼Œä¸åšä»»ä½•äº‹
                    if (sourceZone === targetZone) {
                        return;
                    }
                    
                    // å¾ä¾†æºå€åŸŸç§»é™¤ï¼ˆå¦‚æœæœ‰ä¾†æºå€åŸŸï¼‰
                    if (sourceZone && sourceZone !== 'items') {
                        setDroppedItems(prev => ({
                            ...prev,
                            [sourceZone]: (prev[sourceZone] || []).filter(i => i.id !== item.id)
                        }));
                    }
                    
                    // æ·»åŠ åˆ°ç›®æ¨™å€åŸŸï¼ˆå¦‚æœä¸æ˜¯ items å€ï¼‰
                    if (targetZone !== 'items') {
                        setDroppedItems(prev => {
                            const existing = prev[targetZone] || [];
                            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                            if (existing.some(i => i.id === item.id)) {
                                return prev;
                            }
                            return {
                                ...prev,
                                [targetZone]: [...existing, item]
                            };
                        });
                    }
                } catch (error) {
                    console.error('Drop error:', error);
                }
            };

            const handleTouchDrop = (item, targetZone) => {
                // è§¸æ§ç‰ˆæœ¬ä¿æŒä¸è®Š
                const currentItems = droppedItems[targetZone] || [];
                const alreadyExists = currentItems.some(i => i.id === item.id);
                
                if (!alreadyExists) {
                    setDroppedItems(prev => ({
                        ...prev,
                        [targetZone]: [...(prev[targetZone] || []), item]
                    }));
                }
            };

            const removeItem = (zoneId, itemId) => {
                setDroppedItems(prev => ({
                    ...prev,
                    [zoneId]: prev[zoneId].filter(item => item.id !== itemId)
                }));
            };

            const checkAnswers = () => {
                setAttempts(prev => prev + 1);
                const newFeedback = {};
                let allCorrect = true;

                Object.keys(currentTest.solution).forEach(zoneId => {
                    const correctVals = currentTest.solution[zoneId];
                    const userVals = (droppedItems[zoneId] || []).map(item => item.val);
                    
                    const isCorrect = userVals.length > 0 &&
                                    userVals.every(val => correctVals.includes(val));
                    
                    newFeedback[zoneId] = isCorrect;
                    if (!isCorrect && userVals.length > 0) {
                        allCorrect = false;
                    }
                });

                const allItemsPlaced = Object.values(droppedItems).flat().length === currentTest.items.length;
                if (!allItemsPlaced) {
                    allCorrect = false;
                }

                setFeedback(newFeedback);

                if (allCorrect) {
                    const completionTime = elapsedTime;
                    const newStatus = {
                        ...completionStatus,
                        [currentTest.id]: {
                            completed: true,
                            completedAt: new Date().toISOString(),
                            time: completionTime,
                            attempts: attempts + 1
                        }
                    };
                    setCompletionStatus(newStatus);
                    localStorage.setItem('chinese_compound_tests_status', JSON.stringify(newStatus));
                    setGameState('completed');
                }
            };

            const restart = () => {
                setGameState('playing');
                setStartTime(new Date());
                setElapsedTime(0);
                setAttempts(0);
                setDroppedItems({});
                setFeedback({});
                setShuffledItems(shuffleArray(currentTest.items));
                setShuffledZones(shuffleArray(currentTest.zones));
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            // é¦–é 
            if (screen === 'home') {
                const allTests = Object.values(TESTS_DATA);
                const completedCount = allTests.filter(test => completionStatus[test.id]?.completed).length;
                const allCompleted = completedCount === allTests.length;

                const downloadAllCertificate = () => {
                    const element = document.getElementById('all-certificate-content');
                    html2canvas(element, {
                        backgroundColor: '#667eea',
                        scale: 2,
                        width: 1200
                    }).then(canvas => {
                        const link = document.createElement('a');
                        const date = new Date();
                        link.download = `è¤‡è©çš„ç¨®é¡-å…¨éƒ¨å®Œæˆè­‰æ›¸-${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                    });
                };

                return (
                    <div className="min-h-screen flex items-center justify-center p-4 md:p-6">
                        <div className="fixed top-4 right-4 z-50 flex items-center gap-2 glass-effect rounded-xl p-2 shadow-xl">
                            <button
                                onClick={decreaseFontSize}
                                disabled={fontScale <= 70}
                                className={`px-3 py-2 rounded-lg font-bold transition-all ${
                                    fontScale <= 70
                                        ? 'bg-white/10 text-white/30 cursor-not-allowed'
                                        : 'bg-white/20 text-white hover:bg-white/30 hover:scale-110'
                                }`}
                            >
                                <span className="text-sm">A<sup className="text-xs">-</sup></span>
                            </button>
                            
                            <button
                                onClick={increaseFontSize}
                                disabled={fontScale >= 150}
                                className={`px-3 py-2 rounded-lg font-bold transition-all ${
                                    fontScale >= 150
                                        ? 'bg-white/10 text-white/30 cursor-not-allowed'
                                        : 'bg-white/20 text-white hover:bg-white/30 hover:scale-110'
                                }`}
                            >
                                <span className="text-sm">A<sup className="text-xs">+</sup></span>
                            </button>
                        </div>
                        
                        <div className="max-w-4xl w-full">
                            <div className="text-center mb-8 md:mb-12 fade-in">
                                <h1 className="text-4xl md:text-5xl font-black text-white mb-4">
                                    <i className="fas fa-book mr-3 md:mr-4"></i>
                                    è¤‡è©çš„ç¨®é¡
                                </h1>
                                <p className="text-lg md:text-xl text-white/90 mb-2">åœ‹ä¸­åœ‹æ–‡ èªæ–‡å¸¸è­˜</p>
                                <p className="text-sm md:text-base text-white/70">
                                    å®Œæˆé€²åº¦ï¼š{completedCount} / {allTests.length}
                                </p>
                                
                                {allCompleted && (
                                    <div className="mt-4 glass-effect rounded-2xl p-4 md:p-6 animate-bounce-slow inline-block">
                                        <div className="text-3xl md:text-4xl mb-2">ğŸ†</div>
                                        <div className="text-lg md:text-xl font-bold text-yellow-300 mb-3">
                                            æ­å–œå®Œæˆæ‰€æœ‰æ¸¬é©—ï¼
                                        </div>
                                        <button
                                            onClick={downloadAllCertificate}
                                            className="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-6 md:px-8 py-3 md:py-4 rounded-xl font-bold text-base md:text-lg hover:scale-110 transition-all shadow-2xl"
                                        >
                                            <i className="fas fa-download mr-2"></i>
                                            ä¸‹è¼‰å®Œæ•´å­¸ç¿’è­‰æ›¸
                                        </button>
                                    </div>
                                )}
                                
                                {Object.keys(completionStatus).length > 0 && (
                                    <button
                                        onClick={() => {
                                            if (confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å®Œæˆè¨˜éŒ„å—ï¼Ÿ')) {
                                                setCompletionStatus({});
                                                localStorage.removeItem('chinese_compound_tests_status');
                                                alert('âœ… å·²æ¸…é™¤æ‰€æœ‰è¨˜éŒ„ï¼');
                                            }
                                        }}
                                        className="mt-4 bg-red-500/80 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all shadow-lg hover:scale-105"
                                    >
                                        <i className="fas fa-trash-alt mr-2"></i>
                                        æ¸…é™¤æ‰€æœ‰è¨˜éŒ„
                                    </button>
                                )}
                            </div>

                            <div className="grid md:grid-cols-2 gap-4 md:gap-6">
                                {allTests.map((test, index) => {
                                    const isCompleted = completionStatus[test.id]?.completed;
                                    const status = completionStatus[test.id];
                                    
                                    return (
                                        <div
                                            key={test.id}
                                            className="glass-effect rounded-2xl p-6 md:p-8 hover:scale-105 transition-all duration-300 cursor-pointer fade-in relative"
                                            style={{ animationDelay: `${index * 0.1}s` }}
                                            onClick={() => selectTest(test.id)}
                                        >
                                            {isCompleted && (
                                                <div className="absolute top-3 md:top-4 right-3 md:right-4 bg-green-500 text-white px-2 md:px-3 py-1 rounded-full text-xs md:text-sm font-bold flex items-center gap-1 shadow-lg">
                                                    <i className="fas fa-check-circle"></i>
                                                    å·²å®Œæˆ
                                                </div>
                                            )}
                                            
                                            <div className="flex items-center gap-3 md:gap-4 mb-4">
                                                <div className={`w-14 h-14 md:w-16 md:h-16 bg-gradient-to-br ${test.color} rounded-xl md:rounded-2xl flex items-center justify-center flex-shrink-0`}>
                                                    <i className={`${test.icon} text-2xl md:text-3xl text-white`}></i>
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <h2 className="text-lg md:text-xl font-bold text-white truncate">
                                                            {test.title}
                                                        </h2>
                            
                            {/* éš±è—çš„å…¨éƒ¨å®Œæˆè­‰æ›¸å…§å®¹ */}
                            {allCompleted && (
                                <div 
                                    id="all-certificate-content"
                                    style={{
                                        position: 'fixed',
                                        left: '-9999px',
                                        width: '1200px',
                                        backgroundColor: '#667eea',
                                        padding: '60px',
                                        fontFamily: 'Noto Sans TC, sans-serif'
                                    }}
                                >
                                    <div style={{textAlign: 'center', marginBottom: '40px'}}>
                                        <div style={{fontSize: '80px', marginBottom: '20px'}}>ğŸ†</div>
                                        <h1 style={{fontSize: '48px', fontWeight: '900', color: 'white', marginBottom: '10px'}}>
                                            å­¸ç¿’å®Œæˆè­‰æ›¸
                                        </h1>
                                        <h2 style={{fontSize: '36px', fontWeight: 'bold', color: '#fbbf24', marginBottom: '20px'}}>
                                            è¤‡è©çš„ç¨®é¡ - å…¨éƒ¨é€šé—œ
                                        </h2>
                                        <div style={{fontSize: '18px', color: 'rgba(255,255,255,0.9)'}}>
                                            å®Œæˆæ™‚é–“ï¼š{new Date().toLocaleString('zh-TW')}
                                        </div>
                                    </div>

                                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '20px', marginBottom: '40px'}}>
                                        <div style={{backgroundColor: 'rgba(255,255,255,0.1)', borderRadius: '16px', padding: '30px', textAlign: 'center'}}>
                                            <div style={{fontSize: '40px', marginBottom: '10px'}}>ğŸ“š</div>
                                            <div style={{fontSize: '14px', color: 'rgba(255,255,255,0.8)', marginBottom: '8px'}}>å®Œæˆæ¸¬é©—</div>
                                            <div style={{fontSize: '32px', fontWeight: 'bold', color: '#4ade80'}}>4 / 4</div>
                                        </div>
                                        <div style={{backgroundColor: 'rgba(255,255,255,0.1)', borderRadius: '16px', padding: '30px', textAlign: 'center'}}>
                                            <div style={{fontSize: '40px', marginBottom: '10px'}}>ğŸ“</div>
                                            <div style={{fontSize: '14px', color: 'rgba(255,255,255,0.8)', marginBottom: '8px'}}>ç¸½é¡Œç›®æ•¸</div>
                                            <div style={{fontSize: '32px', fontWeight: 'bold', color: 'white'}}>
                                                {allTests.reduce((sum, test) => sum + test.itemCount, 0)}
                                            </div>
                                        </div>
                                        <div style={{backgroundColor: 'rgba(255,255,255,0.1)', borderRadius: '16px', padding: '30px', textAlign: 'center'}}>
                                            <div style={{fontSize: '40px', marginBottom: '10px'}}>â±ï¸</div>
                                            <div style={{fontSize: '14px', color: 'rgba(255,255,255,0.8)', marginBottom: '8px'}}>ç¸½ç”¨æ™‚</div>
                                            <div style={{fontSize: '32px', fontWeight: 'bold', color: 'white'}}>
                                                {formatTime(allTests.reduce((sum, test) => sum + (completionStatus[test.id]?.time || 0), 0))}
                                            </div>
                                        </div>
                                        <div style={{backgroundColor: 'rgba(255,255,255,0.1)', borderRadius: '16px', padding: '30px', textAlign: 'center'}}>
                                            <div style={{fontSize: '40px', marginBottom: '10px'}}>ğŸ¯</div>
                                            <div style={{fontSize: '14px', color: 'rgba(255,255,255,0.8)', marginBottom: '8px'}}>ç¸½å˜—è©¦</div>
                                            <div style={{fontSize: '32px', fontWeight: 'bold', color: 'white'}}>
                                                {allTests.reduce((sum, test) => sum + (completionStatus[test.id]?.attempts || 0), 0)}
                                            </div>
                                        </div>
                                    </div>

                                    <div style={{backgroundColor: 'rgba(255,255,255,0.1)', borderRadius: '16px', padding: '30px', marginBottom: '30px'}}>
                                        <h3 style={{fontSize: '24px', fontWeight: 'bold', color: 'white', marginBottom: '20px'}}>
                                            ğŸ“‹ å„æ¸¬é©—å®Œæˆè©³æƒ…
                                        </h3>
                                        {allTests.map((test, idx) => {
                                            const status = completionStatus[test.id];
                                            return (
                                                <div key={idx} style={{
                                                    backgroundColor: 'rgba(255,255,255,0.1)',
                                                    borderRadius: '12px',
                                                    padding: '20px',
                                                    marginBottom: '15px',
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center'
                                                }}>
                                                    <div style={{display: 'flex', alignItems: 'center', gap: '15px'}}>
                                                        <div style={{
                                                            width: '50px',
                                                            height: '50px',
                                                            backgroundColor: '#22c55e',
                                                            borderRadius: '12px',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'center',
                                                            fontSize: '24px',
                                                            color: 'white',
                                                            fontWeight: 'bold'
                                                        }}>âœ“</div>
                                                        <div>
                                                            <div style={{fontSize: '20px', fontWeight: 'bold', color: 'white', marginBottom: '5px'}}>
                                                                {test.title}
                                                            </div>
                                                            <div style={{fontSize: '14px', color: 'rgba(255,255,255,0.7)'}}>
                                                                {test.subtitle} Â· {test.itemCount}é¡Œ Â· å˜—è©¦{status?.attempts || 0}æ¬¡
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div style={{fontSize: '20px', color: 'rgba(255,255,255,0.8)', fontFamily: 'monospace'}}>
                                                        {formatTime(status?.time || 0)}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>

                                    <div style={{backgroundColor: 'rgba(255,255,255,0.1)', borderRadius: '16px', padding: '30px', textAlign: 'center'}}>
                                        <h3 style={{fontSize: '24px', fontWeight: 'bold', color: 'white', marginBottom: '20px'}}>
                                            ğŸŒŸ ç¸½é«”è©•åƒ¹
                                        </h3>
                                        <div style={{fontSize: '80px', marginBottom: '15px'}}>
                                            {allTests.every(test => (completionStatus[test.id]?.attempts || 0) === 1) ? 'ğŸ†' : 
                                             allTests.every(test => (completionStatus[test.id]?.attempts || 0) <= 2) ? 'ğŸ¥‡' : 'ğŸ¥ˆ'}
                                        </div>
                                        <div style={{fontSize: '32px', fontWeight: 'bold', color: 'white', marginBottom: '10px'}}>
                                            {allTests.every(test => (completionStatus[test.id]?.attempts || 0) === 1) ? 'å®Œç¾å¤§å¸«' : 
                                             allTests.every(test => (completionStatus[test.id]?.attempts || 0) <= 2) ? 'å„ªç§€å­¸ç¿’è€…' : 'èªçœŸå­¸ç¿’è€…'}
                                        </div>
                                        <div style={{fontSize: '16px', color: 'rgba(255,255,255,0.8)'}}>
                                            {allTests.every(test => (completionStatus[test.id]?.attempts || 0) === 1) ? 'æ‰€æœ‰æ¸¬é©—ä¸€æ¬¡é€šéï¼ŒçœŸæ­£çš„åœ‹æ–‡é«˜æ‰‹ï¼' : 
                                             allTests.every(test => (completionStatus[test.id]?.attempts || 0) <= 2) ? 'å„ªç§€çš„å­¸ç¿’è¡¨ç¾ï¼ŒæŒçºŒä¿æŒï¼' : 
                                             'å®Œæˆå°±æ˜¯å‹åˆ©ï¼Œç¹¼çºŒåŠ æ²¹ï¼'}
                                        </div>
                                    </div>

                                    <div style={{marginTop: '40px', textAlign: 'center', fontSize: '14px', color: 'rgba(255,255,255,0.6)'}}>
                                        æ­¤è­‰æ›¸è­‰æ˜å­¸ç¿’è€…å·²å®Œæˆã€Œè¤‡è©çš„ç¨®é¡ã€æ‰€æœ‰æ¸¬é©—
                                    </div>
                                </div>
                            )}
                                                        <span className="text-xs md:text-sm text-yellow-300 whitespace-nowrap">
                                                            {test.difficulty}
                                                        </span>
                                                    </div>
                                                    <p className="text-xs md:text-sm text-white/70">
                                                        {test.subtitle}
                                                    </p>
                                                </div>
                                            </div>
                                            
                                            <div className="text-white/80 text-sm md:text-base mb-3">
                                                é¡Œæ•¸ï¼š{test.itemCount} é¡Œ
                                            </div>
                                            
                                            {isCompleted && status && (
                                                <div className="text-white/60 text-xs md:text-sm space-y-1">
                                                    <div>â±ï¸ ç”¨æ™‚ï¼š{formatTime(status.time)}</div>
                                                    <div>ğŸ¯ å˜—è©¦ï¼š{status.attempts} æ¬¡</div>
                                                </div>
                                            )}
                                            
                                            {!isCompleted && (
                                                <div className="text-white/60 text-xs md:text-sm">
                                                    é»æ“Šé–‹å§‹æ¸¬é©—
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            }

            // æ¸¬é©—é€²è¡Œä¸­
            if (screen === 'playing' && currentTest) {
                let availableItems = [];
                const placedItemIds = Object.values(droppedItems).flat().map(item => item.id);
                availableItems = shuffledItems.filter(item => !placedItemIds.includes(item.id));

                // æ¸¬é©—å®Œæˆç•«é¢
                if (gameState === 'completed') {
                    const completionTime = elapsedTime;
                    const status = completionStatus[currentTest.id];
                    
                    const downloadCertificate = () => {
                        const element = document.getElementById('certificate-content');
                        html2canvas(element, {
                            backgroundColor: '#667eea',
                            scale: 2,
                            width: 1000
                        }).then(canvas => {
                            const link = document.createElement('a');
                            const date = new Date();
                            link.download = `${currentTest.title}-å®Œæˆè­‰æ›¸-${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}.png`;
                            link.href = canvas.toDataURL();
                            link.click();
                        });
                    };

                    return (
                        <div className="min-h-screen flex items-center justify-center p-4 md:p-6">
                            <div className="max-w-3xl w-full">
                                {/* é¡¯ç¤ºç”¨è­‰æ›¸ */}
                                <div className="glass-effect rounded-3xl p-6 md:p-12 text-center fade-in mb-6">
                                    <div className="text-6xl md:text-8xl mb-4">ğŸ‰</div>
                                    <h2 className="text-3xl md:text-5xl font-black text-white mb-4">
                                        æ¸¬é©—å®Œæˆï¼
                                    </h2>
                                    <p className="text-xl md:text-2xl text-white/90 mb-6">
                                        {currentTest.title}
                                    </p>
                                    
                                    <div className="grid grid-cols-3 gap-4 md:gap-6 mb-8">
                                        <div className="glass-effect rounded-2xl p-4 md:p-6">
                                            <div className="text-3xl md:text-4xl mb-2">â±ï¸</div>
                                            <div className="text-white/80 text-xs md:text-sm mb-1">å®Œæˆæ™‚é–“</div>
                                            <div className="text-2xl md:text-3xl font-bold text-white">
                                                {formatTime(completionTime)}
                                            </div>
                                        </div>
                                        <div className="glass-effect rounded-2xl p-4 md:p-6">
                                            <div className="text-3xl md:text-4xl mb-2">ğŸ“</div>
                                            <div className="text-white/80 text-xs md:text-sm mb-1">é¡Œç›®æ•¸é‡</div>
                                            <div className="text-2xl md:text-3xl font-bold text-white">
                                                {currentTest.itemCount}
                                            </div>
                                        </div>
                                        <div className="glass-effect rounded-2xl p-4 md:p-6">
                                            <div className="text-3xl md:text-4xl mb-2">ğŸ¯</div>
                                            <div className="text-white/80 text-xs md:text-sm mb-1">å˜—è©¦æ¬¡æ•¸</div>
                                            <div className="text-2xl md:text-3xl font-bold text-white">
                                                {status?.attempts || attempts + 1}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="glass-effect rounded-2xl p-4 md:p-6 mb-8">
                                        <h3 className="text-lg md:text-xl font-bold text-white mb-3">
                                            ğŸŒŸ æˆå°±è©•åƒ¹
                                        </h3>
                                        <div className="text-4xl md:text-6xl mb-3">
                                            {(status?.attempts || attempts + 1) === 1 ? 'ğŸ†' : 
                                             (status?.attempts || attempts + 1) <= 2 ? 'ğŸ¥‡' : 
                                             (status?.attempts || attempts + 1) <= 3 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'}
                                        </div>
                                        <div className="text-xl md:text-2xl font-bold text-white mb-2">
                                            {(status?.attempts || attempts + 1) === 1 ? 'å®Œç¾é€šé—œï¼' : 
                                             (status?.attempts || attempts + 1) <= 2 ? 'å„ªç§€è¡¨ç¾ï¼' : 
                                             (status?.attempts || attempts + 1) <= 3 ? 'è¡¨ç¾è‰¯å¥½ï¼' : 'ç¹¼çºŒåŠ æ²¹ï¼'}
                                        </div>
                                        <div className="text-sm md:text-base text-white/80">
                                            {(status?.attempts || attempts + 1) === 1 ? 'ä¸€æ¬¡å°±å®Œæˆæ‰€æœ‰é¡Œç›®ï¼Œå¤ªå²å®³äº†ï¼' : 
                                             (status?.attempts || attempts + 1) <= 2 ? 'åªå˜—è©¦å°‘æ•¸æ¬¡å°±å®Œæˆï¼Œéå¸¸æ£’ï¼' : 
                                             (status?.attempts || attempts + 1) <= 3 ? 'ç©©å®šå®Œæˆæ¸¬é©—ï¼Œç¹¼çºŒä¿æŒï¼' : 
                                             'å®Œæˆå°±æ˜¯å‹åˆ©ï¼Œä¸‹æ¬¡æœƒæ›´å¥½ï¼'}
                                        </div>
                                    </div>

                                    <div className="flex flex-col md:flex-row gap-3 md:gap-4">
                                        <button
                                            onClick={downloadCertificate}
                                            className="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 md:px-8 py-3 md:py-4 rounded-xl font-bold text-base md:text-lg hover:scale-105 transition-all shadow-xl"
                                        >
                                            <i className="fas fa-download mr-2"></i>
                                            ä¸‹è¼‰å®Œæˆè­‰æ›¸
                                        </button>
                                        <button
                                            onClick={restart}
                                            className="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 md:px-8 py-3 md:py-4 rounded-xl font-bold text-base md:text-lg hover:scale-105 transition-all shadow-xl"
                                        >
                                            <i className="fas fa-redo mr-2"></i>
                                            å†æŒ‘æˆ°ä¸€æ¬¡
                                        </button>
                                    </div>
                                    <button
                                        onClick={() => setScreen('home')}
                                        className="w-full mt-3 bg-white/20 text-white px-6 md:px-8 py-3 md:py-4 rounded-xl font-bold text-base md:text-lg hover:bg-white/30 transition-all"
                                    >
                                        <i className="fas fa-home mr-2"></i>
                                        è¿”å›é¦–é 
                                    </button>
                                </div>

                                {/* éš±è—çš„è­‰æ›¸å…§å®¹ç”¨æ–¼æˆªåœ– */}
                                <div 
                                    id="certificate-content"
                                    style={{
                                        position: 'fixed',
                                        left: '-9999px',
                                        width: '1000px',
                                        backgroundColor: '#667eea',
                                        padding: '60px',
                                        fontFamily: 'Noto Sans TC, sans-serif'
                                    }}
                                >
                                    <div style={{textAlign: 'center', marginBottom: '40px'}}>
                                        <div style={{fontSize: '80px', marginBottom: '20px'}}>ğŸ“</div>
                                        <h1 style={{fontSize: '48px', fontWeight: '900', color: 'white', marginBottom: '10px'}}>
                                            æ¸¬é©—å®Œæˆè­‰æ›¸
                                        </h1>
                                        <h2 style={{fontSize: '36px', fontWeight: 'bold', color: '#fbbf24', marginBottom: '20px'}}>
                                            {currentTest.title}
                                        </h2>
                                        <div style={{fontSize: '18px', color: 'rgba(255,255,255,0.9)'}}>
                                            å®Œæˆæ™‚é–“ï¼š{new Date().toLocaleString('zh-TW')}
                                        </div>
                                    </div>

                                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '20px', marginBottom: '40px'}}>
                                        <div style={{backgroundColor: 'rgba(255,255,255,0.1)', borderRadius: '16px', padding: '30px', textAlign: 'center'}}>
                                            <div style={{fontSize: '40px', marginBottom: '10px'}}>â±ï¸</div>
                                            <div style={{fontSize: '14px', color: 'rgba(255,255,255,0.8)', marginBottom: '8px'}}>å®Œæˆæ™‚é–“</div>
                                            <div style={{fontSize: '32px', fontWeight: 'bold', color: 'white'}}>
                                                {formatTime(completionTime)}
                                            </div>
                                        </div>
                                        <div style={{backgroundColor: 'rgba(255,255,255,0.1)', borderRadius: '16px', padding: '30px', textAlign: 'center'}}>
                                            <div style={{fontSize: '40px', marginBottom: '10px'}}>ğŸ“</div>
                                            <div style={{fontSize: '14px', color: 'rgba(255,255,255,0.8)', marginBottom: '8px'}}>é¡Œç›®æ•¸é‡</div>
                                            <div style={{fontSize: '32px', fontWeight: 'bold', color: '#4ade80'}}>
                                                {currentTest.itemCount}
                                            </div>
                                        </div>
                                        <div style={{backgroundColor: 'rgba(255,255,255,0.1)', borderRadius: '16px', padding: '30px', textAlign: 'center'}}>
                                            <div style={{fontSize: '40px', marginBottom: '10px'}}>ğŸ¯</div>
                                            <div style={{fontSize: '14px', color: 'rgba(255,255,255,0.8)', marginBottom: '8px'}}>å˜—è©¦æ¬¡æ•¸</div>
                                            <div style={{fontSize: '32px', fontWeight: 'bold', color: 'white'}}>
                                                {status?.attempts || attempts + 1}
                                            </div>
                                        </div>
                                    </div>

                                    <div style={{backgroundColor: 'rgba(255,255,255,0.1)', borderRadius: '16px', padding: '40px', textAlign: 'center', marginBottom: '30px'}}>
                                        <h3 style={{fontSize: '24px', fontWeight: 'bold', color: 'white', marginBottom: '20px'}}>
                                            ğŸŒŸ æˆå°±è©•åƒ¹
                                        </h3>
                                        <div style={{fontSize: '80px', marginBottom: '15px'}}>
                                            {(status?.attempts || attempts + 1) === 1 ? 'ğŸ†' : 
                                             (status?.attempts || attempts + 1) <= 2 ? 'ğŸ¥‡' : 
                                             (status?.attempts || attempts + 1) <= 3 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'}
                                        </div>
                                        <div style={{fontSize: '32px', fontWeight: 'bold', color: 'white', marginBottom: '10px'}}>
                                            {(status?.attempts || attempts + 1) === 1 ? 'å®Œç¾é€šé—œ' : 
                                             (status?.attempts || attempts + 1) <= 2 ? 'å„ªç§€è¡¨ç¾' : 
                                             (status?.attempts || attempts + 1) <= 3 ? 'è¡¨ç¾è‰¯å¥½' : 'ç¹¼çºŒåŠ æ²¹'}
                                        </div>
                                        <div style={{fontSize: '16px', color: 'rgba(255,255,255,0.8)'}}>
                                            {currentTest.subtitle} - {currentTest.difficulty}
                                        </div>
                                    </div>

                                    <div style={{marginTop: '40px', textAlign: 'center', fontSize: '14px', color: 'rgba(255,255,255,0.6)'}}>
                                        æ­¤è­‰æ›¸è­‰æ˜å­¸ç¿’è€…å·²å®Œæˆã€Œ{currentTest.title}ã€æ¸¬é©—
                                    </div>
                                </div>
                            </div>
                        </div>
                    );
                }

                // éŠæˆ²é€²è¡Œä¸­ç•«é¢
                return (
                    <div className="h-screen flex flex-col overflow-hidden">
                        <div className={`flex-shrink-0 bg-gradient-to-r ${currentTest.color.replace('300', '400').replace('400', '500')} p-2 md:p-3 text-white shadow-xl`}>
                            <div className="flex items-center gap-2 mb-2">
                                <div className="flex items-center gap-2 flex-shrink-0">
                                    <div className="flex items-center gap-1 bg-black/20 rounded-lg p-1">
                                        <button
                                            onClick={decreaseFontSize}
                                            disabled={fontScale <= 70}
                                            className={`px-1.5 py-0.5 rounded text-xs font-bold transition-all ${
                                                fontScale <= 70 ? 'text-white/30 cursor-not-allowed' : 'text-white hover:bg-white/20'
                                            }`}
                                        >
                                            A<sup style={{ fontSize: '8px' }}>-</sup>
                                        </button>
                                        <button
                                            onClick={increaseFontSize}
                                            disabled={fontScale >= 150}
                                            className={`px-1.5 py-0.5 rounded text-xs font-bold transition-all ${
                                                fontScale >= 150 ? 'text-white/30 cursor-not-allowed' : 'text-white hover:bg-white/20'
                                            }`}
                                        >
                                            A<sup style={{ fontSize: '8px' }}>+</sup>
                                        </button>
                                    </div>
                                    <h2 className="text-sm md:text-base font-bold truncate">{currentTest.title}</h2>
                                </div>
                                
                                <div className="flex-1"></div>
                                
                                <div className="flex items-center gap-2 flex-shrink-0">
                                    <span className="text-xs opacity-80 whitespace-nowrap hidden sm:inline">
                                        â±ï¸ {formatTime(elapsedTime)}
                                    </span>
                                    <span className="text-xs bg-black/20 px-2 py-0.5 rounded whitespace-nowrap">
                                        ğŸ¯ {attempts}
                                    </span>
                                    <button
                                        onClick={() => setScreen('home')}
                                        className="bg-white/20 hover:bg-white/30 px-2 py-1 rounded transition-all text-xs"
                                    >
                                        <i className="fas fa-home"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-2 md:p-4" style={{WebkitOverflowScrolling: 'touch', maxHeight: '90%'}}>
                            <div className="grid lg:grid-cols-3 gap-2 md:gap-3 max-w-7xl mx-auto">
                                <div className="lg:col-span-1">
                                    <div className="glass-effect rounded-lg p-2 md:p-3 lg:sticky lg:top-2">
                                        <h3 className="text-sm md:text-base font-bold text-white mb-2 flex items-center">
                                            <i className="fas fa-cube mr-1 text-xs"></i>
                                            å¾…åˆ†é¡è©èª
                                        </h3>
                                        <p className="text-xs text-white/70 mb-3">{currentTest.description}</p>
                                        <div 
                                            data-zone-id="items"
                                            onDrop={(e) => handleDrop(e, 'items')}
                                            onDragOver={handleDragOver}
                                            className={`drop-zone gap-1.5 min-h-[100px] ${
                                                currentTest.id === 'test-1' || currentTest.id === 'test-3' || currentTest.id === 'test-4' ? 'grid grid-cols-2' : 'grid grid-cols-3'
                                            }`}
                                        >
                                            {availableItems.map(item => (
                                                <div
                                                    key={item.id}
                                                    draggable
                                                    onDragStart={(e) => handleDragStart(e, item, 'items')}
                                                    onDragEnd={handleDragEnd}
                                                    onTouchStart={(e) => handleTouchStart(e, item, null)}
                                                    onTouchMove={handleTouchMove}
                                                    onTouchEnd={(e) => handleTouchEnd(e, handleTouchDrop)}
                                                    className="drag-item bg-white rounded-lg p-2 shadow-lg"
                                                >
                                                    <p className={`text-gray-800 font-medium text-center ${
                                                        currentTest.id === 'test-1' || currentTest.id === 'test-3' || currentTest.id === 'test-4' ? 'text-sm md:text-base' : 'text-xs md:text-sm'
                                                    }`}>
                                                        {item.text}
                                                    </p>
                                                </div>
                                            ))}
                                            {availableItems.length === 0 && (
                                                <div className={`text-center text-white/70 py-3 text-xs ${
                                                    currentTest.id === 'test-1' || currentTest.id === 'test-3' || currentTest.id === 'test-4' ? 'col-span-2' : 'col-span-3'
                                                }`}>
                                                    æ‰€æœ‰è©èªéƒ½å·²åˆ†é¡
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                <div className="lg:col-span-2">
                                    <div className="grid gap-2">
                                        {shuffledZones.map(zone => (
                                            <div
                                                key={zone.id}
                                                data-zone-id={zone.id}
                                                onDragOver={handleDragOver}
                                                onDrop={(e) => handleDrop(e, zone.id)}
                                                className={`
                                                    drop-zone glass-effect rounded-lg p-2 md:p-3
                                                    ${feedback[zone.id] === true ? 'correct-answer' : ''}
                                                    ${feedback[zone.id] === false ? 'wrong-answer' : ''}
                                                    ${!feedback[zone.id] ? 'border-2 border-white/30' : ''}
                                                `}
                                            >
                                                <h4 className="text-sm md:text-base font-bold text-white mb-2 flex items-center">
                                                    <i className={`${zone.icon} mr-1 text-xs`}></i>
                                                    <span className="flex-1 text-xs md:text-sm">{zone.title}</span>
                                                    {feedback[zone.id] === true && (
                                                        <i className="fas fa-check-circle text-green-400 text-base"></i>
                                                    )}
                                                    {feedback[zone.id] === false && (
                                                        <i className="fas fa-times-circle text-red-400 text-base"></i>
                                                    )}
                                                </h4>
                                                <div className={`gap-1.5 ${
                                                    currentTest.id === 'test-1' || currentTest.id === 'test-3' || currentTest.id === 'test-4' ? 'grid grid-cols-2' : 'grid grid-cols-3'
                                                }`}>
                                                    {(droppedItems[zone.id] || []).map(item => (
                                                        <div
                                                            key={item.id}
                                                            draggable
                                                            onDragStart={(e) => handleDragStart(e, item, zone.id)}
                                                            onDragEnd={handleDragEnd}
                                                            onTouchStart={(e) => handleTouchStart(e, item, () => removeItem(zone.id, item.id))}
                                                            onTouchMove={handleTouchMove}
                                                            onTouchEnd={(e) => handleTouchEnd(e, handleTouchDrop)}
                                                            className="bg-white rounded-lg p-2 shadow-lg group relative cursor-move"
                                                        >
                                                            <p className={`text-gray-800 font-medium text-center pr-5 ${
                                                                currentTest.id === 'test-1' || currentTest.id === 'test-3' || currentTest.id === 'test-4' ? 'text-sm' : 'text-xs'
                                                            }`}>
                                                                {item.text}
                                                            </p>
                                                            <button
                                                                onClick={() => removeItem(zone.id, item.id)}
                                                                className="absolute top-1 right-1 w-4 h-4 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-xs"
                                                            >
                                                                Ã—
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>

                                    <div className="mt-2 flex gap-2">
                                        {gameState === 'playing' && (() => {
                                            const totalItems = currentTest.items.length;
                                            const placedItems = Object.values(droppedItems).flat().length;
                                            const allPlaced = placedItems === totalItems;
                                            
                                            return (
                                                <button
                                                    onClick={checkAnswers}
                                                    className={`flex-1 py-2.5 rounded-lg font-bold text-sm transition-all shadow-xl ${
                                                        allPlaced 
                                                            ? 'bg-gradient-to-r from-green-500 to-emerald-600 text-white hover:scale-105 cursor-pointer'
                                                            : 'bg-gray-400 text-gray-200 cursor-not-allowed'
                                                    }`}
                                                    disabled={!allPlaced}
                                                >
                                                    <i className="fas fa-check mr-1"></i>
                                                    {allPlaced ? 'æª¢æŸ¥ç­”æ¡ˆ' : `å°šæœªå®Œæˆ (${placedItems}/${totalItems})`}
                                                </button>
                                            );
                                        })()}
                                        {gameState === 'completed' && (
                                            <button
                                                onClick={() => setScreen('home')}
                                                className="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white py-2.5 rounded-lg font-bold text-sm hover:scale-105 transition-all shadow-xl"
                                            >
                                                <i className="fas fa-home mr-1"></i>
                                                è¿”å›é¦–é 
                                            </button>
                                        )}
                                        <button
                                            onClick={restart}
                                            className="bg-white/20 text-white px-3 py-2.5 rounded-lg hover:bg-white/30 transition-all text-sm"
                                        >
                                            <i className="fas fa-redo"></i>
                                            <span className="ml-1 hidden sm:inline">é‡ä¾†</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
